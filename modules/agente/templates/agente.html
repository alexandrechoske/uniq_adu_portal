{% extends "base.html" %}

{% block title %}Agente Unique - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('agente.static', filename='css/agente.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            {{ breadcrumb([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Ferramentas', 'icon': 'mdi mdi-tools', 'url': url_for('menu.ferramentas')},
                {'name': 'Agente Unique', 'icon': 'mdi mdi-robot'}
            ]) }}
        </div>
        {% if is_admin_view %}
        <div class="actions-right">
            <span class="status-badge status-active">
                <i class="mdi mdi-shield-crown"></i>
                Modo Administrador
            </span>
        </div>
        {% endif %}
    </div>

    {% if is_admin_view %}
    <!-- ===== PAINEL ADMINISTRATIVO ===== -->
    <div class="admin-main-content">
        
        <!-- Seção de Estatísticas -->
        <div class="stats-section">
            <div class="stat-card total-users">
                <div class="stat-icon">
                    <i class="mdi mdi-account-multiple"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total de Usuários</div>
                    <div class="stat-value" data-stat="total_users">0</div>
                </div>
            </div>
            
            <div class="stat-card active-users">
                <div class="stat-icon">
                    <i class="mdi mdi-account-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Usuários Ativos</div>
                    <div class="stat-value" data-stat="active_users">0</div>
                </div>
            </div>
            
            <div class="stat-card total-numbers">
                <div class="stat-icon">
                    <i class="mdi mdi-phone"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total de Números</div>
                    <div class="stat-value" data-stat="total_numbers">0</div>
                </div>
            </div>
            
            <div class="stat-card total-companies">
                <div class="stat-icon">
                    <i class="mdi mdi-office-building"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Empresas</div>
                    <div class="stat-value" data-stat="total_companies">0</div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="admin-filters-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-info-light); color: var(--color-info);">
                    <i class="mdi mdi-filter"></i>
                </div>
                <h3 class="card-title">Filtros de Busca</h3>
            </div>
            
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label">Buscar Usuário</label>
                    <div class="input-group">
                        <input type="text" id="search-users" class="form-input with-icon" placeholder="Nome, email ou número..." onkeyup="filterUsers()">
                        <i class="input-icon mdi mdi-magnify"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="status-filter" class="form-input" onchange="filterUsers()">
                        <option value="all">Todos</option>
                        <option value="active">Ativos</option>
                        <option value="inactive">Inativos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Empresa</label>
                    <select id="company-filter" class="form-input" onchange="filterUsers()">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabela de Usuários -->
        <div class="users-table-section">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="mdi mdi-account-group"></i>
                    Gerenciamento de Usuários
                </h3>
                <div class="table-controls">
                    <button class="btn btn-info btn-table" onclick="refreshData()">
                        <i class="mdi mdi-refresh"></i>
                        Atualizar
                    </button>
                    <button class="btn btn-success btn-table" onclick="exportAllData()">
                        <i class="mdi mdi-download"></i>
                        Exportar
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th class="user-info-cell">Usuário</th>
                            <th class="numbers-cell">Números WhatsApp</th>
                            <th class="companies-cell">Empresas</th>
                            <th class="status-cell">Status</th>
                            <th class="actions-cell">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        {% for usuario in usuarios %}
                        <tr data-user-id="{{ usuario.user_id }}">
                            <td class="user-info-cell">
                                <div class="user-name-table">{{ usuario.nome or 'Nome não informado' }}</div>
                                <div class="user-email-table">{{ usuario.email }}</div>
                            </td>
                            <td class="numbers-cell">
                                <div class="numbers-list-table">
                                    {% if usuario.numeros %}
                                        {% for numero in usuario.numeros %}
                                        <span class="number-badge" title="{{ numero.nome }} • {{ numero.tipo|title }}{% if numero.principal %} • Principal{% endif %}">
                                            {{ numero.numero }}
                                            {% if numero.principal %}<i class="mdi mdi-star" style="color: var(--color-warning);"></i>{% endif %}
                                        </span>
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: var(--color-text-muted); font-size: 0.75rem;">Nenhum número</span>
                                    {% endif %}
                                </div>
                                <div class="add-number-inline" style="display: none;">
                                    <input type="text" class="form-input add-number-input" placeholder="Novo número" id="new-number-{{ usuario.user_id }}">
                                    <button class="btn btn-success btn-table" onclick="adminAddNumber('{{ usuario.user_id }}')">
                                        <i class="mdi mdi-plus"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="companies-cell">
                                {% if usuario.empresas %}
                                    <span class="companies-count">{{ usuario.empresas|length }} empresa(s)</span>
                                    <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                                        {% for empresa in usuario.empresas[:2] %}
                                            {{ empresa }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                        {% if usuario.empresas|length > 2 %}...{% endif %}
                                    </div>
                                {% else %}
                                    <span style="color: var(--color-text-muted); font-size: 0.75rem;">Nenhuma empresa</span>
                                {% endif %}
                            </td>
                            <td class="status-cell">
                                {% if usuario.ativo %}
                                    <span class="status-badge status-active"><i class="mdi mdi-check-circle"></i> Ativo</span>
                                {% else %}
                                    <span class="status-badge status-inactive"><i class="mdi mdi-close-circle"></i> Inativo</span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <button class="btn btn-primary btn-table" onclick="showUserDetails('{{ usuario.user_id }}')" title="Visualizar detalhes">
                                    <i class="mdi mdi-eye"></i>
                                </button>
                                {% if usuario.ativo %}
                                    <button class="btn btn-warning btn-table" onclick="adminToggleUser('{{ usuario.user_id }}', false)" title="Desativar">
                                        <i class="mdi mdi-pause"></i>
                                    </button>
                                {% else %}
                                    <button class="btn btn-success btn-table" onclick="adminToggleUser('{{ usuario.user_id }}', true)" title="Ativar">
                                        <i class="mdi mdi-play"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        {% if not usuarios %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="mdi mdi-account-off"></i>
                                <h3>Nenhum usuário encontrado</h3>
                                <p>Não há usuários cadastrados no sistema Agente Unique.</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="quick-actions-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-warning-light); color: var(--color-warning);">
                    <i class="mdi mdi-lightning-bolt"></i>
                </div>
                <h3 class="card-title">Ações Rápidas</h3>
            </div>
            
            <div class="quick-actions-grid">
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="mdi mdi-refresh"></i>
                    Recarregar Dados
                </button>
                <button class="btn btn-info" onclick="exportAllData()">
                    <i class="mdi mdi-download"></i>
                    Exportar Relatório
                </button>
                <button class="btn btn-warning" onclick="showBulkActions()">
                    <i class="mdi mdi-cog"></i>
                    Ações em Massa
                </button>
            </div>
        </div>
    </div>

    {% else %}
    <!-- ===== ÁREA DO USUÁRIO COMUM ===== -->
    <div class="main-content agent-grid">
        {% if user_data and user_data.tem_numeros %}
        <!-- Agente Configurado -->
        <div class="agent-card agent-main-card">
            <!-- Header com Status -->
            <div class="agent-status-header">
                <div class="card-icon">
                    <i class="mdi mdi-robot"></i>
                </div>
                <div>
                    <h2 class="card-title">Agente Unique Ativo</h2>
                    <span class="agent-status-badge">
                        <i class="mdi mdi-check-circle"></i>
                        {{ user_data.numeros|length }} número(s) ativo(s)
                    </span>
                </div>
            </div>

            <!-- Seção de Números -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <i class="mdi mdi-phone"></i>
                    Números WhatsApp
                </h3>
                
                {% if user_data.numeros %}
                <div class="numbers-grid">
                    {% for numero in user_data.numeros %}
                    {% set raw = (numero.numero or numero.numero_whatsapp) %}
                    {% if raw and raw.startswith('+55') and raw|length >= 14 %}
                        {% set phone = raw[3:] %}
                        {% set ddd = phone[:2] %}
                        {% set main = phone[2:] %}
                        {% set main_fmt = main[:5] ~ '-' ~ main[5:] %}
                        {% set display_num = '(' ~ ddd ~ ') ' ~ main_fmt %}
                    {% else %}
                        {% set display_num = raw %}
                    {% endif %}
                    <div class="number-item" data-numero-id="{{ numero.id }}">
                        <div style="flex:1;">
                            <div class="number-text">
                                {{ display_num }}
                                {% if numero.principal %}
                                    <span style="color: var(--color-primary); font-size: 0.75rem; margin-left: 0.5rem;">★ Principal</span>
                                {% endif %}
                            </div>
                            <div style="font-size:0.75rem;color:var(--color-text-muted);margin-top:2px;">
                                {{ numero.nome or numero.nome_contato }} • {{ (numero.tipo or numero.tipo_numero)|title }}
                            </div>
                        </div>
                        <div class="number-actions">
                            {% if not numero.principal %}
                            <button class="btn-icon btn btn-primary" onclick="setPrincipal('{{ numero.id }}')" title="Definir como principal">
                                <i class="mdi mdi-star"></i>
                            </button>
                            {% endif %}
                            <button class="btn-icon btn btn-danger" onclick="removeNumber('{{ numero.id }}', '{{ display_num }}')" title="Remover">
                                <i class="mdi mdi-delete"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Adicionar Novo Número -->
                <div class="add-number-section" onclick="showAddNumberForm()">
                    <div id="add-number-placeholder">
                        <i class="mdi mdi-plus-circle" style="font-size: 2rem; color: var(--color-primary); margin-bottom: var(--spacing-sm);"></i>
                        <p style="margin: 0; color: var(--color-text-secondary); font-weight: 500;">Adicionar Novo Número</p>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-muted);">Clique para adicionar outro número WhatsApp</p>
                    </div>
                    <div id="add-number-form" class="add-number-form" style="display: none;" onclick="event.stopPropagation()">
                        <div style="width: 100%; max-width: 400px;">
                            <div class="form-group">
                                <label class="form-label">Número WhatsApp</label>
                                <input type="tel" id="novo-numero" class="form-input" placeholder="(11) 99999-9999" maxlength="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nome para identificação</label>
                                <input type="text" id="nome-contato" class="form-input" placeholder="Ex: João - Comercial" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de número</label>
                                <select id="tipo-numero" class="form-input">
                                    <option value="pessoal">Pessoal</option>
                                    <option value="comercial">Comercial</option>
                                    <option value="suporte">Suporte</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                                <button type="button" class="btn btn-success" id="btn-add-numero" onclick="addNumber()">
                                    <i class="mdi mdi-plus"></i> Adicionar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddNumberForm()">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Empresas -->
            {% if user_data.empresas %}
            <div class="form-section">
                <h3 class="form-section-title">
                    <i class="mdi mdi-domain"></i>
                    Empresas Vinculadas
                </h3>
                <div class="companies-list">
                    {% for empresa in user_data.empresas %}
                    <div class="company-item">
                        <div class="company-name">
                            <i class="mdi mdi-office-building" style="margin-right: var(--spacing-xs);"></i>
                            {{ empresa.nome_cliente }}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: var(--spacing-xs);">
                            <i class="mdi mdi-file-document-outline"></i>
                            {% if empresa.total_cnpjs > 0 %}
                                {{ empresa.total_cnpjs }} CNPJ(s) vinculado(s)
                            {% else %}
                                Nenhum CNPJ vinculado
                            {% endif %}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: 2px;">
                            <i class="mdi mdi-calendar-check"></i>
                            Vinculado em {{ empresa.data_vinculo_formatada }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Resumo das empresas -->
                <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-background); border-radius: var(--radius-md); border-left: 3px solid var(--color-info);">
                    <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                        <i class="mdi mdi-information-outline" style="margin-right: var(--spacing-xs);"></i>
                        <strong>Resumo:</strong> 
                        Você tem acesso a {{ user_data.empresas|length }} empresa(s) no sistema.
                        {% set total_cnpjs = user_data.empresas | map(attribute='total_cnpjs') | sum %}
                        {% if total_cnpjs > 0 %}
                            Total de {{ total_cnpjs }} CNPJ(s) disponível(eis) para consultas e relatórios.
                        {% else %}
                            Configure os CNPJs nas empresas para liberar o acesso completo.
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ações -->
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                <button class="btn btn-danger" id="btn-cancelar-adesao" onclick="cancelSubscription()">
                    <i class="mdi mdi-cancel"></i>
                    Cancelar Adesão
                </button>
            </div>
        </div>

        {% else %}
        <!-- Configurar Agente -->
        <div class="agent-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="mdi mdi-robot-outline"></i>
                </div>
                <h2 class="card-title">Configurar Agente Unique</h2>
            </div>
            
            <form method="POST" action="{{ url_for('agente.index') }}">
                <div class="form-section">
                    <div class="form-group">
                        <label for="numero_whatsapp" class="form-label">
                            <i class="mdi mdi-phone"></i>
                            Número WhatsApp
                        </label>
                        <input type="tel" 
                               id="numero_whatsapp" 
                               name="numero_whatsapp" 
                               class="form-input" 
                               placeholder="(11) 99999-9999" 
                               required 
                               maxlength="20">
                        <div class="form-help">Digite o número com DDD, sem espaços ou símbolos</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nome_contato" class="form-label">
                            <i class="mdi mdi-account"></i>
                            Nome para identificação
                        </label>
                        <input type="text" 
                               id="nome_contato" 
                               name="nome_contato" 
                               class="form-input" 
                               placeholder="Ex: João - Comercial" 
                               required 
                               maxlength="50">
                        <div class="form-help">Nome para identificar este número</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_numero" class="form-label">
                            <i class="mdi mdi-tag"></i>
                            Tipo de número
                        </label>
                        <select id="tipo_numero" name="tipo_numero" class="form-input">
                            <option value="pessoal">Pessoal</option>
                            <option value="comercial">Comercial</option>
                            <option value="suporte">Suporte</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="terms-section">
                        <h3 class="terms-title">Termos de Uso</h3>
                        <div class="terms-text">
                            <p>Ao ativar o Agente Unique, você concorda que:</p>
                            <ul>
                                <li>O sistema poderá enviar mensagens via WhatsApp</li>
                                <li>Você é responsável pelo número informado</li>
                                <li>O serviço pode ser suspenso por uso inadequado</li>
                            </ul>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aceite_terms" name="aceite_terms" class="checkbox-input" required>
                            <label for="aceite_terms" class="checkbox-label">
                                Eu li e aceito os termos de uso
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" id="btn-ativar-agente">
                    <i class="mdi mdi-check"></i>
                    Ativar Agente Unique
                </button>
            </form>
        </div>
        {% endif %}
        
        <!-- Informações sobre o Agente -->
        <div class="agent-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-info-light); color: var(--color-info);">
                    <i class="mdi mdi-information"></i>
                </div>
                <h2 class="card-title">Como Funciona</h2>
            </div>
            
            <div style="display: grid; gap: var(--spacing-md);">
                <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
                    <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-primary);">
                        <i class="mdi mdi-chat"></i>
                        Consultas Inteligentes
                    </h4>
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        Faça perguntas sobre seus processos e receba respostas detalhadas na hora.
                    </p>
                </div>
                
                <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--radius-md); border-left: 3px solid var(--color-warning);">
                    <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-warning);">
                        <i class="mdi mdi-security"></i>
                        Seguro e Privado
                    </h4>
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        Todas as informações são transmitidas de forma segura e você pode desativar a qualquer momento.
                    </p>
                </div>
            </div>
        </div>
        
        {% if session.user.role == 'admin' %}
        <!-- Link para área administrativa -->
        <div class="agent-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-purple-light); color: var(--color-purple);">
                    <i class="mdi mdi-shield-crown"></i>
                </div>
                <h2 class="card-title">Área Administrativa</h2>
            </div>
            
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                Como administrador, você pode visualizar e gerenciar todos os agentes cadastrados no sistema.
            </p>
            
            <a href="{{ url_for('agente.admin') }}" class="btn btn-primary">
                <i class="mdi mdi-cog"></i>
                Gerenciar Agentes
            </a>
        </div>
        {% endif %}
    </div>
    
    {% endif %}
    
    <!-- Mensagens Flash (serão convertidas para toasts) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}" style="display: none;">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Modal de Detalhes do Usuário -->
    <div id="user-details-modal" class="user-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-account-details"></i>
                    Detalhes do Usuário
                </h3>
                <button class="modal-close" onclick="closeUserDetailsModal()">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            
            <div class="modal-body" id="modal-body-content">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('agente.static', filename='js/agente.js') }}"></script>
{% endblock %}

