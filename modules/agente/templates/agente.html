{% extends "base.html" %}

{% block title %}Agente Unique - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('agente.static', filename='css/agente.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            {{ breadcrumb([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Ferramentas', 'icon': 'mdi mdi-tools', 'url': url_for('menu.ferramentas')},
                {'name': 'Agente Unique', 'icon': 'mdi mdi-robot'}
            ]) }}
        </div>
        <div class="actions-right">
            <!-- Botões de ação podem ser adicionados aqui se necessário -->
        </div>
    </div>

    <div class="main-content agent-grid">
        {% if user_data and user_data.usuario_ativo %}
        <!-- Grid: Agente Configurado | Como Funciona -->
        <div class="agent-card agent-main-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="mdi mdi-robot"></i>
                </div>
                <h2 class="card-title">Agente Configurado</h2>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Números do WhatsApp</div>
                    <div class="info-value">
                        <ul id="numeros-list" style="list-style:none; padding:0; margin:0;">
                            {% for numero in user_data.numero %}
                            <li style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                <span>{{ numero }}</span>
                                <button class="btn btn-danger btn-sm btn-remove-numero" data-numero="{{ numero }}" title="Remover número">
                                    <i class="mdi mdi-delete"></i>
                                </button>
                            </li>
                            {% endfor %}
                        </ul>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <input type="text" id="novo-numero" class="form-input" placeholder="Ex: 5511999999999">
                            <button class="btn btn-success" id="btn-add-numero">
                                <i class="mdi mdi-plus"></i> Adicionar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge status-active">
                            <span class="status-dot"></span>
                            Ativo
                        </span>
                    </div>
                </div>
                {% if user_data.empresa %}
                <div class="info-item">
                    <div class="info-label">Empresas Associadas</div>
                    <div class="info-value">
                        <ul style="margin:0; padding:0; list-style:none;">
                        {% for empresa in user_data.empresa %}
                            <li style="margin-bottom:4px;">
                                <span style="font-weight:600;">{{ empresa.cnpj if empresa.cnpj else empresa }}</span>
                                {% if empresa.razao_social %}<span style="color:var(--color-text-secondary);"> - {{ empresa.razao_social }}</span>{% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
            <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md);">
                <button class="btn btn-danger" id="btn-cancelar-adesao">
                    <i class="mdi mdi-stop"></i> Cancelar Adesão
                </button>
            </div>
        </div>
        <!-- O card 'Como Funciona' já está presente no layout horizontal acima -->
{% block extra_js %}
<script>
// Adicionar número via AJAX
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('btn-add-numero');
    const input = document.getElementById('novo-numero');
    if (addBtn && input) {
        addBtn.onclick = function(e) {
            e.preventDefault();
            const numero = input.value.trim();
            if (!numero) return;
            fetch("{{ url_for('agente.ajax_add_numero') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({numero})
            })
            .then(r => r.json())
            .then(data => { window.location.reload(); })
            .catch(() => alert('Erro ao adicionar número.'));
        };
    }
    // Remover número via AJAX
    document.querySelectorAll('.btn-remove-numero').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            const numero = this.dataset.numero;
            if (!numero) return;
            if (!confirm('Remover este número?')) return;
            fetch("{{ url_for('agente.ajax_remove_numero') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({numero})
            })
            .then(r => r.json())
            .then(data => { window.location.reload(); })
            .catch(() => alert('Erro ao remover número.'));
        };
    });
    // Cancelar adesão via AJAX
    const cancelarBtn = document.getElementById('btn-cancelar-adesao');
    if (cancelarBtn) {
        cancelarBtn.onclick = function(e) {
            e.preventDefault();
            if (!confirm('Tem certeza que deseja cancelar a adesão?')) return;
            fetch("{{ url_for('agente.ajax_cancelar_adesao') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            })
            .then(r => r.json())
            .then(data => { window.location.reload(); })
            .catch(() => alert('Erro ao cancelar adesão.'));
        };
    }
});
</script>
{% endblock %}
        {% else %}
            <!-- Configurar Agente -->
            <div class="agent-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="mdi mdi-robot-outline"></i>
                    </div>
                    <h2 class="card-title">Configurar Agente</h2>
                </div>
                
                <form method="POST" action="{{ url_for('agente.cadastrar') }}">
                    <div class="form-group">
                        <label for="numero_whatsapp" class="form-label">
                            <i class="mdi mdi-whatsapp"></i>
                            Número do WhatsApp
                        </label>
                        <input type="text" 
                               id="numero_whatsapp" 
                               name="numero_whatsapp" 
                               class="form-input" 
                               placeholder="Ex: 5511999999999" 
                               value="{{ user_data.numero if user_data else '' }}"
                               required>
                        <div class="form-help">
                            Digite seu número completo com código do país (55) e DDD
                        </div>
                    </div>
                    
                    <div class="terms-section">
                        <h3 class="terms-title">
                            <i class="mdi mdi-file-document"></i>
                            Termos de Uso
                        </h3>
                        <p class="terms-text">
                            Ao ativar o Agente Unique, você concorda que poderemos enviar mensagens 
                            automatizadas para o número informado com informações sobre seus processos 
                            de importação. Você pode desativar o serviço a qualquer momento.
                        </p>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" 
                                   id="aceite_terms" 
                                   name="aceite_terms" 
                                   class="checkbox-input"
                                   {% if user_data and user_data.aceite_termos %}checked{% endif %}
                                   required>
                            <label for="aceite_terms" class="checkbox-label">
                                Eu aceito os termos de uso do Agente Unique
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="mdi mdi-check"></i>
                        Ativar Agente
                    </button>
                </form>
            </div>
        {% endif %}
        
        <!-- Informações sobre o Agente -->
        <div class="agent-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-info-light); color: var(--color-info);">
                    <i class="mdi mdi-information"></i>
                </div>
                <h2 class="card-title">Como Funciona</h2>
            </div>
            
            <div style="display: grid; gap: var(--spacing-md);">
               
                <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
                    <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-primary);">
                        <i class="mdi mdi-chat"></i>
                        Consultas Inteligentes
                    </h4>
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        Faça perguntas sobre seus processos e receba respostas detalhadas na hora.
                    </p>
                </div>
                
                <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--radius-md); border-left: 3px solid var(--color-warning);">
                    <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-warning);">
                        <i class="mdi mdi-security"></i>
                        Seguro e Privado
                    </h4>
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        Todas as informações são transmitidas de forma segura e você pode desativar a qualquer momento.
                    </p>
                </div>
            </div>
        </div>
        
        {% if session.user.role == 'admin' %}
        <!-- Link para área administrativa -->
        <div class="agent-card">
            <div class="card-header">
                <div class="card-icon" style="background: var(--color-purple-light); color: var(--color-purple);">
                    <i class="mdi mdi-shield-crown"></i>
                </div>
                <h2 class="card-title">Área Administrativa</h2>
            </div>
            
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                Como administrador, você pode visualizar e gerenciar todos os agentes cadastrados no sistema.
            </p>
            
            <a href="{{ url_for('agente.admin') }}" class="btn btn-primary">
                <i class="mdi mdi-cog"></i>
                Gerenciar Agentes
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

