{% extends "base.html" %}

{% block title %}Gestão de Cargos - RH{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='rh/css/rh-theme.css') }}?v=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='rh/colaboradores/colaboradores.css') }}?v=2.4">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='rh/css/rh-tables.css') }}?v=3.6">
{% endblock %}

{% block content %}
<div class="rh-container">
    <!-- Actions Bar -->
    <div class="actions-bar module-header-rh">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/" style="color: #6f42c1;"><i class="mdi mdi-home-outline"></i> Início</a></li>
                <li class="breadcrumb-item"><a href="#" style="color: #6f42c1;">RH</a></li>
                <li class="breadcrumb-item active">Gestão de Cargos</li>
            </ol>
        </nav>
        <div class="actions-buttons">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCargo" onclick="abrirModalNovo()">
                <i class="mdi mdi-plus"></i> Novo Cargo
            </button>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="kpi-section">
        <div class="kpi-group">
            <h5 class="kpi-group-title">
                <i class="mdi mdi-chart-box-outline"></i>
                Resumo Geral
            </h5>
            <div class="kpi-grid-rh">
                <div class="kpi-card kpi-success">
                    <div class="kpi-icon">
                        <i class="mdi mdi-briefcase"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Total de Cargos</p>
                        <p class="kpi-value">{{ total_cargos }}</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-danger">
                    <div class="kpi-icon">
                        <i class="mdi mdi-sitemap"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Grupos Distintos</p>
                        <p class="kpi-value">{{ total_grupos }}</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-primary">
                    <div class="kpi-icon">
                        <i class="mdi mdi-check-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Sistema</p>
                        <p class="kpi-value">{{ total_cargos + total_grupos }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Busca e Filtros -->
    <div class="card rh-card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="mdi mdi-magnify text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0" 
                               placeholder="Buscar por nome ou grupo...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filterGrupo" class="form-select">
                        <option value="">Todos os Grupos</option>
                        {% for grupo in grupos %}
                        <option value="{{ grupo }}">{{ grupo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                        <i class="mdi mdi-eraser"></i> Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Cargos -->
    <div class="card rh-card">
        <div class="card-body p-0">
            {% if cargos|length > 0 %}
            <div class="table-responsive">
                <table class="table mb-0 rh-table" id="tableCargos">
                    <thead class="rh-table-header">
                        <tr>
                            <th style="width: 3%;">#</th>
                            <th style="width: 22%;">Nome do Cargo</th>
                            <th style="width: 12%;">Grupo</th>
                            <th style="width: 48%;">Descrição</th>
                            <th style="width: 15%;" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cargo in cargos %}
                        <tr data-nome="{{ cargo.nome_cargo }}" data-grupo="{{ cargo.grupo_cargo or 'Sem Grupo' }}">
                            <td class="text-muted small">{{ loop.index }}</td>
                            <td>
                                <strong class="text-dark">{{ cargo.nome_cargo }}</strong>
                            </td>
                            <td>
                                {% if cargo.grupo_cargo %}
                                <span class="badge badge-grupo {{ cargo.grupo_cargo.lower() }}">
                                    {{ cargo.grupo_cargo }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cargo.descricao %}
                                <span class="text-muted" style="font-size: 0.875rem; line-height: 1.4;">
                                    {{ cargo.descricao[:120] }}{% if cargo.descricao|length > 120 %}...{% endif %}
                                </span>
                                {% else %}
                                <span class="text-muted">Sem descrição</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- Botão Visualizar -->
                                    <button class="btn btn-outline-info" 
                                            onclick="visualizarCargo('{{ cargo.id }}')" 
                                            data-bs-toggle="tooltip"
                                            title="Visualizar detalhes">
                                        <i class="mdi mdi-eye"></i>
                                    </button>
                                    
                                    <!-- Botão Editar -->
                                    <button class="btn btn-outline-primary" 
                                            onclick="editarCargo('{{ cargo.id }}')" 
                                            data-bs-toggle="tooltip"
                                            title="Editar">
                                        <i class="mdi mdi-pencil"></i>
                                    </button>
                                    
                                    <!-- Botão Excluir -->
                                    <button class="btn btn-outline-danger" 
                                            onclick="confirmarExclusao('{{ cargo.id }}', '{{ cargo.nome_cargo }}')" 
                                            data-bs-toggle="tooltip"
                                            title="Excluir">
                                        <i class="mdi mdi-delete"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="mdi mdi-briefcase-outline" style="font-size: 4rem; color: #6f42c1; opacity: 0.3;"></i>
                <h5>Nenhum cargo cadastrado</h5>
                <p>Clique em "Novo Cargo" para adicionar o primeiro cargo</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal: Adicionar/Editar Cargo -->
<div class="modal fade" id="modalCargo" tabindex="-1" aria-labelledby="modalCargoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header module-header-rh">
                <h5 class="modal-title text-white" id="modalCargoLabel">
                    <i class="mdi mdi-briefcase"></i> <span id="modalTitle">Novo Cargo</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCargo">
                    <input type="hidden" id="cargo_id" name="cargo_id">
                    
                    <div class="row g-3">
                        <!-- Nome do Cargo -->
                        <div class="col-md-8">
                            <label for="nome" class="form-label">
                                <i class="mdi mdi-briefcase"></i> Nome do Cargo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   placeholder="Ex: Analista de Importação Pleno" required>
                        </div>
                        
                        <!-- Grupo -->
                        <div class="col-md-4">
                            <label for="grupo" class="form-label">
                                <i class="mdi mdi-sitemap"></i> Grupo
                            </label>
                            <select class="form-select" id="grupo" name="grupo">
                                <option value="">Selecione...</option>
                                <option value="Operacional">Operacional</option>
                                <option value="Liderança">Liderança</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Estratégico">Estratégico</option>
                            </select>
                        </div>
                        
                        <!-- Descrição -->
                        <div class="col-12">
                            <label for="descricao" class="form-label">
                                <i class="mdi mdi-text"></i> Descrição
                            </label>
                            <textarea class="form-control" id="descricao" name="descricao" 
                                      rows="4" placeholder="Responsabilidades e requisitos do cargo..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close"></i> Cancelar
                </button>
                <button type="button" class="btn btn-rh-primary" onclick="salvarCargo()">
                    <i class="mdi mdi-content-save"></i> Salvar Cargo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Exclusão -->
<div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalExcluirLabel">
                    <i class="mdi mdi-alert"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Você tem certeza que deseja excluir o cargo:</p>
                <p class="text-center">
                    <strong id="cargoNomeExcluir"></strong>
                </p>
                <div class="alert alert-warning">
                    <i class="mdi mdi-information-outline"></i>
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita. O cargo só será excluído se não estiver associado a nenhum colaborador ou histórico.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                    <i class="mdi mdi-delete"></i> Sim, Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('estrutura_org.static', filename='estrutura_org/estrutura.js') }}?v=3"></script>
<script>
// Inicializar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Busca em tempo real
document.getElementById('searchInput').addEventListener('keyup', filtrarTabela);
document.getElementById('filterGrupo').addEventListener('change', filtrarTabela);

function filtrarTabela() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const grupoValue = document.getElementById('filterGrupo').value.toLowerCase();
    const rows = document.querySelectorAll('#tableCargos tbody tr');
    
    rows.forEach(row => {
        const nome = row.dataset.nome.toLowerCase();
        const grupo = row.dataset.grupo.toLowerCase();
        
        const matchSearch = nome.includes(searchValue) || grupo.includes(searchValue);
        const matchGrupo = grupoValue === '' || grupo === grupoValue;
        
        if (matchSearch && matchGrupo) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function limparFiltros() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterGrupo').value = '';
    filtrarTabela();
}

// Função para visualizar detalhes do cargo
function visualizarCargo(cargoId) {
    // Buscar dados do cargo na API
    fetch(`/rh/estrutura/api/cargos/${cargoId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const cargo = data.cargo;
            
            // Criar modal de visualização
            const modalHtml = `
                <div class="modal fade" id="modalVisualizarCargo" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header module-header-rh">
                                <h5 class="modal-title text-white">
                                    <i class="mdi mdi-eye"></i> Detalhes do Cargo
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-4">
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold text-muted">
                                            <i class="mdi mdi-briefcase"></i> Nome do Cargo
                                        </label>
                                        <p class="fs-5 text-dark">${cargo.nome_cargo}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-muted">
                                            <i class="mdi mdi-sitemap"></i> Grupo
                                        </label>
                                        <p>
                                            ${cargo.grupo_cargo ? 
                                                `<span class="badge badge-grupo ${cargo.grupo_cargo.toLowerCase()}" style="font-size: 1rem; padding: 0.5rem 1rem;">${cargo.grupo_cargo}</span>` 
                                                : '<span class="text-muted">Não definido</span>'}
                                        </p>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold text-muted">
                                            <i class="mdi mdi-text"></i> Descrição
                                        </label>
                                        <div class="p-3 bg-light rounded">
                                            ${cargo.descricao ? 
                                                `<p class="mb-0" style="white-space: pre-wrap; line-height: 1.6;">${cargo.descricao}</p>` 
                                                : '<p class="text-muted mb-0">Sem descrição cadastrada</p>'}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-muted">
                                            <i class="mdi mdi-calendar-plus"></i> Criado em
                                        </label>
                                        <p>${cargo.criado_em ? new Date(cargo.criado_em).toLocaleString('pt-BR') : '-'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-muted">
                                            <i class="mdi mdi-calendar-edit"></i> Atualizado em
                                        </label>
                                        <p>${cargo.atualizado_em ? new Date(cargo.atualizado_em).toLocaleString('pt-BR') : '-'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="mdi mdi-close"></i> Fechar
                                </button>
                                <button type="button" class="btn btn-rh-primary" onclick="editarCargo('${cargo.id}'); $('#modalVisualizarCargo').modal('hide');">
                                    <i class="mdi mdi-pencil"></i> Editar Cargo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal antigo se existir
            const oldModal = document.getElementById('modalVisualizarCargo');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Adicionar novo modal ao body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalVisualizarCargo'));
            modal.show();
            
            // Remover modal do DOM quando fechado
            document.getElementById('modalVisualizarCargo').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        } else {
            alert('Erro ao carregar dados do cargo: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar dados do cargo');
    });
}
</script>
{% endblock %}
