{% extends "base.html" %}

{% block title %}
    {% if modo == 'novo' %}Novo Colaborador{% else %}Editar Colaborador{% endif %} - RH
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='rh/colaboradores/colaboradores.css') }}?v=2.2">
{% endblock %}

{% block content %}
<div class="rh-container">
    <!-- Actions Bar com Breadcrumb -->
    <div class="actions-bar module-header-rh">
        <div class="actions-left">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('colaboradores.lista_colaboradores') }}">RH</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('colaboradores.lista_colaboradores') }}">Colaboradores</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{% if modo == 'novo' %}Novo{% else %}Editar{% endif %}</li>
                </ol>
            </nav>
        </div>
        <div class="actions-right">
            <a href="{{ url_for('colaboradores.lista_colaboradores') }}" class="btn btn-outline-secondary">
                <i class="mdi mdi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Formul√°rio -->
    <form id="formColaborador">
        <!-- üî• Campo hidden para vincular ao candidato -->
        {% if candidato_id %}
        <input type="hidden" name="candidato_id" value="{{ candidato_id }}">
        
        <!-- Alert informando que est√° efetivando um candidato -->
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="mdi mdi-information-outline me-2" style="font-size: 1.5rem;"></i>
            <div>
                <strong>Efetivando Candidato como Colaborador</strong><br>
                <small>Os dados abaixo foram pr√©-preenchidos com as informa√ß√µes do candidato <strong>{{ candidato.nome_completo if candidato else '' }}</strong>. Revise e complete as informa√ß√µes necess√°rias.</small>
            </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Dados Pessoais -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-account"></i> Dados Pessoais</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Nome Completo</label>
                            <input type="text" class="form-control" id="nome_completo" name="nome_completo" 
                                   value="{{ candidato.nome_completo if candidato else (colaborador.nome_completo if colaborador else '') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" 
                                   value="{{ colaborador.cpf if colaborador else '' }}" 
                                   placeholder="000.000.000-00" 
                                   maxlength="14"
                                   pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                                   required
                                   {% if colaborador %}readonly{% endif %}>
                            <small class="text-muted">Formato: 000.000.000-00</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label required">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento"
                                   value="{{ candidato.data_nascimento if candidato else (colaborador.data_nascimento if colaborador else '') }}" 
                                   max="{{ hoje }}"
                                   required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">G√™nero</label>
                            <select class="form-select" id="genero" name="genero">
                                <option value="">Selecione...</option>
                                <option value="MASCULINO" {% if (candidato and candidato.sexo == 'Masculino') or (colaborador and colaborador.genero == 'MASCULINO') %}selected{% endif %}>Masculino</option>
                                <option value="FEMININO" {% if (candidato and candidato.sexo == 'Feminino') or (colaborador and colaborador.genero == 'FEMININO') %}selected{% endif %}>Feminino</option>
                                <option value="N√ÉO-BIN√ÅRIO" {% if colaborador and colaborador.genero == 'N√ÉO-BIN√ÅRIO' %}selected{% endif %}>N√£o-bin√°rio</option>
                                <option value="PREFIRO N√ÉO INFORMAR" {% if colaborador and colaborador.genero == 'PREFIRO N√ÉO INFORMAR' %}selected{% endif %}>Prefiro n√£o informar</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Escolaridade</label>
                            <select class="form-select" id="escolaridade" name="escolaridade">
                                <option value="">Selecione...</option>
                                <option value="Ensino Fundamental Incompleto" {% if colaborador and colaborador.escolaridade == 'Ensino Fundamental Incompleto' %}selected{% endif %}>Ensino Fundamental Incompleto</option>
                                <option value="Ensino Fundamental Completo" {% if colaborador and colaborador.escolaridade == 'Ensino Fundamental Completo' %}selected{% endif %}>Ensino Fundamental Completo</option>
                                <option value="Ensino M√©dio Incompleto" {% if colaborador and colaborador.escolaridade == 'Ensino M√©dio Incompleto' %}selected{% endif %}>Ensino M√©dio Incompleto</option>
                                <option value="Ensino M√©dio Completo" {% if colaborador and colaborador.escolaridade == 'Ensino M√©dio Completo' %}selected{% endif %}>Ensino M√©dio Completo</option>
                                <option value="Superior Incompleto" {% if colaborador and colaborador.escolaridade == 'Superior Incompleto' %}selected{% endif %}>Superior Incompleto</option>
                                <option value="Superior Completo" {% if colaborador and colaborador.escolaridade == 'Superior Completo' %}selected{% endif %}>Superior Completo</option>
                                <option value="P√≥s-gradua√ß√£o" {% if colaborador and colaborador.escolaridade == 'P√≥s-gradua√ß√£o' %}selected{% endif %}>P√≥s-gradua√ß√£o</option>
                                <option value="Mestrado" {% if colaborador and colaborador.escolaridade == 'Mestrado' %}selected{% endif %}>Mestrado</option>
                                <option value="Doutorado" {% if colaborador and colaborador.escolaridade == 'Doutorado' %}selected{% endif %}>Doutorado</option>
                            </select>
                        </div>
                    </div>                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ra√ßa/Cor</label>
                            <select class="form-select" id="raca_cor" name="raca_cor">
                                <option value="">Selecione...</option>
                                <option value="Branca" {% if colaborador and colaborador.raca_cor == 'Branca' %}selected{% endif %}>Branca</option>
                                <option value="Preta" {% if colaborador and colaborador.raca_cor == 'Preta' %}selected{% endif %}>Preta</option>
                                <option value="Parda" {% if colaborador and colaborador.raca_cor == 'Parda' %}selected{% endif %}>Parda</option>
                                <option value="Amarela" {% if colaborador and colaborador.raca_cor == 'Amarela' %}selected{% endif %}>Amarela</option>
                                <option value="Ind√≠gena" {% if colaborador and colaborador.raca_cor == 'Ind√≠gena' %}selected{% endif %}>Ind√≠gena</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nacionalidade</label>
                            <input type="text" class="form-control" id="nacionalidade" name="nacionalidade"
                                   value="{{ colaborador.nacionalidade if colaborador else 'Brasileira' }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Documenta√ß√£o -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-card-account-details"></i> Documenta√ß√£o</h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">PIS/PASEP</label>
                            <input type="text" class="form-control" id="pis_pasep" name="pis_pasep"
                                   value="{{ colaborador.pis_pasep if colaborador else '' }}"
                                   maxlength="20"
                                   placeholder="000.00000.00-0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CTPS N√∫mero</label>
                            <input type="text" class="form-control" id="ctps_numero" name="ctps_numero"
                                   value="{{ colaborador.ctps_numero if colaborador else '' }}"
                                   maxlength="20">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CTPS S√©rie</label>
                            <input type="text" class="form-control" id="ctps_serie" name="ctps_serie"
                                   value="{{ colaborador.ctps_serie if colaborador else '' }}"
                                   maxlength="20">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">CNH N√∫mero</label>
                            <input type="text" class="form-control" id="cnh_numero" name="cnh_numero"
                                   value="{{ colaborador.cnh_numero if colaborador else '' }}"
                                   maxlength="20"
                                   placeholder="N√∫mero da CNH">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Contato -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-phone"></i> Contato</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone Celular</label>
                            <input type="text" class="form-control" id="telefone_celular" name="telefone_celular"
                                   value="{{ colaborador.telefones_jsonb.celular if colaborador and colaborador.telefones_jsonb else (candidato.telefone if candidato else '') }}"
                                   placeholder="(41) 99999-9999"
                                   maxlength="15">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone Fixo</label>
                            <input type="text" class="form-control" id="telefone_fixo" name="telefone_fixo"
                                   value="{{ colaborador.telefones_jsonb.fixo if colaborador and colaborador.telefones_jsonb else '' }}"
                                   placeholder="(41) 3333-4444"
                                   maxlength="14">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Endere√ßo -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-map-marker"></i> Endere√ßo</h5>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="endereco_cep" name="endereco_cep"
                                   value="{{ colaborador.endereco_jsonb.cep if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="00000-000"
                                   maxlength="9">
                        </div>
                        <div class="col-md-7 mb-3">
                            <label class="form-label">Rua/Avenida</label>
                            <input type="text" class="form-control" id="endereco_rua" name="endereco_rua"
                                   value="{{ colaborador.endereco_jsonb.rua if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="Nome da rua">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">N√∫mero</label>
                            <input type="text" class="form-control" id="endereco_numero" name="endereco_numero"
                                   value="{{ colaborador.endereco_jsonb.numero if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="123">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="endereco_complemento" name="endereco_complemento"
                                   value="{{ colaborador.endereco_jsonb.complemento if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="Apto, Bloco, etc.">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="endereco_bairro" name="endereco_bairro"
                                   value="{{ colaborador.endereco_jsonb.bairro if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="Nome do bairro">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="endereco_cidade" name="endereco_cidade"
                                   value="{{ colaborador.endereco_jsonb.cidade if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="Nome da cidade">
                        </div>
                        <div class="col-md-1 mb-3">
                            <label class="form-label">UF</label>
                            <input type="text" class="form-control text-uppercase" id="endereco_estado" name="endereco_estado"
                                   value="{{ colaborador.endereco_jsonb.estado if colaborador and colaborador.endereco_jsonb else '' }}"
                                   placeholder="PR"
                                   maxlength="2">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Dados Corporativos -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-briefcase"></i> Dados Corporativos</h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Matr√≠cula</label>
                            <input type="text" class="form-control bg-light" id="matricula" name="matricula"
                                   value="{{ colaborador.matricula if colaborador else '' }}"
                                   readonly
                                   placeholder="Gerado automaticamente">
                            <small class="text-muted">Ser√° gerado automaticamente (ex: UN001, UN002...)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Email Corporativo</label>
                            <input type="email" class="form-control" id="email_corporativo" name="email_corporativo"
                                   value="{{ candidato.email if candidato else (colaborador.email_corporativo if colaborador else '') }}"
                                   placeholder="nome@unique.com.br">
                            <small class="text-muted">Digite um email v√°lido</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required">Data de Admiss√£o</label>
                            <input type="date" class="form-control" id="data_admissao" name="data_admissao"
                                   value="{{ colaborador.data_admissao if colaborador else '' }}" 
                                   max="{{ hoje }}"
                                   required
                                   {% if colaborador %}readonly{% endif %}>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cargo</label>
                            <select class="form-select" id="cargo_id" name="cargo_id">
                                <option value="">Selecione...</option>
                                {% for cargo in cargos %}
                                <option value="{{ cargo.id }}" 
                                    {% if ultimo_historico and ultimo_historico.cargo_id == cargo.id %}selected{% endif %}>
                                    {{ cargo.nome_cargo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Departamento</label>
                            <select class="form-select" id="departamento_id" name="departamento_id">
                                <option value="">Selecione...</option>
                                {% for depto in departamentos %}
                                <option value="{{ depto.id }}"
                                    {% if ultimo_historico and ultimo_historico.departamento_id == depto.id %}selected{% endif %}>
                                    {{ depto.nome_departamento }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Gestor</label>
                            <select class="form-select" id="gestor_id" name="gestor_id">
                                <option value="">Selecione...</option>
                                {% for gestor in gestores %}
                                <option value="{{ gestor.id }}"
                                    {% if ultimo_historico and ultimo_historico.gestor_id == gestor.id %}selected{% endif %}>
                                    {{ gestor.nome_completo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Sal√°rio Mensal</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="salario_mensal" name="salario_mensal" 
                                       step="0.01" 
                                       min="0"
                                       max="999999.99"
                                       value="{{ ultimo_historico.salario_mensal if ultimo_historico else '' }}"
                                       placeholder="0.00">
                            </div>
                            <small class="text-muted">Apenas n√∫meros</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Contrato</label>
                            <select class="form-select" id="tipo_contrato" name="tipo_contrato">
                                <option value="">Selecione...</option>
                                <option value="CLT" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'CLT' %}selected{% endif %}>CLT</option>
                                <option value="PJ" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'PJ' %}selected{% endif %}>PJ</option>
                                <option value="Est√°gio" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'Est√°gio' %}selected{% endif %}>Est√°gio</option>
                                <option value="Tempor√°rio" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'Tempor√°rio' %}selected{% endif %}>Tempor√°rio</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Modelo de Trabalho</label>
                            <select class="form-select" id="modelo_trabalho" name="modelo_trabalho">
                                <option value="">Selecione...</option>
                                <option value="Presencial" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'Presencial' %}selected{% endif %}>Presencial</option>
                                <option value="Remoto" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'Remoto' %}selected{% endif %}>Remoto</option>
                                <option value="H√≠brido" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'H√≠brido' %}selected{% endif %}>H√≠brido</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                      placeholder="Observa√ß√µes sobre esta altera√ß√£o..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="rh-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('colaboradores.lista_colaboradores') }}" class="btn btn-outline-secondary">
                        <i class="mdi mdi-close"></i> Cancelar
                    </a>
                    <button type="button" class="btn btn-primary" id="btnSalvar" onclick="salvarColaborador()">
                        <i class="mdi mdi-content-save"></i> Salvar Colaborador
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('colaboradores.static', filename='colaboradores/colaboradores.js') }}"></script>
<script>
// ===================================================================
// FUN√á√ÉO GLOBAL DE SALVAMENTO
// ===================================================================

// Declarar fun√ß√£o globalmente para que onclick possa acess√°-la
window.salvarColaborador = async function() {
    console.log('üöÄ salvarColaborador() chamada!');
    
    const form = document.getElementById('formColaborador');
    const btnSalvar = document.getElementById('btnSalvar');
    console.log('üìã Form:', form);
    console.log('üìç Bot√£o:', btnSalvar);
    
    if (!form) {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
        return;
    }
    
    const textoOriginal = btnSalvar.innerHTML;
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Salvando...';
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    console.log('üì¶ Dados coletados:', data);
    
    // üî• Converter campos de telefone em JSON
    const telefones = {};
    if (document.getElementById('telefone_celular')?.value) {
        telefones.celular = document.getElementById('telefone_celular').value;
    }
    if (document.getElementById('telefone_fixo')?.value) {
        telefones.fixo = document.getElementById('telefone_fixo').value;
    }
    if (Object.keys(telefones).length > 0) {
        data.telefones_jsonb = telefones;
    }
    
    // üî• Converter campos de endere√ßo em JSON
    const endereco = {};
    if (document.getElementById('endereco_cep')?.value) endereco.cep = document.getElementById('endereco_cep').value;
    if (document.getElementById('endereco_rua')?.value) endereco.rua = document.getElementById('endereco_rua').value;
    if (document.getElementById('endereco_numero')?.value) endereco.numero = document.getElementById('endereco_numero').value;
    if (document.getElementById('endereco_complemento')?.value) endereco.complemento = document.getElementById('endereco_complemento').value;
    if (document.getElementById('endereco_bairro')?.value) endereco.bairro = document.getElementById('endereco_bairro').value;
    if (document.getElementById('endereco_cidade')?.value) endereco.cidade = document.getElementById('endereco_cidade').value;
    if (document.getElementById('endereco_estado')?.value) endereco.estado = document.getElementById('endereco_estado').value.toUpperCase();
    if (Object.keys(endereco).length > 0) {
        data.endereco_jsonb = endereco;
    }
    
    // Remover campos individuais
    delete data.telefone_celular;
    delete data.telefone_fixo;
    delete data.endereco_cep;
    delete data.endereco_rua;
    delete data.endereco_numero;
    delete data.endereco_complemento;
    delete data.endereco_bairro;
    delete data.endereco_cidade;
    delete data.endereco_estado;
    
    try {
        const modo = '{{ modo }}';
        const url = modo === 'novo' 
            ? '/rh/colaboradores/api/colaboradores'
            : '/rh/colaboradores/api/colaboradores/{{ colaborador.id if colaborador else "" }}';
        
        const method = modo === 'novo' ? 'POST' : 'PUT';
        
        console.log('üéØ Enviando para:', url);
        console.log('üì° M√©todo:', method);
        console.log('üìÑ Payload:', JSON.stringify(data, null, 2));
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        console.log('‚úÖ Response status:', response.status);
        const result = await response.json();
        console.log('üì• Result:', result);
        
        if (response.ok && result.success) {
            mostrarAlerta('Colaborador salvo com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("colaboradores.lista_colaboradores") }}';
            }, 1500);
        } else {
            throw new Error(result.error || 'Erro ao salvar colaborador');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarAlerta(`Erro ao salvar: ${error.message}`, 'danger');
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
    }
};

// ===================================================================
// M√ÅSCARAS E VALIDA√á√ïES
// ===================================================================

// M√°scara de CPF
document.getElementById('cpf')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
    }
});

// M√°scara de PIS/PASEP
document.getElementById('pis_pasep')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{5})(\d)/, '$1.$2');
        value = value.replace(/(\d{2})(\d{1})$/, '$1-$2');
        e.target.value = value;
    }
});

// Apenas n√∫meros para CNH
document.getElementById('cnh_numero')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 11);
});

// Valida√ß√£o de email em tempo real
document.getElementById('email_corporativo')?.addEventListener('blur', function(e) {
    const email = e.target.value;
    if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        e.target.classList.add('is-invalid');
        if (!e.target.nextElementSibling?.classList.contains('invalid-feedback')) {
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = 'Digite um email v√°lido';
            e.target.parentNode.appendChild(feedback);
        }
    } else {
        e.target.classList.remove('is-invalid');
        e.target.nextElementSibling?.remove();
    }
});

// ===================================================================
// GERA√á√ÉO AUTOM√ÅTICA DE MATR√çCULA
// ===================================================================

async function gerarProximaMatricula() {
    const modo = '{{ modo }}';
    const matriculaInput = document.getElementById('matricula');
    
    // Se estiver editando, n√£o gera nova matr√≠cula
    if (modo !== 'novo' || matriculaInput.value) {
        return;
    }
    
    try {
        console.log('[RH] Gerando pr√≥xima matr√≠cula...');
        
        // Buscar √∫ltima matr√≠cula via API
        const response = await fetch('/rh/colaboradores/api/colaboradores');
        const data = await response.json();
        
        if (data.success && data.data) {
            // Filtrar apenas matr√≠culas que come√ßam com UN
            const matriculas = data.data
                .map(c => c.matricula)
                .filter(m => m && m.startsWith('UN'))
                .map(m => parseInt(m.replace('UN', '')))
                .filter(n => !isNaN(n));
            
            // Pegar o maior n√∫mero
            const maiorNumero = matriculas.length > 0 ? Math.max(...matriculas) : 0;
            const proximoNumero = maiorNumero + 1;
            
            // Formatar com zeros √† esquerda (UN001, UN002, etc)
            const novaMatricula = 'UN' + String(proximoNumero).padStart(3, '0');
            
            matriculaInput.value = novaMatricula;
            console.log(`[RH] Matr√≠cula gerada: ${novaMatricula}`);
        }
    } catch (error) {
        console.error('[RH] Erro ao gerar matr√≠cula:', error);
        // Em caso de erro, gera uma matr√≠cula padr√£o
        matriculaInput.value = 'UN001';
    }
}

// Gerar matr√≠cula quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß DOM carregado, inicializando form...');
    gerarProximaMatricula();
});

</script>
{% endblock %}
    console.log('ÔøΩ salvarColaborador() chamada!');
    
    const form = document.getElementById('formColaborador');
    const btnSalvar = document.getElementById('btnSalvar');
    console.log('ÔøΩ Form:', form);
    console.log('üìç Bot√£o:', btnSalvar);
    
    if (!form) {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
        return;
    }
    
    const textoOriginal = btnSalvar.innerHTML;
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Salvando...';
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    console.log('üì¶ Dados coletados:', data);    // üî• Converter campos de telefone em JSON
    const telefones = {};
    if (document.getElementById('telefone_celular')?.value) {
        telefones.celular = document.getElementById('telefone_celular').value;
    }
    if (document.getElementById('telefone_fixo')?.value) {
        telefones.fixo = document.getElementById('telefone_fixo').value;
    }
    // S√≥ adicionar se tiver pelo menos um telefone
    if (Object.keys(telefones).length > 0) {
        data.telefones_jsonb = telefones;
    }
    
    // üî• Converter campos de endere√ßo em JSON
    const endereco = {};
    if (document.getElementById('endereco_cep')?.value) endereco.cep = document.getElementById('endereco_cep').value;
    if (document.getElementById('endereco_rua')?.value) endereco.rua = document.getElementById('endereco_rua').value;
    if (document.getElementById('endereco_numero')?.value) endereco.numero = document.getElementById('endereco_numero').value;
    if (document.getElementById('endereco_complemento')?.value) endereco.complemento = document.getElementById('endereco_complemento').value;
    if (document.getElementById('endereco_bairro')?.value) endereco.bairro = document.getElementById('endereco_bairro').value;
    if (document.getElementById('endereco_cidade')?.value) endereco.cidade = document.getElementById('endereco_cidade').value;
    if (document.getElementById('endereco_estado')?.value) endereco.estado = document.getElementById('endereco_estado').value.toUpperCase();
    // S√≥ adicionar se tiver pelo menos um campo de endere√ßo
    if (Object.keys(endereco).length > 0) {
        data.endereco_jsonb = endereco;
    }
    
    // Remover campos individuais que foram convertidos em JSON
    delete data.telefone_celular;
    delete data.telefone_fixo;
    delete data.endereco_cep;
    delete data.endereco_rua;
    delete data.endereco_numero;
    delete data.endereco_complemento;
    delete data.endereco_bairro;
    delete data.endereco_cidade;
    delete data.endereco_estado;
    
    try {
        const modo = '{{ modo }}';
        const url = modo === 'novo' 
            ? '/rh/colaboradores/api/colaboradores'
            : '/rh/colaboradores/api/colaboradores/{{ colaborador.id if colaborador else "" }}';
        
        const method = modo === 'novo' ? 'POST' : 'PUT';
        
        console.log('üéØ Enviando para:', url);
        console.log('üì° M√©todo:', method);
        console.log('üìÑ Payload:', JSON.stringify(data, null, 2));
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        console.log('‚úÖ Response status:', response.status);
        const result = await response.json();
        console.log('üì• Result:', result);
        
        if (response.ok && result.success) {
            mostrarAlerta('Colaborador salvo com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("colaboradores.lista_colaboradores") }}';
            }, 1500);
        } else {
            throw new Error(result.error || 'Erro ao salvar colaborador');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarAlerta(`Erro ao salvar: ${error.message}`, 'danger');
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
    }
}

</script>
{% endblock %}
