{% extends "base.html" %}

{% block title %}
    Departamento de Gest√£o de Pessoas - {% if modo == 'novo' %}Novo Colaborador{% else %}Editar Colaborador{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='rh/colaboradores/colaboradores.css') }}?v=2.2">
{% endblock %}

{% block content %}
<div class="rh-container"
    {% if is_editing %}
    id="colaboradorPerfil"
    data-colaborador-id="{{ colaborador.id }}"
    data-beneficios='{{ info_atual.beneficios_jsonb | tojson | safe if info_atual and info_atual.beneficios_jsonb else "{}" }}'
    data-salario="{{ info_atual.salario_mensal if info_atual else '' }}"
    data-nome="{{ colaborador.nome_completo }}"
    {% endif %}>
    <!-- Actions Bar com Breadcrumb -->
    <div class="actions-bar module-header-rh">
        <div class="actions-left">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('colaboradores.lista_colaboradores') }}">Departamento de Gest√£o de Pessoas</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('colaboradores.lista_colaboradores') }}">Colaboradores</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{% if modo == 'novo' %}Novo{% else %}Editar{% endif %}</li>
                </ol>
            </nav>
        </div>
        <div class="actions-right">
            <a href="{{ url_for('colaboradores.lista_colaboradores') }}" class="btn btn-outline-secondary">
                <i class="mdi mdi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Formul√°rio -->
    <form id="formColaborador">
        <!-- üî• Campo hidden para vincular ao candidato -->
        {% if candidato_id %}
        <input type="hidden" name="candidato_id" value="{{ candidato_id }}">
        
        <!-- Alert informando que est√° efetivando um candidato -->
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="mdi mdi-information-outline me-2" style="font-size: 1.5rem;"></i>
            <div>
                <strong>Efetivando Candidato como Colaborador</strong><br>
                <small>Os dados abaixo foram pr√©-preenchidos com as informa√ß√µes do candidato <strong>{{ candidato.nome_completo if candidato else '' }}</strong>. Revise e complete as informa√ß√µes necess√°rias.</small>
            </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o: Dados Pessoais -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-account"></i> Dados Pessoais</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Nome Completo</label>
                            <input type="text" class="form-control" id="nome_completo" name="nome_completo" 
                                   value="{{ candidato.nome_completo if candidato else (colaborador.nome_completo if colaborador else '') }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" 
                                   value="{{ colaborador.cpf if colaborador else '' }}" 
                                   placeholder="000.000.000-00" 
                                   maxlength="14"
                                   pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                                   required
                                   {% if colaborador %}readonly{% endif %}>
                            <small class="text-muted">Formato: 000.000.000-00</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label required">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento"
                                   value="{{ candidato.data_nascimento if candidato else (colaborador.data_nascimento if colaborador else '') }}" 
                                   max="{{ hoje }}"
                                   required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">G√™nero</label>
                            <select class="form-select" id="genero" name="genero">
                                <option value="">Selecione...</option>
                                <option value="MASCULINO" {% if (candidato and candidato.sexo == 'Masculino') or (colaborador and colaborador.genero == 'MASCULINO') %}selected{% endif %}>Masculino</option>
                                <option value="FEMININO" {% if (candidato and candidato.sexo == 'Feminino') or (colaborador and colaborador.genero == 'FEMININO') %}selected{% endif %}>Feminino</option>
                                <option value="N√ÉO-BIN√ÅRIO" {% if colaborador and colaborador.genero == 'N√ÉO-BIN√ÅRIO' %}selected{% endif %}>N√£o-bin√°rio</option>
                                <option value="PREFIRO N√ÉO INFORMAR" {% if colaborador and colaborador.genero == 'PREFIRO N√ÉO INFORMAR' %}selected{% endif %}>Prefiro n√£o informar</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Escolaridade</label>
                            <select class="form-select" id="escolaridade" name="escolaridade">
                                <option value="">Selecione...</option>
                                <option value="Ensino Fundamental Incompleto" {% if colaborador and colaborador.escolaridade == 'Ensino Fundamental Incompleto' %}selected{% endif %}>Ensino Fundamental Incompleto</option>
                                <option value="Ensino Fundamental Completo" {% if colaborador and colaborador.escolaridade == 'Ensino Fundamental Completo' %}selected{% endif %}>Ensino Fundamental Completo</option>
                                <option value="Ensino M√©dio Incompleto" {% if colaborador and colaborador.escolaridade == 'Ensino M√©dio Incompleto' %}selected{% endif %}>Ensino M√©dio Incompleto</option>
                                <option value="Ensino M√©dio Completo" {% if colaborador and colaborador.escolaridade == 'Ensino M√©dio Completo' %}selected{% endif %}>Ensino M√©dio Completo</option>
                                <option value="Superior Incompleto" {% if colaborador and colaborador.escolaridade == 'Superior Incompleto' %}selected{% endif %}>Superior Incompleto</option>
                                <option value="Superior Completo" {% if colaborador and colaborador.escolaridade == 'Superior Completo' %}selected{% endif %}>Superior Completo</option>
                                <option value="P√≥s-gradua√ß√£o" {% if colaborador and colaborador.escolaridade == 'P√≥s-gradua√ß√£o' %}selected{% endif %}>P√≥s-gradua√ß√£o</option>
                                <option value="Mestrado" {% if colaborador and colaborador.escolaridade == 'Mestrado' %}selected{% endif %}>Mestrado</option>
                                <option value="Doutorado" {% if colaborador and colaborador.escolaridade == 'Doutorado' %}selected{% endif %}>Doutorado</option>
                            </select>
                        </div>
                    </div>                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ra√ßa/Cor</label>
                            <select class="form-select" id="raca_cor" name="raca_cor">
                                <option value="">Selecione...</option>
                                <option value="Branca" {% if colaborador and colaborador.raca_cor == 'Branca' %}selected{% endif %}>Branca</option>
                                <option value="Preta" {% if colaborador and colaborador.raca_cor == 'Preta' %}selected{% endif %}>Preta</option>
                                <option value="Parda" {% if colaborador and colaborador.raca_cor == 'Parda' %}selected{% endif %}>Parda</option>
                                <option value="Amarela" {% if colaborador and colaborador.raca_cor == 'Amarela' %}selected{% endif %}>Amarela</option>
                                <option value="Ind√≠gena" {% if colaborador and colaborador.raca_cor == 'Ind√≠gena' %}selected{% endif %}>Ind√≠gena</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nacionalidade</label>
                            <input type="text" class="form-control" id="nacionalidade" name="nacionalidade"
                                   value="{{ colaborador.nacionalidade if colaborador else 'Brasileira' }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Documenta√ß√£o, Contato e Endere√ßo -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="row g-4 align-items-stretch">
                    <div class="col-lg-4">
                        <div class="form-section h-100">
                            <h5><i class="mdi mdi-card-account-details"></i> Documenta√ß√£o</h5>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">PIS/PASEP</label>
                                    <input type="text" class="form-control" id="pis_pasep" name="pis_pasep"
                                           value="{{ colaborador.pis_pasep if colaborador else '' }}"
                                           maxlength="20"
                                           placeholder="000.00000.00-0">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CTPS N√∫mero</label>
                                    <input type="text" class="form-control" id="ctps_numero" name="ctps_numero"
                                           value="{{ colaborador.ctps_numero if colaborador else '' }}"
                                           maxlength="20">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CTPS S√©rie</label>
                                    <input type="text" class="form-control" id="ctps_serie" name="ctps_serie"
                                           value="{{ colaborador.ctps_serie if colaborador else '' }}"
                                           maxlength="20">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">CNH N√∫mero</label>
                                    <input type="text" class="form-control" id="cnh_numero" name="cnh_numero"
                                           value="{{ colaborador.cnh_numero if colaborador else '' }}"
                                           maxlength="20"
                                           placeholder="N√∫mero da CNH">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="form-section h-100">
                            <h5><i class="mdi mdi-phone"></i> Contato</h5>
                            <label class="form-label">Telefone de Contato</label>
                            <input type="text" class="form-control" id="tel_contato" name="tel_contato"
                                   value="{{ colaborador.tel_contato if colaborador else (candidato.telefone if candidato else '') }}"
                                   placeholder="(41) 99999-9999"
                                   maxlength="20">
                            <small class="text-muted d-block mt-2">Use somente n√∫meros; formata√ß√£o aplicada automaticamente.</small>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="form-section h-100">
                            <h5><i class="mdi mdi-map-marker"></i> Endere√ßo</h5>
                            <label class="form-label">Endere√ßo Completo</label>
                            <textarea class="form-control" id="endereco_completo" name="endereco_completo" rows="5"
                                      placeholder="Rua, n√∫mero, complemento, bairro, cidade/UF, CEP">{{ colaborador.endereco_completo if colaborador else '' }}</textarea>
                            <small class="text-muted">Campo livre conforme utilizado em documentos oficiais.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o: Dados Corporativos -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="form-section">
                    <h5><i class="mdi mdi-briefcase"></i> Dados Corporativos</h5>

                    {% set info_carreira = info_atual if info_atual else (ultimo_historico if ultimo_historico else {}) %}

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Matr√≠cula</label>
                            <input type="text" class="form-control bg-light" id="matricula" name="matricula"
                                   value="{{ colaborador.matricula if colaborador else '' }}"
                                   readonly
                                   placeholder="Gerado automaticamente">
                            <small class="text-muted">Ser√° gerado automaticamente (ex: UN001, UN002...)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Email Corporativo</label>
                            <input type="email" class="form-control" id="email_corporativo" name="email_corporativo"
                                   value="{{ candidato.email if candidato else (colaborador.email_corporativo if colaborador else '') }}"
                                   placeholder="nome@unique.com.br">
                            <small class="text-muted">Digite um email v√°lido</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label required">Data de Admiss√£o</label>
                            <input type="date" class="form-control" id="data_admissao" name="data_admissao"
                                   value="{{ colaborador.data_admissao if colaborador else '' }}"
                                   max="{{ hoje }}"
                                   required
                                   {% if colaborador %}readonly{% endif %}>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label {% if not is_editing %}required{% endif %}">Cargo Atual</label>
                            {% if is_editing %}
                                <input type="text" class="form-control bg-light" value="{{ info_carreira.nome_cargo or 'N√£o informado' }}" readonly>
                                <small class="text-muted">Use o atalho "Promover" para alterar.</small>
                            {% else %}
                                <select class="form-select" id="cargo_id" name="cargo_id" required>
                                    <option value="">Selecione o cargo inicial...</option>
                                    {% for cargo in cargos %}
                                    <option value="{{ cargo.id }}" {% if ultimo_historico and ultimo_historico.cargo_id == cargo.id %}selected{% endif %}>{{ cargo.nome_cargo }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Campo obrigat√≥rio</small>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label {% if not is_editing %}required{% endif %}">Departamento Atual</label>
                            {% if is_editing %}
                                <input type="text" class="form-control bg-light" value="{{ info_carreira.nome_departamento or 'N√£o informado' }}" readonly>
                                <small class="text-muted">Use o atalho "Transferir" para alterar.</small>
                            {% else %}
                                <select class="form-select" id="departamento_id" name="departamento_id" required>
                                    <option value="">Selecione o departamento inicial...</option>
                                    {% for depto in departamentos %}
                                    <option value="{{ depto.id }}" {% if ultimo_historico and ultimo_historico.departamento_id == depto.id %}selected{% endif %}>{{ depto.nome_departamento }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Campo obrigat√≥rio</small>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Gestor Atual</label>
                            {% if is_editing %}
                                {% if info_carreira.nome_gestor %}
                                    <input type="text" class="form-control bg-light" value="{{ info_carreira.nome_gestor }}" readonly>
                                {% else %}
                                    <input type="text" class="form-control bg-light" value="Sem gestor definido" readonly>
                                {% endif %}
                                <small class="text-muted">Use o atalho "Transferir" para alterar.</small>
                            {% else %}
                                <select class="form-select" id="gestor_id" name="gestor_id">
                                    <option value="">Selecione o gestor inicial (opcional)...</option>
                                    {% for gestor in gestores %}
                                    <option value="{{ gestor.id }}" {% if ultimo_historico and ultimo_historico.gestor_id == gestor.id %}selected{% endif %}>{{ gestor.nome_completo }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Opcional</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        {% if not is_editing %}
                        <!-- Campo de sal√°rio aparece apenas no cadastro inicial -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label required">Sal√°rio Mensal</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="salario_mensal" name="salario_mensal" step="0.01" min="0" max="999999.99" value="{{ ultimo_historico.salario_mensal if ultimo_historico else '' }}" placeholder="0.00" required>
                            </div>
                            <small class="text-muted">Campo obrigat√≥rio - informe apenas n√∫meros</small>
                        </div>
                        {% endif %}
                        <div class="col-md-{% if is_editing %}6{% else %}4{% endif %} mb-3">
                            <label class="form-label {% if not is_editing %}required{% endif %}">Tipo de Contrato</label>
                            {% if is_editing %}
                                <input type="text" class="form-control bg-light" value="{{ info_carreira.tipo_contrato or 'N√£o informado' }}" readonly>
                                <small class="text-muted">Atualize esse campo pelos atalhos de movimenta√ß√£o.</small>
                            {% else %}
                                <select class="form-select" id="tipo_contrato" name="tipo_contrato" required>
                                    <option value="">Selecione...</option>
                                    <option value="CLT" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'CLT' %}selected{% endif %}>CLT</option>
                                    <option value="PJ" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'PJ' %}selected{% endif %}>PJ</option>
                                    <option value="Est√°gio" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'Est√°gio' %}selected{% endif %}>Est√°gio</option>
                                    <option value="Tempor√°rio" {% if ultimo_historico and ultimo_historico.tipo_contrato == 'Tempor√°rio' %}selected{% endif %}>Tempor√°rio</option>
                                </select>
                                <small class="text-muted">Campo obrigat√≥rio</small>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label {% if not is_editing %}required{% endif %}">Modelo de Trabalho</label>
                            {% if is_editing %}
                                <input type="text" class="form-control bg-light" value="{{ info_carreira.modelo_trabalho or 'N√£o informado' }}" readonly>
                                <small class="text-muted">Atualize esse campo pelos atalhos de movimenta√ß√£o.</small>
                            {% else %}
                                <select class="form-select" id="modelo_trabalho" name="modelo_trabalho" required>
                                    <option value="">Selecione...</option>
                                    <option value="Presencial" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'Presencial' %}selected{% endif %}>Presencial</option>
                                    <option value="Remoto" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'Remoto' %}selected{% endif %}>Remoto</option>
                                    <option value="H√≠brido" {% if ultimo_historico and ultimo_historico.modelo_trabalho == 'H√≠brido' %}selected{% endif %}>H√≠brido</option>
                                </select>
                                <small class="text-muted">Campo obrigat√≥rio</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                      placeholder="Observa√ß√µes sobre esta altera√ß√£o..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if is_editing %}
        <!-- Remunera√ß√£o e Benef√≠cios -->
        <div class="rh-card mb-4">
            <div class="card-body">
                {% set snapshot = info_atual or {} %}
                {% set beneficios_view = snapshot.beneficios_view or {} %}
                {% set remuneracao_view = beneficios_view.get('remuneracao_adicional', {}) %}
                {% set beneficios_padrao_view = beneficios_view.get('beneficios_padrao', {}) %}
                {% set remuneracao_items = remuneracao_view.get('items', []) %}
                {% set beneficios_padrao_items = beneficios_padrao_view.get('items', []) %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="mdi mdi-cash-multiple"></i> Remunera√ß√£o e Benef√≠cios</h5>
                    <button type="button"
                            class="btn btn-outline-primary btn-sm"
                            id="btnAlterarBeneficios"
                            data-beneficios='{{ snapshot.beneficios_jsonb | tojson | safe if snapshot.beneficios_jsonb else "{}" }}'
                            data-colaborador-id="{{ colaborador.id }}"
                            data-nome="{{ colaborador.nome_completo }}"
                            data-salario="{{ snapshot.salario_mensal if snapshot.salario_mensal is not none else '' }}">
                        <i class="mdi mdi-plus"></i> Alterar Benef√≠cios
                    </button>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <small class="text-muted d-block">Sal√°rio Base</small>
                        <strong>{{ snapshot.salario_formatado or '-' }}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Remunera√ß√£o Adicional</small>
                        <strong>{{ remuneracao_view.get('total_formatado', 'R$ 0,00') }}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Benef√≠cios Padr√£o</small>
                        <strong>{{ beneficios_padrao_view.get('total_formatado', 'R$ 0,00') }}</strong>
                    </div>
                </div>

                <div class="alert alert-light border d-flex justify-content-between align-items-center py-2 px-3">
                    <div>
                        <strong>Custo Total Mensal</strong>
                        <div class="small text-muted mb-0">Sal√°rio + Remunera√ß√£o Adicional + Benef√≠cios</div>
                    </div>
                    <div class="h5 mb-0">{{ snapshot.total_remuneracao_formatado or (snapshot.salario_formatado if snapshot.salario_formatado else 'R$ 0,00') }}</div>
                </div>

                <div class="row mt-3 g-3">
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted fw-semibold small mb-2">Remunera√ß√£o Adicional</h6>
                        <div class="list-group list-group-flush rounded border">
                            {% if remuneracao_items %}
                                {% for item in remuneracao_items %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>{{ item.label }}</span>
                                    <span class="fw-semibold">{{ item.valor_formatado }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="list-group-item text-muted">
                                    <i class="mdi mdi-alert-circle-outline me-1"></i> Nenhuma remunera√ß√£o adicional cadastrada.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted fw-semibold small mb-2">Pacote de Benef√≠cios</h6>
                        <div class="list-group list-group-flush rounded border">
                            {% if beneficios_padrao_items %}
                                {% for item in beneficios_padrao_items %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>{{ item.label }}</span>
                                    <span class="fw-semibold">{{ item.valor_formatado }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="list-group-item text-muted">
                                    <i class="mdi mdi-wallet-outline me-1"></i> Nenhum benef√≠cio padr√£o cadastrado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dependentes -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="mdi mdi-account-multiple-outline"></i> Dependentes</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="abrirModalDependente()">
                        <i class="mdi mdi-plus"></i> Adicionar Dependente
                    </button>
                </div>
                {% if dependentes %}
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome Completo</th>
                                <th>Parentesco</th>
                                <th>Data de Nascimento</th>
                                <th class="text-center">Idade</th>
                                <th class="text-center" style="width: 110px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dependente in dependentes %}
                            <tr>
                                <td>{{ dependente.nome_completo }}</td>
                                <td>{{ dependente.parentesco }}</td>
                                <td>{{ dependente.data_nascimento_br or '-' }}</td>
                                <td class="text-center">{{ dependente.idade if dependente.idade is not none else '-' }}</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button"
                                                class="btn btn-outline-primary"
                                                title="Editar"
                                                data-dependente='{{ dependente | tojson | safe }}'
                                                onclick="editarDependente(this)">
                                            <i class="mdi mdi-pencil"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                title="Excluir"
                                                onclick="confirmarRemocaoDependente('{{ dependente.id }}', '{{ dependente.nome_completo }}')">
                                            <i class="mdi mdi-trash-can"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">
                    <i class="mdi mdi-account-alert"></i> Nenhum dependente cadastrado at√© o momento.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Contatos de Emerg√™ncia -->
        <div class="rh-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="mdi mdi-phone-alert"></i> Contatos de Emerg√™ncia</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="abrirModalContato()">
                        <i class="mdi mdi-plus"></i> Adicionar Contato
                    </button>
                </div>
                {% if contatos_emergencia %}
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Parentesco</th>
                                <th class="text-center" style="width: 110px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contato in contatos_emergencia %}
                            <tr>
                                <td>{{ contato.nome_contato }}</td>
                                <td>{{ contato.telefone_contato or '-' }}</td>
                                <td>{{ contato.parentesco or '-' }}</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button"
                                                class="btn btn-outline-primary"
                                                title="Editar"
                                                data-contato='{{ contato | tojson | safe }}'
                                                onclick="editarContato(this)">
                                            <i class="mdi mdi-pencil"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                title="Excluir"
                                                onclick="confirmarRemocaoContato('{{ contato.id }}', '{{ contato.nome_contato }}')">
                                            <i class="mdi mdi-trash-can"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">
                    <i class="mdi mdi-phone-off"></i> Nenhum contato de emerg√™ncia cadastrado.
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Bot√µes de A√ß√£o -->
        <div class="rh-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('colaboradores.lista_colaboradores') }}" class="btn btn-outline-secondary">
                        <i class="mdi mdi-close"></i> Cancelar
                    </a>
                    <button type="button" class="btn btn-primary" id="btnSalvar" onclick="salvarColaborador()">
                        <i class="mdi mdi-content-save"></i> Salvar Colaborador
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{% if is_editing %}
<!-- Modal Altera√ß√£o de Benef√≠cios -->
<div class="modal fade" id="modalAlterarBeneficios" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="mdi mdi-cash-plus"></i>
                    Alterar Benef√≠cios de <span id="beneficiosColaboradorNome"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formAlterarBeneficios">
                <div class="modal-body">
                    <input type="hidden" id="beneficiosColaboradorId">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Data da Altera√ß√£o</label>
                            <input type="date" class="form-control" id="beneficiosData" required>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Motivo da Altera√ß√£o</label>
                            <textarea class="form-control" id="beneficiosDescricao" rows="2" placeholder="Ex: Reajuste anual do vale alimenta√ß√£o" required></textarea>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">
                            <i class="mdi mdi-cash-plus me-1"></i> Remunera√ß√£o Adicional
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label mb-1" for="beneficioAjudaCusto">Ajuda de Custo</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="beneficioAjudaCusto" min="0" step="0.01" placeholder="0,00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label mb-1" for="beneficioAuxilioCreche">Aux√≠lio Creche</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="beneficioAuxilioCreche" min="0" step="0.01" placeholder="0,00">
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">Informe os valores pagos mensalmente como remunera√ß√£o adicional.</small>
                    </div>

                    <div class="mb-2">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">
                            <i class="mdi mdi-wallet-outline me-1"></i> Benef√≠cios Padr√£o
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label mb-1" for="beneficioValeAlimentacao">Vale Alimenta√ß√£o / Refei√ß√£o</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="beneficioValeAlimentacao" min="0" step="0.01" placeholder="0,00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label mb-1" for="beneficioValeTransporte">Vale Transporte</label>
                                <input type="text" class="form-control" id="beneficioValeTransporte" placeholder="Ex: Sim ou 180,00">
                                <small class="text-muted">Digite "Sim" quando o benef√≠cio for concedido sem desconto.</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4 mb-0" id="beneficiosAviso" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnSalvarBeneficios">
                        <i class="mdi mdi-content-save"></i> Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Dependente -->
<div class="modal fade" id="modalDependente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="mdi mdi-account-plus-outline"></i> <span id="tituloModalDependente">Adicionar Dependente</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formDependente">
                <div class="modal-body">
                    <input type="hidden" id="dependenteId">
                    <div class="mb-3">
                        <label class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="dependenteNome" placeholder="Nome completo do dependente" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parentesco</label>
                        <select class="form-select" id="dependenteParentesco" required>
                            <option value="">Selecione...</option>
                            <option value="Filho(a)">Filho(a)</option>
                            <option value="C√¥njuge">C√¥njuge</option>
                            <option value="Enteado(a)">Enteado(a)</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-control" id="dependenteDataNascimento" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarDependente">
                        <i class="mdi mdi-content-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Contato de Emerg√™ncia -->
<div class="modal fade" id="modalContato" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="mdi mdi-phone-plus"></i> <span id="tituloModalContato">Adicionar Contato de Emerg√™ncia</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formContato">
                <div class="modal-body">
                    <input type="hidden" id="contatoId">
                    <div class="mb-3">
                        <label class="form-label">Nome do Contato</label>
                        <input type="text" class="form-control" id="contatoNome" placeholder="Nome completo" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="contatoTelefone" placeholder="(00) 00000-0000" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parentesco</label>
                        <input type="text" class="form-control" id="contatoParentesco" placeholder="Ex: M√£e, Pai, C√¥njuge">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info text-white" id="btnSalvarContato">
                        <i class="mdi mdi-content-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
window.RH_BENEFICIOS_CATALOGO = JSON.parse('{{ beneficios_catalogo | tojson | safe }}');
</script>
<script src="{{ url_for('colaboradores.static', filename='colaboradores/colaboradores.js') }}"></script>
<script>
// ===================================================================
// FUN√á√ÉO GLOBAL DE SALVAMENTO
// ===================================================================

// Declarar fun√ß√£o globalmente para que onclick possa acess√°-la
window.salvarColaborador = async function() {
    console.log('üöÄ salvarColaborador() chamada!');
    
    const form = document.getElementById('formColaborador');
    const btnSalvar = document.getElementById('btnSalvar');
    console.log('üìã Form:', form);
    console.log('üìç Bot√£o:', btnSalvar);
    
    if (!form) {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
        return;
    }
    
    const textoOriginal = btnSalvar.innerHTML;
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Salvando...';
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Remover campos vazios para evitar sobrescrever com strings em branco
    Object.keys(data).forEach((key) => {
        if (data[key] === '') {
            delete data[key];
        }
    });

    const modo = '{{ modo }}';
    if (modo !== 'novo') {
        delete data.salario_mensal;
        delete data.cargo_id;
        delete data.departamento_id;
        delete data.gestor_id;
        delete data.tipo_contrato;
        delete data.modelo_trabalho;
    }
    console.log('üì¶ Dados coletados:', data);
    
    try {
        const url = modo === 'novo' 
            ? '/rh/colaboradores/api/colaboradores'
            : '/rh/colaboradores/api/colaboradores/{{ colaborador.id if colaborador else "" }}';
        
        const method = modo === 'novo' ? 'POST' : 'PUT';
        
        console.log('üéØ Enviando para:', url);
        console.log('üì° M√©todo:', method);
        console.log('üìÑ Payload:', JSON.stringify(data, null, 2));
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        console.log('‚úÖ Response status:', response.status);
        const result = await response.json();
        console.log('üì• Result:', result);
        
        if (response.ok && result.success) {
            mostrarAlerta('Colaborador salvo com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("colaboradores.lista_colaboradores") }}';
            }, 1500);
        } else {
            throw new Error(result.error || 'Erro ao salvar colaborador');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarAlerta(`Erro ao salvar: ${error.message}`, 'danger');
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
    }
};

// ===================================================================
// M√ÅSCARAS E VALIDA√á√ïES
// ===================================================================

// M√°scara de CPF
document.getElementById('cpf')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = value;
    }
});

// M√°scara simples para telefone de contato
document.getElementById('tel_contato')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '').substring(0, 11);

    if (value.length >= 11) {
        e.target.value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (value.length >= 7) {
        e.target.value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3').replace(/-$/, '');
    } else if (value.length > 2) {
        e.target.value = value.replace(/(\d{2})(\d{0,4})/, '($1) $2');
    } else if (value.length > 0) {
        e.target.value = '(' + value;
    } else {
        e.target.value = '';
    }
});

// M√°scara de PIS/PASEP
document.getElementById('pis_pasep')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{5})(\d)/, '$1.$2');
        value = value.replace(/(\d{2})(\d{1})$/, '$1-$2');
        e.target.value = value;
    }
});

// Apenas n√∫meros para CNH
document.getElementById('cnh_numero')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 11);
});

// Valida√ß√£o de email em tempo real
document.getElementById('email_corporativo')?.addEventListener('blur', function(e) {
    const email = e.target.value;
    if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        e.target.classList.add('is-invalid');
        if (!e.target.nextElementSibling?.classList.contains('invalid-feedback')) {
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = 'Digite um email v√°lido';
            e.target.parentNode.appendChild(feedback);
        }
    } else {
        e.target.classList.remove('is-invalid');
        e.target.nextElementSibling?.remove();
    }
});

// ===================================================================
// GERA√á√ÉO AUTOM√ÅTICA DE MATR√çCULA
// ===================================================================

async function gerarProximaMatricula() {
    const modo = '{{ modo }}';
    const matriculaInput = document.getElementById('matricula');
    
    // Se estiver editando, n√£o gera nova matr√≠cula
    if (modo !== 'novo' || matriculaInput.value) {
        return;
    }
    
    try {
        console.log('[RH] Gerando pr√≥xima matr√≠cula...');
        
        // Buscar √∫ltima matr√≠cula via API
        const response = await fetch('/rh/colaboradores/api/colaboradores');
        const data = await response.json();
        
        if (data.success && data.data) {
            // Filtrar apenas matr√≠culas que come√ßam com UN
            const matriculas = data.data
                .map(c => c.matricula)
                .filter(m => m && m.startsWith('UN'))
                .map(m => parseInt(m.replace('UN', '')))
                .filter(n => !isNaN(n));
            
            // Pegar o maior n√∫mero
            const maiorNumero = matriculas.length > 0 ? Math.max(...matriculas) : 0;
            const proximoNumero = maiorNumero + 1;
            
            // Formatar com zeros √† esquerda (UN001, UN002, etc)
            const novaMatricula = 'UN' + String(proximoNumero).padStart(3, '0');
            
            matriculaInput.value = novaMatricula;
            console.log(`[RH] Matr√≠cula gerada: ${novaMatricula}`);
        }
    } catch (error) {
        console.error('[RH] Erro ao gerar matr√≠cula:', error);
        // Em caso de erro, gera uma matr√≠cula padr√£o
        matriculaInput.value = 'UN001';
    }
}

// Gerar matr√≠cula quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß DOM carregado, inicializando form...');
    gerarProximaMatricula();
});

</script>
{% endblock %}
