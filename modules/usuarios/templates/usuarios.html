{% extends "base.html" %}

{% block title %}Gerenciamento de Usuários - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('usuarios.static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="usuarios-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            {{ breadcrumb([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Configurações', 'icon': 'mdi mdi-cog', 'url': url_for('menu.configuracoes')},
                {'name': 'Usuários', 'icon': 'mdi mdi-account-multiple'}
            ]) }}
        </div>
        <div class="actions-right">
            <button id="btn-refresh" class="btn btn-secondary">
                <i class="mdi mdi-refresh"></i>
                Atualizar
            </button>
            <button id="btn-novo-usuario" class="btn btn-primary">
                <i class="mdi mdi-plus"></i>
                Novo Usuário
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <i class="mdi mdi-account-multiple"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total de Usuários</p>
                <p class="kpi-value" id="kpi-total-usuarios">{{ users|length if users else 0 }}</p>
            </div>
        </div>
        
        <!-- Admin KPI - Only visible to Master Admins -->
        {% if user_role == 'admin' and user_perfil_principal == 'admin_geral' %}
        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <i class="mdi mdi-shield-crown"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Administradores</p>
                <p class="kpi-value" id="kpi-admin">0</p>
            </div>
        </div>
        {% endif %}
        
        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <i class="mdi mdi-account-tie"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Equipe Interna</p>
                <p class="kpi-value" id="kpi-interno">0</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <i class="mdi mdi-domain"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Clientes</p>
                <p class="kpi-value" id="kpi-clientes">0</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-emerald">
            <div class="kpi-icon">
                <i class="mdi mdi-check-circle"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Ativos</p>
                <p class="kpi-value" id="kpi-ativos">0</p>
            </div>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="mdi mdi-magnify search-icon"></i>
                <input 
                    type="text" 
                    id="search-usuarios" 
                    class="search-input" 
                    placeholder="Buscar por nome, email ou perfil..."
                    autocomplete="off"
                >
            </div>
        </div>
        <div class="filter-controls">
            <div class="filter-group">
                <label for="filter-perfil" class="filter-label">Perfil:</label>
                <select id="filter-perfil" class="filter-select">
                    <option value="">Todos os perfis</option>
                    {% if user_role == 'admin' and user_perfil_principal == 'admin_geral' %}
                    <option value="admin">Administradores</option>
                    {% endif %}
                    <option value="interno_unique">Equipe Interna</option>
                    <option value="cliente_unique">Clientes</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-status" class="filter-label">Status:</label>
                <select id="filter-status" class="filter-select">
                    <option value="">Todos</option>
                    <option value="active">Ativos</option>
                    <option value="inactive">Inativos</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification-area" class="notification-area hidden"></div>

    <!-- Users Cards by Role -->
    <div class="users-sections">
        <!-- Administradores - Only visible to Master Admins -->
        {% if user_role == 'admin' and user_perfil_principal == 'admin_geral' %}
        <div class="role-section" id="section-admin">
            <div class="section-header">
                <div class="section-title">
                    <div class="section-icon kpi-success">
                        <i class="mdi mdi-shield-crown"></i>
                    </div>
                    <div class="section-info">
                        <h3>Administradores</h3>
                        <p>Usuários com acesso total ao sistema</p>
                    </div>
                </div>
                <div class="section-count">
                    <span class="count-badge count-admin" id="count-admin">0</span>
                </div>
            </div>
            <div class="users-grid" id="grid-admin">
                <!-- Usuários admin serão inseridos aqui -->
            </div>
        </div>
        {% endif %}

        <!-- Equipe Interna -->
        <div class="role-section" id="section-interno">
            <div class="section-header">
                <div class="section-title">
                    <div class="section-icon kpi-info">
                        <i class="mdi mdi-account-tie"></i>
                    </div>
                    <div class="section-info">
                        <h3>Equipe Interna</h3>
                        <p>Colaboradores da Unique Aduaneira</p>
                    </div>
                </div>
                <div class="section-count">
                    <span class="count-badge count-interno" id="count-interno">0</span>
                </div>
            </div>
            <div class="users-grid" id="grid-interno">
                <!-- Usuários internos serão inseridos aqui -->
            </div>
        </div>

        <!-- Clientes -->
        <div class="role-section" id="section-clientes">
            <div class="section-header">
                <div class="section-title">
                    <div class="section-icon kpi-warning">
                        <i class="mdi mdi-domain"></i>
                    </div>
                    <div class="section-info">
                        <h3>Clientes</h3>
                        <p>Empresas e usuários clientes</p>
                    </div>
                </div>
                <div class="section-count">
                    <span class="count-badge count-clientes" id="count-clientes">0</span>
                </div>
            </div>
            <div class="users-grid" id="grid-clientes">
                <!-- Usuários clientes serão inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Empty State (when no users) -->
    <div id="empty-state" class="empty-state-container hidden">
        <div class="empty-state">
            <div class="empty-icon">
                <i class="mdi mdi-account-multiple-outline"></i>
            </div>
            <h3>Nenhum usuário encontrado</h3>
            <p>Ajuste os filtros ou crie um novo usuário</p>
            <button id="btn-novo-usuario-empty" class="btn btn-primary">
                <i class="mdi mdi-plus"></i>
                Criar Primeiro Usuário
            </button>
        </div>
    </div>
</div>

<!-- Modal de Criação/Edição de Usuário -->
<div id="modal-usuario" class="modal-overlay hidden">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="modal-title" class="modal-title">Novo Usuário</h2>
            <button id="btn-close-modal" class="btn-close-modal">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        
        <div class="modal-content">
            <form id="form-usuario" class="user-form">
                <!-- Loading Indicator -->
                <div id="form-loading" class="form-loading hidden">
                    <div class="loading-spinner"></div>
                    <p>Carregando dados...</p>
                </div>

                <!-- Container das Seções em Layout Reorganizado -->
                <div class="form-sections-container">
                    
                    <!-- Row: Informações + Empresas lado a lado -->
                    <div class="form-sections-row">
                        
                        <!-- Seção 1: Informações do Usuário -->
                        <div class="form-section-informacoes active">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="mdi mdi-account"></i>
                            Informações
                        </h3>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="nome" class="form-label required">Nome Completo</label>
                                <input type="text" id="nome" name="nome" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="email" class="form-label required">Email</label>
                                <input type="email" id="email" name="email" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="role" class="form-label required">Perfil de Acesso</label>
                                <select id="role" name="role" class="form-select" required>
                                    <option value="">Selecione um perfil</option>
                                    {% if user_role == 'admin' and user_perfil_principal == 'admin_geral' %}
                                    <option value="admin">Administrador</option>
                                    {% endif %}
                                    <option value="interno_unique">Equipe Interna</option>
                                    <option value="cliente_unique">Cliente</option>
                                </select>
                            </div>
                            <div class="form-group status-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ativo" name="ativo" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Usuário Ativo</span>
                                </label>
                            </div>
                        </div>

                        <!-- Campos de Senha (apenas para novo usuário) -->
                        <div id="password-section" class="password-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="senha" class="form-label required">Senha</label>
                                    <input type="password" id="senha" name="senha" class="form-input" required>
                                    <span class="form-hint">Mínimo 6 caracteres</span>
                                </div>
                                <div class="form-group">
                                    <label for="confirmar_senha" class="form-label required">Confirmar Senha</label>
                                    <input type="password" id="confirmar_senha" name="confirmar_senha" class="form-input" required>
                                </div>
                            </div>
                        </div>

                                                </div>
                    </div>
                </div>

                        <!-- Seção 2: Perfis de Acesso -->
                        <div class="form-section-perfis">
                    <div class="section-header collapsible-header" data-target="perfis-content">
                        <h3 class="section-title">
                            <i class="mdi mdi-shield-account"></i>
                            Perfis de Acesso
                            <i class="mdi mdi-chevron-down collapse-icon"></i>
                        </h3>
                        <p class="section-subtitle">Perfis de acesso específicos do sistema</p>
                    </div>
                    <div id="perfis-content" class="section-content collapsible-content collapsed">
                        <div class="perfis-selection-container">
                            <div class="perfis-search-container">
                                <div class="search-input-wrapper">
                                    <i class="mdi mdi-magnify search-icon"></i>
                                    <input type="text" id="perfis-search" class="form-input" placeholder="Buscar perfis...">
                                </div>
                            </div>
                            
                            <div class="perfis-list-container">
                                <div class="list-header">
                                    <span class="list-title">Perfis Disponíveis</span>
                                    <span class="count-badge" id="perfis-selected-count">0 selecionados</span>
                                </div>
                                <div id="perfis-list" class="perfis-list">
                                    <!-- Perfis serão carregados aqui -->
                                </div>
                                <div id="perfis-empty" class="empty-list">
                                    <i class="mdi mdi-shield-account-outline"></i>
                                    <p>Nenhum perfil encontrado</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Seção 3: Empresas Associadas -->
                        <div id="empresas-section" class="form-section-empresas hidden">
                    <div class="section-header collapsible-header" data-target="empresas-content">
                        <h3 class="section-title">
                            <i class="mdi mdi-domain"></i>
                            Empresas
                            <i class="mdi mdi-chevron-down collapse-icon"></i>
                        </h3>
                        <p class="section-subtitle">Empresas que este usuário pode acessar</p>
                    </div>
                    <div id="empresas-content" class="section-content collapsible-content collapsed">
                        <!-- Busca e Adição de Empresas -->
                        <div class="empresa-search-container">
                            <div class="search-add-wrapper">
                                <div class="empresa-search-input-wrapper">
                                    <input type="text" id="empresa-search" class="form-input" placeholder="Buscar empresa por nome ou CNPJ...">
                                    <div id="empresa-search-results" class="search-results hidden"></div>
                                </div>
                                <button type="button" id="btn-add-empresa" class="btn btn-secondary" disabled>
                                    <i class="mdi mdi-plus"></i>
                                    Adicionar
                                </button>
                            </div>
                        </div>

                        <!-- Lista de Empresas Associadas -->
                        <div class="empresas-list-container">
                            <div class="list-header">
                                <h4 class="list-title">
                                    <i class="mdi mdi-domain"></i>
                                    Empresas Vinculadas
                                    <span class="count-badge" id="empresas-count">0</span>
                                </h4>
                            </div>
                            <div id="empresas-list" class="empresas-list">
                                <div class="empty-list">
                                    <i class="mdi mdi-domain-off"></i>
                                    <p>Nenhuma empresa vinculada</p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fecha form-sections-row -->

                    <!-- Seção 4: WhatsApp (largura total) -->
                    <div id="whatsapp-section" class="form-section-whatsapp">
                    <div class="section-header collapsible-header" data-target="whatsapp-content">
                        <h3 class="section-title">
                            <i class="mdi mdi-whatsapp"></i>
                            WhatsApp
                            <i class="mdi mdi-chevron-down collapse-icon"></i>
                        </h3>
                        <p class="section-subtitle">Números para comunicação e notificações</p>
                    </div>
                    <div id="whatsapp-content" class="section-content collapsible-content collapsed">
                        <!-- Formulário de Adição de WhatsApp -->
                        <div class="whatsapp-form-container">
                            <div class="whatsapp-form-grid">
                                <div class="form-group">
                                    <label for="whatsapp-nome" class="form-label">Nome/Identificação</label>
                                    <input type="text" id="whatsapp-nome" class="form-input" placeholder="Ex: Pessoal, Trabalho, Suporte...">
                                </div>
                                <div class="form-group">
                                    <label for="whatsapp-numero" class="form-label required">Número WhatsApp</label>
                                    <input type="text" id="whatsapp-numero" class="form-input" placeholder="(11)987654321" maxlength="15">
                                </div>
                                <div class="form-group-btn">
                                    <button type="button" id="btn-add-whatsapp" class="btn btn-secondary">
                                        <i class="mdi mdi-plus"></i>
                                        Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Números de WhatsApp -->
                        <div class="whatsapp-list-container">
                            <div class="list-header">
                                <h4 class="list-title">
                                    <i class="mdi mdi-whatsapp"></i>
                                    Números Cadastrados
                                    <span class="count-badge" id="whatsapp-count">0</span>
                                </h4>
                            </div>
                            <div id="whatsapp-list" class="whatsapp-list">
                                <div class="empty-list">
                                    <i class="mdi mdi-phone-off"></i>
                                    <p>Nenhum número cadastrado</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- Fecha form-sections-container -->
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" id="btn-cancel" class="btn btn-secondary">
                <i class="mdi mdi-close"></i>
                Cancelar
            </button>
            <button type="submit" id="btn-save" class="btn btn-primary" form="form-usuario">
                <i class="mdi mdi-check"></i>
                <span id="save-text">Salvar</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="modal-delete-confirm" class="modal-overlay hidden">
    <div class="modal-container modal-small">
        <div class="modal-header">
            <h2 class="modal-title">Confirmar Exclusão</h2>
        </div>
        <div class="modal-content">
            <div class="delete-confirm-content">
                <div class="delete-icon">
                    <i class="mdi mdi-alert-circle"></i>
                </div>
                <div class="delete-message">
                    <p>Tem certeza que deseja excluir o usuário <strong id="delete-user-name"></strong>?</p>
                    <p class="delete-warning">Esta ação não pode ser desfeita.</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="btn-cancel-delete" class="btn btn-secondary">
                <i class="mdi mdi-close"></i>
                Cancelar
            </button>
            <button type="button" id="btn-confirm-delete" class="btn btn-danger">
                <i class="mdi mdi-delete"></i>
                Excluir
            </button>
        </div>
    </div>
</div>

<!-- Template para Card de Usuário -->
<template id="user-card-template">
    <div class="user-card" data-user-id="{user_id}" data-role="{role}" data-status="{status}">
        <div class="user-card-header">
            <div class="user-status {status_class}"></div>
            <div class="user-actions">
                <button class="btn-action btn-edit" title="Editar usuário" onclick="openEditModal('{user_id}')">
                    <i class="mdi mdi-pencil"></i>
                </button>
                <button class="btn-action btn-delete" title="Excluir usuário" onclick="deleteUser('{user_id}', '{user_name}')">
                    <i class="mdi mdi-delete"></i>
                </button>
            </div>
        </div>
        <div class="user-card-content">
            <div class="user-info">
                <h4 class="user-name">{user_name}</h4>
                <p class="user-email">{user_email}</p>
            </div>
            <div class="user-meta">
                {empresas_info}
                {whatsapp_info}
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('usuarios.static', filename='js/script.js') }}"></script>
{% endblock %}
