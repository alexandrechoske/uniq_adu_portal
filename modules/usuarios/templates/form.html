{% extends "base.html" %}

{% block title %}
    {% if user %}Editar{% else %}Novo{% endif %} Usuário - Portal UniSystem
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('usuarios.static', filename='css/usuarios.css') }}">
<link rel="stylesheet" href="{{ url_for('usuarios.static', filename='css/form.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            {{ breadcrumb([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Usuários', 'icon': 'mdi mdi-account-group', 'url': url_for('usuarios.index')},
                {'name': ('Editar Usuário' if user else 'Novo Usuário'), 'icon': 'mdi mdi-account-edit'}
            ]) }}
        </div>
        <div class="actions-right">
            <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline">
                <i class="mdi mdi-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="form-container">
            <!-- Formulário Principal -->
            <div class="form-card">
                <div class="form-header">
                    <div class="form-icon">
                        <i class="mdi mdi-account-{{ 'edit' if user else 'plus' }}"></i>
                    </div>
                    <h1 class="form-title">
                        {% if user %}
                            Editar Usuário
                        {% else %}
                            Novo Usuário
                        {% endif %}
                    </h1>
                    <p class="form-subtitle">
                        {% if user %}
                            Atualize as informações do usuário e suas empresas associadas
                        {% else %}
                            Preencha os dados para criar um novo usuário no sistema
                        {% endif %}
                    </p>
                </div>

                <!-- Feedback do formulário -->
                <div id="form-feedback" class="form-feedback" style="display: none;">
                    <i class="mdi mdi-information"></i>
                    <span id="feedback-message"></span>
                </div>

                <!-- Mensagens Flash do Backend -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="form-feedback {{ 'error' if category == 'error' else 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' }}">
                                <i class="mdi mdi-{{ 'alert-circle' if category == 'error' else 'check-circle' if category == 'success' else 'alert' if category == 'warning' else 'information' }}"></i>
                                <span>{{ message }}</span>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Loading do formulário -->
                <div id="form-loading" class="form-loading">
                    <i class="mdi mdi-loading mdi-spin"></i>
                    <span>Processando...</span>
                </div>

                <form id="userForm" method="POST" data-user-id="{{ user.id if user else '' }}">
                    <div class="form-grid">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name" class="form-label required">Nome Completo</label>
                                <input type="text" 
                                       id="name" 
                                       name="name" 
                                       class="form-input" 
                                       value="{{ user.name if user else '' }}" 
                                       required
                                       placeholder="Digite o nome completo">
                            </div>

                            <div class="form-group">
                                <label for="email" class="form-label required">Email</label>
                                <input type="email" 
                                       id="email" 
                                       name="email" 
                                       class="form-input" 
                                       value="{{ user.email if user else '' }}" 
                                       required
                                       placeholder="usuario@exemplo.com">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="role" class="form-label required">Perfil do Usuário</label>
                                <select id="role" name="role" class="form-select" required>
                                    <option value="">Selecione o perfil</option>
                                    <option value="admin" {{ 'selected' if user and user.role == 'admin' else '' }}>
                                        Administrador
                                    </option>
                                    <option value="interno_unique" {{ 'selected' if user and user.role == 'interno_unique' else '' }}>
                                        Equipe Interna
                                    </option>
                                    <option value="cliente_unique" {{ 'selected' if user and user.role == 'cliente_unique' else '' }}>
                                        Cliente
                                    </option>
                                </select>
                                <div class="form-help">Administrador tem acesso completo. Equipe Interna e Clientes têm acessos específicos.</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div class="form-switch">
                                    <input type="checkbox" 
                                           id="is_active" 
                                           name="is_active" 
                                           value="true" 
                                           class="switch-input"
                                           {{ 'checked' if not user or user.is_active else '' }}>
                                    <label for="is_active" class="switch-label">Usuário Ativo</label>
                                </div>
                                <div class="form-help">Usuários inativos não conseguem fazer login no sistema.</div>
                            </div>
                        </div>

                        {% if not user %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password" class="form-label required">Senha</label>
                                <input type="password" 
                                       id="password" 
                                       name="password" 
                                       class="form-input" 
                                       required
                                       minlength="6"
                                       placeholder="Mínimo 6 caracteres">
                            </div>

                            <div class="form-group">
                                <label for="confirm_password" class="form-label required">Confirmar Senha</label>
                                <input type="password" 
                                       id="confirm_password" 
                                       name="confirm_password" 
                                       class="form-input" 
                                       required
                                       minlength="6"
                                       placeholder="Digite a senha novamente">
                            </div>
                        </div>
                        {% endif %}

                        <!-- Seção de Empresas -->
                        <div id="empresas-section" class="empresas-section full-width" style="display: none;">
                            <div class="empresas-header">
                                <h3 class="empresas-title">
                                    <i class="mdi mdi-domain"></i>
                                    Empresas Associadas
                                </h3>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Buscar e Adicionar Empresa</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="text" 
                                           id="cnpj-search" 
                                           class="form-input" 
                                           placeholder="Digite o CNPJ (com ou sem formatação) ou nome da empresa..."
                                           autocomplete="off"
                                           style="flex: 1;">
                                    <button type="button" 
                                            id="btn-buscar-empresa" 
                                            class="btn btn-primary btn-sm">
                                        <i class="mdi mdi-magnify"></i>
                                        Buscar
                                    </button>
                                </div>
                                <div class="form-help">
                                    Busque empresas por CNPJ ou razão social para associar ao usuário
                                </div>
                            </div>

                            <!-- Lista de empresas selecionadas -->
                            <div id="empresas-list" class="empresas-list">
                                <p style="color: var(--color-text-muted); font-style: italic;">
                                    Nenhuma empresa selecionada
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline">
                            <i class="mdi mdi-cancel"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="mdi mdi-{{ 'content-save' if user else 'plus' }}"></i>
                            {% if user %}Salvar Alterações{% else %}Criar Usuário{% endif %}
                        </button>
                    </div>
                </form>
            </div>

            <!-- Card de Informações -->
            {% if user %}
            <div class="form-card">
                <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 8px;">
                    <i class="mdi mdi-information-outline"></i>
                    Informações Adicionais
                </h3>
                <div style="display: grid; gap: 12px; font-size: 0.875rem;">
                    <div>
                        <strong>ID:</strong> {{ user.id }}
                    </div>
                    <div>
                        <strong>Criado em:</strong> 
                        {{ user.created_at.strftime('%d/%m/%Y às %H:%M') if user.created_at else 'Não disponível' }}
                    </div>
                    <div>
                        <strong>Última atualização:</strong> 
                        {{ user.updated_at.strftime('%d/%m/%Y às %H:%M') if user.updated_at else 'Não disponível' }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('usuarios.static', filename='js/form.js') }}"></script>
<script>
// Sistema de gerenciamento do formulário de usuários
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] Inicializando formulário de usuários');

    const form = document.getElementById('userForm');
    const roleSelect = document.getElementById('role');
    const empresasSection = document.getElementById('empresas-section');
    const btnBuscarEmpresa = document.getElementById('btn-buscar-empresa');
    const cnpjSearchInput = document.getElementById('cnpj-search');
    const empresasList = document.getElementById('empresas-list');

    // Estado do formulário
    let empresasSelecionadas = [];

    // === FEEDBACK SYSTEM ===
    const feedback = document.getElementById('form-feedback');
    const feedbackMessage = document.getElementById('feedback-message');
    const loading = document.getElementById('form-loading');

    function showFeedback(message, type = 'info') {
        feedback.className = `form-feedback ${type}`;
        feedbackMessage.textContent = message;
        feedback.style.display = 'flex';
        
        // Auto-hide após 5 segundos se for sucesso
        if (type === 'success') {
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 5000);
        }
    }

    function showLoading(show = true) {
        if (show) {
            loading.classList.add('active');
            form.querySelector('button[type="submit"]').classList.add('loading');
            form.querySelector('button[type="submit"]').disabled = true;
        } else {
            loading.classList.remove('active');
            form.querySelector('button[type="submit"]').classList.remove('loading');
            form.querySelector('button[type="submit"]').disabled = false;
        }
    }

    // === CONTROLE DE PERFIL ===
    function handleRoleChange() {
        const role = roleSelect.value;
        console.log('[DEBUG] Role alterada para:', role);

        if (role === 'cliente_unique' || role === 'interno_unique') {
            empresasSection.style.display = 'block';
        } else {
            empresasSection.style.display = 'none';
            empresasSelecionadas = [];
            updateEmpresasList();
        }
    }

    if (roleSelect) {
        roleSelect.addEventListener('change', handleRoleChange);
        
        // Verificar role inicial
        if (roleSelect.value === 'cliente_unique' || roleSelect.value === 'interno_unique') {
            empresasSection.style.display = 'block';
        }
    }

    // === BUSCA DE EMPRESAS ===
    function buscarEmpresa() {
        const termo = cnpjSearchInput.value.trim();
        
        if (!termo) {
            showFeedback('Digite um CNPJ ou nome da empresa para buscar', 'warning');
            return;
        }

        console.log('[DEBUG] Buscando empresa:', termo);

        fetch('/usuarios/api/empresas/buscar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cnpj: termo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.multiple) {
                    // Múltiplas empresas - mostrar seletor
                    mostrarSeletorEmpresas(data.empresas);
                } else {
                    // Uma empresa - adicionar diretamente
                    const empresa = data.empresa;
                    adicionarEmpresa(empresa);
                    cnpjSearchInput.value = '';
                }
            } else {
                showFeedback('Erro ao buscar empresa: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('[DEBUG] Erro ao buscar empresa:', error);
            showFeedback('Erro de conexão ao buscar empresa', 'error');
        });
    }

    function mostrarSeletorEmpresas(empresas) {
        // Remove seletor anterior se existir
        const seletorExistente = document.getElementById('empresa-selector');
        if (seletorExistente) {
            seletorExistente.remove();
        }

        // Criar seletor
        const seletor = document.createElement('div');
        seletor.id = 'empresa-selector';
        seletor.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 2px;
        `;

        empresas.forEach(empresa => {
            const opcao = document.createElement('div');
            opcao.style.cssText = `
                padding: 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                transition: background-color 0.2s;
            `;

            // Formatear CNPJs
            let cnpjDisplay = '';
            if (Array.isArray(empresa.cnpj)) {
                cnpjDisplay = empresa.cnpj.join(', ');
            } else {
                cnpjDisplay = empresa.cnpj;
            }

            opcao.innerHTML = `
                <div style="font-weight: bold; color: #1f2937;">${empresa.nome_cliente || empresa.razao_social}</div>
                <div style="font-size: 0.9em; color: #666;">${cnpjDisplay}</div>
            `;

            opcao.addEventListener('click', () => {
                adicionarEmpresa(empresa);
                seletor.remove();
                cnpjSearchInput.value = '';
            });

            opcao.addEventListener('mouseover', () => {
                opcao.style.backgroundColor = '#f3f4f6';
            });

            opcao.addEventListener('mouseout', () => {
                opcao.style.backgroundColor = 'white';
            });

            seletor.appendChild(opcao);
        });

        // Posicionar seletor
        const inputContainer = cnpjSearchInput.parentNode;
        inputContainer.style.position = 'relative';
        inputContainer.appendChild(seletor);
    }

    function adicionarEmpresa(empresa) {
        // Verificar se já foi adicionada
        const jaExiste = empresasSelecionadas.find(e => e.id === empresa.id);
        if (jaExiste) {
            showFeedback('Esta empresa já foi adicionada', 'warning');
            return;
        }

        empresasSelecionadas.push(empresa);
        updateEmpresasList();
        showFeedback(`Empresa "${empresa.nome_cliente || empresa.razao_social}" adicionada`, 'success');
    }

    function removerEmpresa(empresaId) {
        empresasSelecionadas = empresasSelecionadas.filter(e => e.id !== empresaId);
        updateEmpresasList();
        showFeedback('Empresa removida', 'info');
    }

    function updateEmpresasList() {
        if (empresasSelecionadas.length === 0) {
            empresasList.innerHTML = '<p style="color: var(--color-text-muted); font-style: italic;">Nenhuma empresa selecionada</p>';
            return;
        }

        const html = empresasSelecionadas.map(empresa => {
            let cnpjDisplay = '';
            if (Array.isArray(empresa.cnpj)) {
                cnpjDisplay = empresa.cnpj.join(', ');
            } else {
                cnpjDisplay = empresa.cnpj;
            }

            return `
                <div class="empresa-item" style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px;
                    background: #f0f9ff;
                    border: 1px solid #0ea5e9;
                    border-radius: 6px;
                    margin-bottom: 8px;
                ">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #0c4a6e;">${empresa.nome_cliente || empresa.razao_social}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${cnpjDisplay}</div>
                    </div>
                    <button type="button" 
                            onclick="removerEmpresa(${empresa.id})" 
                            style="
                                background: #dc2626;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                padding: 6px 8px;
                                cursor: pointer;
                                font-size: 0.8rem;
                            ">
                        <i class="mdi mdi-trash-can"></i>
                    </button>
                </div>
            `;
        }).join('');

        empresasList.innerHTML = html;
    }

    // Expor função para os botões
    window.removerEmpresa = removerEmpresa;

    // Event listeners
    if (btnBuscarEmpresa) {
        btnBuscarEmpresa.addEventListener('click', buscarEmpresa);
    }

    if (cnpjSearchInput) {
        cnpjSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarEmpresa();
            }
        });
    }

    // === VALIDAÇÃO E ENVIO ===
    if (form) {
        form.addEventListener('submit', function(e) {
            // Verificar se há mensagens flash de erro - se sim, não interceptar
            const flashMessages = document.querySelectorAll('.form-feedback:not(#form-feedback)');
            const hasErrorFlash = Array.from(flashMessages).some(msg => msg.classList.contains('error'));
            
            if (hasErrorFlash) {
                // Não interceptar - deixar o form ser enviado normalmente para mostrar as mensagens
                console.log('[DEBUG] Mensagem flash de erro detectada, permitindo envio normal');
                return true;
            }
            
            e.preventDefault();
            
            // Validações básicas
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirm_password');
            
            if (password && confirmPassword) {
                if (password.value !== confirmPassword.value) {
                    showFeedback('As senhas não coincidem', 'error');
                    return;
                }
                
                if (password.value.length < 6) {
                    showFeedback('A senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
            }

            // Validar email
            const emailInput = document.getElementById('email');
            if (emailInput) {
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email)) {
                    showFeedback('Formato de email inválido', 'error');
                    emailInput.focus();
                    return;
                }
            }

            showLoading(true);
            showFeedback('Salvando usuário...', 'info');

            // Submeter formulário
            const formData = new FormData(form);
            
            fetch(form.action || window.location.pathname, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // Se houve redirecionamento, significa que deu certo
                    showFeedback('Usuário salvo com sucesso!', 'success');
                    
                    // Se há empresas selecionadas e é um novo usuário, associar empresas
                    if (empresasSelecionadas.length > 0 && !form.dataset.userId) {
                        // Extrair ID do usuário da URL de redirecionamento
                        const url = new URL(response.url);
                        if (url.pathname.includes('/usuarios/')) {
                            // Assumir que voltou para a lista, usuário foi criado
                            setTimeout(() => {
                                window.location.href = response.url;
                            }, 1500);
                        } else {
                            window.location.href = response.url;
                        }
                    } else {
                        setTimeout(() => {
                            window.location.href = response.url;
                        }, 1500);
                    }
                } else {
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    // Se retornou HTML, verificar por mensagens de erro
                    if (html.includes('alert-danger') || html.includes('error') || html.includes('form-feedback error')) {
                        showFeedback('Erro ao salvar usuário. Recarregando página...', 'error');
                        // Recarregar página para mostrar mensagens flash
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showFeedback('Usuário salvo com sucesso!', 'success');
                        setTimeout(() => {
                            window.location.href = "{{ url_for('usuarios.index') }}";
                        }, 1500);
                    }
                }
            })
            .catch(error => {
                console.error('[DEBUG] Erro ao salvar:', error);
                showFeedback('Erro de conexão. Recarregando página...', 'error');
                // Recarregar página para mostrar mensagens flash
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .finally(() => {
                showLoading(false);
            });
        });
    }

    // === VALIDAÇÃO EM TEMPO REAL ===
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !emailRegex.test(email)) {
                this.classList.add('error');
                showFeedback('Formato de email inválido', 'warning');
            } else {
                this.classList.remove('error');
            }
        });
    }

    // Validação de confirmação de senha
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm_password');
    
    if (passwordField && confirmPasswordField) {
        function validatePasswordMatch() {
            const password = passwordField.value;
            const confirmPassword = confirmPasswordField.value;
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordField.classList.add('error');
            } else {
                confirmPasswordField.classList.remove('error');
            }
        }
        
        passwordField.addEventListener('input', validatePasswordMatch);
        confirmPasswordField.addEventListener('input', validatePasswordMatch);
    }

    console.log('[DEBUG] Formulário de usuários inicializado com sucesso');
});
</script>
{% endblock %}
