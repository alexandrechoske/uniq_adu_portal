{% extends 'base.html' %}
{% block title %}Exporta√ß√£o de Relat√≥rios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('export_relatorios.static', filename='export_relatorios/export_relatorios.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container export-page">
  <div class="actions-bar">
    <div class="actions-left">
      {{ breadcrumb([
        {'name': 'Menu Principal', 'icon': 'mdi mdi-home', 'url': url_for('menu.menu_home')},
        {'name': 'Exporta√ß√£o de Relat√≥rios', 'icon': 'mdi mdi-file-export'}
      ]) }}
    </div>
  </div>
  
  <div class="main-content">
    <div class="content-wrapper">
      <!-- Se√ß√£o de Filtros -->
      <div class="export-section">
        <div class="export-card">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800">
            <i class="mdi mdi-filter-variant text-blue-600"></i>
            Filtros de Busca
          </h2>
          
          <form id="form-filtros" class="space-y-6">
            <!-- Filtros principais -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data In√≠cio</label>
                <input type="date" name="date_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                <input type="date" name="date_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              <div class="multi-search-field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ref. Unique</label>
                <input type="text" name="ref_unique" placeholder="UN25/0000, UN25/0001, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                <div class="multi-search-hint">üí° Separe m√∫ltiplas refer√™ncias por v√≠rgula</div>
              </div>
              <div class="multi-search-field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ref. Importador</label>
                <input type="text" name="ref_importador" placeholder="REF-IMP-001, REF-IMP-002, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                <div class="multi-search-hint">üí° Separe m√∫ltiplas refer√™ncias por v√≠rgula</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ Cliente</label>
                <input type="text" name="cnpj_importador" placeholder="00.000.000/0000-00" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
            </div>

            <!-- Filtros avan√ßados -->
            <details class="group">
              <summary class="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-800 flex items-center gap-2 select-none">
                <i class="mdi mdi-chevron-right group-open:rotate-90 transition-transform"></i>
                Filtros Avan√ßados
              </summary>
              <div id="advanced-filters-container" class="mt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg">
                
                <!-- Modal (Dropdown) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Modal</label>
                  <select name="modal" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <option value="MAR√çTIMA">MAR√çTIMA</option>
                    <option value="A√âREA">A√âREA</option>
                    <option value="RODOVI√ÅRIA">RODOVI√ÅRIA</option>
                  </select>
                </div>
                
                <!-- Container -->
                <div class="multi-search-field">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Container</label>
                  <input type="text" name="container" placeholder="CXRU-159.565-5, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                  <div class="multi-search-hint">üí° Separe m√∫ltiplos containers por v√≠rgula</div>
                </div>
                
                <!-- Data Embarque -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Embarque (De)</label>
                  <input type="date" name="data_embarque_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Embarque (At√©) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Embarque (At√©)</label>
                  <input type="date" name="data_embarque_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Chegada -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Chegada (De)</label>
                  <input type="date" name="data_chegada_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Chegada (At√©) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Chegada (At√©)</label>
                  <input type="date" name="data_chegada_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Registro -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Registro (De)</label>
                  <input type="date" name="data_registro_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Registro (At√©) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Registro (At√©)</label>
                  <input type="date" name="data_registro_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Desembara√ßo -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Desembara√ßo (De)</label>
                  <input type="date" name="data_desembaraco_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Data Desembara√ßo (At√©) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data Desembara√ßo (At√©)</label>
                  <input type="date" name="data_desembaraco_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- URF/Destino (Dropdown com busca din√¢mica) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">URF/Destino</label>
                  <select name="urf_despacho" id="select-urf" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes carregadas dinamicamente -->
                  </select>
                </div>
                
                <!-- Exportador -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Exportador</label>
                  <input type="text" name="exportador_fornecedor" placeholder="Nome do exportador" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Canal (Dropdown) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Canal</label>
                  <select name="canal" id="select-canal" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <option value="Verde">Verde</option>
                    <option value="Amarelo">Amarelo</option>
                    <option value="Vermelho">Vermelho</option>
                    <option value="Cinza">Cinza</option>
                  </select>
                </div>
                
                <!-- N¬∫ DI -->
                <div class="multi-search-field">
                  <label class="block text-sm font-medium text-gray-700 mb-1">N¬∫ DI</label>
                  <input type="text" name="numero_di" placeholder="25/0000000-0, 25/0000001-1, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                  <div class="multi-search-hint">üí° Separe m√∫ltiplos n√∫meros por v√≠rgula</div>
                </div>
                
                <!-- Importador -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Importador</label>
                  <input type="text" name="importador" placeholder="Nome da empresa" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
                
                <!-- Status Sistema (Dropdown din√¢mico) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status Sistema</label>
                  <select name="status_sistema" id="select-status-sistema" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes carregadas dinamicamente -->
                  </select>
                </div>
                
                <!-- Status Timeline (Dropdown din√¢mico) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status Timeline</label>
                  <select name="status_timeline" id="select-status-timeline" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes carregadas dinamicamente -->
                  </select>
                </div>
                
                <!-- Pa√≠s de Proced√™ncia (Dropdown din√¢mico) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s de Proced√™ncia</label>
                  <select name="pais_procedencia" id="select-pais-procedencia" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes carregadas dinamicamente -->
                  </select>
                </div>
                
                <!-- Mercadoria/Material (Dropdown din√¢mico) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Mercadoria / Material</label>
                  <select name="mercadoria" id="select-mercadoria" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes carregadas dinamicamente -->
                  </select>
                </div>
                
              </div>
            </details>

            <!-- A√ß√µes -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
              <button type="button" id="btn-executar" class="px-6 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium flex items-center gap-2 transition-colors">
                <i class="mdi mdi-magnify"></i> 
                Executar Consulta
              </button>
              <div class="flex items-center gap-3">
                <span id="consulta-status" class="text-sm text-gray-500"></span>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Se√ß√£o de Resultados -->
      <div class="export-section">
        <div class="export-card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold flex items-center gap-2 text-gray-800">
              <i class="mdi mdi-table text-blue-600"></i>
              Resultados da Consulta
            </h2>
            <div class="flex items-center gap-2">
              <button type="button" id="btn-exportar-excel" disabled class="px-4 py-2 bg-gray-400 text-white rounded-md text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:bg-green-600">
                <i class="mdi mdi-file-excel"></i> 
                Exportar Excel
              </button>
              <button type="button" id="btn-exportar-csv" disabled class="px-4 py-2 bg-gray-400 text-white rounded-md text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:bg-blue-600">
                <i class="mdi mdi-file-delimited"></i> 
                Exportar CSV
              </button>
            </div>
          </div>
          
          <div id="tabela-wrapper">
            <table id="tabela-resultados">
              <thead>
                <tr id="thead-row"></tr>
              </thead>
              <tbody id="tbody-rows">
                <!-- Estado inicial: aguardando primeira consulta -->
                <tr>
                  <td colspan="100%" class="p-0 border-0">
                    <div class="tabela-empty-state">
                      <i class="mdi mdi-magnify-scan"></i>
                      <h3>Pronto para buscar</h3>
                      <p>Configure os filtros acima e clique em "Executar Consulta" para visualizar os dados hist√≥ricos de importa√ß√µes.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div id="paginacao" class="flex items-center justify-between mt-4 pt-3 border-t border-gray-200 text-sm text-gray-600 hidden">
            <div class="flex items-center gap-2">
              <button id="prev-page" class="px-3 py-1.5 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="mdi mdi-chevron-left"></i>
              </button>
              <span class="font-medium">
                P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span>
              </span>
              <button id="next-page" class="px-3 py-1.5 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="mdi mdi-chevron-right"></i>
              </button>
            </div>
            <div class="text-gray-500">
              <span id="total-registros"></span> registros encontrados
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Documentos -->
<div id="modal-documentos" class="modal-overlay hidden">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="mdi mdi-file-multiple"></i>
        Documentos do Processo
      </h3>
      <button id="modal-close" class="modal-close-btn">
        <i class="mdi mdi-close"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="modal-process-info">
        <span class="modal-ref-label">Refer√™ncia:</span>
        <span id="modal-ref-unique" class="modal-ref-value"></span>
        <button id="btn-download-all-zip" class="btn-download-all">
          <i class="mdi mdi-download-multiple"></i>
          Baixar Todos (ZIP)
        </button>
      </div>
      
      <div id="modal-docs-list" class="modal-docs-list">
        <!-- Lista de documentos ser√° inserida aqui -->
      </div>
      
      <div id="modal-loading" class="modal-loading hidden">
        <div class="spinner"></div>
        <p>Preparando download...</p>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('export_relatorios.static', filename='export_relatorios/export_relatorios.js') }}"></script>
{% endblock %}
