{% extends 'base.html' %}
{% block title %}Exporta√ß√£o de Relat√≥rios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('export_relatorios.static', filename='export_relatorios/export_relatorios.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container export-page">
  <div class="actions-bar">
    <div class="actions-left">
      {{ breadcrumb([
        {'name': 'Menu Principal', 'icon': 'mdi mdi-home', 'url': url_for('menu.menu_home')},
        {'name': 'Exporta√ß√£o de Relat√≥rios', 'icon': 'mdi mdi-file-export'}
      ]) }}
    </div>
  </div>
  
  <div class="main-content">
    <div class="content-wrapper">
      <!-- Header da p√°gina -->
      <div class="export-header">
        <h1 class="export-title">
          <i class="mdi mdi-file-export text-blue-600"></i>
          Exporta√ß√£o de Relat√≥rios
        </h1>
        <p class="export-description">
          Consulte e exporte dados hist√≥ricos de importa√ß√µes. Use os filtros para refinar sua busca e gerar relat√≥rios personalizados.
        </p>
        
        <!-- Informa√ß√µes de Seguran√ßa -->
        {% if security_info %}
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-2">
            <i class="mdi mdi-shield-check text-blue-600 text-lg mt-0.5"></i>
            <div class="text-sm">
              <p class="font-medium text-blue-800 mb-1">Acesso de Dados</p>
              {% if security_info.role == 'cliente_unique' %}
                {% if security_info.has_companies %}
                <p class="text-blue-700">Voc√™ tem acesso aos dados dos seguintes CNPJs:</p>
                <div class="mt-2 flex flex-wrap gap-1">
                  {% for cnpj in security_info.companies %}
                  <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">
                    {{ cnpj }}
                  </span>
                  {% endfor %}
                </div>
                {% else %}
                <p class="text-orange-700">Nenhum CNPJ associado √† sua conta. Entre em contato com o suporte.</p>
                {% endif %}
              {% elif security_info.role == 'interno_unique' %}
                {% if security_info.has_companies %}
                <p class="text-blue-700">Acesso restrito aos CNPJs: {{ security_info.companies|join(', ') }}</p>
                {% else %}
                <p class="text-blue-700">Acesso completo aos dados como usu√°rio interno.</p>
                {% endif %}
              {% elif security_info.role == 'admin' %}
                <p class="text-blue-700">Acesso administrativo completo a todos os dados.</p>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Se√ß√£o de Filtros -->
      <div class="export-section">
        <div class="export-card">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800">
            <i class="mdi mdi-filter-variant text-blue-600"></i>
            Filtros de Busca
          </h2>
          
          <form id="form-filtros" class="space-y-6">
            <!-- Filtros principais -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data In√≠cio</label>
                <input type="date" name="date_start" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                <input type="date" name="date_end" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              <div class="multi-search-field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ref. Importador</label>
                <input type="text" name="ref_importador" placeholder="REF-IMP-001, REF-IMP-002, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                <div class="multi-search-hint">üí° Separe m√∫ltiplas refer√™ncias por v√≠rgula</div>
              </div>
              <div class="multi-search-field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ref. Unique</label>
                <input type="text" name="ref_unique" placeholder="UN25/0000, UN25/0001, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                <div class="multi-search-hint">üí° Separe m√∫ltiplas refer√™ncias por v√≠rgula</div>
              </div>
              <div class="multi-search-field">
                <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero DI</label>
                <input type="text" name="numero_di" placeholder="25000000000, 25000000001, ..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                <div class="multi-search-hint">üí° Separe m√∫ltiplos n√∫meros por v√≠rgula</div>
              </div>
            </div>

            <!-- Filtros avan√ßados -->
            <details class="group">
              <summary class="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-800 flex items-center gap-2 select-none">
                <i class="mdi mdi-chevron-right group-open:rotate-90 transition-transform"></i>
                Filtros Avan√ßados
              </summary>
              <div class="mt-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg">
                {% set extra_cols = ['cnpj_importador','importador','modal','container','exportador_fornecedor','mercadoria','status_processo','status_macro','status_macro_sistema','urf_despacho','canal'] %}
                {% for col in extra_cols %}
                <div>
                  {% if col == 'cnpj_importador' %}
                    <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ Importador</label>
                    <input type="text" name="{{ col }}" placeholder="00.000.000/0000-00" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                  {% elif col == 'importador' %}
                    <label class="block text-sm font-medium text-gray-700 mb-1">Importador</label>
                    <input type="text" name="{{ col }}" placeholder="Nome da empresa" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                  {% else %}
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ col.replace('_', ' ').title() }}</label>
                    <input type="text" name="{{ col }}" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </details>

            <!-- A√ß√µes -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
              <button type="button" id="btn-executar" class="px-6 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium flex items-center gap-2 transition-colors">
                <i class="mdi mdi-magnify"></i> 
                Executar Consulta
              </button>
              <div class="flex items-center gap-3">
                <span id="consulta-status" class="text-sm text-gray-500"></span>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Se√ß√£o de Resultados -->
      <div class="export-section">
        <div class="export-card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold flex items-center gap-2 text-gray-800">
              <i class="mdi mdi-table text-blue-600"></i>
              Resultados da Consulta
            </h2>
            <button type="button" id="btn-exportar" disabled class="px-4 py-2 bg-gray-400 text-white rounded-md text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
              <i class="mdi mdi-download"></i> 
              Exportar CSV
            </button>
          </div>
          
          <div id="tabela-wrapper" class="overflow-auto">
            <table id="tabela-resultados" class="min-w-full">
              <thead>
                <tr id="thead-row"></tr>
              </thead>
              <tbody id="tbody-rows">
                <!-- Estado inicial: aguardando primeira consulta -->
                <tr>
                  <td colspan="100%" class="p-0 border-0">
                    <div class="tabela-empty-state">
                      <i class="mdi mdi-magnify-scan"></i>
                      <h3>Pronto para buscar</h3>
                      <p>Configure os filtros acima e clique em "Executar Consulta" para visualizar os dados hist√≥ricos de importa√ß√µes.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div id="paginacao" class="flex items-center justify-between mt-4 pt-3 border-t border-gray-200 text-sm text-gray-600 hidden">
            <div class="flex items-center gap-2">
              <button id="prev-page" class="px-3 py-1.5 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="mdi mdi-chevron-left"></i>
              </button>
              <span class="font-medium">
                P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span>
              </span>
              <button id="next-page" class="px-3 py-1.5 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="mdi mdi-chevron-right"></i>
              </button>
            </div>
            <div class="text-gray-500">
              <span id="total-registros"></span> registros encontrados
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('export_relatorios.static', filename='export_relatorios/export_relatorios.js') }}"></script>
{% endblock %}
