{% extends "base.html" %}

{% block title %}Analytics do Agente - UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('dashboard_executivo.static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('analytics.static', filename='css/analytics_portal.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container analytics-portal">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            <div class="analytics-header">
                <h1 class="analytics-title">
                    <i class="mdi mdi-robot"></i>
                    Analytics do Agente
                </h1>
                <p class="analytics-subtitle">Estatísticas de usabilidade e interações do agente inteligente</p>
            </div>
            <!-- Resumo de Filtros -->
            <div id="filter-summary" class="filter-summary">
                <span id="filter-summary-text">Vendo dados dos últimos 30 dias</span>
            </div>
        </div>
        <div class="actions-right">
            <button id="reset-filters" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-filter-off"></i>
                Remover Filtros
            </button>
            <button id="open-filters" class="btn btn-primary">
                <i class="mdi mdi-filter"></i>
                Filtros
            </button>
            <button id="refresh-data" class="btn btn-secondary">
                <i class="mdi mdi-refresh"></i>
                Atualizar
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div id="kpi-loading" class="component-loading"><div class="spinner"></div></div>
        <div class="kpi-card kpi-primary" id="interactions-card">
            <div class="kpi-icon">
                <i class="mdi mdi-chat-outline"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total de Interações</p>
                <p class="kpi-value" id="total-interactions">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>
        <div class="kpi-card kpi-success" id="unique-users-card">
            <div class="kpi-icon">
                <i class="mdi mdi-account-group"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Usuários Únicos</p>
                <p class="kpi-value" id="unique-users">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>
        <div class="kpi-card kpi-warning" id="companies-card">
            <div class="kpi-icon">
                <i class="mdi mdi-office-building"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Empresas Atendidas</p>
                <p class="kpi-value" id="companies-served">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>
        <div class="kpi-card kpi-info" id="success-rate-card">
            <div class="kpi-icon">
                <i class="mdi mdi-check-circle"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Taxa de Sucesso</p>
                <p class="kpi-value" id="success-rate">--</p>
                <p class="kpi-sub-value">Respostas processadas</p>
            </div>
        </div>
        <div class="kpi-card kpi-purple" id="avg-response-time-card">
            <div class="kpi-icon">
                <i class="mdi mdi-clock-outline"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Tempo Médio de Resposta</p>
                <p class="kpi-value" id="avg-response-time">--</p>
                <p class="kpi-sub-value">Últimas interações</p>
            </div>
        </div>
    </div>

    <!-- Charts Grid - Nova distribuição otimizada -->
    <!-- Primeira Linha: Interações Diárias (1/2) + Empresas Ativas (1/2) -->
    <div class="charts-grid two-columns">
        <div class="chart-section chart-half-width">
            <div class="chart-header">
                <h2 class="chart-title">Interações Diárias do Agente</h2>
                <div class="period-controls">
                    <button class="period-btn active" data-period="30d" data-chart="daily">30 Dias</button>
                    <button class="period-btn" data-period="7d" data-chart="daily">7 Dias</button>
                    <button class="period-btn" data-period="1d" data-chart="daily">Hoje</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="daily-loading" class="component-loading"><div class="spinner"></div></div>
                <canvas id="daily-interactions-chart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="summary-section chart-half-width">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="mdi mdi-office-building"></i>
                    Empresas Ativas
                </h2>
                <div class="chart-controls">
                    <span class="chart-count" id="company-summary-count">Carregando...</span>
                </div>
            </div>
            <div class="summary-container">
                <div id="company-summary-loading" class="component-loading"><div class="spinner"></div></div>
                <div id="company-summary-content" class="summary-content">
                    <!-- Dados carregados dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda Linha: Distribuição de Tipos (1/3) + Top Usuários (1/3) + Usuários Ativos (1/3) -->
    <div class="charts-grid three-columns">
        <div class="chart-section chart-one-third">
            <div class="chart-header">
                <h2 class="chart-title">Distribuição de Tipos</h2>
                <p class="chart-subtitle">Normais vs Documentos</p>
            </div>
            <div class="chart-container">
                <div id="interaction-types-loading" class="component-loading"><div class="spinner"></div></div>
                <canvas id="interaction-types-chart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="chart-section chart-one-third">
            <div class="chart-header">
                <h2 class="chart-title">Top Usuários</h2>
                <p class="chart-subtitle">Mais ativos</p>
            </div>
            <div class="chart-container">
                <div id="top-users-chart-loading" class="component-loading"><div class="spinner"></div></div>
                <canvas id="top-users-chart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="enhanced-table-section chart-one-third">
            <div class="enhanced-table-header">
                <h2 class="enhanced-table-title">
                    <i class="mdi mdi-account-star"></i>
                    Usuários Ativos
                </h2>
                <div class="enhanced-table-controls">
                    <div class="enhanced-table-info">
                        <span class="enhanced-table-count" id="users-count">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="enhanced-table-container">
                <div id="top-users-loading" class="component-loading"><div class="spinner"></div></div>
                <table id="top-users-table" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Interações</th>
                            <th>Última Atividade</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detalhes das Interações - Largura Total -->
    <div class="enhanced-table-section" id="interaction-details-container">
        <div class="enhanced-table-header">
            <h2 class="enhanced-table-title">
                <i class="mdi mdi-chat-processing"></i>
                Detalhes das Interações
            </h2>
            <div class="enhanced-table-controls">
                <div class="enhanced-table-info">
                    <span class="enhanced-table-count" id="interaction-details-count">Carregando...</span>
                </div>
                <button id="load-more-details" class="btn btn-secondary">
                    <i class="mdi mdi-refresh"></i>
                    Carregar Mais
                </button>
            </div>
        </div>
        <div class="enhanced-table-container">
            <div id="interaction-details-loading" class="component-loading"><div class="spinner"></div></div>
            <table id="interaction-details-table" class="enhanced-table">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Usuário</th>
                        <th>Empresa</th>
                        <th>Pergunta/Solicitação</th>
                        <th>Tipo Interação</th>
                        <th>Tempo Resposta</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados carregados dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Interaction Details Modal -->
<div id="interaction-modal" class="modal" style="display: none;">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="mdi mdi-chat-outline"></i>
                Detalhes da Interação
            </h3>
            <button class="modal-close" id="close-interaction-modal">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="interaction-details">
                <div class="interaction-section">
                    <h4><i class="mdi mdi-account"></i> Informações do Usuário</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Nome:</label>
                            <span id="modal-user-name">-</span>
                        </div>
                        <div class="detail-item">
                            <label>WhatsApp:</label>
                            <span id="modal-whatsapp">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Empresa:</label>
                            <span id="modal-empresa">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Data/Hora:</label>
                            <span id="modal-timestamp">-</span>
                        </div>
                    </div>
                </div>

                <div class="interaction-section">
                    <h4><i class="mdi mdi-message-text"></i> Pergunta do Usuário</h4>
                    <div class="message-content">
                        <div id="modal-user-message" class="user-message">-</div>
                    </div>
                </div>

                <div class="interaction-section">
                    <h4><i class="mdi mdi-robot"></i> Resposta do Agente</h4>
                    <div class="response-info">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Tipo:</label>
                                <span id="modal-response-type" class="badge">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Processos Encontrados:</label>
                                <span id="modal-processes-found">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Empresas:</label>
                                <span id="modal-companies-found">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Tempo de Resposta:</label>
                                <span id="modal-response-time">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="agent-response-content">
                        <label>Resposta Completa:</label>
                        <div id="modal-agent-response" class="agent-response">-</div>
                    </div>
                </div>

                <div class="interaction-section">
                    <h4><i class="mdi mdi-information"></i> Informações Técnicas</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Status:</label>
                            <span id="modal-status" class="badge">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Session ID:</label>
                            <span id="modal-session-id">-</span>
                        </div>
                        <div class="detail-item">
                            <label>Instância:</label>
                            <span id="modal-instance">-</span>
                        </div>
                        <div class="detail-item">
                            <label>CNPJs Consultados:</label>
                            <span id="modal-cnpjs">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros -->
<div id="filters-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Filtros de Analytics do Agente</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="filter-group">
                <label for="date-range">Período:</label>
                <select id="date-range">
                    <option value="30d" selected>Últimos 30 dias</option>
                    <option value="7d">Últimos 7 dias</option>
                    <option value="1d">Hoje</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            <div class="filter-group" id="custom-dates" style="display: none;">
                <label for="start-date">Data Inicial:</label>
                <input type="date" id="start-date">
                <label for="end-date">Data Final:</label>
                <input type="date" id="end-date">
            </div>
            <div class="filter-group">
                <label for="response-type">Tipo de Resposta:</label>
                <select id="response-type">
                    <option value="all" selected>Todos</option>
                    <option value="normal">Resposta Normal</option>
                    <option value="arquivo">Arquivo/Documento</option>
                    <option value="error">Com Erro</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="company-filter">Empresa:</label>
                <select id="company-filter">
                    <option value="all" selected>Todas</option>
                    <!-- Opções carregadas dinamicamente -->
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button id="apply-filters" class="btn btn-primary">Aplicar Filtros</button>
            <button id="clear-filters" class="btn btn-secondary">Limpar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="{{ url_for('analytics.static', filename='js/analytics_agente.js') }}"></script>
<script>
// Sistema de loading específico para Analytics do Agente
const AGENTE_HIDE_LOADER = (id) => { 
    const el = document.getElementById(id); 
    if (el) { 
        el.style.display = 'none'; 
        console.log('[AGENTE_ANALYTICS] Loader hidden:', id); 
    } 
};

const AGENTE_TRY_WRAP = (name, id) => {
    const fn = window[name];
    if (typeof fn === 'function') {
        window[name] = function() {
            const r = fn.apply(this, arguments);
            try { AGENTE_HIDE_LOADER(id); } catch (_) {}
            return r;
        };
        console.log('[AGENTE_ANALYTICS] Wrapped function:', name, '-> hides', id);
    }
};

// Aplicar wrappers após carregar analytics_agente.js
document.addEventListener('DOMContentLoaded', function() {
    AGENTE_TRY_WRAP('updateKPIs', 'kpi-loading');
    AGENTE_TRY_WRAP('createInteractionsChart', 'daily-loading');
    AGENTE_TRY_WRAP('createInteractionTypesChart', 'interaction-types-loading');
    AGENTE_TRY_WRAP('createTopUsersChart', 'top-users-chart-loading');
    AGENTE_TRY_WRAP('createTopCompaniesChart', 'top-companies-chart-loading');
    AGENTE_TRY_WRAP('updateUsersTable', 'top-users-loading');
    AGENTE_TRY_WRAP('updateInteractionDetailsTable', 'interaction-details-loading');

    // Fallback: observar linhas das tabelas para esconder loaders quando houver conteúdo
    const observeRows = (tableSelector, loaderId) => {
        const table = document.querySelector(tableSelector);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        const mo = new MutationObserver(() => {
            if (tbody.children.length > 0) { AGENTE_HIDE_LOADER(loaderId); mo.disconnect(); }
        });
        mo.observe(tbody, { childList: true });
    };
    observeRows('#top-users-table', 'top-users-loading');
    observeRows('#interaction-details-table', 'interaction-details-loading');

    // Safety timeout para evitar loader preso
    setTimeout(() => {
        ['kip-loading','daily-loading','interaction-types-loading','top-users-chart-loading','top-companies-chart-loading','top-users-loading','interaction-details-loading']
            .forEach(AGENTE_HIDE_LOADER);
        console.warn('[AGENTE_ANALYTICS] Safety timeout reached. Forced hiding of loaders.');
    }, 20000);
});
</script>
{% endblock %}
