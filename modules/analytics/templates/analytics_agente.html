{% extends "base.html" %}

{% block title %}Analytics do Agente - UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('dashboard_executivo.static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('analytics.static', filename='css/analytics_agente.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container analytics-agente">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            <div class="analytics-header">
                <h1 class="analytics-title">
                    <i class="mdi mdi-robot"></i>
                    Analytics do Agente
                </h1>
                <p class="analytics-subtitle">Estatísticas de uso e interações com o Agente Unique</p>
            </div>
        </div>
        <div class="actions-right">
            <button id="refresh-data" class="btn btn-secondary">
                <i class="mdi mdi-refresh"></i>
                Atualizar
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div id="kpi-loading" class="component-loading"><div class="spinner"></div></div>
        
        <div class="kpi-card kpi-primary" id="interactions-card">
            <div class="kpi-icon">
                <i class="mdi mdi-message-text"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total de Interações</p>
                <p class="kpi-value" id="total-interactions">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-secondary" id="users-card">
            <div class="kpi-icon">
                <i class="mdi mdi-account-group"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Usuários Únicos</p>
                <p class="kpi-value" id="unique-users">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-info" id="companies-card">
            <div class="kpi-icon">
                <i class="mdi mdi-domain"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Empresas Atendidas</p>
                <p class="kpi-value" id="unique-companies">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-success" id="success-rate-card">
            <div class="kpi-icon">
                <i class="mdi mdi-check-circle"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Taxa de Sucesso</p>
                <p class="kpi-value" id="success-rate">--</p>
                <p class="kpi-sub-value">Respostas processadas</p>
            </div>
        </div>

        <div class="kpi-card kpi-warning" id="response-time-card">
            <div class="kpi-icon">
                <i class="mdi mdi-timer"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Tempo Médio de Resposta</p>
                <p class="kpi-value" id="avg-response-time">--</p>
                <p class="kpi-sub-value">Últimas interações</p>
            </div>
        </div>

        <div class="kpi-card kpi-primary" id="normal-responses-card">
            <div class="kpi-icon">
                <i class="mdi mdi-chat"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Respostas Normais</p>
                <p class="kpi-value" id="normal-responses">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-secondary" id="arquivo-responses-card">
            <div class="kpi-icon">
                <i class="mdi mdi-file-document"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Solicitações de Arquivo</p>
                <p class="kpi-value" id="arquivo-responses">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>
    </div>

    <!-- Gráfico de Interações - Largura Completa -->
    <div class="chart-section">
        <div class="chart-header">
            <h2 class="chart-title">
                <i class="mdi mdi-chart-line"></i>
                Interações ao Longo do Tempo
            </h2>
        </div>
        <div class="chart-content">
            <div id="interactions-chart-loading" class="component-loading"><div class="spinner"></div></div>
            <canvas id="interactions-chart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- Container para as duas tabelas lado a lado -->
    <div class="tables-side-by-side-container">
        <!-- Top Empresas - 50% width -->
        <div class="enhanced-table-section table-half-width">
            <div class="enhanced-table-header">
                <h2 class="enhanced-table-title">
                    <i class="mdi mdi-trophy"></i>
                    Empresas que Mais Usam
                </h2>
            </div>
            <div id="top-companies-loading" class="component-loading"><div class="spinner"></div></div>
            <div id="top-companies-table" class="enhanced-table-container"></div>
        </div>
        
        <!-- Top Usuários - 50% width -->
        <div class="enhanced-table-section table-half-width">
            <div class="enhanced-table-header">
                <h2 class="enhanced-table-title">
                    <i class="mdi mdi-account-star"></i>
                    Usuários que Mais Usam
                </h2>
            </div>
            <div id="top-users-loading" class="component-loading"><div class="spinner"></div></div>
            <div id="top-users-table" class="enhanced-table-container"></div>
        </div>
    </div>

    <!-- Recent Interactions Table -->
    <div class="enhanced-table-section">
        <div class="enhanced-table-header">
            <h2 class="enhanced-table-title">
                <i class="mdi mdi-clock-outline"></i>
                Interações Recentes
            </h2>
        </div>
        <div id="recent-interactions-loading" class="component-loading"><div class="spinner"></div></div>
        <div id="recent-interactions-table" class="enhanced-table-container"></div>
    </div>
</div>

<!-- Modal para detalhes da interação -->
<div class="modal fade" id="interactionModal" tabindex="-1" aria-labelledby="interactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="interactionModalLabel">
                    <i class="mdi mdi-message-text-outline"></i>
                    Detalhes da Interação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Informações do Usuário -->
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Usuário</div>
                            <div id="modal-user-name" class="detail-value">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">WhatsApp</div>
                            <div id="modal-whatsapp" class="detail-value">-</div>
                        </div>
                    </div>
                    
                    <!-- Informações da Empresa -->
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Empresa</div>
                            <div id="modal-empresa" class="detail-value">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Data/Hora</div>
                            <div id="modal-timestamp" class="detail-value">-</div>
                        </div>
                    </div>
                    
                    <!-- Tipos e Métricas -->
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Tipo de Mensagem</div>
                            <div id="modal-message-type" class="detail-value">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Tipo de Resposta</div>
                            <div id="modal-response-type" class="detail-value">-</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Processos Encontrados</div>
                            <div id="modal-processos" class="detail-value">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-group">
                            <div class="detail-label">Tempo de Resposta</div>
                            <div id="modal-response-time" class="detail-value">-</div>
                        </div>
                    </div>
                    
                    <!-- Mensagens -->
                    <div class="col-md-12">
                        <div class="detail-group">
                            <div class="detail-label">Mensagem do Usuário</div>
                            <div id="modal-user-message" class="detail-value" style="max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="detail-group">
                            <div class="detail-label">Resposta do Agente</div>
                            <div id="modal-agent-response" class="detail-value" style="max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="col-md-12">
                        <div id="modal-success-status" class="detail-group">
                            <div class="detail-label">Status da Interação</div>
                            <div id="modal-status-text" class="detail-value">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('analytics.static', filename='js/analytics_agente.js') }}"></script>
{% endblock %}
