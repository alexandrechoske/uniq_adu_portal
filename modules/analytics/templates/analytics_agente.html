{% extends "base.html" %}

{% block title %}Analytics do Agente - UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('dashboard_executivo.static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('analytics.static', filename='css/analytics_agente.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container analytics-agente">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            <div class="analytics-header">
                <h1 class="analytics-title">
                    <i class="mdi mdi-robot"></i>
                    Analytics do Agente
                </h1>
                <p class="analytics-subtitle">Estatísticas de uso e interações com o Agente Unique</p>
            </div>
        </div>
        <div class="actions-right">
            <button id="refresh-data" class="btn btn-secondary">
                <i class="mdi mdi-refresh"></i>
                Atualizar
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div id="kpi-loading" class="component-loading"><div class="spinner"></div></div>
        
        <div class="kpi-card kpi-primary" id="interactions-card">
            <div class="kpi-icon">
                <i class="mdi mdi-message-text"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total de Interações</p>
                <p class="kpi-value" id="total-interactions">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-secondary" id="users-card">
            <div class="kpi-icon">
                <i class="mdi mdi-account-group"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Usuários Únicos</p>
                <p class="kpi-value" id="unique-users">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-info" id="companies-card">
            <div class="kpi-icon">
                <i class="mdi mdi-domain"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Empresas Atendidas</p>
                <p class="kpi-value" id="unique-companies">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-success" id="success-rate-card">
            <div class="kpi-icon">
                <i class="mdi mdi-check-circle"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Taxa de Sucesso</p>
                <p class="kpi-value" id="success-rate">--</p>
                <p class="kpi-sub-value">Respostas processadas</p>
            </div>
        </div>

        <div class="kpi-card kpi-warning" id="response-time-card">
            <div class="kpi-icon">
                <i class="mdi mdi-timer"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Tempo Médio de Resposta</p>
                <p class="kpi-value" id="avg-response-time">--</p>
                <p class="kpi-sub-value">Últimas interações</p>
            </div>
        </div>

        <div class="kpi-card kpi-primary" id="normal-responses-card">
            <div class="kpi-icon">
                <i class="mdi mdi-chat"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Respostas Normais</p>
                <p class="kpi-value" id="normal-responses">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>

        <div class="kpi-card kpi-secondary" id="arquivo-responses-card">
            <div class="kpi-icon">
                <i class="mdi mdi-file-document"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Solicitações de Arquivo</p>
                <p class="kpi-value" id="arquivo-responses">--</p>
                <p class="kpi-sub-value">Últimos 30 dias</p>
            </div>
        </div>
    </div>

    <!-- Charts and Companies Grid -->
    <div class="charts-grid">
        <!-- Container for Chart and Companies side by side -->
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- Gráfico de Interações - 70% width -->
            <div class="chart-section" style="flex: 0 0 70%;">
                <div class="chart-header">
                    <h2 class="chart-title">Interações ao Longo do Tempo</h2>
                </div>
                <div class="chart-container">
                    <div id="interactions-chart-loading" class="component-loading"><div class="spinner"></div></div>
                    <canvas id="interactions-chart" class="chart-canvas"></canvas>
                </div>
            </div>
            
            <!-- Top Empresas - 30% width -->
            <div class="enhanced-table-section" style="flex: 0 0 30%;">
                <div class="enhanced-table-header">
                    <h2 class="enhanced-table-title">
                        <i class="mdi mdi-trophy"></i>
                        Empresas que Mais Usam
                    </h2>
                </div>
                <div id="top-companies-loading" class="component-loading"><div class="spinner"></div></div>
                <div id="top-companies-table" class="enhanced-table-container"></div>
            </div>
        </div>
    </div>

    <!-- Recent Interactions Table -->
    <div class="enhanced-table-section">
        <div class="enhanced-table-header">
            <h2 class="enhanced-table-title">
                <i class="mdi mdi-clock-outline"></i>
                Interações Recentes
            </h2>
        </div>
        <div id="recent-interactions-loading" class="component-loading"><div class="spinner"></div></div>
        <div id="recent-interactions-table" class="enhanced-table-container"></div>
    </div>
</div>

<!-- Modal para detalhes da interação -->
<div class="modal fade" id="interactionModal" tabindex="-1" aria-labelledby="interactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="interactionModalLabel">Detalhes da Interação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Usuário:</strong>
                        <p id="modal-user-name" class="text-muted">-</p>
                    </div>
                    <div class="col-md-6">
                        <strong>WhatsApp:</strong>
                        <p id="modal-whatsapp" class="text-muted">-</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Empresa:</strong>
                        <p id="modal-empresa" class="text-muted">-</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Data/Hora:</strong>
                        <p id="modal-timestamp" class="text-muted">-</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Tipo de Mensagem:</strong>
                        <span id="modal-message-type" class="badge bg-secondary">-</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Tipo de Resposta:</strong>
                        <span id="modal-response-type" class="badge bg-info">-</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Processos Encontrados:</strong>
                        <span id="modal-processos" class="badge bg-success">-</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Tempo de Resposta:</strong>
                        <span id="modal-response-time" class="badge bg-warning">-</span>
                    </div>
                    <div class="col-md-12 mt-3">
                        <strong>Mensagem do Usuário:</strong>
                        <div id="modal-user-message" class="bg-light p-3 rounded mt-2" style="max-height: 150px; overflow-y: auto;">-</div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <strong>Resposta do Agente:</strong>
                        <div id="modal-agent-response" class="bg-light p-3 rounded mt-2" style="max-height: 200px; overflow-y: auto;">-</div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <div id="modal-success-status" class="alert" role="alert">
                            Status da interação será exibido aqui
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('analytics.static', filename='js/analytics_agente.js') }}"></script>
{% endblock %}
