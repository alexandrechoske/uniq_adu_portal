{% extends "base.html" %}

{% block title %}Usuários Online - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
<link rel="stylesheet" href="{{ url_for('usuarios_online.static', filename='usuarios_online/usuarios_online.css') }}">
{% endblock %}

{% block content %}
<div class="usuarios-online-container">
    <div class="actions-bar module-header-generic">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Administração', 'icon': 'mdi mdi-shield-crown'},
                {'name': 'Usuários Online', 'icon': 'mdi mdi-account-multiple-check'}
            ], 'default') }}
        </div>
        <div class="actions-right">
            <div class="update-info text-muted me-3" style="font-size: 0.85rem;">
                <i class="mdi mdi-clock-outline"></i> Atualização automática: <span id="countdown">30</span>s
            </div>
            <button type="button" class="btn btn-light btn-cleanup" onclick="cleanupSessions()">
                <i class="mdi mdi-broom"></i>
                Limpar Sessões Inativas
            </button>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <i class="mdi mdi-account-check"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Usuários Online</p>
                <p class="kpi-value" id="online-count">0</p>
            </div>
        </div>
        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <i class="mdi mdi-account-tie"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Time Interno</p>
                <p class="kpi-value" id="admin-count">0</p>
            </div>
        </div>
        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <i class="mdi mdi-file-multiple"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Páginas Ativas</p>
                <p class="kpi-value" id="page-count">0</p>
            </div>
        </div>
    </div>

    <section class="users-section mt-4">
        <div class="users-table-wrapper">
            <table class="users-table" id="online-users-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Página Atual</th>
                        <th>IP</th>
                        <th>Visto por último</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr class="empty-state-row">
                        <td colspan="4">
                            <div class="empty-state">
                                <i class="mdi mdi-account-off-outline"></i>
                                <h3>Nenhum usuário online</h3>
                                <p>Assim que um usuário conectar, ele aparecerá aqui automaticamente.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Removido Socket.IO, usando Polling + Heartbeat
const onlineUsers = new Map();

const usersTableBody = document.getElementById('users-table-body');
const onlineCount = document.getElementById('online-count');
const adminCount = document.getElementById('admin-count');
const pageCount = document.getElementById('page-count');

async function fetchOnlineUsers() {
    try {
        const response = await fetch('/usuarios-online/api/online-users');
        if (!response.ok) throw new Error('Erro na API');
        
        const data = await response.json();
        
        onlineUsers.clear();
        if (data.users) {
            data.users.forEach(user => {
                onlineUsers.set(user.user_id, user);
            });
        }
        
        renderUsers();
        
    } catch (error) {
        console.error('Erro ao buscar usuários:', error);
    }
}

function renderUsers() {
    const count = onlineUsers.size;
    onlineCount.textContent = count;

    const internos = Array.from(onlineUsers.values()).filter(u => u.user_role === 'interno_unique' || u.user_role === 'admin').length;
    adminCount.textContent = internos;

    const pages = new Set(Array.from(onlineUsers.values()).map(u => u.current_page));
    pageCount.textContent = pages.size;

    if (count === 0) {
        usersTableBody.innerHTML = `
            <tr class="empty-state-row">
                <td colspan="4">
                    <div class="empty-state">
                        <i class="mdi mdi-account-off-outline"></i>
                        <h3>Nenhum usuário online</h3>
                        <p>Assim que um usuário conectar, ele aparecerá aqui automaticamente.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    const sortedUsers = Array.from(onlineUsers.values()).sort((a, b) => {
        return new Date(b.last_seen) - new Date(a.last_seen);
    });

    const rowsHtml = sortedUsers.map(createUserRow).join('');
    usersTableBody.innerHTML = rowsHtml;
}

function createUserRow(user) {
    const initials = getInitials(user.user_name);
    const roleLabel = getRoleLabel(user.user_role);
    const timeAgo = formatTimeAgo(user.last_seen);

    let pageDisplay = 'Portal Unique';
    if (user.page_title && user.page_title !== 'Portal Unique') {
        pageDisplay = user.page_title;
    } else if (user.current_page && user.current_page !== '/') {
        pageDisplay = user.current_page;
    }

    const roleClass = getRoleClass(user.user_role);

    return `
        <tr>
            <td>
                <div class="user-cell">
                    <div class="user-avatar" aria-hidden="true">${initials}</div>
                    <div class="user-info">
                        <span class="user-name">${user.user_name}</span>
                        <span class="user-email">${user.user_email}</span>
                        <span class="user-role-tag ${roleClass}">${roleLabel}</span>
                    </div>
                </div>
            </td>
            <td>
                <div class="page-cell" title="${user.current_page || '/'}">
                    <span class="page-title">${pageDisplay}</span>
                    <span class="page-path">${user.current_page || '/'}</span>
                </div>
            </td>
            <td>
                <span class="ip-cell">${user.ip_address || 'N/A'}</span>
            </td>
            <td>
                <div class="status-cell">
                    <span class="status-badge status-online">Online</span>
                    <span class="status-time">Visto ${timeAgo}</span>
                </div>
            </td>
        </tr>
    `;
}

function getInitials(name) {
    if (!name) return 'U';
    return name
        .split(' ')
        .filter(Boolean)
        .map(word => word[0])
        .join('')
        .toUpperCase()
        .substring(0, 2);
}

function getRoleClass(role) {
    if (role === 'admin') return 'role-admin';
    if (role === 'interno_unique') return 'role-interno';
    return 'role-cliente';
}

function getRoleLabel(role) {
    if (role === 'admin') return 'Administrador';
    if (role === 'interno_unique') return 'Interno';
    return 'Cliente';
}

function formatTimeAgo(timestamp) {
    if (!timestamp) return 'agora mesmo';

    try {
        const now = new Date();
        const time = new Date(timestamp);

        if (isNaN(time.getTime())) {
            console.warn('Timestamp inválido:', timestamp);
            return 'agora mesmo';
        }

        const diff = Math.floor((now - time) / 1000);

        if (diff < 0) return 'agora mesmo';
        if (diff < 30) return 'agora mesmo';
        if (diff < 60) return `${diff}s atrás`;
        if (diff < 3600) return `${Math.floor(diff / 60)}m atrás`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h atrás`;
        return `${Math.floor(diff / 86400)}d atrás`;
    } catch (error) {
        console.error('Erro ao formatar timestamp:', error);
        return 'agora mesmo';
    }
}

async function cleanupSessions() {
    if (!confirm('Deseja limpar todas as sessões inativas?')) {
        return;
    }

    try {
        const res = await fetch('/usuarios-online/api/cleanup-sessions', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            alert('✅ Sessões inativas limpas com sucesso!');
            fetchOnlineUsers();
        } else {
            alert('❌ Erro ao limpar sessões: ' + data.error);
        }
    } catch (error) {
        alert('❌ Erro: ' + error.message);
    }
}

// Inicialização
fetchOnlineUsers();

// Polling a cada 30 segundos com countdown
let timeLeft = 30;
const countdownEl = document.getElementById('countdown');

setInterval(() => {
    timeLeft--;
    if (countdownEl) countdownEl.textContent = timeLeft;
    
    if (timeLeft <= 0) {
        fetchOnlineUsers();
        timeLeft = 30;
    }
}, 1000);
</script>
{% endblock %}
