{% extends "base.html" %}

{% block title %}GestÃ£o de Faturamento - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('fin_faturamento.static', filename='css/faturamento.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='shared/process_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="faturamento-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-currency-usd', 'url': '#'},
                {'name': 'Faturamento', 'icon': 'mdi mdi-receipt'}
            ], 'financeiro') }}
            <!-- Resumo de Filtros -->
            <div id="filter-summary" class="filter-summary">
                <span id="filter-summary-text">Vendo dados do ano atual</span>
            </div>
        </div>
        <div class="actions-right">
            <button id="reset-filters" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-filter-off"></i>
                Remover Filtros
            </button>
            <button id="open-filters" class="btn btn-primary">
                <i class="mdi mdi-filter"></i>
                Filtros
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="last-update">Carregando dados de faturamento...</p>
        </div>
    </div>
    
    <!-- Elementos de loading especÃ­ficos -->
    <div id="loading-kpis" style="display: none;"></div>
    <div id="loading-comparativo" style="display: none;"></div>
    <div id="loading-centro-resultado" style="display: none;"></div>
    <div id="loading-categoria-operacao" style="display: none;"></div>
    <div id="loading-top-clientes" style="display: none;"></div>
    <div id="loading-tabela" style="display: none;"></div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="tab-button active" data-tab="visao-geral">VisÃ£o Geral</button>
        <button class="tab-button" data-tab="analise-setor">AnÃ¡lise por Setor</button>
    </div>
    
    <!-- VisÃ£o Geral Tab -->
    <div class="tab-content active" id="visao-geral-tab">
        <!-- Filter Summary (removed from here as it's now in the actions bar) -->
        
        <!-- KPI Cards Expandidos -->
        <div class="kpi-grid-enhanced">
            <div class="kpi-card kpi-success" id="kpi-total-faturado">
                <div class="kpi-icon">
                    <i class="mdi mdi-currency-usd"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Faturado (Ano Atual)</p>
                    <p class="kpi-value" id="kpi-total-faturamento">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-info" id="kpi-crescimento-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-up"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Crescimento vs Ano Anterior</p>
                    <p class="kpi-value" id="kpi-crescimento-anual">-</p>
                    <p class="kpi-sub-value" id="kpi-crescimento-contexto" style="margin-top:4px;font-size:0.75rem;color:#666;">Acumulado atÃ© o mÃªs atual</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-warning" id="kpi-melhor-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trophy"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Melhor MÃªs</p>
                    <p class="kpi-value" id="kpi-melhor-mes">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-red" id="kpi-pior-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-down"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Pior MÃªs</p>
                    <p class="kpi-value" id="kpi-pior-mes">-</p>
                </div>
            </div>

            <div class="kpi-card kpi-aderencia-meta" id="kpi-aderencia-meta-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-target"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">AderÃªncia Ã  Meta</p>
                    <p class="kpi-value" id="kpi-aderencia-meta">-</p>
                    <p class="kpi-sub-value" id="kpi-aderencia-meta-contexto" style="margin-top:4px;font-size:0.75rem;color:#666;">Realizado vs Meta acumulada</p>
                </div>
            </div>
        </div>

        <!-- Charts Grid Reorganizado -->
        <div class="charts-grid-enhanced">
            <!-- GrÃ¡fico Comparativo Anual (Full Width) -->
            <div class="chart-container-full">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-line"></i>
                        <span id="comparativo-chart-title">Comparativo Anual de Faturamento</span>
                    </h3>
                    <div class="chart-controls">
                        <button id="toggle-meta-comparativo" class="btn btn-outline-primary btn-sm me-2">
                            <i class="mdi mdi-target"></i>
                            Meta vs Realizado
                        </button>
                        <button id="toggle-data-labels" class="btn btn-outline-secondary btn-sm">
                            <i class="mdi mdi-tag-text"></i>
                            RÃ³tulos de Dados
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="comparativo-chart"></canvas>
                </div>
            </div>
            
            <!-- Tabela de Faturamento Mensal (embaixo do grÃ¡fico) -->
            <div class="chart-container-full">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-table"></i>
                        Faturamento Mensal Resumido
                    </h3>
                </div>
                <div class="chart-content">
                    <table id="resumo-mensal" class="enhanced-table compact">
                        <thead>
                            <tr>
                                <th>MÃªs</th>
                                <!-- Anos serÃ£o adicionados dinamicamente -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Segunda linha - GrÃ¡ficos de Rosca e Tabela de Clientes -->
        <div class="charts-grid-three-cols">
            <!-- GrÃ¡fico de Rosca - Centro de Resultado -->
            <div class="chart-container" id="centro-resultado-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-donut"></i>
                        <span id="centro-resultado-title">Centro de Resultado</span>
                    </h3>
                    <div class="chart-actions">
                        <button id="centro-resultado-voltar" class="btn btn-sm btn-outline-secondary" style="display: none;">
                            <i class="mdi mdi-arrow-left"></i>
                            Voltar
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <p id="centro-resultado-info" class="text-muted mb-2" style="font-size: 0.875rem;">
                        ðŸ’¡ Clique em uma fatia do grÃ¡fico para ver mais detalhes
                    </p>
                    <canvas id="centro-resultado-chart"></canvas>
                </div>
            </div>
            
            <!-- GrÃ¡fico de Rosca - Categoria -->
            <div class="chart-container" id="categoria-operacao-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-pie"></i>
                        Categoria
                    </h3>
                </div>
                <div class="chart-content">
                    <canvas id="categoria-operacao-chart"></canvas>
                </div>
            </div>
            
            <!-- Tabela Top 10 Clientes -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-account-star"></i>
                        Top 10 Clientes
                    </h3>
                </div>
                <div class="chart-content">
                    <table id="top-clientes-table" class="enhanced-table compact">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor (R$)</th>
                                <th>% do Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AnÃ¡lise por Setor Tab - Layout OnePage -->
    <div class="tab-content" id="analise-setor-tab">
        <!-- Header com Filtro de Setor -->
        <div class="setor-filter-header">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="mdi mdi-filter"></i>
                        Selecionar Setor:
                    </label>
                    <div class="sector-buttons">
                        <button class="sector-btn active" data-setor="importacao">
                            <i class="mdi mdi-import"></i>
                            ImportaÃ§Ã£o
                        </button>
                        <button class="sector-btn" data-setor="exportacao">
                            <i class="mdi mdi-export"></i>
                            ExportaÃ§Ã£o
                        </button>
                        <button class="sector-btn" data-setor="consultoria">
                            <i class="mdi mdi-account-tie"></i>
                            Consultoria
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Container DinÃ¢mico - Setor Selecionado -->
        <div id="dynamic-sector-content">
            <!-- KPIs DinÃ¢micos -->
            <div class="kpi-grid-setor">
                <div class="kpi-card kpi-primary" id="kpi-faturamento-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-currency-usd"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Faturamento Total</p>
                        <p class="kpi-value" id="valor-faturamento-setor">-</p>
                        <p class="kpi-description" id="desc-faturamento-setor">Carregando...</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info" id="kpi-participacao-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">% ParticipaÃ§Ã£o</p>
                        <p class="kpi-value" id="valor-participacao-setor">-</p>
                        <p class="kpi-description" id="desc-participacao-setor">Do total geral</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-warning" id="kpi-crescimento-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-trending-up"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Crescimento</p>
                        <p class="kpi-value" id="valor-crescimento-setor">-</p>
                        <p class="kpi-description" id="desc-crescimento-setor">vs ano anterior</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-success" id="kpi-melhor-mes-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-trophy"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Melhor MÃªs</p>
                        <p class="kpi-value" id="valor-melhor-mes-setor">-</p>
                        <p class="kpi-description" id="desc-melhor-mes-setor">Maior faturamento</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts e Tables DinÃ¢micos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-chart-bar"></i>
                            <span id="chart-title-setor">Faturamento Mensal - ImportaÃ§Ã£o</span>
                        </h3>
                        <div class="chart-controls">
                            <button class="btn-toggle-prev-year" id="toggle-prev-year-setor">
                                <i class="mdi mdi-compare"></i>
                                Ano Anterior
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="chart-mensal-setor"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-account-multiple"></i>
                            <span id="table-title-setor">Ranking de Clientes - ImportaÃ§Ã£o</span>
                        </h3>
                    </div>
                    <div class="chart-content">
                        <div class="table-responsive">
                            <table id="tabela-ranking-setor" class="enhanced-table setor-table">
                                <thead>
                                    <tr>
                                        <th class="col-pos">#</th>
                                        <th class="col-cliente">Cliente</th>
                                        <th class="col-valor">Valor Faturado</th>
                                        <th class="col-perc">% Part.</th>
                                        <th class="col-acao">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados carregados via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Filtros -->
    <div id="filter-modal" class="filter-modal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">
                    <i class="mdi mdi-filter"></i>
                    Filtros de Ano
                </h2>
                <button class="filter-modal-close" id="close-modal">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="filter-modal-body">
                <div class="filter-section">
                    <h3 class="filter-section-title">ðŸ“… Ano</h3>
                    <div class="year-month-selector" id="year-selector">
                        <!-- Year buttons will be generated by JavaScript -->
                    </div>
                    <select id="ano-select" class="form-select" style="display: none;">
                        <option value="2027">2027</option>
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
            </div>
            <div class="filter-modal-footer">
                <button type="button" class="btn btn-secondary" id="clear-filters">
                    <i class="mdi mdi-refresh"></i>
                    Limpar Filtros
                </button>
                <button type="button" id="apply-filters" class="btn btn-primary">
                    <i class="mdi mdi-check"></i>
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Drill-Down do Cliente -->
    <div id="cliente-drill-modal" class="drill-modal">
        <div class="drill-modal-content">
            <div class="drill-modal-header">
                <h2 class="drill-modal-title">
                    <i class="mdi mdi-account-details"></i>
                    <span id="drill-cliente-nome">Detalhes do Cliente</span>
                </h2>
                <button type="button" class="drill-modal-close" id="close-drill-modal">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            
            <div class="drill-modal-body">
                <!-- KPIs do Cliente -->
                <div class="drill-kpis">
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-currency-usd"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">Faturamento Total</p>
                            <p class="drill-kpi-value" id="drill-faturamento-total">-</p>
                        </div>
                    </div>
                    
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-percent"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">% do Setor</p>
                            <p class="drill-kpi-value" id="drill-participacao-setor">-</p>
                        </div>
                    </div>
                    
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-trending-up"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">Crescimento</p>
                            <p class="drill-kpi-value" id="drill-crescimento">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- GrÃ¡fico e Detalhamento -->
                <div class="drill-content-grid">
                    <div class="drill-chart-container">
                        <h3 class="drill-section-title">
                            <i class="mdi mdi-chart-line"></i>
                            Faturamento Mensal
                        </h3>
                        <canvas id="drill-chart-mensal"></canvas>
                    </div>
                    
                    <div class="drill-breakdown-container">
                        <h3 class="drill-section-title">
                            <i class="mdi mdi-format-list-bulleted"></i>
                            Breakdown por Centro de Resultado
                        </h3>
                        <div id="drill-breakdown-content">
                            <!-- ConteÃºdo carregado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="drill-modal-footer">
                <button type="button" class="btn btn-secondary" id="drill-close-btn">
                    <i class="mdi mdi-close"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="{{ url_for('fin_faturamento.static', filename='js/faturamento_novo_integrado.js') }}"></script>
{% endblock %}