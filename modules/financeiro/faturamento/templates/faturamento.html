{% extends "base.html" %}

{% block title %}Gest√£o de Faturamento - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('fin_faturamento.static', filename='css/faturamento.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='shared/process_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="faturamento-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-currency-usd', 'url': '#'},
                {'name': 'Faturamento', 'icon': 'mdi mdi-receipt'}
            ], 'financeiro') }}
            
            <!-- Filtros de Empresa -->
            <div class="empresa-filter-buttons" style="margin-left: 20px;">
                <div class="btn-group" role="group" aria-label="Filtro de Empresa">
                    <button type="button" class="btn btn-outline-primary btn-sm empresa-filter-btn active" data-empresa="ambos">
                        <i class="mdi mdi-domain"></i>
                        Ambos
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm empresa-filter-btn" data-empresa="consultoria">
                        <i class="mdi mdi-account-supervisor"></i>
                        Consultoria
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm empresa-filter-btn" data-empresa="imp/exp">
                        <i class="mdi mdi-truck"></i>
                        IMP/EXP
                    </button>
                </div>
            </div>
            
            <!-- Resumo de Filtros -->
            <div id="filter-summary" class="filter-summary">
                <span id="filter-summary-text">Vendo dados de ambas as empresas</span>
            </div>
        </div>
        <div class="actions-right">
            <button id="reset-filters" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-filter-off"></i>
                Remover Filtros
            </button>
            <button id="open-filters" class="btn btn-primary">
                <i class="mdi mdi-filter"></i>
                Filtros
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="last-update">Carregando dados de faturamento...</p>
        </div>
    </div>
    
    <!-- Elementos de loading espec√≠ficos -->
    <div id="loading-kpis" style="display: none;"></div>
    <div id="loading-comparativo" style="display: none;"></div>
    <div id="loading-centro-resultado" style="display: none;"></div>
    <div id="loading-categoria-operacao" style="display: none;"></div>
    <div id="loading-top-clientes" style="display: none;"></div>
    <div id="loading-tabela" style="display: none;"></div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="tab-button active" data-tab="visao-geral">Vis√£o Geral</button>
        <button class="tab-button" data-tab="analise-setor">An√°lise por Setor</button>
    </div>
    
    <!-- Vis√£o Geral Tab -->
    <div class="tab-content active" id="visao-geral-tab">
        <!-- Filter Summary (removed from here as it's now in the actions bar) -->
        
        <!-- KPI Cards Expandidos -->
        <div class="kpi-grid-enhanced">
            <div class="kpi-card kpi-success" id="kpi-total-faturado">
                <div class="kpi-icon">
                    <i class="mdi mdi-currency-usd"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Faturado (Ano Atual)</p>
                    <p class="kpi-value" id="kpi-total-faturamento">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-info" id="kpi-crescimento-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-up"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Crescimento vs Ano Anterior</p>
                    <p class="kpi-value" id="kpi-crescimento-anual">-</p>
                    <p class="kpi-sub-value" id="kpi-crescimento-contexto" style="margin-top:4px;font-size:0.75rem;color:#666;">Acumulado at√© o m√™s atual</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-warning" id="kpi-melhor-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trophy"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Melhor M√™s</p>
                    <p class="kpi-value" id="kpi-melhor-mes">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-red" id="kpi-pior-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-down"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Pior M√™s</p>
                    <p class="kpi-value" id="kpi-pior-mes">-</p>
                </div>
            </div>

            <div class="kpi-card kpi-aderencia-meta" id="kpi-aderencia-meta-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-target"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Ader√™ncia √† Meta</p>
                    <p class="kpi-value" id="kpi-aderencia-meta">-</p>
                    <p class="kpi-sub-value" id="kpi-aderencia-meta-contexto" style="margin-top:4px;font-size:0.75rem;color:#666;">Realizado vs Meta acumulada</p>
                </div>
            </div>
        </div>

        <!-- Charts Grid Reorganizado -->
        <div class="charts-grid-enhanced">
            <!-- Gr√°fico Comparativo Anual (Full Width) -->
            <div class="chart-container-full">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-line"></i>
                        <span id="comparativo-chart-title">Comparativo Anual de Faturamento</span>
                    </h3>
                    <div class="chart-controls">
                        <button id="toggle-meta-comparativo" class="btn btn-outline-primary btn-sm me-2">
                            <i class="mdi mdi-target"></i>
                            Meta vs Realizado
                        </button>
                        <button id="toggle-data-labels" class="btn btn-outline-secondary btn-sm">
                            <i class="mdi mdi-tag-text"></i>
                            R√≥tulos de Dados
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="comparativo-chart"></canvas>
                </div>
            </div>
            
            <!-- Tabela de Faturamento Mensal (embaixo do gr√°fico) -->
            <div class="chart-container-full">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-table"></i>
                        Faturamento Mensal Resumido
                    </h3>
                </div>
                <div class="chart-content">
                    <table id="resumo-mensal" class="enhanced-table compact">
                        <thead>
                            <tr>
                                <th>M√™s</th>
                                <!-- Anos ser√£o adicionados dinamicamente -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Segunda linha - Gr√°fico Hier√°rquico e Tabela de Clientes -->
        <div class="charts-grid-two-cols">
            <!-- Gr√°fico de Barras Hier√°rquico -->
            <div class="chart-container-wide">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-bar"></i>
                        <span id="hierarquico-chart-title">An√°lise Hier√°rquica - Meta Grupo</span>
                    </h3>
                    <div class="chart-controls">
                        <button id="hierarquico-voltar" class="btn btn-sm btn-outline-secondary" style="display: none;">
                            <i class="mdi mdi-arrow-left"></i>
                            Voltar
                        </button>
                        <button id="hierarquico-reset" class="btn btn-sm btn-outline-primary" style="display: none;">
                            <i class="mdi mdi-home"></i>
                            In√≠cio
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <p id="hierarquico-info" class="text-muted mb-2" style="font-size: 0.875rem;">
                        üí° Clique em uma barra para fazer drill-down: Meta Grupo ‚Üí Centro de Resultado ‚Üí Categoria ‚Üí Classe
                    </p>
                    <div id="hierarquico-breadcrumb" class="breadcrumb-container mb-3" style="display: none;">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="#" id="breadcrumb-meta-grupo">Meta Grupo</a></li>
                                <li class="breadcrumb-item" id="breadcrumb-centro" style="display: none;"><a href="#"></a></li>
                                <li class="breadcrumb-item" id="breadcrumb-categoria" style="display: none;"><a href="#"></a></li>
                                <li class="breadcrumb-item active" id="breadcrumb-atual" aria-current="page">Meta Grupo</li>
                            </ol>
                        </nav>
                    </div>
                    <canvas id="hierarquico-chart" style="height: 400px;"></canvas>
                </div>
            </div>
            
            <!-- Tabela Top 10 Clientes -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-account-star"></i>
                        Top 10 Clientes
                    </h3>
                </div>
                <div class="chart-content">
                    <table id="top-clientes-table" class="enhanced-table compact">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Valor (R$)</th>
                                <th>% do Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- An√°lise por Setor Tab - Layout OnePage -->
    <div class="tab-content" id="analise-setor-tab">
        <!-- Header com Filtro de Setor -->
        <div class="setor-filter-header">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="mdi mdi-filter"></i>
                        Selecionar Setor:
                    </label>
                    <div class="sector-buttons">
                        <button class="sector-btn active" data-setor="importacao">
                            <i class="mdi mdi-import"></i>
                            Importa√ß√£o
                        </button>
                        <button class="sector-btn" data-setor="exportacao">
                            <i class="mdi mdi-export"></i>
                            Exporta√ß√£o
                        </button>
                        <button class="sector-btn" data-setor="consultoria">
                            <i class="mdi mdi-account-tie"></i>
                            Consultoria
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Container Din√¢mico - Setor Selecionado -->
        <div id="dynamic-sector-content">
            <!-- KPIs Din√¢micos -->
            <div class="kpi-grid-setor">
                <div class="kpi-card kpi-primary" id="kpi-faturamento-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-currency-usd"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Faturamento Total</p>
                        <p class="kpi-value" id="valor-faturamento-setor">-</p>
                        <p class="kpi-description" id="desc-faturamento-setor">Carregando...</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info" id="kpi-participacao-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">% Participa√ß√£o</p>
                        <p class="kpi-value" id="valor-participacao-setor">-</p>
                        <p class="kpi-description" id="desc-participacao-setor">Do total geral</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-warning" id="kpi-crescimento-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-trending-up"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Crescimento</p>
                        <p class="kpi-value" id="valor-crescimento-setor">-</p>
                        <p class="kpi-description" id="desc-crescimento-setor">vs ano anterior</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-success" id="kpi-melhor-mes-setor">
                    <div class="kpi-icon">
                        <i class="mdi mdi-trophy"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Melhor M√™s</p>
                        <p class="kpi-value" id="valor-melhor-mes-setor">-</p>
                        <p class="kpi-description" id="desc-melhor-mes-setor">Maior faturamento</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts e Tables Din√¢micos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-chart-bar"></i>
                            <span id="chart-title-setor">Faturamento Mensal - Importa√ß√£o</span>
                        </h3>
                        <div class="chart-controls">
                            <button class="btn-toggle-prev-year" id="toggle-prev-year-setor">
                                <i class="mdi mdi-compare"></i>
                                Ano Anterior
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="chart-mensal-setor"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-account-multiple"></i>
                            <span id="table-title-setor">Ranking de Clientes - Importa√ß√£o</span>
                        </h3>
                    </div>
                    <div class="chart-content">
                        <div class="table-responsive">
                            <table id="tabela-ranking-setor" class="enhanced-table setor-table">
                                <thead>
                                    <tr>
                                        <th class="col-pos">#</th>
                                        <th class="col-cliente">Cliente</th>
                                        <th class="col-valor">Valor Faturado</th>
                                        <th class="col-perc">% Part.</th>
                                        <th class="col-acao">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados carregados via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Filtros -->
    <div id="filter-modal" class="filter-modal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">
                    <i class="mdi mdi-filter"></i>
                    Filtros Avan√ßados
                </h2>
                <button class="filter-modal-close" id="close-modal">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="filter-modal-body">
                <!-- Filtro de Per√≠odo -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-calendar-range"></i>
                        Per√≠odo
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="start-date" class="form-label">Data In√≠cio</label>
                            <input type="date" id="start-date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="end-date" class="form-label">Data Fim</label>
                            <input type="date" id="end-date" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Filtro R√°pido de Ano -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-calendar"></i>
                        Filtro R√°pido por Ano
                    </h3>
                    <select id="ano-select" class="form-select">
                        <option value="">Todos os Anos</option>
                        <option value="2027">2027</option>
                        <option value="2026">2026</option>
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                    <small class="text-muted">Selecionar um ano ajusta automaticamente o per√≠odo</small>
                </div>

                <!-- Filtro de M√™s -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-calendar-month"></i>
                        M√™s Espec√≠fico
                    </h3>
                    <select id="mes-select" class="form-select">
                        <option value="">Todos os Meses</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>

                <!-- Filtro de Empresa -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-domain"></i>
                        Empresa
                    </h3>
                    <select id="empresa-select" class="form-select">
                        <option value="">Todas as Empresas</option>
                        <option value="consultoria">Consultoria</option>
                        <option value="imp/exp">IMP/EXP</option>
                    </select>
                </div>

                <!-- Filtro de Centro de Resultado -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-chart-box-outline"></i>
                        Centro de Resultado
                    </h3>
                    <select id="centro-resultado-select" class="form-select">
                        <option value="">Todos os Centros</option>
                        <!-- Op√ß√µes carregadas dinamicamente -->
                    </select>
                    <div id="loading-centros" style="display: none; margin-top: 8px;">
                        <small class="text-muted"><i class="mdi mdi-loading mdi-spin"></i> Carregando...</small>
                    </div>
                </div>

                <!-- Filtro de Cliente -->
                <div class="filter-section">
                    <h3 class="filter-section-title">
                        <i class="mdi mdi-account-multiple"></i>
                        Cliente
                    </h3>
                    <select id="cliente-select" class="form-select">
                        <option value="">Todos os Clientes</option>
                        <!-- Op√ß√µes carregadas dinamicamente -->
                    </select>
                    <div id="loading-clientes" style="display: none; margin-top: 8px;">
                        <small class="text-muted"><i class="mdi mdi-loading mdi-spin"></i> Carregando...</small>
                    </div>
                </div>
            </div>
            <div class="filter-modal-footer">
                <button type="button" class="btn btn-secondary" id="clear-filters">
                    <i class="mdi mdi-refresh"></i>
                    Limpar Filtros
                </button>
                <button type="button" id="apply-filters" class="btn btn-primary">
                    <i class="mdi mdi-check"></i>
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Drill-Down do Cliente -->
    <div id="cliente-drill-modal" class="drill-modal">
        <div class="drill-modal-content">
            <div class="drill-modal-header">
                <h2 class="drill-modal-title">
                    <i class="mdi mdi-account-details"></i>
                    <span id="drill-cliente-nome">Detalhes do Cliente</span>
                </h2>
                <button type="button" class="drill-modal-close" id="close-drill-modal">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            
            <div class="drill-modal-body">
                <!-- KPIs do Cliente -->
                <div class="drill-kpis">
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-currency-usd"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">Faturamento Total</p>
                            <p class="drill-kpi-value" id="drill-faturamento-total">-</p>
                        </div>
                    </div>
                    
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-percent"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">% do Setor</p>
                            <p class="drill-kpi-value" id="drill-participacao-setor">-</p>
                        </div>
                    </div>
                    
                    <div class="drill-kpi-card">
                        <div class="drill-kpi-icon">
                            <i class="mdi mdi-trending-up"></i>
                        </div>
                        <div class="drill-kpi-content">
                            <p class="drill-kpi-label">Crescimento</p>
                            <p class="drill-kpi-value" id="drill-crescimento">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico e Detalhamento -->
                <div class="drill-content-grid">
                    <div class="drill-chart-container">
                        <h3 class="drill-section-title">
                            <i class="mdi mdi-chart-line"></i>
                            Faturamento Mensal
                        </h3>
                        <canvas id="drill-chart-mensal"></canvas>
                    </div>
                    
                    <div class="drill-breakdown-container">
                        <h3 class="drill-section-title">
                            <i class="mdi mdi-format-list-bulleted"></i>
                            Breakdown por Centro de Resultado
                        </h3>
                        <div id="drill-breakdown-content">
                            <!-- Conte√∫do carregado dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="drill-modal-footer">
                <button type="button" class="btn btn-secondary" id="drill-close-btn">
                    <i class="mdi mdi-close"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="{{ url_for('fin_faturamento.static', filename='js/faturamento_novo_integrado.js') }}"></script>
{% endblock %}