{% extends "base.html" %}

{% block title %}Gestão de Faturamento - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('fin_faturamento.static', filename='css/faturamento.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='shared/process_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="faturamento-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-currency-usd', 'url': '#'},
                {'name': 'Faturamento', 'icon': 'mdi mdi-receipt'}
            ], 'financeiro') }}
            <!-- Resumo de Filtros -->
            <div id="filter-summary" class="filter-summary">
                <span id="filter-summary-text">Vendo dados do ano atual</span>
            </div>
        </div>
        <div class="actions-right">
            <button id="reset-filters" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-filter-off"></i>
                Remover Filtros
            </button>
            <button id="open-filters" class="btn btn-primary">
                <i class="mdi mdi-filter"></i>
                Filtros
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="last-update">Carregando dados de faturamento...</p>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="tab-button active" data-tab="visao-geral">Visão Geral</button>
        <button class="tab-button" data-tab="analise-setor">Análise por Setor</button>
    </div>
    
    <!-- Visão Geral Tab -->
    <div class="tab-content active" id="visao-geral-tab">
        <!-- Filter Summary (removed from here as it's now in the actions bar) -->
        
        <!-- KPI Cards Expandidos -->
        <div class="kpi-grid-enhanced">
            <div class="kpi-card kpi-success" id="kpi-total-faturado">
                <div class="kpi-icon">
                    <i class="mdi mdi-currency-usd"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Faturado (Ano Atual)</p>
                    <p class="kpi-value" id="kpi-total-faturamento">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-info" id="kpi-crescimento-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-up"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Crescimento vs Ano Anterior</p>
                    <p class="kpi-value" id="kpi-crescimento-anual">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-warning" id="kpi-melhor-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trophy"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Melhor Mês</p>
                    <p class="kpi-value" id="kpi-melhor-mes">-</p>
                </div>
            </div>
            
            <div class="kpi-card kpi-red" id="kpi-pior-mes-card">
                <div class="kpi-icon">
                    <i class="mdi mdi-trending-down"></i>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Pior Mês</p>
                    <p class="kpi-value" id="kpi-pior-mes">-</p>
                </div>
            </div>
        </div>

        <!-- Charts Grid Reorganizado -->
        <div class="charts-grid-enhanced">
            <!-- Gráfico Comparativo Anual (Full Width) -->
            <div class="chart-container-full">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-line"></i>
                        Comparativo Anual de Faturamento
                    </h3>
                    <div class="chart-controls">
                        <div id="year-toggles" class="year-toggles">
                            <!-- Anos serão carregados dinamicamente -->
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="comparativo-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Segunda linha de gráficos -->
        <div class="charts-grid-two-elements">
            <!-- Gráfico Sunburst - Proporção Hierárquica -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-chart-donut"></i>
                        Distribuição por Centro de Resultado
                    </h3>
                </div>
                <div class="chart-content">
                    <canvas id="sunburst-chart"></canvas>
                </div>
            </div>
            
            <!-- Tabela de Faturamento Mensal -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="mdi mdi-table"></i>
                        Faturamento Mensal Resumido
                    </h3>
                </div>
                <div class="chart-content">
                    <table id="resumo-mensal" class="enhanced-table compact">
                        <thead>
                            <tr>
                                <th>Ano</th>
                                <th>Jan</th>
                                <th>Fev</th>
                                <th>Mar</th>
                                <th>Abr</th>
                                <th>Mai</th>
                                <th>Jun</th>
                                <th>Jul</th>
                                <th>Ago</th>
                                <th>Set</th>
                                <th>Out</th>
                                <th>Nov</th>
                                <th>Dez</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Análise por Setor Tab - Layout OnePage -->
    <div class="tab-content" id="analise-setor-tab">
        <!-- Seção Importação -->
        <div class="setor-section" id="setor-importacao">
            <div class="setor-header">
                <h2 class="setor-title">
                    <i class="mdi mdi-import"></i>
                    Importação
                </h2>
                <div class="setor-description">
                    Análise de faturamento do setor de importação
                </div>
            </div>
            
            <!-- KPI Cards do Setor -->
            <div class="kpi-grid-setor">
                <div class="kpi-card kpi-success" id="kpi-faturamento-importacao">
                    <div class="kpi-icon">
                        <i class="mdi mdi-currency-usd"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Faturamento Total</p>
                        <p class="kpi-value" id="valor-faturamento-importacao">-</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info" id="kpi-percentual-importacao">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">% Participação Total</p>
                        <p class="kpi-value" id="valor-percentual-importacao">-</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts e Tables da Importação -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-chart-line"></i>
                            Comparativo de Faturamento - Importação
                        </h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="chart-faturamento-importacao"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-account-multiple"></i>
                            Ranking de Clientes - Importação
                        </h3>
                    </div>
                    <div class="chart-content">
                        <table id="tabela-ranking-importacao" class="enhanced-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Valor Faturado</th>
                                    <th>% Participação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção Exportação -->
        <div class="setor-section" id="setor-exportacao">
            <div class="setor-header">
                <h2 class="setor-title">
                    <i class="mdi mdi-export"></i>
                    Exportação
                </h2>
                <div class="setor-description">
                    Análise de faturamento do setor de exportação
                </div>
            </div>
            
            <!-- KPI Cards do Setor -->
            <div class="kpi-grid-setor">
                <div class="kpi-card kpi-warning" id="kpi-faturamento-exportacao">
                    <div class="kpi-icon">
                        <i class="mdi mdi-currency-usd"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Faturamento Total</p>
                        <p class="kpi-value" id="valor-faturamento-exportacao">-</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info" id="kpi-percentual-exportacao">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">% Participação Total</p>
                        <p class="kpi-value" id="valor-percentual-exportacao">-</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts e Tables da Exportação -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-chart-line"></i>
                            Comparativo de Faturamento - Exportação
                        </h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="chart-faturamento-exportacao"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-account-multiple"></i>
                            Ranking de Clientes - Exportação
                        </h3>
                    </div>
                    <div class="chart-content">
                        <table id="tabela-ranking-exportacao" class="enhanced-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Valor Faturado</th>
                                    <th>% Participação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção Consultoria -->
        <div class="setor-section" id="setor-consultoria">
            <div class="setor-header">
                <h2 class="setor-title">
                    <i class="mdi mdi-account-tie"></i>
                    Consultoria
                </h2>
                <div class="setor-description">
                    Análise de faturamento do setor de consultoria
                </div>
            </div>
            
            <!-- KPI Cards do Setor -->
            <div class="kpi-grid-setor">
                <div class="kpi-card kpi-purple" id="kpi-faturamento-consultoria">
                    <div class="kpi-icon">
                        <i class="mdi mdi-currency-usd"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">Faturamento Total</p>
                        <p class="kpi-value" id="valor-faturamento-consultoria">-</p>
                    </div>
                </div>
                
                <div class="kpi-card kpi-info" id="kpi-percentual-consultoria">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <p class="kpi-label">% Participação Total</p>
                        <p class="kpi-value" id="valor-percentual-consultoria">-</p>
                    </div>
                </div>
            </div>
            
            <!-- Charts e Tables da Consultoria -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-chart-line"></i>
                            Comparativo de Faturamento - Consultoria
                        </h3>
                    </div>
                    <div class="chart-content">
                        <canvas id="chart-faturamento-consultoria"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="mdi mdi-account-multiple"></i>
                            Ranking de Clientes - Consultoria
                        </h3>
                    </div>
                    <div class="chart-content">
                        <table id="tabela-ranking-consultoria" class="enhanced-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Valor Faturado</th>
                                    <th>% Participação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Filtros -->
    <div id="filter-modal" class="filter-modal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">
                    <i class="mdi mdi-filter"></i>
                    Filtros de Ano
                </h2>
                <button class="filter-modal-close" id="close-modal">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="filter-modal-body">
                <div class="filter-section">
                    <h3 class="filter-section-title">📅 Ano</h3>
                    <div class="year-month-selector" id="year-selector">
                        <!-- Year buttons will be generated by JavaScript -->
                    </div>
                    <select id="ano-select" class="form-select" style="display: none;">
                        <option value="2027">2027</option>
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
            </div>
            <div class="filter-modal-footer">
                <button type="button" class="btn btn-secondary" id="clear-filters">
                    <i class="mdi mdi-refresh"></i>
                    Limpar Filtros
                </button>
                <button type="button" id="apply-filters" class="btn btn-primary">
                    <i class="mdi mdi-check"></i>
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="{{ url_for('fin_faturamento.static', filename='js/faturamento.js') }}"></script>
{% endblock %}