{% extends "base.html" %}

{% block title %}Conciliação de Lançamentos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='shared/process_modal.css') }}">
<link href="{{ url_for('fin_conciliacao_lancamentos.static', filename='conciliacao_lancamentos.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="conciliacao-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-chart-line'},
                {'name': 'Conciliação de Lançamentos', 'icon': 'mdi mdi-bank-transfer'}
            ], 'financeiro') }}
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Processando conciliação...</p>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <div class="section-header">
            <h3><i class="mdi mdi-upload"></i> Upload de Extratos Bancários</h3>
            <p>Selecione arquivos Excel (.xlsx, .xls) com extratos bancários para conciliação</p>
        </div>
        
        <div class="upload-area" id="upload-area">
            <div class="upload-content">
                <i class="mdi mdi-cloud-upload upload-icon"></i>
                <h4>Arraste arquivos aqui ou <a href="#" id="upload-link">clique para selecionar</a></h4>
                <p>Formatos aceitos: .xlsx, .xls (máx. 10MB por arquivo)</p>
            </div>
            <input type="file" id="file-input" multiple accept=".xlsx,.xls" style="display: none;">
        </div>
        
        <div id="files-list" style="display: none;">
            <h4>Arquivos Selecionados</h4>
            <div id="files-container"></div>
        </div>
        
        <div class="upload-actions">
            <button id="btn-processar" class="btn btn-primary" disabled>
                <i class="mdi mdi-cog"></i> Processar Conciliação
            </button>
            <button id="btn-limpar" class="btn btn-secondary">
                <i class="mdi mdi-delete"></i> Limpar Tudo
            </button>
        </div>
    </div>

    <!-- KPI Section -->
    <div id="kpi-section" class="kpi-section" style="display: none;">
        <div class="section-header">
            <h3><i class="mdi mdi-chart-box"></i> Resumo da Conciliação</h3>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card kpi-total">
                <div class="kpi-content">
                    <div class="kpi-number" id="total-sistema">0</div>
                    <div class="kpi-label">Movimentos Sistema</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-database"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-extratos">
                <div class="kpi-content">
                    <div class="kpi-number" id="total-extratos">0</div>
                    <div class="kpi-label">Movimentos Extratos</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-bank"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-conciliados">
                <div class="kpi-content">
                    <div class="kpi-number" id="total-conciliados">0</div>
                    <div class="kpi-label">Conciliados</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-check-circle"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-pendentes">
                <div class="kpi-content">
                    <div class="kpi-number" id="total-pendentes">0</div>
                    <div class="kpi-label">Pendentes</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-clock-outline"></i>
                </div>
            </div>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card kpi-valor-sistema">
                <div class="kpi-content">
                    <div class="kpi-number" id="valor-sistema">R$ 0,00</div>
                    <div class="kpi-label">Valor Sistema</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-currency-usd"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-valor-extratos">
                <div class="kpi-content">
                    <div class="kpi-number" id="valor-extratos">R$ 0,00</div>
                    <div class="kpi-label">Valor Extratos</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-currency-usd"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-valor-conciliados">
                <div class="kpi-content">
                    <div class="kpi-number" id="valor-conciliados">R$ 0,00</div>
                    <div class="kpi-label">Valor Conciliado</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-check-circle"></i>
                </div>
            </div>
            
            <div class="kpi-card kpi-valor-pendentes">
                <div class="kpi-content">
                    <div class="kpi-number" id="valor-pendentes">R$ 0,00</div>
                    <div class="kpi-label">Valor Pendente</div>
                </div>
                <div class="kpi-icon">
                    <i class="mdi mdi-alert-circle"></i>
                </div>
            </div>
        </div>
    </div>
    <!-- Conciliação Section -->
    <div id="conciliacao-section" class="conciliacao-section" style="display: none;">
        <div class="section-header">
            <h3><i class="mdi mdi-compare"></i> Conciliação Manual</h3>
            <div class="section-actions">
                <button id="btn-conciliar-selecionados" class="btn btn-success" disabled>
                    <i class="mdi mdi-link"></i> Conciliar Selecionados
                </button>
            </div>
        </div>
        
        <div class="selection-summary">
            <div class="summary-item">
                <span id="summary-sistema">Sistema: R$ 0,00 (0 selecionados)</span>
            </div>
            <div class="summary-item">
                <span id="summary-banco">Banco: R$ 0,00 (0 selecionados)</span>
            </div>
            <div class="summary-item">
                <span id="summary-diferenca" class="diferenca">Diferença: R$ 0,00</span>
            </div>
        </div>
        
        <div class="conciliacao-grid">
            <!-- Tabela Sistema -->
            <div class="conciliacao-panel">
                <div class="panel-header">
                    <h4><i class="mdi mdi-database"></i> Movimentos do Sistema</h4>
                    <div class="panel-controls">
                        <input type="text" id="filter-sistema" placeholder="Filtrar..." class="filter-input">
                        <select id="status-sistema" class="filter-select">
                            <option value="">Todos os Status</option>
                            <option value="pendente">Pendente</option>
                            <option value="conciliado">Conciliado</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-sistema">
                                </th>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Ref</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-sistema-tbody">
                            <!-- Dados serão carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tabela Banco -->
            <div class="conciliacao-panel">
                <div class="panel-header">
                    <h4><i class="mdi mdi-bank"></i> Movimentos Bancários</h4>
                    <div class="panel-controls">
                        <input type="text" id="filter-banco" placeholder="Filtrar..." class="filter-input">
                        <select id="status-banco" class="filter-select">
                            <option value="">Todos os Status</option>
                            <option value="pendente">Pendente</option>
                            <option value="conciliado">Conciliado</option>
                        </select>
                        <select id="banco-origem" class="filter-select">
                            <option value="">Todos os Bancos</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-banco">
                                </th>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Banco</th>
                                <th>Status</th>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="mdi mdi-link"></i> Confirmar Conciliação</h3>
                <button class="modal-close" id="confirmation-modal-close">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-summary">
                    <div class="summary-row">
                        <span class="summary-label">Sistema:</span>
                        <span class="summary-value">
                            <span id="conf-sistema-count">0</span> itens • 
                            <span id="conf-sistema-valor">R$ 0,00</span>
                        </span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">Banco:</span>
                        <span class="summary-value">
                            <span id="conf-banco-count">0</span> itens • 
                            <span id="conf-banco-valor">R$ 0,00</span>
                        </span>
                    </div>
                    
                    <div class="summary-row total">
                        <span class="summary-label">Diferença:</span>
                        <span class="summary-value" id="conf-diferenca">R$ 0,00</span>
                    </div>
                </div>
                
                <div id="conf-warning" class="warning-message" style="display: none;">
                    <i class="mdi mdi-alert"></i>
                    <span>Atenção: Os valores não conferem exatamente. Deseja continuar?</span>
                </div>
                
                <p>Esta ação irá conciliar os movimentos selecionados. Deseja continuar?</p>
            </div>
            
            <div class="modal-footer">
                <button id="confirmation-cancel" class="btn btn-secondary">
                    <i class="mdi mdi-close"></i> Cancelar
                </button>
                <button id="confirmation-confirm" class="btn btn-primary">
                    <i class="mdi mdi-check"></i> Confirmar Conciliação
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('fin_conciliacao_lancamentos.static', filename='conciliacao_lancamentos.js') }}"></script>
{% endblock %}
