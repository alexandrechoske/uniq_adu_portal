{% extends "base.html" %}

{% block title %}Concilia√ß√£o Banc√°ria - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
<link rel="stylesheet" href="{{ url_for('fin_conciliacao_lancamentos.static', filename='conciliacao_lancamentos.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('fin_conciliacao_lancamentos.static', filename='conciliacao_lancamentos.js') }}"></script>
{% endblock %}

{% block content %}
<div class="conciliacao-container">
    <!-- Header -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-currency-usd', 'url': '#'},
                {'name': 'Concilia√ß√£o Banc√°ria', 'icon': 'mdi mdi-file-compare'}
            ], 'financeiro') }}
        </div>
        <div class="actions-right">
            <button class="btn btn-outline-info" type="button" data-bs-toggle="modal" data-bs-target="#modalLogicaConciliacao">
                <i class="mdi mdi-information-variant"></i>
                Como conciliamos?
            </button>
            <button id="btnLimparSessao" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-refresh"></i>
                Nova Sess√£o
            </button>
            <button id="btnExportarRelatorio" class="btn btn-primary" style="display: none;">
                <i class="mdi mdi-download"></i>
                Exportar Relat√≥rio
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loading-message">Processando...</p>
        </div>
    </div>

    <!-- Notification Bar -->
    <div id="notification-bar" class="notification-bar" style="display: none;"></div>

    <!-- Navega√ß√£o por Abas -->
    <div class="tabs-navigation">
        <button class="tab-btn active" data-tab="conciliar">
            <i class="mdi mdi-file-compare"></i>
            Conciliar
            <span class="tab-badge" id="badge-pendentes">0</span>
        </button>
        <button class="tab-btn" data-tab="conciliados">
            <i class="mdi mdi-check-circle"></i>
            Conciliados
            <span class="tab-badge" id="badge-conciliados">0</span>
        </button>
    </div>

    <!-- ABA 1: CONCILIAR (A√ß√£o) -->
    <div id="tab-conciliar" class="tab-content active">
        
        <!-- Se√ß√£o 1: Upload e Processamento -->
        <div class="upload-section card">
            <div class="card-header">
                <h5><i class="mdi mdi-cloud-upload"></i> Upload e Processamento</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Data Inicial (Sistema)</label>
                                <input type="date" id="data_inicio_sistema" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Data Final (Sistema)</label>
                                <input type="date" id="data_fim_sistema" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Banco (opcional, auto-detectado)</label>
                                <select id="banco_origem" class="form-select">
                                    <option value="auto">üîç Identificar Automaticamente</option>
                                    <option value="itau">üè¶ Ita√∫</option>
                                    <option value="santander">üè¶ Santander</option>
                                    <option value="banco_brasil">üè¶ Banco do Brasil</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">Empresa dos Lan√ßamentos</label>
                                <div class="empresa-radio-group">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="empresa_filtro" id="empresaFiltroTodas" value="todas" checked>
                                        <label class="form-check-label" for="empresaFiltroTodas">Todas</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="empresa_filtro" id="empresaFiltroUnique" value="Unique Consultoria">
                                        <label class="form-check-label" for="empresaFiltroUnique">Unique Consultoria</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="empresa_filtro" id="empresaFiltroUnique" value="Unique Solu√ß√µes">
                                        <label class="form-check-label" for="empresaFiltroUnique">Unique Solu√ß√µes</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="arquivoBancario" name="arquivo_bancario" 
                               accept=".ofx,.xlsx,.txt" multiple hidden>
                        <div class="upload-placeholder">
                            <i class="mdi mdi-cloud-upload upload-icon"></i>
                            <p class="upload-title">Arraste arquivos aqui ou clique para selecionar</p>
                            <p class="upload-subtitle">Formatos aceitos: .ofx, .xlsx, .txt</p>
                            <button type="button" id="btnSelecionarArquivos" class="btn btn-secondary">
                                Selecionar Arquivos
                            </button>
                        </div>
                        <div id="filesList" class="files-list" style="display: none;"></div>
                    </div>

                    <div class="text-center mt-3">
                        <button type="submit" id="btnProcessar" class="btn btn-success btn-lg" disabled>
                            <i class="mdi mdi-play-circle"></i>
                            Processar e Conciliar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Se√ß√£o 2: KPIs (exibido ap√≥s processamento) -->
        <div id="kpisSection" class="kpis-section" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <div class="kpi-card kpi-warning">
                        <div class="kpi-icon"><i class="mdi mdi-alert-circle"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-label">Pendentes - Sistema</div>
                            <div class="kpi-value" id="kpi-pendentes-sistema-count">0</div>
                            <div class="kpi-subtitle" id="kpi-pendentes-sistema-valor">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card kpi-warning">
                        <div class="kpi-icon"><i class="mdi mdi-alert-circle"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-label">Pendentes - Banco</div>
                            <div class="kpi-value" id="kpi-pendentes-banco-count">0</div>
                            <div class="kpi-subtitle" id="kpi-pendentes-banco-valor">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card kpi-success">
                        <div class="kpi-icon"><i class="mdi mdi-check-circle"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-label">Conciliados (Sess√£o)</div>
                            <div class="kpi-value" id="kpi-conciliados-count">0</div>
                            <div class="kpi-subtitle" id="kpi-conciliados-valor">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card kpi-info">
                        <div class="kpi-icon"><i class="mdi mdi-information"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-label">Total de Registros</div>
                            <div class="kpi-value" id="kpi-total-sistema">0</div>
                            <div class="kpi-subtitle"><span id="kpi-total-banco">0</span> banco</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 3: √Årea de Trabalho (Tabelas Lado a Lado) -->
        <div id="workspace" class="workspace-section" style="display: none;">
            <div class="workspace-grid">
                
                <!-- Coluna Esquerda: Sistema -->
                <div class="workspace-column">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="mdi mdi-database"></i> Sistema Aberta</h5>
                            <div class="card-controls">
                                <input type="text" id="searchSistema" class="form-control form-control-sm" 
                                       placeholder="üîç Buscar...">
                            </div>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th width="40"><input type="checkbox" id="checkAllSistema"></th>
                                        <th class="sortable" data-table="sistema" data-sort="data">Data</th>
                                        <th class="sortable" data-table="sistema" data-sort="descricao">Descri√ß√£o</th>
                                        <th class="sortable" data-table="sistema" data-sort="ref">Ref. Unique</th>
                                        <th class="text-end sortable" data-table="sistema" data-sort="valor">Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSistema">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="mdi mdi-information"></i>
                                            Nenhum lan√ßamento pendente
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer">
                            <div class="card-footer-content">
                                <small class="text-muted">
                                    <span id="countSistema">0</span> lan√ßamento(s) |
                                    Total: <strong id="totalSistema">R$ 0,00</strong>
                                </small>
                                <div id="paginationSistema" class="pagination-controls"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coluna Direita: Banco -->
                <div class="workspace-column">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="mdi mdi-bank"></i> Extratos Banc√°rios</h5>
                            <div class="card-controls">
                                <input type="text" id="searchBanco" class="form-control form-control-sm" 
                                       placeholder="üîç Buscar...">
                                <select id="filtroBanco" class="form-select form-select-sm ms-2">
                                    <option value="">Todos os bancos</option>
                                    <option value="itau">Ita√∫</option>
                                    <option value="santander">Santander</option>
                                    <option value="banco_brasil">Banco do Brasil</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th width="40"><input type="checkbox" id="checkAllBanco"></th>
                                        <th class="sortable" data-table="banco" data-sort="data">Data</th>
                                        <th class="sortable" data-table="banco" data-sort="descricao">Descri√ß√£o</th>
                                        <th class="sortable" data-table="banco" data-sort="ref">Ref. Unique</th>
                                        <th class="sortable" data-table="banco" data-sort="banco">Banco</th>
                                        <th class="text-end sortable" data-table="banco" data-sort="valor">Valor (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBanco">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="mdi mdi-information"></i>
                                            Nenhum lan√ßamento pendente
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer">
                            <div class="card-footer-content">
                                <small class="text-muted">
                                    <span id="countBanco">0</span> lan√ßamento(s) |
                                    Total: <strong id="totalBanco">R$ 0,00</strong>
                                </small>
                                <div id="paginationBanco" class="pagination-controls"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Se√ß√£o 4: A√ß√£o de Concilia√ß√£o Manual -->
            <div class="conciliar-action">
                <div class="totals-display">
                    <div class="total-item">
                        <span class="total-label">Total Selecionado Sistema:</span>
                        <span class="total-value" id="totalSelSistema">R$ 0,00</span>
                    </div>
                    <button id="btnConciliarManual" class="btn btn-primary btn-lg" disabled>
                        <i class="mdi mdi-link-variant"></i>
                        Conciliar Selecionados
                    </button>
                    <div class="total-item">
                        <span class="total-label">Total Selecionado Banco:</span>
                        <span class="total-value" id="totalSelBanco">R$ 0,00</span>
                    </div>
                </div>
                <div id="validation-message" class="validation-message" style="display: none;"></div>
            </div>

        </div>

    </div>

    <!-- ABA 2: CONCILIADOS (Confer√™ncia) -->
    <div id="tab-conciliados" class="tab-content">
        
        <!-- Filtros -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Tipo de Concilia√ß√£o</label>
                        <select id="filtroTipoConciliacao" class="form-select">
                            <option value="">Todos</option>
                            <option value="auto_ref">Autom√°tica por Refer√™ncia</option>
                            <option value="auto_valor">Autom√°tica por Valor</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Banco</label>
                        <select id="filtroBancoConciliados" class="form-select">
                            <option value="">Todos</option>
                            <option value="itau">Ita√∫</option>
                            <option value="santander">Santander</option>
                            <option value="banco_brasil">Banco do Brasil</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Buscar</label>
                        <input type="text" id="searchConciliados" class="form-control" 
                               placeholder="üîç Buscar na descri√ß√£o...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Concilia√ß√µes -->
        <div class="card">
            <div class="card-header">
                <h5><i class="mdi mdi-check-all"></i> Lan√ßamentos Conciliados</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="80">Status</th>
                                <th width="100">Data</th>
                                <th width="120" class="text-end">Valor Total</th>
                                <th>Lan√ßamentos do Sistema</th>
                                <th>Lan√ßamentos do Banco</th>
                                <th width="80" class="text-center">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tableConciliados">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="mdi mdi-checkbox-blank-circle-outline" style="font-size: 3rem;"></i>
                                    <p class="mt-2">Nenhuma concilia√ß√£o realizada ainda</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Modal: L√≥gica de Concilia√ß√£o -->
<div class="modal fade" id="modalLogicaConciliacao" tabindex="-1" aria-labelledby="modalLogicaConciliacaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLogicaConciliacaoLabel"><i class="mdi mdi-file-compare"></i> Entenda a nossa l√≥gica de concilia√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Aplicamos as regras abaixo em sequ√™ncia para aproximar os lan√ßamentos do sistema e do banco. Assim, voc√™ sabe exatamente como encontramos (ou n√£o) cada combina√ß√£o.</p>
                <div class="list-group">
                    <div class="list-group-item">
                        <h6 class="mb-1 text-primary"><i class="mdi mdi-numeric-1-circle"></i> Chave completa: c√≥digo + data + valor</h6>
                        <p class="mb-0">Primeiro buscamos pares em que o <strong>c√≥digo de refer√™ncia (Ref. Unique)</strong>, a <strong>data</strong> e o <strong>valor</strong> s√£o id√™nticos nos dois lados. Encontramos a mesma opera√ß√£o registrada nos dois lugares.</p>
                    </div>
                    <div class="list-group-item">
                        <h6 class="mb-1 text-primary"><i class="mdi mdi-numeric-2-circle"></i> Data + valor + descri√ß√£o parecida</h6>
                        <p class="mb-0">Quando o c√≥digo n√£o existe em ambos, comparamos <strong>data</strong> e <strong>valor</strong> iguais e verificamos se as descri√ß√µes compartilham palavras-chave relevantes (ex.: nome do imposto, fornecedor ou servi√ßo).</p>
                    </div>
                    <div class="list-group-item">
                        <h6 class="mb-1 text-primary"><i class="mdi mdi-numeric-3-circle"></i> Somente data + valor</h6>
                        <p class="mb-0">Ainda sem coincid√™ncia, avaliamos pares com a mesma <strong>data</strong> e o mesmo <strong>valor</strong>. Esse n√≠vel gera mais aten√ß√£o, pois pode haver lan√ßamentos diferentes com valores iguais. O analista confirma se a associa√ß√£o faz sentido.</p>
                    </div>
                    <div class="list-group-item">
                        <h6 class="mb-1 text-primary"><i class="mdi mdi-numeric-4-circle"></i> Valor igual e data aproximada</h6>
                        <p class="mb-0">Como √∫ltimo passo autom√°tico avaliamos valores id√™nticos com diferen√ßa de at√© <strong>3 dias</strong> entre as datas e descri√ß√£o semelhante. √ötil quando o banco compensa em outro dia ou quando o sistema registrou um pagamento no D+1.</p>
                    </div>
                </div>
                <hr>
                <p class="mb-2"><strong>Importante:</strong></p>
                <ul class="mb-0">
                    <li>Os n√≠veis acima s√£o sempre executados nessa ordem, do mais preciso ao mais amplo.</li>
                    <li>Quando encontramos mais de um poss√≠vel par para a mesma regra, deixamos o lan√ßamento pendente para revis√£o manual.</li>
                    <li>Voc√™ pode revisar, desfazer ou refazer concilia√ß√µes a qualquer momento pela aba <strong>Conciliados</strong>.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
