{% extends "base.html" %}

{% block title %}Conciliação Bancária V2 - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
<link rel="stylesheet" href="/financeiro/conciliacao-v2/static/fin_conciliacao_v2/conciliacao_v2.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="/financeiro/conciliacao-v2/static/fin_conciliacao_v2/conciliacao_v2.js"></script>
{% endblock %}

{% block content %}
<div class="conciliacao-v2-container">
    <!-- Header com Breadcrumb e Métricas -->
    <div class="module-header-financeiro">
        <div class="header-content">
            <div class="header-left">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb module-breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('menu.menu_home') }}">
                                <i class="mdi mdi-menu"></i> Menu
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <i class="mdi mdi-currency-usd"></i> Financeiro
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="mdi mdi-file-compare"></i> Conciliação Bancária V2
                        </li>
                    </ol>
                </nav>
                
                <div class="header-subtitle">
                    <p>Sistema inteligente de conciliação automática com motor de IA</p>
                </div>
            </div>
            
            <div class="header-right">
                <button id="btnLimparDados" class="btn btn-outline-secondary" style="display: none;">
                    <i class="mdi mdi-refresh"></i> Reiniciar Processo
                </button>
                <button id="btnExportarRelatorio" class="btn btn-success" style="display: none;">
                    <i class="mdi mdi-file-excel"></i> Exportar Relatório
                </button>
            </div>
        </div>

        <!-- Barra de Progresso Global -->
        <div class="progress-global" id="progressoGlobal" style="display: none;">
            <div class="progress-steps">
                <div class="step" id="step1">
                    <div class="step-icon"><i class="mdi mdi-upload"></i></div>
                    <div class="step-label">Upload Bancos</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon"><i class="mdi mdi-database"></i></div>
                    <div class="step-label">Dados Sistema</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon"><i class="mdi mdi-auto-fix"></i></div>
                    <div class="step-label">Conciliação Auto</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-icon"><i class="mdi mdi-hand-pointing-up"></i></div>
                    <div class="step-label">Conciliação Manual</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h4 id="loadingTitle">Processando...</h4>
            <p id="loadingMessage">Aguarde enquanto processamos seus dados</p>
            <div class="loading-progress">
                <div class="progress-bar-loading">
                    <div class="progress-fill-loading"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard de Métricas -->
    <div class="metrics-dashboard" id="metricsDashboard" style="display: none;">
        <div class="row">
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card success">
                    <div class="kpi-icon">
                        <i class="mdi mdi-check-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="metricaConciliados">0</div>
                        <div class="kpi-label">Conciliados</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card warning">
                    <div class="kpi-icon">
                        <i class="mdi mdi-clock-outline"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="metricaPendentes">0</div>
                        <div class="kpi-label">Pendentes</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card info">
                    <div class="kpi-icon">
                        <i class="mdi mdi-database"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="metricaSistema">0</div>
                        <div class="kpi-label">Sistema</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card secondary">
                    <div class="kpi-icon">
                        <i class="mdi mdi-bank"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="metricaBanco">0</div>
                        <div class="kpi-label">Banco</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card primary">
                    <div class="kpi-icon">
                        <i class="mdi mdi-percent"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="metricaPercentual">0%</div>
                        <div class="kpi-label">Taxa Sucesso</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="kpi-card gauge">
                    <div class="kpi-content">
                        <canvas id="gaugeChart" width="100" height="100"></canvas>
                        <div class="kpi-label">Progresso</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 1: Upload de Arquivos Bancários -->
    <div class="section-card" id="uploadSection">
        <div class="card">
            <div class="card-header">
                <div class="card-title-area">
                    <h5 class="card-title">
                        <i class="mdi mdi-file-upload text-primary"></i>
                        Upload de Extratos Bancários
                    </h5>
                    <p class="card-subtitle">Faça upload dos arquivos de extrato dos bancos para conciliação</p>
                </div>
                <div class="card-actions">
                    <div class="upload-status" id="uploadStatus">
                        <span class="badge bg-light">Nenhum arquivo carregado</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Zona de Upload Drag & Drop -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-zone-content">
                        <div class="upload-icon">
                            <i class="mdi mdi-cloud-upload"></i>
                        </div>
                        <h6>Arraste os arquivos aqui ou clique para selecionar</h6>
                        <p>Suporte para Excel (.xlsx) e TXT do Banco do Brasil, Itaú e Santander</p>
                        <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.txt,.csv" hidden>
                        <button type="button" id="btnSelectFiles" class="btn btn-primary">
                            <i class="mdi mdi-file-plus"></i> Selecionar Arquivos
                        </button>
                    </div>
                </div>

                <!-- Lista de Arquivos Carregados -->
                <div class="files-list" id="filesList" style="display: none;">
                    <h6><i class="mdi mdi-file-multiple"></i> Arquivos Processados</h6>
                    <div class="files-container" id="filesContainer">
                        <!-- Arquivos serão adicionados dinamicamente -->
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="upload-actions" id="uploadActions" style="display: none;">
                    <button type="button" id="btnProcessarArquivos" class="btn btn-success">
                        <i class="mdi mdi-cog"></i> Processar Todos os Arquivos
                    </button>
                    <button type="button" id="btnLimparArquivos" class="btn btn-outline-secondary">
                        <i class="mdi mdi-delete"></i> Limpar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 2: Carregamento de Dados do Sistema -->
    <div class="section-card" id="sistemaSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <div class="card-title-area">
                    <h5 class="card-title">
                        <i class="mdi mdi-database text-info"></i>
                        Dados do Sistema
                    </h5>
                    <p class="card-subtitle">Configure os parâmetros para carregar dados da tabela de movimentos</p>
                </div>
            </div>
            <div class="card-body">
                <form id="formSistema">
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group">
                                <label for="selectBanco" class="form-label">
                                    <i class="mdi mdi-bank"></i> Filtro por Banco
                                </label>
                                <select id="selectBanco" class="form-select">
                                    <option value="todos">Todos os bancos</option>
                                    <option value="BANCO_DO_BRASIL">Banco do Brasil</option>
                                    <option value="BANCO_ITAU">Itaú</option>
                                    <option value="BANCO_SANTANDER">Santander</option>
                                    <option value="Bradesco">Bradesco</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="form-group">
                                <label for="selectPeriodo" class="form-label">
                                    <i class="mdi mdi-calendar"></i> Período
                                </label>
                                <select id="selectPeriodo" class="form-select">
                                    <option value="ultimos_30_dias">Últimos 30 dias</option>
                                    <option value="mes_atual">Mês atual</option>
                                    <option value="mes_anterior">Mês anterior</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6" id="dataInicioGroup" style="display: none;">
                            <div class="form-group">
                                <label for="dataInicio" class="form-label">Data Início</label>
                                <input type="date" id="dataInicio" class="form-control">
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6" id="dataFimGroup" style="display: none;">
                            <div class="form-group">
                                <label for="dataFim" class="form-label">Data Fim</label>
                                <input type="date" id="dataFim" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" id="btnCarregarSistema" class="btn btn-info">
                                <i class="mdi mdi-database-search"></i> Carregar Dados do Sistema
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Seção 3: Conciliação Automática -->
    <div class="section-card" id="conciliacaoSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <div class="card-title-area">
                    <h5 class="card-title">
                        <i class="mdi mdi-auto-fix text-success"></i>
                        Conciliação Automática
                    </h5>
                    <p class="card-subtitle">Execute a conciliação automática baseada em critérios inteligentes</p>
                </div>
            </div>
            <div class="card-body">
                <div class="conciliacao-info">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="info-item">
                                <div class="info-label">Critérios de Conciliação:</div>
                                <ul class="criteria-list">
                                    <li><i class="mdi mdi-check text-success"></i> Data exata</li>
                                    <li><i class="mdi mdi-check text-success"></i> Valor exato</li>
                                    <li><i class="mdi mdi-check text-success"></i> Código de referência</li>
                                    <li><i class="mdi mdi-check text-warning"></i> Similaridade de descrição</li>
                                    <li><i class="mdi mdi-check text-info"></i> Compatibilidade de banco</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="resumo-dados">
                                <div class="resumo-item">
                                    <span class="label">Movimentos Sistema:</span>
                                    <span class="value" id="resumoSistema">0</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="label">Movimentos Banco:</span>
                                    <span class="value" id="resumoBanco">0</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="label">Arquivos Carregados:</span>
                                    <span class="value" id="resumoArquivos">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="conciliacao-actions">
                    <button type="button" id="btnConciliacaoAuto" class="btn btn-success btn-lg">
                        <i class="mdi mdi-auto-fix"></i>
                        Executar Conciliação Automática
                    </button>
                    <div class="conciliacao-progress" id="conciliacaoProgress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Processando conciliação automática...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 4: Resultados e Conciliação Manual -->
    <div class="section-card" id="resultadosSection" style="display: none;">
        <div class="row">
            <!-- Coluna Esquerda: Dados do Sistema -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="table-header">
                            <h6 class="card-title">
                                <i class="mdi mdi-database text-info"></i>
                                Movimentos do Sistema
                                <span class="badge bg-info" id="badgeSistema">0</span>
                            </h6>
                            <div class="table-filters">
                                <div class="filter-group">
                                    <select id="filtroTipoSistema" class="form-select form-select-sm">
                                        <option value="todos">Todos os tipos</option>
                                        <option value="RECEITA">Receitas</option>
                                        <option value="DESPESA">Despesas</option>
                                    </select>
                                    <select id="filtroBancoSistema" class="form-select form-select-sm">
                                        <option value="todos">Todos os bancos</option>
                                    </select>
                                    <input type="text" id="searchSistema" class="form-control form-control-sm" placeholder="Buscar...">
                                </div>
                            </div>
                        </div>
                        <div class="selection-info">
                            <span id="selecaoSistemaInfo">
                                <strong>0</strong> selecionados | Valor: <strong>R$ 0,00</strong>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-hover table-sm" id="tabelaSistema">
                                <thead>
                                    <tr>
                                        <th width="5%" class="text-center">
                                            <input type="checkbox" id="selectAllSistema" title="Selecionar todos">
                                        </th>
                                        <th width="12%" class="sortable" data-column="data">Data</th>
                                        <th width="13%" class="sortable" data-column="valor">Valor</th>
                                        <th width="15%" class="sortable" data-column="banco">Banco</th>
                                        <th width="10%" class="sortable" data-column="tipo">Tipo</th>
                                        <th width="35%" class="sortable" data-column="descricao">Descrição</th>
                                        <th width="10%" class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodySistema">
                                    <!-- Dados carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Dados do Banco -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="table-header">
                            <h6 class="card-title">
                                <i class="mdi mdi-bank text-secondary"></i>
                                Extratos Bancários
                                <span class="badge bg-secondary" id="badgeBanco">0</span>
                            </h6>
                            <div class="table-filters">
                                <div class="filter-group">
                                    <select id="filtroTipoBanco" class="form-select form-select-sm">
                                        <option value="todos">Todos os tipos</option>
                                        <option value="CREDITO">Créditos</option>
                                        <option value="DEBITO">Débitos</option>
                                    </select>
                                    <select id="filtroBancoBanco" class="form-select form-select-sm">
                                        <option value="todos">Todos os bancos</option>
                                    </select>
                                    <input type="text" id="searchBanco" class="form-control form-control-sm" placeholder="Buscar...">
                                </div>
                            </div>
                        </div>
                        <div class="selection-info">
                            <span id="selecaoBancoInfo">
                                <strong>0</strong> selecionados | Valor: <strong>R$ 0,00</strong>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-hover table-sm" id="tabelaBanco">
                                <thead>
                                    <tr>
                                        <th width="5%" class="text-center">
                                            <input type="checkbox" id="selectAllBanco" title="Selecionar todos">
                                        </th>
                                        <th width="12%" class="sortable" data-column="data">Data</th>
                                        <th width="13%" class="sortable" data-column="valor">Valor</th>
                                        <th width="15%" class="sortable" data-column="banco">Banco</th>
                                        <th width="10%" class="sortable" data-column="tipo">Tipo</th>
                                        <th width="35%" class="sortable" data-column="descricao">Histórico</th>
                                        <th width="10%" class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyBanco">
                                    <!-- Dados carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Conciliação Manual -->
        <div class="manual-reconciliation-panel" id="manualPanel" style="display: none;">
            <div class="panel-content">
                <div class="panel-header">
                    <h6><i class="mdi mdi-hand-pointing-up"></i> Conciliação Manual</h6>
                    <button type="button" class="btn-close-panel" id="btnClosePanel">
                        <i class="mdi mdi-close"></i>
                    </button>
                </div>
                <div class="panel-body">
                    <div class="selection-summary">
                        <div class="summary-item">
                            <div class="summary-label">Sistema</div>
                            <div class="summary-count" id="summaryCountSistema">0 itens</div>
                            <div class="summary-value" id="summaryValueSistema">R$ 0,00</div>
                        </div>
                        <div class="summary-divider">
                            <i class="mdi mdi-arrow-left-right"></i>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Banco</div>
                            <div class="summary-count" id="summaryCountBanco">0 itens</div>
                            <div class="summary-value" id="summaryValueBanco">R$ 0,00</div>
                        </div>
                        <div class="summary-result">
                            <div class="result-label">Diferença</div>
                            <div class="result-value" id="summaryDiferenca">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="panel-actions">
                        <button type="button" id="btnConciliarManual" class="btn btn-warning" disabled>
                            <i class="mdi mdi-link"></i> Conciliar Selecionados
                        </button>
                        <button type="button" id="btnLimparSelecao" class="btn btn-outline-secondary">
                            <i class="mdi mdi-refresh"></i> Limpar Seleção
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção 5: Resumo Final -->
    <div class="section-card" id="resumoFinalSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="mdi mdi-chart-pie text-primary"></i>
                    Resumo Final da Conciliação
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="final-stats">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="stat-card success">
                                        <div class="stat-icon">
                                            <i class="mdi mdi-check-circle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="finalConciliados">0</div>
                                            <div class="stat-label">Conciliados</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card warning">
                                        <div class="stat-icon">
                                            <i class="mdi mdi-clock-alert"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="finalParciais">0</div>
                                            <div class="stat-label">Parciais</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card danger">
                                        <div class="stat-icon">
                                            <i class="mdi mdi-alert-circle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="finalPendentes">0</div>
                                            <div class="stat-label">Pendentes</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card info">
                                        <div class="stat-icon">
                                            <i class="mdi mdi-hand-pointing-up"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="finalManuais">0</div>
                                            <div class="stat-label">Manuais</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="progress-circle-container">
                            <canvas id="progressChart" width="200" height="200"></canvas>
                            <div class="progress-text">
                                <div class="progress-percentage" id="progressPercentage">0%</div>
                                <div class="progress-label">Conciliado</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modais -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirmar Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Tem certeza que deseja continuar?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
