{% extends "base.html" %}

{% block title %}Controle de Despesas - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('fin_despesas.static', filename='css/despesas_anual.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='shared/process_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="despesas-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar module-header-financeiro">
        <div class="actions-left">
            {{ get_breadcrumb_with_module_colors([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Financeiro', 'icon': 'mdi mdi-currency-usd', 'url': '#'},
                {'name': 'Controle de Despesas', 'icon': 'mdi mdi-cash-minus'}
            ], 'financeiro') }}
            <!-- Resumo de Filtros -->
            <div id="filter-summary" class="filter-summary">
                <span id="filter-summary-text">Vendo dados do ano atual</span>
            </div>
        </div>
        <div class="actions-right">
            <button id="reset-filters" class="btn btn-secondary" style="display: none;">
                <i class="mdi mdi-filter-off"></i>
                Remover Filtros
            </button>
            <button id="open-filters" class="btn btn-primary">
                <i class="mdi mdi-filter"></i>
                Filtros
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="last-update">Carregando dados de despesas...</p>
        </div>
    </div>
    
    <!-- KPI Cards Principais -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-danger" id="kpi-total-despesas">
            <div class="kpi-icon">
                <i class="mdi mdi-cash-minus"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Despesas Totais</p>
                <p class="kpi-value" id="valor-total-despesas">-</p>
                <p class="kpi-variation" id="var-total-despesas">-</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-warning" id="kpi-funcionarios">
            <div class="kpi-icon">
                <i class="mdi mdi-account-group"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Despesas com Funcionários</p>
                <p class="kpi-value" id="valor-funcionarios">-</p>
                <p class="kpi-variation" id="var-funcionarios">-</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-info" id="kpi-folha-liquida">
            <div class="kpi-icon">
                <i class="mdi mdi-wallet"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Folha Líquida</p>
                <p class="kpi-value" id="valor-folha-liquida">-</p>
                <p class="kpi-variation" id="var-folha-liquida">-</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-purple" id="kpi-impostos">
            <div class="kpi-icon">
                <i class="mdi mdi-file-document"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Impostos</p>
                <p class="kpi-value" id="valor-impostos">-</p>
                <p class="kpi-variation" id="var-impostos">-</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-success" id="kpi-percentual-folha">
            <div class="kpi-icon">
                <i class="mdi mdi-percent"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">% Folha sobre Faturamento</p>
                <p class="kpi-value" id="valor-percentual-folha">-</p>
                <p class="kpi-variation" id="var-percentual-folha">Indicador de eficiência operacional</p>
            </div>
        </div>
    </div>
    
    <!-- Seção de Gráficos e Análises -->
    <div class="charts-section">
        <!-- Gráfico de Despesas por Categoria/Centro de Resultado -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title-section">
                    <h3>
                        <i class="mdi mdi-chart-bar"></i>
                        <span id="chart-title">Despesas por Centro de Resultado</span>
                    </h3>
                    <small class="chart-hint">
                        <i class="mdi mdi-information-outline"></i>
                        Clique nas barras para ver detalhes
                    </small>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="chart-categorias" width="400" height="200"></canvas>
            </div>
        </div>
        
        <!-- Gráfico de Tendências Mensais -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>
                    <i class="mdi mdi-chart-line"></i>
                    Tendências Mensais - Top 5 Centro de Resultado → Categoria
                </h3>
            </div>
            <div class="chart-content">
                <canvas id="chart-tendencias" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Seção de Tabelas -->
    <div class="tables-section">
        <!-- Tabela de Análise por Centro de Resultado -->
        <div class="table-container">
            <div class="table-header">
                <h3>
                    <i class="mdi mdi-office-building"></i>
                    Análise por Centro de Resultado
                </h3>
            </div>
            <div class="table-content">
                <div class="enhanced-table-container">
                    <table id="table-centro-resultado" class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Centro de Resultado</th>
                                <th>Valor</th>
                                <th>% do Total</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tabela de Análise por Categoria -->
        <div class="table-container">
            <div class="table-header">
                <h3>
                    <i class="mdi mdi-tag-multiple"></i>
                    Análise por Categoria
                </h3>
            </div>
            <div class="table-content">
                <div class="enhanced-table-container">
                    <table id="table-categoria" class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>% do Total</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Categoria -->
<div id="detalhes-modal" class="modal detalhes-modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-container detalhes-modal-container">
        <div class="modal-header">
            <h3>
                <i class="mdi mdi-magnify"></i>
                Detalhes: <span id="modal-categoria-selecionada">-</span>
            </h3>
            <button id="close-detalhes-modal" class="btn-close">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        
        <div class="modal-body detalhes-modal-body">
            <!-- Estatísticas rápidas da categoria -->
            <div class="detalhes-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="mdi mdi-cash"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Total da Categoria</span>
                        <span class="stat-value" id="modal-total-categoria">-</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="mdi mdi-file-document-multiple"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Nº de Transações</span>
                        <span class="stat-value" id="modal-num-transacoes">-</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="mdi mdi-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Valor Médio</span>
                        <span class="stat-value" id="modal-valor-medio">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Filtros do modal -->
            <div class="detalhes-filters">
                <div class="filter-group">
                    <input type="text" id="modal-search" class="form-control" placeholder="Buscar descrição...">
                </div>
                <div class="filter-group">
                    <select id="modal-classe-filter" class="form-control">
                        <option value="">Todas as Classes</option>
                    </select>
                </div>
            </div>
            
            <!-- Tabela de detalhes -->
            <div class="detalhes-table-container">
                <table id="modal-table-detalhes" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Classe</th>
                            <th>Código</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="modal-footer">
            <!-- Paginação -->
            <div class="pagination-container">
                <button id="modal-btn-prev-page" class="btn btn-sm btn-secondary">
                    <i class="mdi mdi-chevron-left"></i>
                    Anterior
                </button>
                <span id="modal-pagination-info" class="pagination-info">-</span>
                <button id="modal-btn-next-page" class="btn btn-sm btn-secondary">
                    <i class="mdi mdi-chevron-right"></i>
                    Próximo
                </button>
            </div>
            
            <div class="modal-actions">
                <button id="modal-export-btn" class="btn btn-primary">
                    <i class="mdi mdi-download"></i>
                    Exportar
                </button>
                <button id="modal-close-btn" class="btn btn-secondary">
                    <i class="mdi mdi-close"></i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros -->
<div id="filters-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h3>
                <i class="mdi mdi-filter"></i>
                Filtros de Período
            </h3>
            <button id="close-modal" class="btn-close">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label for="periodo-select">Período:</label>
                <select id="periodo-select" class="form-control">
                    <option value="mes_atual">Mês Atual</option>
                    <option value="trimestre_atual">Trimestre Atual</option>
                    <option value="ano_atual" selected>Ano Atual</option>
                    <option value="ultimos_12_meses">Últimos 12 Meses</option>
                    <option value="personalizado">Período Personalizado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="centro-resultado-select">Centro de Resultado:</label>
                <select id="centro-resultado-select" class="form-control">
                    <option value="">Todos os Centros de Resultado</option>
                    <!-- Opções carregadas dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="categoria-select">Categoria:</label>
                <select id="categoria-select" class="form-control">
                    <option value="">Todas as Categorias</option>
                    <!-- Opções carregadas dinamicamente -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="classe-select">Classe:</label>
                <select id="classe-select" class="form-control">
                    <option value="">Todas as Classes</option>
                    <!-- Opções carregadas dinamicamente -->
                </select>
            </div>
            
            <div id="periodo-personalizado" class="form-group" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="data-inicio">Data Início:</label>
                        <input type="date" id="data-inicio" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="data-fim">Data Fim:</label>
                        <input type="date" id="data-fim" class="form-control">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button id="clear-filters" class="btn btn-secondary">
                <i class="mdi mdi-filter-off"></i>
                Limpar
            </button>
            <button id="apply-filters" class="btn btn-primary">
                <i class="mdi mdi-check"></i>
                Aplicar Filtros
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="{{ url_for('fin_despesas.static', filename='js/despesas_anual.js') }}"></script>
<script>
// Inicializar controlador das despesas após o carregamento completo
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que jQuery esteja carregado
    if (typeof $ !== 'undefined') {
        console.log('Inicializando DespesasController...');
        window.despesasController = new DespesasController();
    } else {
        console.error('jQuery não carregado, tentando novamente...');
        setTimeout(function() {
            if (typeof $ !== 'undefined') {
                window.despesasController = new DespesasController();
            } else {
                console.error('Falha ao carregar jQuery');
            }
        }, 500);
    }
});
</script>
{% endblock %}
