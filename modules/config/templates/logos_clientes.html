{% extends "base.html" %}

{% block title %}Logos Clientes - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('config.static', filename='css/config.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('shared.static', filename='css/enhanced-table.css') }}">
{% endblock %}

{% block content %}
<div class="usuarios-container">
    <!-- Actions Bar with Breadcrumb -->
    <div class="actions-bar">
        <div class="actions-left">
            {{ breadcrumb([
                {'name': 'Menu', 'icon': 'mdi mdi-menu', 'url': url_for('menu.menu_home')},
                {'name': 'Configurações', 'icon': 'mdi mdi-cog', 'url': url_for('menu.configuracoes')},
                {'name': 'Logos de Clientes', 'icon': 'mdi mdi-domain'}
            ]) }}
        </div>
                <button type="button" id="add-cnpj" class="btn btn-outline">
                    <i class="mdi mdi-plus"></i>
                    Adicionar manual
                </button>
            </button>
            <button id="btn-adicionar" class="btn btn-primary">
                <i class="mdi mdi-plus"></i>
                Novo Cliente
            </button>
        </div>
        <p class="form-help">Busque por parte da razão social ou CNPJ. Marque múltiplos na lista e clique em "Adicionar selecionados" ou adicione manualmente um CNPJ formatado.</p>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <i class="mdi mdi-domain"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total de Clientes</p>
                <p class="kpi-value" id="kpi-total-clientes">0</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <i class="mdi mdi-office-building"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Total CNPJs</p>
                <p class="kpi-value" id="kpi-total-cnpjs">0</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <i class="mdi mdi-image-multiple"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Com Logos</p>
                <p class="kpi-value" id="kpi-com-logos">0</p>
            </div>
        </div>
        
        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <i class="mdi mdi-image-off"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-label">Sem Logos</p>
                <p class="kpi-value" id="kpi-sem-logos">0</p>
            </div>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="mdi mdi-magnify search-icon"></i>
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Buscar por nome, CNPJ ou razão social..."
                    autocomplete="off"
                >
            </div>
        </div>
        
        <div class="filter-controls">
            <button type="button" id="clear-filters" class="btn btn-outline">
                <i class="mdi mdi-filter-remove"></i>
                Limpar Filtros
            </button>
        </div>
    </div>

    <!-- Table Section -->
    <div class="enhanced-table-section">
        <div class="enhanced-table-header">
            <h3 class="enhanced-table-title">
                <i class="mdi mdi-domain"></i>
                Clientes Cadastrados
            </h3>
            <div class="enhanced-table-controls">
                <span class="enhanced-table-count" id="table-count">
                    <i class="mdi mdi-counter"></i>
                    <span id="count-display">0 clientes</span>
                </span>
            </div>
        </div>
        
        <div class="enhanced-table-container">
            <table class="enhanced-data-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Logo</th>
                        <th>Cliente</th>
                        <th>CNPJs Associados</th>
                        <th style="width: 100px; text-align: center;">Total CNPJs</th>
                        <th style="width: 120px; text-align: center;">Ações</th>
                    </tr>
                </thead>
                <tbody id="clientes-tbody">
                    <tr>
                        <td colspan="5" class="loading-state">
                            <div class="loading-spinner">
                                <i class="mdi mdi-loading mdi-spin"></i>
                                Carregando clientes...
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">
                <i class="mdi mdi-domain-off"></i>
            </div>
            <h3 class="empty-state-title">Nenhum cliente encontrado</h3>
            <p class="empty-state-description">
                Não há clientes cadastrados ou nenhum cliente corresponde aos filtros aplicados.
            </p>
            <button id="btn-add-first-client" class="btn btn-primary">
                <i class="mdi mdi-plus"></i>
                Adicionar Primeiro Cliente
            </button>
        </div>
    </div>
</div>

<!-- Modal de Cliente -->
<div id="modal-cliente" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="modal-title" class="modal-title">
                <i class="mdi mdi-domain"></i>
                Adicionar Cliente
            </h3>
            <button type="button" onclick="closeClienteModal()" class="modal-close">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        
        <form id="form-cliente" method="POST">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome_cliente" class="form-label required">Nome do Cliente</label>
                        <input 
                            type="text" 
                            id="nome_cliente" 
                            name="nome_cliente" 
                            required 
                            class="form-input" 
                            placeholder="Nome do cliente no sistema"
                        >
                        <p class="form-help">Nome que será exibido no sistema para identificar o cliente</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="cnpjs" class="form-label required">CNPJs Associados</label>
                        <div id="cnpjs-container" class="cnpj-management">
                            <div class="cnpj-input-group">
                                <input 
                                    type="text" 
                                    id="cnpj-input" 
                                    class="form-input" 
                                    placeholder="Digite parte do nome (razão social) ou CNPJ" 
                                    maxlength="60"
                                    autocomplete="off"
                                    name="cnpj-input"
                                >
                                <!-- Dropdown de sugestões -->
                                <div id="cnpj-suggestions" class="autocomplete-suggestions hidden"></div>
                                <button type="button" id="btn-pesquisar-empresas" class="btn btn-secondary">
                                    <i class="mdi mdi-magnify"></i>
                                    Pesquisar empresas
                                </button>
                                <button type="button" id="add-cnpj" class="btn btn-outline">
                                    <i class="mdi mdi-plus"></i>
                                    Adicionar
                                </button>
                            </div>
                            
                            <div id="selected-cnpjs" class="selected-cnpjs-list">
                                <!-- CNPJs selecionados aparecerão aqui -->
                            </div>
                        </div>
                        <p class="form-help">
                            Fluxo: Digite parte do nome e clique em <strong>Pesquisar empresas</strong> para listar e selecionar múltiplas. <br>
                            Ou informe diretamente um CNPJ (14 dígitos) e clique em <strong>Adicionar</strong> para inclusão manual.
                        </p>
                    </div>
                    
                    <div class="logo-upload-section">
                        <h4 class="section-title">
                            <i class="mdi mdi-image"></i>
                            Logo do Cliente
                        </h4>
                        
                        <div class="logo-upload-options">
                            <div class="form-group">
                                <label for="logo_file" class="form-label">Upload do Arquivo</label>
                                <input type="file" id="logo_file" accept="image/*" class="form-input">
                                <p class="form-help">Formatos aceitos: JPG, PNG, GIF, SVG (máx. 2MB)</p>
                            </div>
                            
                            <div class="upload-divider">
                                <span>ou</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="logo_url" class="form-label">URL da Imagem</label>
                                <input 
                                    type="url" 
                                    id="logo_url" 
                                    name="logo_url" 
                                    class="form-input" 
                                    placeholder="https://exemplo.com/logo.png"
                                >
                                <p class="form-help">Insira uma URL válida de imagem disponível na internet</p>
                            </div>
                        </div>
                        
                        <!-- Preview do Logo -->
                        <div id="logo-preview" class="logo-preview-container hidden">
                            <label class="form-label">Preview do Logo</label>
                            <div class="logo-preview-wrapper">
                                <img id="logo-preview-img" src="" alt="Preview" class="logo-preview-image">
                                <button type="button" id="remove-preview" class="remove-preview-btn">
                                    <i class="mdi mdi-close"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeClienteModal()" class="btn btn-outline">
                    <i class="mdi mdi-close"></i>
                    Cancelar
                </button>
                <button type="submit" id="btn-salvar" class="btn btn-primary">
                    <i class="mdi mdi-check"></i>
                    <span id="btn-salvar-text">Salvar Cliente</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Pesquisa de Empresas -->
<div id="modal-pesquisa-empresas" class="modal-overlay" style="display:none;">
    <div class="modal-container" style="max-width:760px;">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="mdi mdi-domain-search"></i>
                Selecionar Empresas
            </h3>
            <button type="button" class="modal-close" onclick="fecharModalPesquisaEmpresas()">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        <div class="modal-body" style="padding-top:0.5rem;">
                <div class="search-empresas-bar" style="display:flex; gap:.5rem; align-items:center; margin-bottom:1rem;">
                        <input type="text" id="input-termo-pesquisa-empresas" class="form-input" placeholder="Refine a busca" maxlength="60" autocomplete="off" />
                        <button type="button" class="btn btn-secondary" id="btn-refazer-pesquisa">
                                <i class="mdi mdi-refresh"></i>
                                Pesquisar
                        </button>
                </div>
                <div id="resultado-pesquisa-empresas" class="empresas-result-list" style="max-height:380px; overflow:auto; border:1px solid #e5e7eb; border-radius:6px; background:#fff;">
                        <div class="placeholder" style="padding:1rem; color:#6b7280; font-size:.9rem;">Digite um termo e clique em Pesquisar empresas.</div>
                </div>
                <div class="modal-footer" style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:.85rem; color:#6b7280;" id="status-pesquisa-empresas"></div>
                        <div style="display:flex; gap:.5rem;">
                                <button type="button" class="btn btn-outline" onclick="fecharModalPesquisaEmpresas()">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="btn-adicionar-empresas-selecionadas" disabled>Adicionar selecionados (0)</button>
                        </div>
                </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mdi/font@7.0.96/js/materialdesignicons.min.js"></script>
<script src="{{ url_for('config.static', filename='js/logos-clientes-sistema.js') }}"></script>

<script>
// Funções globais para o modal
function closeClienteModal() {
    const modal = document.getElementById('modal-cliente');
    const form = document.getElementById('form-cliente');
    
    if (modal) {
        modal.style.display = 'none';
    }
    
    if (form) {
        form.reset();
    }
    
    // Limpar preview
    const preview = document.getElementById('logo-preview');
    if (preview) {
        preview.classList.add('hidden');
    }
    
    // Resetar variáveis globais se existirem
    if (typeof selectedCnpjs !== 'undefined') {
        selectedCnpjs = [];
        if (typeof renderSelectedCnpjs === 'function') {
            renderSelectedCnpjs();
        }
    }
}

// Event listeners para botões de ação
document.addEventListener('DOMContentLoaded', function() {
    // Botão refresh
    const btnRefresh = document.getElementById('btn-refresh');
    if (btnRefresh) {
        btnRefresh.addEventListener('click', function() {
            if (typeof loadClientes === 'function') {
                loadClientes();
            }
        });
    }
    
    // Botão adicionar do empty state
    const btnAddFirst = document.getElementById('btn-add-first-client');
    if (btnAddFirst) {
        btnAddFirst.addEventListener('click', function() {
            if (typeof openModal === 'function') {
                openModal();
            }
        });
    }
    
    // Preview de logo - remover
    const removePreview = document.getElementById('remove-preview');
    if (removePreview) {
        removePreview.addEventListener('click', function() {
            const preview = document.getElementById('logo-preview');
            const logoUrl = document.getElementById('logo_url');
            const logoFile = document.getElementById('logo_file');
            
            if (preview) preview.classList.add('hidden');
            if (logoUrl) logoUrl.value = '';
            if (logoFile) logoFile.value = '';
        });
    }
});
</script>
{% endblock %}
