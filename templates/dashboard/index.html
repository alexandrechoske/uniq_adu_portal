{% extends "base.html" %}

{% block title %}Dashboard Geral - Portal UniSystem{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table-sort.css') }}">
<style>
    /* Estilos para quebra de linha em células específicas */
    .break-lines {
        white-space: normal;
        word-wrap: break-word;
        max-width: 150px;
        line-height: 1.3;
        font-size: 0.85rem;
    }
    
    .break-lines-cliente {
        white-space: normal;
        word-wrap: break-word;
        max-width: 120px;
        line-height: 1.3;
        font-size: 0.8rem;
    }

    /* Estilos para os cards de métricas */
    .metric-card {
        background-color: white; /* Fundo branco */
        border-radius: 0.75rem; /* Bordas mais arredondadas */
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb; /* Borda leve */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Sombra leve */
        min-height: 120px; /* Altura mínima para estabilizar */
        display: flex;
        align-items: center;
    }

    .metric-card:hover {
        transform: translateY(-4px); /* Efeito de levantar */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra mais pronunciada no hover */
    }

    .metric-icon-wrapper {
        padding: 0.75rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid;
        transition: all 0.2s;
    }

    .metric-icon-wrapper:hover {
        transform: scale(1.05);
    }

    /* Cores das métricas (usando classes customizadas) */
    .color-blue {
        background-color: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.2);
        color: #2563eb;
    }

    .color-green {
        background-color: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.2);
        color: #059669;
    }

    .color-yellow {
        background-color: rgba(245, 158, 11, 0.1);
        border-color: rgba(245, 158, 11, 0.2);
        color: #d97706;
    }

    .color-purple {
        background-color: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.2);
        color: #7c3aed;
    }

    .color-red {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.2);
        color: #dc2626;
    }

    .color-orange {
        background-color: rgba(251, 146, 60, 0.1);
        border-color: rgba(251, 146, 60, 0.2);
        color: #ea580c;
    }

    .color-emerald {
        background-color: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.2);
        color: #059669;
    }

    .color-cyan {
        background-color: rgba(6, 182, 212, 0.1);
        border-color: rgba(6, 182, 212, 0.2);
        color: #0891b2;
    }

    .metric-value {
        font-size: 1.875rem; /* text-3xl */
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
        color: #1f2937; /* Cor mais escura para o valor */
    }

    .metric-title {
        color: #4b5563;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem; /* Aumentar espaço */
    }

    /* Estilos para indicadores de câmbio */
    .currency-container {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    
    .currency-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .currency-symbol {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
    }

    /* Estilos para a tabela */
    .table-wrapper {
        background: white; /* Fundo branco para o wrapper da tabela */
        border-radius: 0.75rem; /* Mais arredondado */
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        width: 100%; /* Garante que o wrapper ocupe a largura total do seu contêiner */
        max-width: none; /* Remove qualquer restrição de largura máxima */
        margin-top: 1.5rem; /* Espaço acima da tabela */
    }

    .table-header {
        background: #f8fafc;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .table-title {
        font-family: 'Inter', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .table-scroll {
        overflow-x: auto;
        max-height: 500px;
        overflow-y: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: white; /* Garante fundo branco para a tabela */
        font-size: 0.875rem;
        font-family: 'Inter', sans-serif;
    }

    .data-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table th {
        background: #f3f4f6;
        padding: 1rem 1.25rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        font-family: 'Inter', sans-serif;
    }

    .data-table td {
        padding: 1rem 1.25rem;
        color: #4b5563;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
        font-family: 'Inter', sans-serif;
        background: transparent; /* Permite que a zebra stripe apareça */
    }

    .data-table tbody tr:nth-child(even) td {
        background-color: #f9fafb; /* Cinza claro para as listras de zebra */
    }

    .data-table tbody tr:hover td {
        background-color: #f0f9ff;
        transition: background-color 0.2s ease;
    }

    /* Status colors */
    .status-aguardando-embarque {
        color: #f59e0b; /* amber-500 */
        background-color: rgba(245, 158, 11, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-em-transito {
        color: #3b82f6; /* blue-500 */
        background-color: rgba(59, 130, 246, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-desembarcada {
        color: #10b981; /* emerald-500 */
        background-color: rgba(16, 185, 129, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-default {
        color: #6b7280; /* gray-500 */
        background-color: rgba(107, 114, 128, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 2.5rem 1.25rem;
        color: #6b7280;
        font-style: italic;
        font-family: 'Inter', sans-serif;
    }

    /* Estilos específicos para select e botões */
    .company-select {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #374151;
    }

    .company-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* ring-blue-500 */
        border-color: #3b82f6; /* border-blue-500 */
    }

    /* Responsive */
    @media (max-width: 640px) {
        .mobile-hidden {
            display: none;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.75rem;
        }

        .table-header {
            padding: 1rem;
        }

        .table-title {
            font-size: 1.125rem;
        }
        
        /* Ajustes para os KPIs mobile */
        .metric-value {
            font-size: 1.5rem;
        }
        
        .metric-title {
            font-size: 0.75rem;
        }
    }
    
    /* Tablet e desktop médio */
    @media (max-width: 1024px) {
        .metric-value {
            font-size: 1.75rem;
        }
    }

    /* Animações */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideInUp 0.6s ease-out;
    }

    /* Estilos para os gráficos */
    .chart-container {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        min-height: 380px; /* Altura mínima otimizada */
        max-height: 450px; /* Altura máxima para melhor visualização */
        display: flex;
        flex-direction: column;
    }

    /* Específico para o gráfico mensal (que ocupa 2 colunas) */
    .chart-container.lg\\:col-span-2 {
        min-height: 380px;
        max-height: 450px;
    }

    /* Específico para o gráfico de rosca (que ocupa 1 coluna) */
    .chart-container.lg\\:col-span-1 {
        min-height: 380px;
        max-height: 450px;
    }

    /* Ajustes para tabelas dentro do grid de gráficos */
    .table-wrapper.lg\\:col-span-2 {
        min-height: 380px;
        max-height: 450px;
        display: flex;
        flex-direction: column;
    }

    .table-wrapper.lg\\:col-span-2 .table-scroll {
        flex: 1;
        overflow-y: auto;
    }

    .chart-container:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
    }

    /* Ajustes para os divs internos dos gráficos */
    .chart-container > div {
        height: 100%;
        width: 100%;
    }

    /* Responsive para gráficos */
    @media (max-width: 1024px) {
        .chart-container {
            margin-bottom: 1rem;
        }
        
        /* Em telas menores, todos os containers têm a mesma altura */
        .chart-container.lg\\:col-span-2,
        .chart-container.lg\\:col-span-1,
        .table-wrapper.lg\\:col-span-2 {
            min-height: 350px;
            max-height: 400px;
        }
        
        /* Ajustes para grid de 5 colunas em telas menores */
        .lg\\:grid-cols-5 {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard-table-sort.js') }}"></script>
<script>
    // Animação de entrada
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.metric-card, .chart-container');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('animate-slide-in');
            }, index * 100);
        });

        // Redimensionar gráficos quando necessário
        window.addEventListener('resize', function() {
            if (typeof Plotly !== 'undefined') {
                const charts = ['daily-chart', 'canal-chart', 'radar-chart', 'material-chart'];
                charts.forEach(chartId => {
                    const element = document.getElementById(chartId);
                    if (element) {
                        Plotly.Plots.resize(element);
                    }
                });
            }
        });
    });

    // Filtro por empresa
    function filterByCompany(value) {
        const url = new URL(window.location);
        if (value) {
            url.searchParams.set('empresa', value);
        } else {
            url.searchParams.delete('empresa');
        }
        window.location.href = url.toString();
    }
</script>
{% endblock %}

{% block content %}
<div class="p-4 bg-slate-50 min-h-screen">
    {# Header Section #}
    <div class="mb-6">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div class="flex items-center gap-4 flex-grow">
                <h1 class="text-2xl font-bold text-slate-800">Dashboard Executivo</h1>
            </div>
            
            {% if user_role in ['interno_unique', 'admin'] %}
            <div class="flex items-center space-x-4 flex-wrap justify-end gap-2">
                <select id="company-filter" class="company-select px-4 py-2 border border-slate-300 rounded-md bg-white text-sm text-slate-700 focus:ring-blue-500 focus:border-blue-500" onchange="filterByCompany(this.value)">
                    <option value="">Todas as empresas</option>
                    {% for company in companies %}
                    <option value="{{ company.cpfcnpj }}" {% if selected_company == company.cpfcnpj %}selected{% endif %}>
                        {{ company.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        
        {# Subtitle com última atualização #}
        <p class="text-sm text-slate-600 mt-2">Visão geral das operações de importação • Atualizado em {{ last_update }}</p>
    </div>

    {# KPI Cards Section - Desktop Layout #}
    <div class="mb-6 hidden lg:block">
        {# Primeira linha: Operações e Status #}
        <div class="grid grid-cols-6 gap-4 mb-4">
            {# Total de Operações #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Total Operações</p>
                    <p class="text-2xl font-bold text-blue-600 metric-value">{{ kpis.total or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-blue-100 text-blue-600 metric-icon-wrapper color-blue ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M12 15h.01"></path></svg>
                </div>
            </div>

            {# Aguardando Embarque #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Aguard. Embarque</p>
                    <p class="text-2xl font-bold text-orange-600 metric-value">{{ kpis.aguardando_embarque or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-orange-100 text-orange-600 metric-icon-wrapper color-orange ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>

            {# Em Trânsito #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Em Trânsito</p>
                    <p class="text-2xl font-bold text-blue-600 metric-value">{{ kpis.em_transito or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-blue-100 text-blue-600 metric-icon-wrapper color-blue ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>

            {# Desembarcadas #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Desembarcadas</p>
                    <p class="text-2xl font-bold text-green-600 metric-value">{{ kpis.desembarcadas or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-green-100 text-green-600 metric-icon-wrapper color-green ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>

            {# Aéreo #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Aéreo</p>
                    <p class="text-2xl font-bold text-green-600 metric-value">{{ kpis.aereo or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-green-100 text-green-600 metric-icon-wrapper color-green ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </div>
            </div>

            {# Marítimo #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Marítimo</p>
                    <p class="text-2xl font-bold text-purple-600 metric-value">{{ kpis.maritimo or 0 }}</p>
                </div>
                <div class="p-2 rounded-full bg-purple-100 text-purple-600 metric-icon-wrapper color-purple ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18v-9"></path></svg>
                </div>
            </div>
        </div>

        {# Segunda linha: Valores #}
        <div class="grid grid-cols-4 gap-4 mb-4">
            {# Valor Total #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Valor Total</p>
                    <p class="text-2xl font-bold text-purple-600 metric-value">{{ kpis.valor_total_formatted or 'R$ 0' }}</p>
                </div>
                <div class="p-2 rounded-full bg-purple-100 text-purple-600 metric-icon-wrapper color-purple ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path></svg>
                </div>
            </div>

            {# Valor Médio por Processo #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Valor Médio</p>
                    <p class="text-2xl font-bold text-indigo-600 metric-value">{{ kpis.valor_medio_processo_formatted or 'R$ 0' }}</p>
                </div>
                <div class="p-2 rounded-full bg-indigo-100 text-indigo-600 metric-icon-wrapper color-purple ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                </div>
            </div>

            {# Valor Semana Atual #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Semana Atual</p>
                    <p class="text-2xl font-bold text-emerald-600 metric-value">{{ kpis.vmcv_semana_formatted or 'R$ 0' }}</p>
                </div>
                <div class="p-2 rounded-full bg-emerald-100 text-emerald-600 metric-icon-wrapper color-green ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
            </div>

            {# Semana S+1 #}
            <div class="metric-card p-4 flex items-center justify-between bg-white shadow-sm rounded-lg">
                <div class="text-center w-full">
                    <p class="text-xs font-medium text-slate-500 metric-title mb-1">Semana S+1</p>
                    <p class="text-2xl font-bold text-cyan-600 metric-value">{{ kpis.vmcv_proxima_semana_formatted or 'R$ 0' }}</p>
                </div>
                <div class="p-2 rounded-full bg-cyan-100 text-cyan-600 metric-icon-wrapper color-blue ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                </div>
            </div>
        </div>
    </div>

    {# KPI Cards Section - Mobile Layout #}
    <div class="lg:hidden mb-6">
        {# Grid responsivo mobile #}
        <div class="grid grid-cols-2 gap-4 mb-4">
            {# Total de Operações #}
            <div class="metric-card p-4 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-blue-100 text-blue-600 metric-icon-wrapper color-blue mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M12 15h.01"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Total Operações</p>
                <p class="text-xl font-bold text-blue-600 metric-value">{{ kpis.total or 0 }}</p>
            </div>

            {# Valor Total #}
            <div class="metric-card p-4 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-purple-100 text-purple-600 metric-icon-wrapper color-purple mb-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Valor Total</p>
                <p class="text-xl font-bold text-purple-600 metric-value">{{ kpis.valor_total_formatted or 'R$ 0' }}</p>
            </div>
        </div>

        {# Segunda linha mobile - Status #}
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="metric-card p-3 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-orange-100 text-orange-600 metric-icon-wrapper color-orange mb-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Aguard. Embarque</p>
                <p class="text-lg font-bold text-orange-600 metric-value">{{ kpis.aguardando_embarque or 0 }}</p>
            </div>

            <div class="metric-card p-3 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-blue-100 text-blue-600 metric-icon-wrapper color-blue mb-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Em Trânsito</p>
                <p class="text-lg font-bold text-blue-600 metric-value">{{ kpis.em_transito or 0 }}</p>
            </div>

            <div class="metric-card p-3 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-green-100 text-green-600 metric-icon-wrapper color-green mb-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Desembarcadas</p>
                <p class="text-lg font-bold text-green-600 metric-value">{{ kpis.desembarcadas or 0 }}</p>
            </div>
        </div>

        {# Terceira linha mobile - Modais #}
        <div class="grid grid-cols-2 gap-2 mb-4">
            <div class="metric-card p-3 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-green-100 text-green-600 metric-icon-wrapper color-green mb-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Aéreo</p>
                <p class="text-lg font-bold text-green-600 metric-value">{{ kpis.aereo or 0 }}</p>
            </div>

            <div class="metric-card p-3 flex flex-col items-center bg-white shadow-sm rounded-lg">
                <div class="p-2 rounded-full bg-purple-100 text-purple-600 metric-icon-wrapper color-purple mb-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18v-9"></path></svg>
                </div>
                <p class="text-xs font-medium text-slate-500 metric-title mb-1 text-center">Marítimo</p>
                <p class="text-lg font-bold text-purple-600 metric-value">{{ kpis.maritimo or 0 }}</p>
            </div>
        </div>
    </div>

    {# Seção de Gráficos - Nova Estrutura #}
    <div class="mb-6">
        {# Primeira linha: Gráfico Mensal (2 cols) + Rosca Canal (1 col) #}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            {# Gráfico mensal ocupando 2 colunas #}
            {% if monthly_chart %}
            <div class="chart-container p-4 lg:col-span-2">
                <div id="monthly-chart">
                    {{ monthly_chart|safe }}
                </div>
            </div>
            {% endif %}

            {# Gráfico de rosca por canal DI ocupando 1 coluna #}
            {% if canal_chart %}
            <div class="chart-container p-4 lg:col-span-1">
                <div id="canal-chart">
                    {{ canal_chart|safe }}
                </div>
            </div>
            {% endif %}
        </div>

        {# Segunda linha: Radar de Armazéns, Barra de Materiais e Tabela de Análise #}
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
            {# Gráfico de radar por armazém - 1 coluna #}
            {% if radar_chart %}
            <div class="chart-container p-4 lg:col-span-1">
                <div id="radar-chart">
                    {{ radar_chart|safe }}
                </div>
            </div>
            {% endif %}

            {# Gráfico de barras por material - 2 colunas #}
            {% if material_chart %}
            <div class="chart-container p-4 lg:col-span-2">
                <div id="material-chart">
                    {{ material_chart|safe }}
                </div>
            </div>
            {% endif %}
            {# Análise por Material - Tabela Compacta - 2 colunas #}
            {% if material_analysis %}
            <div class="table-wrapper shadow-lg rounded-xl bg-white overflow-hidden border border-gray-200 lg:col-span-2">
                <div class="table-header bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">Análise por Material</h3>
                </div>
                <div class="table-scroll" style="max-height: 300px;">
                    <table class="data-table bg-white" id="material-analysis-table">
                        <thead>
                            <tr>
                                <th class="sortable text-xs px-3 py-2" data-sort="material">Item</th>
                                <th class="sortable text-xs px-3 py-2" data-sort="quantidade">Total Proc.</th>
                                <th class="sortable text-xs px-3 py-2" data-sort="valor_total">Valor Total</th>
                                <th class="sortable text-xs px-3 py-2" data-sort="valor_semana_atual">Semana Atual</th>
                                <th class="sortable text-xs px-3 py-2" data-sort="valor_proxima_semana">S+1</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in material_analysis %}
                            <tr>
                                <td class="font-medium text-xs px-3 py-2">{{ material.material[:20] }}{% if material.material|length > 20 %}...{% endif %}</td>
                                <td class="text-center text-xs px-3 py-2" data-sort-value="{{ material.quantidade }}">{{ material.quantidade }}</td>
                                <td class="text-right text-xs px-3 py-2" data-sort-value="{{ material.valor_total }}">{{ material.valor_total_formatado }}</td>
                                <td class="text-right text-xs px-3 py-2" data-sort-value="{{ material.valor_semana_atual }}">{{ material.valor_semana_atual_formatado }}</td>
                                <td class="text-right text-xs px-3 py-2" data-sort-value="{{ material.valor_proxima_semana }}">{{ material.valor_proxima_semana_formatado }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {# Tabela Principal de Importações #}
    <div class="table-wrapper w-full shadow-lg rounded-xl bg-white overflow-hidden border border-gray-200">
        <div class="table-header bg-gray-50 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Operações de Importação</h3>
        </div>
        <div class="table-scroll">
            <table class="data-table bg-white" id="importacoes-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="cliente_razaosocial">Cliente</th>
                        <th class="sortable" data-sort="nro_pedido">Nº Pedido</th>
                        <th class="sortable" data-sort="data_embarque">Data Embarque</th>
                        <th class="sortable" data-sort="local_embarque">Local Embarque</th>
                        <th class="sortable" data-sort="via_transporte_descricao">Modal</th>
                        <th class="sortable" data-sort="carga_status">Status</th>
                        <th class="sortable mobile-hidden" data-sort="resumo_mercadoria">Mercadoria</th>
                        <th class="sortable mobile-hidden" data-sort="despesas">Despesas</th>
                        <th class="sortable" data-sort="armazem_nome">Recinto</th>
                        <th class="sortable mobile-hidden" data-sort="data_chegada">Data Chegada</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td class="break-lines-cliente">{{ row.cliente_razaosocial or '-' }}</td>
                        <td class="font-medium">{{ row.nro_pedido or '-' }}</td>
                        <td>{{ row.data_embarque or '-' }}</td>
                        <td class="break-lines">{{ row.local_embarque or '-' }}</td>
                        <td class="text-center">
                            {% if row.via_transporte_descricao == 'AEREO' %}
                                <span class="inline-flex items-center text-green-600">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    Aéreo
                                </span>
                            {% elif row.via_transporte_descricao == 'MARITIMO' %}
                                <span class="inline-flex items-center text-blue-600">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18v-9"></path>
                                    </svg>
                                    Marítimo
                                </span>
                            {% elif row.via_transporte_descricao == 'TERRESTRE' %}
                                <span class="inline-flex items-center text-yellow-600">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                                    </svg>
                                    Terrestre
                                </span>
                            {% else %}
                                {{ row.via_transporte_descricao or '-' }}
                            {% endif %}
                        </td>
                        <td>
                            {% if row.carga_status %}
                                {% if 'aguardando embarque' in row.carga_status.lower() %}
                                    <span class="status-aguardando-embarque">{{ row.carga_status }}</span>
                                {% elif 'em transito' in row.carga_status.lower() or 'trânsito' in row.carga_status.lower() %}
                                    <span class="status-em-transito">{{ row.carga_status }}</span>
                                {% elif 'desembarcada' in row.carga_status.lower() %}
                                    <span class="status-desembarcada">{{ row.carga_status }}</span>
                                {% else %}
                                    <span class="status-default">{{ row.carga_status }}</span>
                                {% endif %}
                            {% else %}
                                <span class="status-default">N/A</span>
                            {% endif %}
                        </td>
                        <td class="mobile-hidden">{{ row.resumo_mercadoria or '-' }}</td>
                        <td class="text-right mobile-hidden" data-sort-value="{{ row.despesas or 0 }}">R$ {{ "{:,.2f}".format(row.despesas or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        <td>{{ row.armazem_nome or '-' }}</td>
                        <td class="mobile-hidden">{{ row.data_chegada or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
