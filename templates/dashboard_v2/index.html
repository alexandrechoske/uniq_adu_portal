{% extends "base.html" %}

{% block title %}Dashboard Executivo - Portal UniSystem{% endblock %}

{% block content %}
<div class="container">
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p>Carregando dados...</p>
        </div>
    </div>

    <!-- Header -->
    <div style="margin-bottom: 30px;">
        <h1>Dashboard Executivo</h1>
        <p>Visão geral das operações de importação</p>
        <span id="last-update">Última atualização: --</span>
    </div>
    
    <!-- Tabs -->
    <div style="margin-bottom: 30px;">
        <div style="border-bottom: 2px solid #ddd;">
            <button id="tab-dashboard" class="tab-button active" onclick="showTab('dashboard')">Dashboard Executivo</button>
            <button id="tab-materiais" class="tab-button" onclick="showTab('materiais')">Análise de Materiais</button>
        </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-content" class="tab-content active">
        <!-- KPI Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="kpi-card">
                <div id="kpi-total-processos" class="kpi-value">-</div>
                <div class="kpi-label">Total de Processos</div>
            </div>
            <div class="kpi-card">
                <div id="kpi-total-despesas" class="kpi-value">-</div>
                <div class="kpi-label">Total Despesas (R$)</div>
            </div>
            <div class="kpi-card">
                <div id="kpi-modal-aereo" class="kpi-value">-</div>
                <div class="kpi-label">Modal Aéreo</div>
            </div>
            <div class="kpi-card">
                <div id="kpi-modal-maritimo" class="kpi-value">-</div>
                <div class="kpi-label">Modal Marítimo</div>
            </div>
            <div class="kpi-card">
                <div id="kpi-em-transito" class="kpi-value">-</div>
                <div class="kpi-label">Em Trânsito</div>
            </div>
            <div class="kpi-card">
                <div id="kpi-di-registrada" class="kpi-value">-</div>
                <div class="kpi-label">DI Registrada</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="chart-container">
                <h3>Evolução Mensal</h3>
                <canvas id="monthly-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Distribuição por Modal</h3>
                <canvas id="modal-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top URFs</h3>
                <canvas id="urf-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top Materiais</h3>
                <canvas id="material-chart"></canvas>
            </div>
        </div>
        
        <!-- Recent Operations Table -->
        <div style="margin-bottom: 30px;">
            <h3>Operações Recentes</h3>
            <div id="recent-operations-table">
                <table id="operations-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Processo</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Cliente</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Data</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Modal</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Mercadoria</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Custo Total</th>
                        </tr>
                    </thead>
                    <tbody id="operations-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Materiais Tab -->
    <div id="materiais-content" class="tab-content">
        <!-- Materiais KPI Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="kpi-card">
                <div id="mat-total-processos" class="kpi-value">-</div>
                <div class="kpi-label">Total de Processos</div>
            </div>
            <div class="kpi-card">
                <div id="mat-total-materiais" class="kpi-value">-</div>
                <div class="kpi-label">Tipos de Materiais</div>
            </div>
            <div class="kpi-card">
                <div id="mat-valor-total" class="kpi-value">-</div>
                <div class="kpi-label">Valor Total CIF (R$)</div>
            </div>
            <div class="kpi-card">
                <div id="mat-custo-total" class="kpi-value">-</div>
                <div class="kpi-label">Custo Total (R$)</div>
            </div>
            <div class="kpi-card">
                <div id="mat-ticket-medio" class="kpi-value">-</div>
                <div class="kpi-label">Ticket Médio (R$)</div>
            </div>
            <div class="kpi-card">
                <div id="mat-transit-time" class="kpi-value">-</div>
                <div class="kpi-label">Transit Time Médio (dias)</div>
            </div>
            <!-- Novas métricas: KPIs mês/semana -->
            <div class="kpi-card kpi-new">
                <div id="mat-processos-mes" class="kpi-value">-</div>
                <div class="kpi-label">Processos no Mês</div>
            </div>
            <div class="kpi-card kpi-new">
                <div id="mat-custo-mes" class="kpi-value">-</div>
                <div class="kpi-label">Custo no Mês (R$)</div>
            </div>
            <div class="kpi-card kpi-new">
                <div id="mat-processos-semana" class="kpi-value">-</div>
                <div class="kpi-label">Processos na Semana</div>
            </div>
            <div class="kpi-card kpi-new">
                <div id="mat-custo-semana" class="kpi-value">-</div>
                <div class="kpi-label">Custo na Semana (R$)</div>
            </div>
        </div>
        
        <!-- Materiais Filters -->
        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h4>Filtros</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label>Data Início:</label>
                    <input type="date" id="filter-data-inicio" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label>Data Fim:</label>
                    <input type="date" id="filter-data-fim" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label>Material:</label>
                    <select id="filter-material" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label>Cliente:</label>
                    <select id="filter-cliente" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label>Modal:</label>
                    <select id="filter-modal" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label>Canal:</label>
                    <select id="filter-canal" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="applyFilters()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Aplicar Filtros</button>
                <button onclick="clearFilters()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Limpar</button>
            </div>
        </div>
        
        <!-- Materiais Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="chart-container">
                <h3>Top 10 Materiais</h3>
                <canvas id="top-materiais-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Evolução Mensal - Top 3</h3>
                <canvas id="evolucao-mensal-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Distribuição por Modal</h3>
                <canvas id="mat-modal-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Distribuição por Canal</h3>
                <canvas id="canal-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Transit Time por Material</h3>
                <canvas id="transit-time-chart"></canvas>
            </div>
        </div>
        
        <!-- Materiais Table -->
        <div style="margin-bottom: 30px;">
            <h3>Detalhamento dos Processos</h3>
            <div id="materiais-table">
                <table id="detalhamento-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; border: 1px solid #ddd;">Processo</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Cliente</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Data</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Mercadoria</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Modal</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Valor CIF</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Custo Total</th>
                        </tr>
                    </thead>
                    <tbody id="detalhamento-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.tab-button {
    padding: 10px 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    cursor: pointer;
    margin-right: 5px;
    border-radius: 5px 5px 0 0;
}

.tab-button.active {
    background: #007bff;
    color: white;
}

.tab-content {
    display: none;
    padding: 20px 0;
}

.tab-content.active {
    display: block;
}

.kpi-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kpi-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 10px;
}

.kpi-label {
    font-size: 0.9rem;
    color: #666;
}

.chart-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chart-container h3 {
    margin-top: 0;
    color: #333;
}

.chart-container canvas {
    max-height: 300px;
}

table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

th {
    background: #f8f9fa;
    font-weight: 600;
}

td {
    padding: 10px;
    border: 1px solid #dee2e6;
}

tr:nth-child(even) {
    background: #f9f9f9;
}

tr:hover {
    background: #e9ecef;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let dashboardData = null;
let materiaisCharts = {};
let dashboardCharts = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DASHBOARD_V2] Inicializando...');
    loadInitialData();
    setupDefaultDateFilters();
});

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-content').classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Load specific data for tab
    if (tabName === 'materiais') {
        loadMateriaisData();
    }
}

function setupDefaultDateFilters() {
    const hoje = new Date();
    const trintaDiasAtras = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('filter-data-inicio').value = trintaDiasAtras.toISOString().split('T')[0];
    document.getElementById('filter-data-fim').value = hoje.toISOString().split('T')[0];
}

async function loadInitialData() {
    try {
        console.log('[DASHBOARD_V2] Carregando dados iniciais...');
        
        // Load data from view
        const response = await fetch('/dashboard-v2/api/load-data');
        const result = await response.json();
        
        if (result.success) {
            dashboardData = result.data;
            console.log('[DASHBOARD_V2] Dados carregados:', result.total_records, 'registros');
            
            // Load dashboard data
            await loadDashboardData();
            
            // Load filter options
            await loadFilterOptions();
            
            // Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';
            
            // Update last update time
            document.getElementById('last-update').textContent = 'Última atualização: ' + new Date().toLocaleString('pt-BR');
        } else {
            console.error('[DASHBOARD_V2] Erro ao carregar dados:', result.error);
            alert('Erro ao carregar dados: ' + result.error);
        }
    } catch (error) {
        console.error('[DASHBOARD_V2] Erro:', error);
        alert('Erro ao carregar dados: ' + error.message);
    }
}

async function loadDashboardData() {
    try {
        // Load KPIs
        const kpiResponse = await fetch('/dashboard-v2/api/dashboard-kpis');
        const kpiResult = await kpiResponse.json();
        
        if (kpiResult.success) {
            updateDashboardKPIs(kpiResult.kpis);
        }
        
        // Load Charts
        const chartResponse = await fetch('/dashboard-v2/api/dashboard-charts');
        const chartResult = await chartResponse.json();
        
        if (chartResult.success) {
            createDashboardCharts(chartResult.charts);
        }
        
        // Load Recent Operations
        const opsResponse = await fetch('/dashboard-v2/api/recent-operations');
        const opsResult = await opsResponse.json();
        
        if (opsResult.success) {
            updateRecentOperations(opsResult.operations);
        }
        
    } catch (error) {
        console.error('[DASHBOARD_V2] Erro ao carregar dados do dashboard:', error);
    }
}

async function loadMateriaisData() {
    try {
        // Get current filters
        const params = new URLSearchParams();
        const dataInicio = document.getElementById('filter-data-inicio').value;
        const dataFim = document.getElementById('filter-data-fim').value;
        const material = document.getElementById('filter-material').value;
        const cliente = document.getElementById('filter-cliente').value;
        const modal = document.getElementById('filter-modal').value;
        const canal = document.getElementById('filter-canal').value;
        
        if (dataInicio) params.append('data_inicio', dataInicio);
        if (dataFim) params.append('data_fim', dataFim);
        if (material) params.append('material', material);
        if (cliente) params.append('cliente', cliente);
        if (modal) params.append('modal', modal);
        if (canal) params.append('canal', canal);
        
        const queryString = params.toString();
        
        // Load Materiais KPIs
        const kpiResponse = await fetch('/materiais-v2/api/materiais-kpis?' + queryString);
        const kpiResult = await kpiResponse.json();
        
        if (kpiResult.success) {
            updateMateriaisKPIs(kpiResult.kpis);
        }
        
        // Load Charts
        await loadMateriaisCharts(queryString);
        
        // Load Table
        const tableResponse = await fetch('/materiais-v2/api/detalhamento-processos?' + queryString);
        const tableResult = await tableResponse.json();
        
        if (tableResult.success) {
            updateMateriaisTable(tableResult.data);
        }
        
    } catch (error) {
        console.error('[DASHBOARD_V2] Erro ao carregar dados de materiais:', error);
    }
}

async function loadMateriaisCharts(queryString) {
    try {
        // Top Materiais
        const topResponse = await fetch('/materiais-v2/api/top-materiais?' + queryString);
        const topResult = await topResponse.json();
        if (topResult.success) {
            createTopMateriaisChart(topResult.data);
        }
        
        // Evolução Mensal
        const evolResponse = await fetch('/materiais-v2/api/evolucao-mensal?' + queryString);
        const evolResult = await evolResponse.json();
        if (evolResult.success) {
            createEvolucaoMensalChart(evolResult.data);
        }
        
        // Modal Distribution
        const modalResponse = await fetch('/materiais-v2/api/modal-distribution?' + queryString);
        const modalResult = await modalResponse.json();
        if (modalResult.success) {
            createMatModalChart(modalResult.data);
        }
        
        // Canal Distribution
        const canalResponse = await fetch('/materiais-v2/api/canal-distribution?' + queryString);
        const canalResult = await canalResponse.json();
        if (canalResult.success) {
            createCanalChart(canalResult.data);
        }
        
        // Transit Time
        const transitResponse = await fetch('/materiais-v2/api/transit-time-por-material?' + queryString);
        const transitResult = await transitResponse.json();
        if (transitResult.success) {
            createTransitTimeChart(transitResult.data);
        }
        
    } catch (error) {
        console.error('[DASHBOARD_V2] Erro ao carregar gráficos de materiais:', error);
    }
}

async function loadFilterOptions() {
    try {
        const response = await fetch('/materiais-v2/api/filter-options');
        const result = await response.json();
        
        if (result.success) {
            const options = result.options;
            
            // Populate filter dropdowns
            populateSelect('filter-material', options.materiais || []);
            populateSelect('filter-cliente', options.clientes || []);
            populateSelect('filter-modal', options.modais || []);
            populateSelect('filter-canal', options.canais || []);
        }
    } catch (error) {
        console.error('[DASHBOARD_V2] Erro ao carregar opções de filtro:', error);
    }
}

function populateSelect(elementId, options) {
    const select = document.getElementById(elementId);
    // Clear existing options except first
    select.innerHTML = '<option value="">Todos</option>';
    
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
}

function updateDashboardKPIs(kpis) {
    document.getElementById('kpi-total-processos').textContent = formatNumber(kpis.total_processos);
    document.getElementById('kpi-total-despesas').textContent = formatCurrency(kpis.total_despesas);
    document.getElementById('kpi-modal-aereo').textContent = formatNumber(kpis.modal_aereo);
    document.getElementById('kpi-modal-maritimo').textContent = formatNumber(kpis.modal_maritimo);
    document.getElementById('kpi-em-transito').textContent = formatNumber(kpis.em_transito);
    document.getElementById('kpi-di-registrada').textContent = formatNumber(kpis.di_registrada);
}

function updateMateriaisKPIs(kpis) {
    document.getElementById('mat-total-processos').textContent = formatNumber(kpis.total_processos);
    document.getElementById('mat-total-materiais').textContent = formatNumber(kpis.total_materiais);
    document.getElementById('mat-valor-total').textContent = formatCurrencyCompact(kpis.valor_total);
    document.getElementById('mat-custo-total').textContent = formatCurrencyCompact(kpis.custo_total);
    document.getElementById('mat-ticket-medio').textContent = formatCurrencyCompact(kpis.ticket_medio);
    document.getElementById('mat-transit-time').textContent = formatNumber(kpis.transit_time, 1) + ' dias';

    // Novos KPIs mês/semana (nomes alinhados ao backend)
    document.getElementById('mat-processos-mes').textContent = formatNumber(kpis.total_processos_mes);
    document.getElementById('mat-custo-mes').textContent = formatCurrencyCompact(kpis.custo_total_mes);
    document.getElementById('mat-processos-semana').textContent = formatNumber(kpis.total_processos_semana);
    document.getElementById('mat-custo-semana').textContent = formatCurrencyCompact(kpis.custo_total_semana);
}

// Formatação monetária compacta (ex: 706k)
function formatCurrencyCompact(value) {
    if (!value || value === 0) return 'R$ 0,00';
    const abs = Math.abs(value);
    if (abs >= 1e6) {
        return 'R$ ' + (value / 1e6).toFixed(1).replace('.0','') + 'M';
    } else if (abs >= 1e3) {
        return 'R$ ' + (value / 1e3).toFixed(0) + 'k';
    } else {
        return Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
}


function createDashboardCharts(charts) {
    // Monthly Chart
    if (charts.monthly) {
        createMonthlyChart(charts.monthly);
    }
    
    // Modal Chart
    if (charts.modal) {
        createModalChart(charts.modal);
    }
    
    // URF Chart
    if (charts.urf) {
        createUrfChart(charts.urf);
    }
    
    // Material Chart
    if (charts.material) {
        createMaterialChart(charts.material);
    }
}

function createMonthlyChart(data) {
    const ctx = document.getElementById('monthly-chart').getContext('2d');
    
    if (dashboardCharts.monthly) {
        dashboardCharts.monthly.destroy();
    }
    
    dashboardCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.periods,
            datasets: [{
                label: 'Processos',
                data: data.processes,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: 'Despesas (R$)',
                data: data.values,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function createModalChart(data) {
    const ctx = document.getElementById('modal-chart').getContext('2d');
    
    if (dashboardCharts.modal) {
        dashboardCharts.modal.destroy();
    }
    
    dashboardCharts.modal = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createUrfChart(data) {
    const ctx = document.getElementById('urf-chart').getContext('2d');
    
    if (dashboardCharts.urf) {
        dashboardCharts.urf.destroy();
    }
    
    dashboardCharts.urf = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Processos',
                data: data.values,
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createMaterialChart(data) {
    const ctx = document.getElementById('material-chart').getContext('2d');
    
    if (dashboardCharts.material) {
        dashboardCharts.material.destroy();
    }
    
    dashboardCharts.material = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Processos',
                data: data.values,
                backgroundColor: 'rgba(255, 206, 86, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createTopMateriaisChart(data) {
    const ctx = document.getElementById('top-materiais-chart').getContext('2d');
    
    if (materiaisCharts.topMateriais) {
        materiaisCharts.topMateriais.destroy();
    }
    
    materiaisCharts.topMateriais = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Quantidade',
                data: data.values,
                backgroundColor: 'rgba(75, 192, 192, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createEvolucaoMensalChart(data) {
    const ctx = document.getElementById('evolucao-mensal-chart').getContext('2d');
    
    if (materiaisCharts.evolucaoMensal) {
        materiaisCharts.evolucaoMensal.destroy();
    }
    
    const datasets = data.map((item, index) => ({
        label: item.material,
        data: item.values,
        borderColor: `hsl(${index * 120}, 70%, 50%)`,
        backgroundColor: `hsla(${index * 120}, 70%, 50%, 0.1)`,
        tension: 0.1
    }));
    
    materiaisCharts.evolucaoMensal = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.length > 0 ? data[0].periods : [],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createMatModalChart(data) {
    const ctx = document.getElementById('mat-modal-chart').getContext('2d');
    
    if (materiaisCharts.matModal) {
        materiaisCharts.matModal.destroy();
    }
    
    materiaisCharts.matModal = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createCanalChart(data) {
    const ctx = document.getElementById('canal-chart').getContext('2d');
    
    if (materiaisCharts.canal) {
        materiaisCharts.canal.destroy();
    }
    
    materiaisCharts.canal = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createTransitTimeChart(data) {
    const ctx = document.getElementById('transit-time-chart').getContext('2d');
    
    if (materiaisCharts.transitTime) {
        materiaisCharts.transitTime.destroy();
    }
    
    materiaisCharts.transitTime = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Dias',
                data: data.values,
                backgroundColor: 'rgba(153, 102, 255, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateRecentOperations(operations) {
    const tbody = document.getElementById('operations-tbody');
    tbody.innerHTML = '';
    
    operations.forEach(op => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${op.ref_unique || '-'}</td>
            <td>${op.importador || '-'}</td>
            <td>${op.data_abertura || '-'}</td>
            <td>${op.modal || '-'}</td>
            <td>${op.status_processo || '-'}</td>
            <td>${op.mercadoria || '-'}</td>
            <td>${formatCurrency(op.custo_total)}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateMateriaisTable(data) {
    const tbody = document.getElementById('detalhamento-tbody');
    tbody.innerHTML = '';
    
    data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.ref_unique || '-'}</td>
            <td>${item.importador || '-'}</td>
            <td>${item.data_abertura || '-'}</td>
            <td>${item.mercadoria || '-'}</td>
            <td>${item.modal || '-'}</td>
            <td>${formatCurrency(item.valor_cif_real)}</td>
            <td>${formatCurrency(item.custo_total)}</td>
        `;
        tbody.appendChild(row);
    });
}

function applyFilters() {
    console.log('[DASHBOARD_V2] Aplicando filtros...');
    loadMateriaisData();
}

function clearFilters() {
    document.getElementById('filter-material').value = '';
    document.getElementById('filter-cliente').value = '';
    document.getElementById('filter-modal').value = '';
    document.getElementById('filter-canal').value = '';
    setupDefaultDateFilters();
    
    loadMateriaisData();
}

function formatNumber(value, decimals = 0) {
    if (!value || value === 0) return '0';
    return Number(value).toLocaleString('pt-BR', { 
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals 
    });
}

function formatCurrency(value) {
    if (!value || value === 0) return 'R$ 0,00';
    return Number(value).toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
}
</script>
{% endblock %}
