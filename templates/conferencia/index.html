{% extends "base.html" %}

{% block title %}Conferência Documental IA - Portal UniSystem{% endblock %}

{% block extra_css %}
<style>
    /* === DESIGN SYSTEM - VARIÁVEIS MODERNAS === */
    :root {
        /* Paleta de cores minimalista */
        --color-background: #fafbfc;
        --color-surface: #ffffff;
        --color-surface-hover: #f8fafc;
        --color-border: #e2e8f0;
        --color-border-light: #f1f5f9;
        
        /* Textos */
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --color-text-muted: #64748b;
        --color-text-light: #94a3b8;
        
        /* Cores de destaque elegantes */
        --color-primary: #3b82f6;
        --color-primary-light: #dbeafe;
        --color-success: #10b981;
        --color-success-light: #d1fae5;
        --color-warning: #f59e0b;
        --color-warning-light: #fef3c7;
        --color-danger: #ef4444;
        --color-danger-light: #fee2e2;
        --color-info: #06b6d4;
        --color-info-light: #cffafe;
        
        /* Sombras minimalistas */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        
        /* Espacamentos consistentes */
        --spacing-xs: 0.5rem;
        --spacing-sm: 0.75rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        /* Bordas arredondadas */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* Transições suaves */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
    }

    /* === HEADER DA PÁGINA (igual ao dashboard) === */
    .page-header {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-lg) var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    /* === CARDS DE CONTEÚDO === */
    .main-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .main-card:hover {
        box-shadow: var(--shadow-md);
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-lg) 0;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .card-title .icon {
        color: var(--color-primary);
        font-size: 1.75rem;
    }



    /* === RADIO OPTIONS === */
    .radio-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .radio-option {
        display: flex;
        align-items: flex-start;
        background: var(--color-surface);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .radio-option:hover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .radio-option.selected {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .radio-option input[type="radio"] {
        margin-right: var(--spacing-md);
        width: 1.25rem;
        height: 1.25rem;
        accent-color: var(--color-primary);
        margin-top: 0.125rem;
        flex-shrink: 0;
    }

    .radio-option-info {
        flex: 1;
    }

    .radio-option-title {
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .radio-option-desc {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
    }

    /* === UPLOAD ZONE === */
    .upload-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border-light);
    }

    .upload-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .upload-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-primary);
    }

    .dropzone {
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        text-align: center;
        transition: all var(--transition-normal);
        background: var(--color-surface-hover);
        cursor: pointer;
    }

    .dropzone:hover, .dropzone.dragover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        transform: scale(1.01);
    }

    .dropzone-icon {
        color: var(--color-text-muted);
        width: 3rem;
        height: 3rem;
        margin: 0 auto var(--spacing-lg);
    }

    .dropzone-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .dropzone-subtitle {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-lg);
        font-size: 0.875rem;
    }

    /* === BOTÕES === */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all var(--transition-fast);
        border: none;
        cursor: pointer;
        text-align: center;
        justify-content: center;
    }

    .btn-primary {
        background: var(--color-primary);
        color: white;
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        cursor: pointer;
        border: none;
        transition: all var(--transition-fast);
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
        background: var(--color-text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .btn-outline:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-text-secondary);
        color: var(--color-text-primary);
    }

    .btn-outline svg {
        width: 1rem;
        height: 1rem;
    }

    /* === FILE LIST === */
    .file-list {
        margin-top: var(--spacing-lg);
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-fast);
    }

    .file-item:hover {
        background: var(--color-primary-light);
        border-color: var(--color-primary);
    }

    .file-icon {
        width: 2rem;
        height: 2rem;
        margin-right: var(--spacing-md);
        color: var(--color-text-muted);
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 500;
        color: var(--color-text-primary);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
    }

    .file-size {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .file-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .file-action {
        border: none;
        background: none;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 1.5rem;
        height: 1.5rem;
        padding: 0;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .file-action:hover {
        color: var(--color-danger);
        background: var(--color-danger-light);
    }

    /* === PROGRESS BAR === */
    .progress-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        display: none;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .progress-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .progress-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-primary);
    }

    .progress-info {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-weight: 500;
    }

    .progress-bar-container {
        height: 0.75rem;
        background: var(--color-border-light);
        border-radius: var(--radius-xl);
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary), #2563eb);
        border-radius: var(--radius-xl);
        transition: width 0.3s ease;
    }

    /* === RESULTS === */
    .results-container {
        display: none;
    }

    .results-header {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border-light);
    }

    .results-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .results-title svg {
        width: 1.5rem;
        height: 1.5rem;
        color: var(--color-primary);
    }

    .results-summary {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .results-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .result-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .result-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .result-card-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .result-card-icon {
        width: 3rem;
        height: 3rem;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: var(--spacing-md);
        flex-shrink: 0;
    }

    .result-status-ok {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .result-status-alerta {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .result-status-erro {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .result-status-success {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .result-card-info {
        flex: 1;
    }

    .result-card-filename {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        color: var(--color-text-primary);
    }

    .result-card-summary {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .result-card-stat {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .result-card-stat-icon {
        width: 0.75rem;
        height: 0.75rem;
    }

    .stat-error {
        color: var(--color-danger);
    }

    .stat-warning {
        color: var(--color-warning);
    }

    .stat-info {
        color: var(--color-info);
    }

    .result-card-actions {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-lg);
        gap: var(--spacing-sm);
    }

    /* === VALORES EXTRAÍDOS === */
    .valor-extraido {
        background: var(--color-primary-light);
        color: var(--color-primary);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.875rem;
        font-weight: 600;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .valor-nao-encontrado {
        background: var(--color-danger-light);
        color: var(--color-danger);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid rgba(239, 68, 68, 0.3);
        font-style: italic;
    }

    /* === DETAILS MODAL === */
    .details-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-top: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--color-border-light);
        display: none;
    }

    .details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border-light);
    }

    .details-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
    }

    .details-close {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 2rem;
        height: 2rem;
        padding: 0;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .details-close:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
    }

    .details-table {
        width: 100%;
        border-collapse: collapse;
    }

    .details-table th,
    .details-table td {
        padding: var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
    }

    .details-table th {
        background: var(--color-surface-hover);
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .details-table td {
        font-size: 0.875rem;
        color: var(--color-text-primary);
    }

    .details-table tr:last-child td {
        border-bottom: none;
    }

    .details-table tr:hover td {
        background: var(--color-surface-hover);
    }

    .details-table tbody tr:nth-child(even) {
        background: var(--color-surface-hover);
    }

    /* === STATUS INDICATORS === */
    .status-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
    }

    .status-ok {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .status-alerta {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .status-erro {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .status-cell {
        text-align: center;
        width: 5%;
        white-space: nowrap;
    }

    /* === LOADING OVERLAY === */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 60;
        backdrop-filter: blur(4px);
    }

    .loading-content {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 90%;
        text-align: center;
    }

    .loading-spinner {
        margin-bottom: var(--spacing-lg);
        width: 3rem;
        height: 3rem;
        border: 4px solid var(--color-border-light);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-message {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary);
    }

    /* === FLASH MESSAGES === */
    .flash-message {
        position: fixed;
        top: 8rem;
        right: 1.5rem;
        z-index: 50;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-lg);
        color: white;
        font-weight: 500;
        font-size: 0.875rem;
        max-width: 400px;
        word-wrap: break-word;
    }

    .flash-success {
        background: var(--color-success);
    }

    .flash-error {
        background: var(--color-danger);
    }

    .flash-warning {
        background: var(--color-warning);
    }

    .flash-info {
        background: var(--color-info);
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 1024px) {
        .radio-container {
            grid-template-columns: 1fr;
        }

        .results-cards {
            grid-template-columns: 1fr;
        }

        .result-card-summary {
            flex-direction: column;
            gap: var(--spacing-xs);
        }
    }

    @media (max-width: 768px) {
        .main-card {
            padding: var(--spacing-lg);
        }

        .dropzone {
            padding: var(--spacing-lg);
        }

        .result-card {
            padding: var(--spacing-lg);
        }

        .details-container {
            padding: var(--spacing-lg);
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Sistema de notificações flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Header da Página -->
    <div class="page-header">
        <h1 class="card-title">
            <i class="mdi mdi-file-check icon"></i>
            Conferência Documental com IA
        </h1>
    </div>

    <!-- Seleção do Tipo de Conferência -->
    <div class="main-card">
        <h2 class="card-title">
            <i class="mdi mdi-format-list-bulleted icon"></i>
            Selecione o Tipo de Conferência
        </h2>
        
        <div class="radio-container">
            <label class="radio-option" data-tipo="invoice">
                <input type="radio" name="tipo_conferencia" value="invoice" checked>
                <div class="radio-option-info">
                    <div class="radio-option-title">Conferência de Invoices</div>
                    <div class="radio-option-desc">Verificação específica para invoices comerciais com análise de dados estruturados e validação de campos obrigatórios.</div>
                </div>
            </label>

            <!-- Tipos futuros comentados para desenvolvimento posterior -->
            <!-- 
            <label class="radio-option" data-tipo="packlist">
                <input type="radio" name="tipo_conferencia" value="packlist" disabled>
                <div class="radio-option-info">
                    <div class="radio-option-title">Conferência de Packlists</div>
                    <div class="radio-option-desc">Verificação específica para packlists. (Em desenvolvimento)</div>
                </div>
            </label>

            <label class="radio-option" data-tipo="conhecimento">
                <input type="radio" name="tipo_conferencia" value="conhecimento" disabled>
                <div class="radio-option-info">
                    <div class="radio-option-title">Conferência de Conhecimentos</div>
                    <div class="radio-option-desc">Verificação específica para conhecimentos de embarque (BL/AWB). (Em desenvolvimento)</div>
                </div>
            </label>
            -->
        </div>
    </div>

    <!-- Formulário de Upload -->
    <div class="main-card">
        <h2 class="card-title">
            <i class="mdi mdi-cloud-upload icon"></i>
            Upload de Documentos
        </h2>

        <div class="dropzone" id="dropzone">
            <svg class="dropzone-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <div class="dropzone-title">Arraste e solte arquivos PDF aqui</div>
            <div class="dropzone-subtitle">ou clique para selecionar arquivos</div>
            <input type="file" id="file-input" multiple accept=".pdf" class="hidden">
            <button type="button" class="btn-primary" id="select-files">
                <i class="mdi mdi-plus"></i>
                Selecionar Arquivos
            </button>
        </div>

        <div class="file-list" id="file-list"></div>

        <div style="margin-top: 1.5rem;">
            <button type="button" class="btn-primary" id="upload-btn" style="display: none;">
                <i class="mdi mdi-upload"></i>
                Iniciar Conferência
            </button>
        </div>
    </div>

    <!-- Container de Progresso -->
    <div class="progress-container" id="progress-container">
        <div class="progress-header">
            <div class="progress-title">
                <i class="mdi mdi-cog-clockwise"></i>
                Processamento em Andamento
            </div>
            <div class="progress-info" id="progress-info">0%</div>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Container de Resultados -->
    <div class="results-container" id="results-container">
        <div class="results-header">
            <h2 class="results-title">
                <i class="mdi mdi-check-circle"></i>
                Resultados da Conferência
            </h2>
            <div class="results-summary" id="results-summary"></div>
        </div>

        <div class="results-cards" id="results-cards">
            <!-- Os cards de resultados serão injetados aqui via JavaScript -->
        </div>
    </div>

    <!-- Container de Detalhes -->
    <div class="details-container" id="details-container">
        <div class="details-header">
            <h3 class="details-title" id="details-title">Detalhes da Conferência</h3>
            <button type="button" class="details-close" id="details-close">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        <div class="details-content" id="details-content">
            <table class="details-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Status</th>
                        <th style="width: 20%;">Campo</th>
                        <th style="width: 15%;">Tipo</th>
                        <th>Descrição</th>
                    </tr>
                </thead>
                <tbody id="details-table-body">
                    <!-- As linhas da tabela de detalhes serão injetadas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loading-message">Processando arquivos...</div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificação de compatibilidade do navegador
        if (!window.fetch) {
            alert('Este navegador não suporta todas as funcionalidades necessárias. Por favor, atualize seu navegador.');
            return;
        }

        // Elementos do DOM
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const selectFiles = document.getElementById('select-files');
        const fileList = document.getElementById('file-list');
        const uploadBtn = document.getElementById('upload-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressInfo = document.getElementById('progress-info');
        const resultsContainer = document.getElementById('results-container');
        const resultsCards = document.getElementById('results-cards');
        const resultsSummary = document.getElementById('results-summary');
        const detailsContainer = document.getElementById('details-container');
        const detailsTitle = document.getElementById('details-title');
        const detailsTableBody = document.getElementById('details-table-body');
        const detailsClose = document.getElementById('details-close');
        const radioOptions = document.querySelectorAll('.radio-option');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');

        // Verificação de elementos críticos
        const criticalElements = [dropzone, fileInput, selectFiles, uploadBtn, loadingOverlay];
        const missingElements = criticalElements.filter(el => !el);
        
        if (missingElements.length > 0) {
            console.error('Elementos críticos não encontrados no DOM');
            alert('Erro na inicialização da página. Por favor, recarregue a página.');
            return;
        }

        let selectedFiles = [];
        let currentJobId = null;
        let jobResults = null;
        let checkStatusInterval = null;

        // Função auxiliar para fazer requests fetch de forma segura
        function safeFetch(url, options = {}) {
            // Opções padrão para todas as requisições
            const defaultOptions = {
                credentials: 'same-origin', // Inclui cookies de sessão
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indica que é uma requisição AJAX
                }
            };
            
            // Mescla as opções
            const finalOptions = { ...defaultOptions, ...options };
            
            // Se há headers customizados, mescla com os padrão
            if (options.headers) {
                finalOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }
            
            console.log('Fazendo request para:', url, 'com opções:', finalOptions);
            
            // Tentar usar o fetch original se disponível
            if (window.sessionHandler && window.sessionHandler.originalFetch) {
                console.log('Usando fetch original do session handler');
                return window.sessionHandler.originalFetch.call(window, url, finalOptions);
            }
            
            // Fallback para XMLHttpRequest se fetch não estiver disponível ou causar problemas
            if (!window.fetch || typeof window.fetch !== 'function') {
                console.log('Fetch não disponível, usando XMLHttpRequest');
                return makeXMLHttpRequest(url, finalOptions);
            }
            
            try {
                // Tentar usar o fetch padrão
                console.log('Usando fetch padrão');
                return window.fetch.call(window, url, finalOptions);
            } catch (error) {
                console.log('Erro com fetch padrão, usando XMLHttpRequest:', error);
                return makeXMLHttpRequest(url, finalOptions);
            }
        }

        // Função fallback usando XMLHttpRequest
        function makeXMLHttpRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const method = options.method || 'GET';
                
                xhr.open(method, url, true);
                
                // Configurar headers
                if (options.headers) {
                    Object.keys(options.headers).forEach(key => {
                        xhr.setRequestHeader(key, options.headers[key]);
                    });
                }
                
                // Incluir credenciais se especificado
                if (options.credentials === 'same-origin' || options.credentials === 'include') {
                    xhr.withCredentials = true;
                }
                
                xhr.onload = function() {
                    const response = {
                        ok: xhr.status >= 200 && xhr.status < 300,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        json: function() {
                            return Promise.resolve(JSON.parse(xhr.responseText));
                        },
                        text: function() {
                            return Promise.resolve(xhr.responseText);
                        }
                    };
                    resolve(response);
                };
                
                xhr.onerror = function() {
                    reject(new Error('Erro na requisição XMLHttpRequest'));
                };
                
                // Enviar dados
                if (options.body) {
                    xhr.send(options.body);
                } else {
                    xhr.send();
                }
            });
        }

        // Inicializa a seleção do tipo de conferência
        radioOptions.forEach(option => {
            option.addEventListener('click', function() {
                radioOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                // Marca o input radio
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
            });
        });
        // Seleciona a primeira opção por padrão
        radioOptions[0].classList.add('selected');

        // Event listeners para drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropzone.classList.add('dragover');
        }

        function unhighlight() {
            dropzone.classList.remove('dragover');
        }

        // Manipulação de arquivos
        dropzone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        selectFiles.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
            
            if (validFiles.length === 0) {
                alert('Por favor, selecione apenas arquivos PDF.');
                return;
            }

            validFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                    addFileToList(file);
                }
            });

            updateUploadButton();
        }

        function addFileToList(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileSize = file.size < 1024 * 1024 
                ? `${(file.size / 1024).toFixed(1)} KB` 
                : `${(file.size / (1024 * 1024)).toFixed(1)} MB`;

            fileItem.innerHTML = `
                <i class="mdi mdi-file-pdf-box file-icon"></i>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
                <div class="file-actions">
                    <button type="button" class="file-action remove-file" data-filename="${file.name}" title="Remover arquivo">
                        <i class="mdi mdi-close"></i>
                    </button>
                </div>
            `;
            
            fileList.appendChild(fileItem);

            // Adicionar event listener para remover arquivo
            const removeBtn = fileItem.querySelector('.remove-file');
            removeBtn.addEventListener('click', () => {
                const filename = removeBtn.getAttribute('data-filename');
                selectedFiles = selectedFiles.filter(f => f.name !== filename);
                fileItem.remove();
                updateUploadButton();
            });
        }

        function updateUploadButton() {
            if (selectedFiles.length > 0) {
                uploadBtn.style.display = 'inline-flex';
            } else {
                uploadBtn.style.display = 'none';
            }
        }

        // Evento de upload com verificação adicional
        uploadBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            uploadFiles();
        });

        function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo para enviar.');
                return;
            }

            const tipoConferenciaInput = document.querySelector('input[name="tipo_conferencia"]:checked');
            if (!tipoConferenciaInput) {
                alert('Por favor, selecione um tipo de conferência.');
                return;
            }
            
            const tipoConferencia = tipoConferenciaInput.value;
            
            const formData = new FormData();
            formData.append('tipo_conferencia', tipoConferencia);
            
            selectedFiles.forEach(file => {
                formData.append('files[]', file);
            });
            
            showLoading('Enviando arquivos...');
            
            // Usa a função safeFetch para evitar problemas de contexto
            safeFetch('/conferencia/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    currentJobId = data.job_id;
                    startProgressMonitoring(currentJobId);
                } else {
                    hideLoading();
                    alert(`Erro: ${data.message}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erro ao enviar arquivos:', error);
                alert(`Erro ao enviar arquivos: ${error.message}`);
            });
        }

        function startProgressMonitoring(jobId) {
            progressContainer.style.display = 'block';
            
            // Oculta o painel de upload
            showLoading('Processando arquivos...');
            
            // Inicia o monitoramento do progresso
            checkStatusInterval = setInterval(() => {
                checkJobStatus(jobId);
            }, 2000); // Verifica a cada 2 segundos
        }

        function checkJobStatus(jobId) {
            const statusUrl = `/conferencia/status/${jobId}?t=${Date.now()}`;
            console.log(`Verificando status: ${statusUrl}`);
            
            // Usa a função safeFetch para evitar problemas de contexto
            safeFetch(statusUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const job = data.job;
                        updateProgress(job.progress);
                        
                        if (job.status === 'completed') {
                            clearInterval(checkStatusInterval);
                            loadJobResults(jobId);
                        }
                    } else {
                        clearInterval(checkStatusInterval);
                        hideLoading();
                        alert(`Erro ao verificar status: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro na verificação de status:', error);
                    clearInterval(checkStatusInterval);
                    hideLoading();
                    alert(`Erro na verificação de status: ${error.message}`);
                });
        }

        function updateProgress(progress) {
            progressBar.style.width = `${progress}%`;
            progressInfo.textContent = `${progress}%`;
        }

        function loadJobResults(jobId) {
            console.log('Carregando resultados para job:', jobId);
            const resultUrl = `/conferencia/result/${jobId}?t=${Date.now()}`;
            console.log(`URL dos resultados: ${resultUrl}`);
            
            // Usa a função safeFetch para evitar problemas de contexto
            safeFetch(resultUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    if (data.status === 'success') {
                        hideLoading();
                        jobResults = data.job;
                        console.log('Job results:', jobResults);
                        displayResults(jobResults);
                    } else {
                        hideLoading();
                        alert(`Erro ao carregar resultados: ${data.message}`);
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Erro ao carregar resultados:', error);
                    alert(`Erro ao carregar resultados: ${error.message}`);
                });
        }

        function displayResults(job) {
            console.log('Exibindo resultados:', job);
            // Exibe o container de resultados
            resultsContainer.style.display = 'block';
            
            // Atualiza o resumo
            resultsSummary.textContent = `${job.arquivos_processados} de ${job.total_arquivos} arquivos processados • ${getTipoConferenciaLabel(job.tipo_conferencia)}`;
            
            // Limpa os cards existentes
            resultsCards.innerHTML = '';
            
            // Adiciona um card para cada arquivo
            console.log('Arquivos:', job.arquivos);
            job.arquivos.forEach((arquivo, index) => {
                console.log(`Processando arquivo ${index}:`, arquivo);
                console.log(`Filename: ${arquivo.filename}`);
                console.log(`Status: ${arquivo.status}`);
                console.log(`Has result: ${!!arquivo.result}`);
                
                if (arquivo.status === 'completed' && arquivo.result) {
                    const result = arquivo.result;
                    console.log(`Resultado detalhado do arquivo ${arquivo.filename}:`, result);
                    console.log(`Sumário status: ${result.sumario?.status}`);
                    console.log(`Conclusão: ${result.sumario?.conclusao}`);
                    console.log(`Total erros: ${result.sumario?.total_erros_criticos}`);
                    
                    const card = createResultCard(arquivo.filename, result);
                    resultsCards.appendChild(card);
                    console.log(`Card criado para ${arquivo.filename}`);
                } else {
                    console.log('Arquivo não processado ou sem resultado:', arquivo);
                }
            });
            
            // Scroll para os resultados
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function getTipoConferenciaLabel(tipo) {
            switch (tipo) {
                case 'invoice':
                    return 'Conferência de Invoices';
                case 'packlist':
                    return 'Conferência de Packlists';
                case 'conhecimento':
                    return 'Conferência de Conhecimentos';
                default:
                    return 'Conferência de Inconsistências';
            }
        }

        function createResultCard(filename, result) {
            const sumario = result.sumario || {};
            const statusClass = getStatusClass(sumario.status || 'ok');
            
            // Calcular totais se não estiverem disponíveis
            const totalErros = sumario.total_erros_criticos || 0;
            const totalAlertas = sumario.total_alertas || 0;
            const totalObservacoes = sumario.total_observacoes || 0;
            
            // Verificar se há dados para análise
            const hasAnalysisData = (result.itens && result.itens.length > 0) || 
                                   (result.itens_analisados && result.itens_analisados.length > 0);
            
            // Criar mensagem de status mais informativa
            let statusMessage = sumario.conclusao || 'Análise concluída';
            if (hasAnalysisData) {
                statusMessage += ' • Dados analisados disponíveis';
            }
            
            const card = document.createElement('div');
            card.className = 'result-card';
            
            card.innerHTML = `
                <div class="result-card-header">
                    <div class="result-card-icon ${statusClass}">
                        <i class="mdi mdi-file-document"></i>
                    </div>
                    <div class="result-card-info">
                        <div class="result-card-filename">${truncateFilename(filename, 20)}</div>
                        <div class="result-card-summary">
                            <div class="result-card-stat stat-error">
                                <i class="mdi mdi-alert-circle result-card-stat-icon"></i>
                                ${totalErros}
                            </div>
                            <div class="result-card-stat stat-warning">
                                <i class="mdi mdi-alert result-card-stat-icon"></i>
                                ${totalAlertas}
                            </div>
                            <div class="result-card-stat stat-info">
                                <i class="mdi mdi-information result-card-stat-icon"></i>
                                ${totalObservacoes}
                            </div>
                            ${hasAnalysisData ? '<div class="result-card-stat" style="color: #059669;"><i class="mdi mdi-check-circle result-card-stat-icon"></i>✓</div>' : ''}
                        </div>
                    </div>
                </div>
                <div style="margin: 1rem 0; font-size: 0.875rem; color: #6b7280;">
                    ${statusMessage}
                </div>
                <div class="result-card-actions">
                    <button type="button" class="btn-outline download-pdf" data-filename="${filename}">
                        <i class="mdi mdi-download"></i>
                        PDF
                    </button>
                    <button type="button" class="btn-outline view-details" data-filename="${filename}">
                        <i class="mdi mdi-eye"></i>
                        Ver Detalhes
                    </button>
                </div>
            `;
            
            // Adicionar event listeners
            const viewDetailsBtn = card.querySelector('.view-details');
            viewDetailsBtn.addEventListener('click', function() {
                const filename = this.getAttribute('data-filename');
                showDetails(filename, result);
            });
            
            return card;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'ok':
                    return 'result-status-ok';
                case 'alerta':
                    return 'result-status-alerta';
                case 'erro':
                    return 'result-status-erro';
                default:
                    return '';
            }
        }

        function truncateFilename(filename, maxLength) {
            if (filename.length <= maxLength) return filename;
            
            const extension = filename.slice(filename.lastIndexOf('.'));
            const name = filename.slice(0, filename.lastIndexOf('.'));
            
            return `${name.slice(0, maxLength - extension.length - 3)}...${extension}`;
        }

        function showDetails(filename, result) {
            console.log(`Mostrando detalhes para ${filename}:`, result);
            detailsTitle.textContent = `Detalhes: ${filename}`;
            detailsTableBody.innerHTML = '';
            
            // Identificar a estrutura de itens (pode ser 'itens' ou 'itens_analisados')
            const itemsArray = result?.itens || result?.itens_analisados || [];
            let hasItems = false;
            
            if (itemsArray && itemsArray.length > 0) {
                console.log(`Itens encontrados: ${itemsArray.length}`);
                hasItems = true;
                
                itemsArray.forEach((item, index) => {
                    console.log(`Item ${index}:`, item);
                    const row = document.createElement('tr');
                    const statusClass = `status-${item.status}`;
                    
                    // Criar descrição mais detalhada com valor extraído
                    let descricaoCompleta = item.descricao || item.message || 'Descrição não disponível';
                    if (item.valor_extraido) {
                        descricaoCompleta += `<br><strong>Valor detectado:</strong> <span class="valor-extraido">[${item.valor_extraido}]</span>`;
                    } else if (item.valor_extraido === null) {
                        descricaoCompleta += `<br><strong>Valor detectado:</strong> <span class="valor-nao-encontrado">[Não encontrado]</span>`;
                    }
                    
                    row.innerHTML = `
                        <td class="status-cell">
                            <span class="status-icon ${statusClass}">
                                ${getStatusIcon(item.status)}
                            </span>
                        </td>
                        <td><strong>${item.campo || item.field || 'Campo não especificado'}</strong></td>
                        <td>${getTipoLabel(item.tipo || item.type)}</td>
                        <td>${descricaoCompleta}</td>
                    `;
                    
                    detailsTableBody.appendChild(row);
                });
            }
            
            // Os dados brutos agora estão integrados na análise principal
            // através dos campos 'valor_extraido', então não precisamos de seção separada
            
            // Se não há itens nem dados brutos, mostrar mensagem informativa
            if (!hasItems) {
                console.log('Nenhum item ou dado encontrado no resultado:', result);
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <i class="mdi mdi-information-outline" style="font-size: 3rem; color: #9ca3af;"></i>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Análise em Processamento</div>
                                <div style="font-size: 0.875rem;">
                                    ${result?.sumario?.conclusao || 'O arquivo foi processado mas os dados ainda não estão disponíveis para exibição.'}
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                detailsTableBody.appendChild(noDataRow);
            }
            
            detailsContainer.style.display = 'block';
            detailsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'ok':
                    return '<i class="mdi mdi-check-circle"></i>';
                case 'alerta':
                    return '<i class="mdi mdi-alert"></i>';
                case 'erro':
                    return '<i class="mdi mdi-alert-circle"></i>';
                default:
                    return '';
            }
        }

        function getTipoLabel(tipo) {
            switch (tipo) {
                case 'erro_critico':
                    return 'Erro Crítico';
                case 'observacao':
                    return 'Observação';
                case 'alerta':
                    return 'Alerta';
                case 'ok':
                    return 'OK';
                default:
                    return tipo;
            }
        }

        // Fechar detalhes
        detailsClose.addEventListener('click', function() {
            detailsContainer.style.display = 'none';
        });

        // Funções de loading
        function showLoading(message) {
            loadingMessage.textContent = message || 'Carregando...';
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
    });
</script>
{% endblock %}
