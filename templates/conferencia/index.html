{% extends "base.html" %}

{% block title %}Confer√™ncia Documental IA - Portal UniSystem{% endblock %}

{% block extra_css %}
<style>
    /* === DESIGN SYSTEM - VARI√ÅVEIS MODERNAS === */
    :root {
        /* Paleta de cores minimalista */
        --color-background: #fafbfc;
        --color-surface: #ffffff;
        --color-surface-hover: #f8fafc;
        --color-border: #e2e8f0;
        --color-border-light: #f1f5f9;
        
        /* Textos */
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --color-text-muted: #64748b;
        --color-text-light: #94a3b8;
        
        /* Cores de destaque elegantes */
        --color-primary: #3b82f6;
        --color-primary-light: #dbeafe;
        --color-success: #10b981;
        --color-success-light: #d1fae5;
        --color-warning: #f59e0b;
        --color-warning-light: #fef3c7;
        --color-danger: #ef4444;
        --color-danger-light: #fee2e2;
        --color-info: #06b6d4;
        --color-info-light: #cffafe;
        
        /* Sombras minimalistas */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        
        /* Espacamentos consistentes */
        --spacing-xs: 0.5rem;
        --spacing-sm: 0.75rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        /* Bordas arredondadas */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* Transi√ß√µes suaves */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
    }

    /* === HEADER DA P√ÅGINA (igual ao dashboard) === */
    .page-header {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-lg) var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    /* === CARDS DE CONTE√öDO === */
    .main-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .main-card:hover {
        box-shadow: var(--shadow-md);
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-lg) 0;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .card-title .icon {
        color: var(--color-primary);
        font-size: 1.75rem;
    }



    /* === RADIO OPTIONS === */
    .radio-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .radio-option {
        display: flex;
        align-items: flex-start;
        background: var(--color-surface);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .radio-option:hover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .radio-option.selected {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .radio-option input[type="radio"] {
        margin-right: var(--spacing-md);
        width: 1.25rem;
        height: 1.25rem;
        accent-color: var(--color-primary);
        margin-top: 0.125rem;
        flex-shrink: 0;
    }

    .radio-option-info {
        flex: 1;
    }

    .radio-option-title {
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .radio-option-desc {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
    }

    /* === UPLOAD ZONE === */
    .upload-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border-light);
    }

    .upload-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .upload-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-primary);
    }

    .dropzone {
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        text-align: center;
        transition: all var(--transition-normal);
        background: var(--color-surface-hover);
        cursor: pointer;
    }

    .dropzone:hover, .dropzone.dragover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
        transform: scale(1.01);
    }

    .dropzone-icon {
        color: var(--color-text-muted);
        width: 3rem;
        height: 3rem;
        margin: 0 auto var(--spacing-lg);
    }

    .dropzone-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
    }

    .dropzone-subtitle {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-lg);
        font-size: 0.875rem;
    }

    /* === BOT√ïES === */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all var(--transition-fast);
        border: none;
        cursor: pointer;
        text-align: center;
        justify-content: center;
    }

    .btn-primary {
        background: var(--color-primary);
        color: white;
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        cursor: pointer;
        border: none;
        transition: all var(--transition-fast);
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
        background: var(--color-text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .btn-outline:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-text-secondary);
        color: var(--color-text-primary);
    }

    .btn-outline svg {
        width: 1rem;
        height: 1rem;
    }

    /* === FILE LIST === */
    .file-list {
        margin-top: var(--spacing-lg);
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-fast);
    }

    .file-item:hover {
        background: var(--color-primary-light);
        border-color: var(--color-primary);
    }

    .file-icon {
        width: 2rem;
        height: 2rem;
        margin-right: var(--spacing-md);
        color: var(--color-text-muted);
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 500;
        color: var(--color-text-primary);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
    }

    .file-size {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .file-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .file-action {
        border: none;
        background: none;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 1.5rem;
        height: 1.5rem;
        padding: 0;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .file-action:hover {
        color: var(--color-danger);
        background: var(--color-danger-light);
    }

    /* === PROGRESS BAR === */
    .progress-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        display: none;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .progress-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .progress-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-primary);
    }

    .progress-info {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-weight: 500;
    }

    .progress-bar-container {
        height: 0.75rem;
        background: var(--color-border-light);
        border-radius: var(--radius-xl);
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-primary), #2563eb);
        border-radius: var(--radius-xl);
        transition: width 0.3s ease;
    }

    /* === RESULTS === */
    .results-container {
        display: none;
    }

    .results-header {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border-light);
    }

    .results-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .results-title svg {
        width: 1.5rem;
        height: 1.5rem;
        color: var(--color-primary);
    }

    .results-summary {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .results-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .result-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .result-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .result-card-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .result-card-icon {
        width: 3rem;
        height: 3rem;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: var(--spacing-md);
        flex-shrink: 0;
    }

    .result-status-ok {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .result-status-alerta {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .result-status-erro {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .result-status-success {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .result-card-info {
        flex: 1;
    }

    .result-card-filename {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        color: var(--color-text-primary);
    }

    .result-card-summary {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .result-card-stat {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .result-card-stat-icon {
        width: 0.75rem;
        height: 0.75rem;
    }

    .stat-error {
        color: var(--color-danger);
    }

    .stat-warning {
        color: var(--color-warning);
    }

    .stat-info {
        color: var(--color-info);
    }

    .result-card-actions {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-lg);
        gap: var(--spacing-sm);
    }

    /* === VALORES EXTRA√çDOS === */
    .valor-extraido {
        background: var(--color-primary-light);
        color: var(--color-primary);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.875rem;
        font-weight: 600;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .valor-nao-encontrado {
        background: var(--color-danger-light);
        color: var(--color-danger);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid rgba(239, 68, 68, 0.3);
        font-style: italic;
    }

    /* === DETAILS MODAL === */
    .details-container {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-top: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--color-border-light);
        display: none;
    }

    .details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border-light);
    }

    .details-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
    }

    .details-close {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 2rem;
        height: 2rem;
        padding: 0;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .details-close:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
    }

    .details-table {
        width: 100%;
        border-collapse: collapse;
    }

    .details-table th,
    .details-table td {
        padding: var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
    }

    .details-table th {
        background: var(--color-surface-hover);
        font-weight: 600;
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .details-table td {
        font-size: 0.875rem;
        color: var(--color-text-primary);
    }

    .details-table tr:last-child td {
        border-bottom: none;
    }

    .details-table tr:hover td {
        background: var(--color-surface-hover);
    }

    .details-table tbody tr:nth-child(even) {
        background: var(--color-surface-hover);
    }

    /* === STATUS INDICATORS === */
    .status-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
    }

    .status-ok {
        background: var(--color-success-light);
        color: var(--color-success);
    }

    .status-alerta {
        background: var(--color-warning-light);
        color: var(--color-warning);
    }

    .status-erro {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .status-cell {
        text-align: center;
        width: 5%;
        white-space: nowrap;
    }

    /* === LOADING OVERLAY === */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 60;
        backdrop-filter: blur(4px);
    }

    .loading-content {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 90%;
        min-width: 400px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        text-align: center;
    }

    .loading-spinner {
        margin-bottom: var(--spacing-lg);
        width: 3rem;
        height: 3rem;
        border: 4px solid var(--color-border-light);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-message {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary);
    }

    /* === TIMELINE NO POPUP === */
    .popup-timeline {
        margin-top: 1.5rem;
        width: 100%;
        text-align: left;
    }

    .timeline-steps-popup {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .timeline-step-popup {
        display: flex;
        align-items: flex-start;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        border: 2px solid var(--color-border-light);
        background: var(--color-background);
        transition: all 0.3s ease;
        position: relative;
    }

    .timeline-step-popup.active {
        border-color: var(--color-primary);
        background: rgba(59, 130, 246, 0.1);
        animation: pulse 2s infinite;
    }

    .timeline-step-popup.completed {
        border-color: var(--color-success);
        background: rgba(34, 197, 94, 0.1);
    }

    .timeline-step-popup.error {
        border-color: var(--color-danger);
        background: rgba(239, 68, 68, 0.1);
    }

    .timeline-step-icon-popup {
        font-size: 1.25rem;
        margin-right: 0.75rem;
        width: 1.75rem;
        text-align: center;
        color: var(--color-text-secondary);
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .timeline-step-popup.active .timeline-step-icon-popup {
        color: var(--color-primary);
    }

    .timeline-step-popup.completed .timeline-step-icon-popup {
        color: var(--color-success);
    }

    .timeline-step-popup.error .timeline-step-icon-popup {
        color: var(--color-danger);
    }

    .timeline-step-content-popup {
        flex: 1;
    }

    .timeline-step-title-popup {
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .timeline-step-status-popup {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        line-height: 1.3;
    }

    .timeline-step-popup.active .timeline-step-status-popup {
        color: var(--color-primary);
    }

    .timeline-step-popup.completed .timeline-step-status-popup {
        color: var(--color-success);
    }

    .timeline-step-popup.error .timeline-step-status-popup {
        color: var(--color-danger);
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
        70% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }

    /* === FLASH MESSAGES === */
    .flash-message {
        position: fixed;
        top: 8rem;
        right: 1.5rem;
        z-index: 50;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-lg);
        color: white;
        font-weight: 500;
        font-size: 0.875rem;
        max-width: 400px;
        word-wrap: break-word;
    }

    .flash-success {
        background: var(--color-success);
    }

    .flash-error {
        background: var(--color-danger);
    }

    .flash-warning {
        background: var(--color-warning);
    }

    .flash-info {
        background: var(--color-info);
    }

    /* === DESCRI√á√ÉO DA P√ÅGINA === */
    .page-description {
        background: var(--color-primary-light);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        color: var(--color-text-primary);
    }

    .page-description p {
        margin: 0 0 var(--spacing-sm) 0;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .page-description ul {
        margin: var(--spacing-sm) 0 0 var(--spacing-lg);
        font-size: 0.875rem;
    }

    /* === LAYOUT DE DUAS COLUNAS === */
    .two-column-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .column-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .column-card:hover {
        box-shadow: var(--shadow-md);
    }

    /* === TIMELINE DE PROCESSAMENTO === */
    .processing-timeline {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        display: none;
    }

    .timeline-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .timeline-title svg {
        width: 1.5rem;
        height: 1.5rem;
        color: var(--color-primary);
    }

    .timeline-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        margin-bottom: var(--spacing-md);
    }

    .timeline-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        z-index: 2;
    }

    .timeline-step-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-normal);
        position: relative;
    }

    .timeline-step-icon svg {
        width: 1.5rem;
        height: 1.5rem;
    }

    .timeline-step-title {
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        color: var(--color-text-secondary);
        max-width: 100px;
        line-height: 1.3;
    }

    .timeline-step.pending .timeline-step-icon {
        background: var(--color-border-light);
        color: var(--color-text-muted);
        border: 2px solid var(--color-border);
    }

    .timeline-step.active .timeline-step-icon {
        background: var(--color-primary);
        color: white;
        border: 2px solid var(--color-primary);
        animation: pulse 2s infinite;
    }

    .timeline-step.completed .timeline-step-icon {
        background: var(--color-success);
        color: var(--color-success);
    }

    .timeline-step.error .timeline-step-icon {
        background: var(--color-danger);
        color: white;
        border: 2px solid var(--color-danger);
    }

    .timeline-connector {
        position: absolute;
        top: 1.5rem;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--color-border-light);
        z-index: 1;
    }

    .timeline-progress {
        height: 100%;
        background: var(--color-primary);
        border-radius: 1px;
        transition: width 0.5s ease;
        width: 0%;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 1024px) {
        .radio-container {
            grid-template-columns: 1fr;
        }

        .results-cards {
            grid-template-columns: 1fr;
        }

        .result-card-summary {
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .two-column-layout {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        .timeline-steps {
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .timeline-connector {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .main-card, .column-card {
            padding: var(--spacing-lg);
        }

        .dropzone {
            padding: var(--spacing-lg);
        }

        .result-card {
            padding: var(--spacing-lg);
        }

        .details-container {
            padding: var(--spacing-lg);
        }

        .processing-timeline {
            padding: var(--spacing-lg);
        }

        .timeline-step-title {
            font-size: 0.6875rem;
            max-width: 80px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Sistema de notifica√ß√µes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Header da P√°gina -->
    <div class="page-header">
        <h1 class="card-title">
            <i class="mdi mdi-file-check icon"></i>
            Confer√™ncia Documental com IA
        </h1>
    </div>

    <!-- Descri√ß√£o da P√°gina -->
    <div class="page-description">
        <p><strong>ü§ñ Confer√™ncia Documental Inteligente</strong></p>
        <p>Sistema avan√ßado de an√°lise autom√°tica de documentos aduaneiros utilizando Intelig√™ncia Artificial. Nossa ferramenta realiza:</p>
        <ul>
            <li><strong>Extra√ß√£o autom√°tica de dados:</strong> Identifica e extrai informa√ß√µes essenciais dos documentos</li>
            <li><strong>Valida√ß√£o de conformidade:</strong> Verifica se os documentos atendem aos requisitos regulamentares</li>
            <li><strong>Detec√ß√£o de inconsist√™ncias:</strong> Identifica diverg√™ncias, erros e campos ausentes</li>
            <li><strong>Relat√≥rio detalhado:</strong> Gera an√°lise completa com status e recomenda√ß√µes</li>
        </ul>
    </div>

    <!-- Layout de Duas Colunas -->
    <div class="two-column-layout">
        <!-- Coluna 1: Upload de Documentos -->
        <div class="column-card">
            <h2 class="card-title">
                <i class="mdi mdi-cloud-upload icon"></i>
                Upload de Documentos
            </h2>

            <div class="dropzone" id="dropzone">
                <svg class="dropzone-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <div class="dropzone-title">Arraste arquivos PDF aqui</div>
                <div class="dropzone-subtitle">ou clique para selecionar</div>
                <input type="file" id="file-input" multiple accept=".pdf" class="hidden">
                <button type="button" class="btn-primary" id="select-files">
                    <i class="mdi mdi-plus"></i>
                    Selecionar Arquivos
                </button>
            </div>

            <div class="file-list" id="file-list"></div>

            <div style="margin-top: 1.5rem;">
                <button type="button" class="btn-primary" id="upload-btn" style="display: none;">
                    <i class="mdi mdi-upload"></i>
                    Iniciar Confer√™ncia
                </button>
            </div>
        </div>

        <!-- Coluna 2: Tipo de Confer√™ncia -->
        <div class="column-card">
            <h2 class="card-title">
                <i class="mdi mdi-format-list-bulleted icon"></i>
                Tipo de Confer√™ncia
            </h2>
            
            <div class="radio-container">
                <label class="radio-option" data-tipo="invoice">
                    <input type="radio" name="tipo_conferencia" value="invoice" checked>
                    <div class="radio-option-info">
                        <div class="radio-option-title">Confer√™ncia de Invoices</div>
                        <div class="radio-option-desc">Verifica√ß√£o espec√≠fica para invoices comerciais com an√°lise de dados estruturados e valida√ß√£o de campos obrigat√≥rios conforme regulamenta√ß√£o aduaneira.</div>
                    </div>
                </label>

                <!-- Tipos futuros comentados para desenvolvimento posterior -->
                <!-- 
                <label class="radio-option" data-tipo="packlist">
                    <input type="radio" name="tipo_conferencia" value="packlist" disabled>
                    <div class="radio-option-info">
                        <div class="radio-option-title">Confer√™ncia de Packlists</div>
                        <div class="radio-option-desc">Verifica√ß√£o espec√≠fica para packlists. (Em desenvolvimento)</div>
                    </div>
                </label>

                <label class="radio-option" data-tipo="conhecimento">
                    <input type="radio" name="tipo_conferencia" value="conhecimento" disabled>
                    <div class="radio-option-info">
                        <div class="radio-option-title">Confer√™ncia de Conhecimentos</div>
                        <div class="radio-option-desc">Verifica√ß√£o espec√≠fica para conhecimentos de embarque (BL/AWB). (Em desenvolvimento)</div>
                    </div>
                </label>
                -->
            </div>
        </div>
    </div>

    <!-- Timeline de Processamento -->
    <div class="processing-timeline" id="processing-timeline">
        <h3 class="timeline-title">
            <i class="mdi mdi-timeline-clock"></i>
            Status do Processamento
        </h3>
        
        <div class="timeline-steps">
            <div class="timeline-connector">
                <div class="timeline-progress" id="timeline-progress"></div>
            </div>

            <div class="timeline-step pending" id="step-uploaded">
                <div class="timeline-step-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <div class="timeline-step-title">Documento Anexado</div>
            </div>

            <div class="timeline-step pending" id="step-analyzing">
                <div class="timeline-step-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div class="timeline-step-title">Analisando Documento</div>
            </div>

            <div class="timeline-step pending" id="step-extracting">
                <div class="timeline-step-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div class="timeline-step-title">Extraindo Dados</div>
            </div>

            <div class="timeline-step pending" id="step-validating">
                <div class="timeline-step-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="timeline-step-title">Validando Conformidade</div>
            </div>

            <div class="timeline-step pending" id="step-completed">
                <div class="timeline-step-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="timeline-step-title">An√°lise Conclu√≠da</div>
            </div>
        </div>
    </div>

    <!-- Container de Progresso -->
    <div class="progress-container" id="progress-container">
        <div class="progress-header">
            <div class="progress-title">
                <i class="mdi mdi-cog-clockwise"></i>
                Processamento em Andamento
            </div>
            <div class="progress-info" id="progress-info">0%</div>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Container de Resultados -->
    <div class="results-container" id="results-container">
        <div class="results-header">
            <h2 class="results-title">
                <i class="mdi mdi-check-circle"></i>
                Resultados da Confer√™ncia
            </h2>
            <div class="results-summary" id="results-summary"></div>
        </div>

        <div class="results-cards" id="results-cards">
            <!-- Os cards de resultados ser√£o injetados aqui via JavaScript -->
        </div>
    </div>

    <!-- Container de Detalhes -->
    <div class="details-container" id="details-container">
        <div class="details-header">
            <h3 class="details-title" id="details-title">Detalhes da Confer√™ncia</h3>
            <button type="button" class="details-close" id="details-close">
                <i class="mdi mdi-close"></i>
            </button>
        </div>
        <div class="details-content" id="details-content">
            <table class="details-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Status</th>
                        <th style="width: 20%;">Campo</th>
                        <th style="width: 15%;">Tipo</th>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="details-table-body">
                    <!-- As linhas da tabela de detalhes ser√£o injetadas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loading-message">Processando arquivos...</div>
            
            <!-- Timeline integrada no popup -->
            <div class="popup-timeline" id="popup-timeline" style="display: none; margin-top: 1.5rem; width: 100%; max-width: 500px;">
                <div class="timeline-steps-popup">
                    <div class="timeline-step-popup pending" id="popup-step-uploaded">
                        <div class="timeline-step-icon-popup">
                            <i class="mdi mdi-upload"></i>
                        </div>
                        <div class="timeline-step-content-popup">
                            <div class="timeline-step-title-popup">Documento Anexado</div>
                            <div class="timeline-step-status-popup">Aguardando...</div>
                        </div>
                    </div>

                    <div class="timeline-step-popup pending" id="popup-step-analyzing">
                        <div class="timeline-step-icon-popup">
                            <i class="mdi mdi-magnify-scan"></i>
                        </div>
                        <div class="timeline-step-content-popup">
                            <div class="timeline-step-title-popup">Analisando Documento</div>
                            <div class="timeline-step-status-popup">Aguardando...</div>
                        </div>
                    </div>

                    <div class="timeline-step-popup pending" id="popup-step-extracting">
                        <div class="timeline-step-icon-popup">
                            <i class="mdi mdi-database-export"></i>
                        </div>
                        <div class="timeline-step-content-popup">
                            <div class="timeline-step-title-popup">Extraindo Dados</div>
                            <div class="timeline-step-status-popup">Aguardando...</div>
                        </div>
                    </div>

                    <div class="timeline-step-popup pending" id="popup-step-validating">
                        <div class="timeline-step-icon-popup">
                            <i class="mdi mdi-shield-check"></i>
                        </div>
                        <div class="timeline-step-content-popup">
                            <div class="timeline-step-title-popup">Validando Conformidade</div>
                            <div class="timeline-step-status-popup">Aguardando...</div>
                        </div>
                    </div>

                    <div class="timeline-step-popup pending" id="popup-step-completed">
                        <div class="timeline-step-icon-popup">
                            <i class="mdi mdi-check-circle"></i>
                        </div>
                        <div class="timeline-step-content-popup">
                            <div class="timeline-step-title-popup">An√°lise Conclu√≠da</div>
                            <div class="timeline-step-status-popup">Aguardando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline de Processamento (exemplo) -->
    <div class="processing-timeline" id="processing-timeline">
        <div class="timeline-title">
            <i class="mdi mdi-timeline-clock icon"></i>
            Etapas do Processamento
        </div>
        <div class="timeline-steps" id="timeline-steps">
            <!-- Os passos da timeline ser√£o injetados aqui via JavaScript -->
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verifica√ß√£o de compatibilidade do navegador
        if (!window.fetch) {
            alert('Este navegador n√£o suporta todas as funcionalidades necess√°rias. Por favor, atualize seu navegador.');
            return;
        }

        // Elementos do DOM
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const selectFiles = document.getElementById('select-files');
        const fileList = document.getElementById('file-list');
        const uploadBtn = document.getElementById('upload-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsCards = document.getElementById('results-cards');
        const resultsSummary = document.getElementById('results-summary');
        const detailsContainer = document.getElementById('details-container');
        const detailsTitle = document.getElementById('details-title');
        const detailsTableBody = document.getElementById('details-table-body');
        const detailsClose = document.getElementById('details-close');
        const radioOptions = document.querySelectorAll('.radio-option');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');

        // Verifica√ß√£o de elementos cr√≠ticos
        const criticalElements = [dropzone, fileInput, selectFiles, uploadBtn, loadingOverlay];
        const missingElements = criticalElements.filter(el => !el);
        
        if (missingElements.length > 0) {
            console.error('Elementos cr√≠ticos n√£o encontrados no DOM');
            alert('Erro na inicializa√ß√£o da p√°gina. Por favor, recarregue a p√°gina.');
            return;
        }

        let selectedFiles = [];
        let currentJobId = null;
        let jobResults = null;
        let checkStatusInterval = null;

        // Fun√ß√£o auxiliar para fazer requests fetch de forma segura
        function safeFetch(url, options = {}) {
            // Op√ß√µes padr√£o para todas as requisi√ß√µes
            const defaultOptions = {
                credentials: 'same-origin', // Inclui cookies de sess√£o
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indica que √© uma requisi√ß√£o AJAX
                }
            };
            
            // Mescla as op√ß√µes
            const finalOptions = { ...defaultOptions, ...options };
            
            // Se h√° headers customizados, mescla com os padr√£o
            if (options.headers) {
                finalOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }
            
            console.log('Fazendo request para:', url, 'com op√ß√µes:', finalOptions);
            
            // Tentar usar o fetch original se dispon√≠vel
            if (window.sessionHandler && window.sessionHandler.originalFetch) {
                console.log('Usando fetch original do session handler');
                return window.sessionHandler.originalFetch.call(window, url, finalOptions);
            }
            
            // Fallback para XMLHttpRequest se fetch n√£o estiver dispon√≠vel ou causar problemas
            if (!window.fetch || typeof window.fetch !== 'function') {
                console.log('Fetch n√£o dispon√≠vel, usando XMLHttpRequest');
                return makeXMLHttpRequest(url, finalOptions);
            }
            
            try {
                // Tentar usar o fetch padr√£o
                console.log('Usando fetch padr√£o');
                return window.fetch.call(window, url, finalOptions);
            } catch (error) {
                console.log('Erro com fetch padr√£o, usando XMLHttpRequest:', error);
                return makeXMLHttpRequest(url, finalOptions);
            }
        }

        // Fun√ß√£o fallback usando XMLHttpRequest
        function makeXMLHttpRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const method = options.method || 'GET';
                
                xhr.open(method, url, true);
                
                // Configurar headers
                if (options.headers) {
                    Object.keys(options.headers).forEach(key => {
                        xhr.setRequestHeader(key, options.headers[key]);
                    });
                }
                
                // Incluir credenciais se especificado
                if (options.credentials === 'same-origin' || options.credentials === 'include') {
                    xhr.withCredentials = true;
                }
                
                xhr.onload = function() {
                    const response = {
                        ok: xhr.status >= 200 && xhr.status < 300,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        json: function() {
                            return Promise.resolve(JSON.parse(xhr.responseText));
                        },
                        text: function() {
                            return Promise.resolve(xhr.responseText);
                        }
                    };
                    resolve(response);
                };
                
                xhr.onerror = function() {
                    reject(new Error('Erro na requisi√ß√£o XMLHttpRequest'));
                };
                
                // Enviar dados
                if (options.body) {
                    xhr.send(options.body);
                } else {
                    xhr.send();
                }
            });
        }

        // Inicializa a sele√ß√£o do tipo de confer√™ncia
        radioOptions.forEach(option => {
            option.addEventListener('click', function() {
                radioOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                // Marca o input radio
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
            });
        });
        // Seleciona a primeira op√ß√£o por padr√£o
        radioOptions[0].classList.add('selected');

        // Event listeners para drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropzone.classList.add('dragover');
        }

        function unhighlight() {
            dropzone.classList.remove('dragover');
        }

        // Manipula√ß√£o de arquivos
        dropzone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        selectFiles.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
            
            if (validFiles.length === 0) {
                alert('Por favor, selecione apenas arquivos PDF.');
                return;
            }

            validFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                    addFileToList(file);
                }
            });

            updateUploadButton();
        }

        function addFileToList(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileSize = file.size < 1024 * 1024 
                ? `${(file.size / 1024).toFixed(1)} KB` 
                : `${(file.size / (1024 * 1024)).toFixed(1)} MB`;

            fileItem.innerHTML = `
                <i class="mdi mdi-file-pdf-box file-icon"></i>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
                <div class="file-actions">
                    <button type="button" class="file-action remove-file" data-filename="${file.name}" title="Remover arquivo">
                        <i class="mdi mdi-close"></i>
                    </button>
                </div>
            `;
            
            fileList.appendChild(fileItem);

            // Adicionar event listener para remover arquivo
            const removeBtn = fileItem.querySelector('.remove-file');
            removeBtn.addEventListener('click', () => {
                const filename = removeBtn.getAttribute('data-filename');
                selectedFiles = selectedFiles.filter(f => f.name !== filename);
                fileItem.remove();
                updateUploadButton();
            });
        }

        function updateUploadButton() {
            if (selectedFiles.length > 0) {
                uploadBtn.style.display = 'inline-flex';
            } else {
                uploadBtn.style.display = 'none';
            }
        }

        // Evento de upload com verifica√ß√£o adicional
        uploadBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            uploadFiles();
        });

        function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo para enviar.');
                return;
            }

            const tipoConferenciaInput = document.querySelector('input[name="tipo_conferencia"]:checked');
            if (!tipoConferenciaInput) {
                alert('Por favor, selecione um tipo de confer√™ncia.');
                return;
            }
            
            const tipoConferencia = tipoConferenciaInput.value;
            
            const formData = new FormData();
            formData.append('tipo_conferencia', tipoConferencia);
            
            selectedFiles.forEach(file => {
                formData.append('files[]', file);
            });
            
            showLoading('Enviando arquivos...');
            
            // Usa a fun√ß√£o safeFetch para evitar problemas de contexto
            safeFetch('/conferencia/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    currentJobId = data.job_id;
                    startProgressMonitoring(currentJobId);
                } else {
                    hideLoading();
                    alert(`Erro: ${data.message}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erro ao enviar arquivos:', error);
                alert(`Erro ao enviar arquivos: ${error.message}`);
            });
        }

        function startProgressMonitoring(jobId) {
            // Mostrar timeline dentro do popup
            showTimeline();
            
            // Oculta o painel de upload
            showLoading('Processando arquivos...');
            
            // Simular progresso inicial baseado nos logs reais
            updatePopupTimelineStep('popup-step-uploaded', 'completed', 'Arquivo recebido');
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-analyzing', 'active', 'Conectando com IA Gemini...');
            }, 800);
            
            // Inicia o monitoramento do progresso
            checkStatusInterval = setInterval(() => {
                checkJobStatus(jobId);
            }, 3000); // Verifica a cada 3 segundos (aumentado devido ao processamento mais longo)
        }

        function checkJobStatus(jobId) {
            const statusUrl = `/conferencia/status/${jobId}?t=${Date.now()}`;
            console.log(`Verificando status: ${statusUrl}`);
            
            // Usa a fun√ß√£o safeFetch para evitar problemas de contexto
            safeFetch(statusUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const job = data.job;
                        updateProgressWithJobData(job);
                        
                        if (job.status === 'completed') {
                            clearInterval(checkStatusInterval);
                            updatePopupTimelineStep('popup-step-completed', 'completed', 'An√°lise finalizada com sucesso');
                            setTimeout(() => {
                                loadJobResults(jobId);
                            }, 1000);
                        } else if (job.status === 'error') {
                            clearInterval(checkStatusInterval);
                            updatePopupTimelineStep('popup-step-completed', 'error', 'Erro durante o processamento');
                            hideLoading();
                            alert('Erro durante o processamento. Verifique os logs para mais detalhes.');
                        }
                    } else {
                        clearInterval(checkStatusInterval);
                        hideLoading();
                        updatePopupTimelineStep('popup-step-completed', 'error', 'Erro na verifica√ß√£o de status');
                        alert(`Erro ao verificar status: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro na verifica√ß√£o de status:', error);
                    
                    // Se for timeout ou erro de rede, mostrar na timeline
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        updatePopupTimelineStep('popup-step-validating', 'error', 'Timeout na conex√£o - processamento pode estar demorado');
                    } else {
                        clearInterval(checkStatusInterval);
                        hideLoading();
                        updatePopupTimelineStep('popup-step-completed', 'error', 'Erro de conex√£o');
                        alert(`Erro na verifica√ß√£o de status: ${error.message}`);
                    }
                });
        }

        function updateProgressWithJobData(job) {
            const progress = job.progress || 0;
            const arquivosProcessados = job.arquivos_processados || 0;
            const totalArquivos = job.total_arquivos || 1;
            
            // Atualizar timeline baseado no progresso real
            if (progress > 0 && progress < 25) {
                updatePopupTimelineStep('popup-step-analyzing', 'active', 'Analisando documento com IA...');
            } else if (progress >= 25 && progress < 50) {
                updatePopupTimelineStep('popup-step-analyzing', 'completed', 'An√°lise conclu√≠da');
                updatePopupTimelineStep('popup-step-extracting', 'active', 'Extraindo dados estruturados...');
            } else if (progress >= 50 && progress < 75) {
                updatePopupTimelineStep('popup-step-extracting', 'completed', 'Dados extra√≠dos');
                updatePopupTimelineStep('popup-step-validating', 'active', 'Validando conformidade...');
            } else if (progress >= 75 && progress < 100) {
                updatePopupTimelineStep('popup-step-validating', 'completed', 'Valida√ß√£o conclu√≠da');
                updatePopupTimelineStep('popup-step-completed', 'active', 'Finalizando an√°lise...');
            }
            
            // Atualizar loading message
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) {
                loadingMsg.textContent = `Processando ${arquivosProcessados}/${totalArquivos} arquivos... (${progress}%)`;
            }
        }

        function updateProgress(progress) {
            progressBar.style.width = `${progress}%`;
            progressInfo.textContent = `${progress}%`;
        }

        function loadJobResults(jobId) {
            console.log('Carregando resultados para job:', jobId);
            const resultUrl = `/conferencia/result/${jobId}?t=${Date.now()}`;
            console.log(`URL dos resultados: ${resultUrl}`);
            
            // Usar timeout maior para carregamento de resultados
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos
            
            // Usa a fun√ß√£o safeFetch para evitar problemas de contexto
            safeFetch(resultUrl, { signal: controller.signal })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    if (data.status === 'success') {
                        hideLoading();
                        hideTimeline(); // Esconder a timeline quando os resultados estiverem prontos
                        jobResults = data.job;
                        console.log('Job results:', jobResults);
                        displayResults(jobResults);
                    } else {
                        hideLoading();
                        updatePopupTimelineStep('popup-step-completed', 'error', 'Erro ao carregar resultados');
                        alert(`Erro ao carregar resultados: ${data.message}`);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    hideLoading();
                    
                    if (error.name === 'AbortError') {
                        updatePopupTimelineStep('popup-step-completed', 'error', 'Timeout ao carregar resultados');
                        alert('Timeout ao carregar resultados. O processamento pode ainda estar em andamento. Tente recarregar a p√°gina em alguns minutos.');
                    } else {
                        updatePopupTimelineStep('popup-step-completed', 'error', 'Erro ao carregar resultados');
                        console.error('Erro ao carregar resultados:', error);
                        alert(`Erro ao carregar resultados: ${error.message}`);
                    }
                });
        }

        function displayResults(job) {
            console.log('Exibindo resultados:', job);
            // Exibe o container de resultados
            resultsContainer.style.display = 'block';
            
            // Atualiza o resumo
            resultsSummary.textContent = `${job.arquivos_processados} de ${job.total_arquivos} arquivos processados ‚Ä¢ ${getTipoConferenciaLabel(job.tipo_conferencia)}`;
            
            // Limpa os cards existentes
            resultsCards.innerHTML = '';
            
            // Adiciona um card para cada arquivo
            console.log('Arquivos:', job.arquivos);
            job.arquivos.forEach((arquivo, index) => {
                console.log(`Processando arquivo ${index}:`, arquivo);
                console.log(`Filename: ${arquivo.filename}`);
                console.log(`Status: ${arquivo.status}`);
                console.log(`Has result: ${!!arquivo.result}`);
                
                if (arquivo.status === 'completed' && arquivo.result) {
                    const result = arquivo.result;
                    console.log(`Resultado detalhado do arquivo ${arquivo.filename}:`, result);
                    console.log(`Sum√°rio status: ${result.sumario?.status}`);
                    console.log(`Conclus√£o: ${result.sumario?.conclusao}`);
                    console.log(`Total erros: ${result.sumario?.total_erros_criticos}`);
                    
                    const card = createResultCard(arquivo.filename, result);
                    resultsCards.appendChild(card);
                    console.log(`Card criado para ${arquivo.filename}`);
                } else {
                    console.log('Arquivo n√£o processado ou sem resultado:', arquivo);
                }
            });
            
            // Scroll para os resultados
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function getTipoConferenciaLabel(tipo) {
            switch (tipo) {
                case 'invoice':
                    return 'Confer√™ncia de Invoices';
                case 'packlist':
                    return 'Confer√™ncia de Packlists';
                case 'conhecimento':
                    return 'Confer√™ncia de Conhecimentos';
                default:
                    return 'Confer√™ncia de Inconsist√™ncias';
            }
        }

        function createResultCard(filename, result) {
            const sumario = result.sumario || {};
            const statusClass = getStatusClass(sumario.status || 'ok');
            
            // Calcular totais se n√£o estiverem dispon√≠veis
            const totalErros = sumario.total_erros_criticos || 0;
            const totalAlertas = sumario.total_alertas || 0;
            const totalObservacoes = sumario.total_observacoes || 0;
            
            // Verificar se h√° dados para an√°lise
            const hasAnalysisData = (result.itens && result.itens.length > 0) || 
                                   (result.itens_analisados && result.itens_analisados.length > 0);
            
            // Criar mensagem de status mais informativa
            let statusMessage = sumario.conclusao || 'An√°lise conclu√≠da';
            if (hasAnalysisData) {
                statusMessage += ' ‚Ä¢ Dados analisados dispon√≠veis';
            }
            
            const card = document.createElement('div');
            card.className = 'result-card';
            
            card.innerHTML = `
                <div class="result-card-header">
                    <div class="result-card-icon ${statusClass}">
                        <i class="mdi mdi-file-document"></i>
                    </div>
                    <div class="result-card-info">
                        <div class="result-card-filename">${truncateFilename(filename, 20)}</div>
                        <div class="result-card-summary">
                            <div class="result-card-stat stat-error">
                                <i class="mdi mdi-alert-circle result-card-stat-icon"></i>
                                ${totalErros}
                            </div>
                            <div class="result-card-stat stat-warning">
                                <i class="mdi mdi-alert result-card-stat-icon"></i>
                                ${totalAlertas}
                            </div>
                            <div class="result-card-stat stat-info">
                                <i class="mdi mdi-information result-card-stat-icon"></i>
                                ${totalObservacoes}
                            </div>
                            ${hasAnalysisData ? '<div class="result-card-stat" style="color: #059669;"><i class="mdi mdi-check-circle result-card-stat-icon"></i>‚úì</div>' : ''}
                        </div>
                    </div>
                </div>
                <div style="margin: 1rem 0; font-size: 0.875rem; color: #6b7280;">
                    ${statusMessage}
                </div>
                <div class="result-card-actions">
                    <button type="button" class="btn-outline download-pdf" data-filename="${filename}">
                        <i class="mdi mdi-download"></i>
                        PDF
                    </button>
                    <button type="button" class="btn-outline view-details" data-filename="${filename}">
                        <i class="mdi mdi-eye"></i>
                        Ver Detalhes
                    </button>
                </div>
            `;
            
            // Adicionar event listeners
            const viewDetailsBtn = card.querySelector('.view-details');
            viewDetailsBtn.addEventListener('click', function() {
                const filename = this.getAttribute('data-filename');
                showDetails(filename, result);
            });
            
            return card;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'ok':
                    return 'result-status-ok';
                case 'alerta':
                    return 'result-status-alerta';
                case 'erro':
                    return 'result-status-erro';
                default:
                    return '';
            }
        }

        function truncateFilename(filename, maxLength) {
            if (filename.length <= maxLength) return filename;
            
            const extension = filename.slice(filename.lastIndexOf('.'));
            const name = filename.slice(0, filename.lastIndexOf('.'));
            
            return `${name.slice(0, maxLength - extension.length - 3)}...${extension}`;
        }

        function showDetails(filename, result) {
            console.log(`Mostrando detalhes para ${filename}:`, result);
            detailsTitle.textContent = `Detalhes: ${filename}`;
            detailsTableBody.innerHTML = '';
            
            // Identificar a estrutura de itens (pode ser 'itens' ou 'itens_analisados')
            const itemsArray = result?.itens || result?.itens_analisados || [];
            let hasItems = false;
            
            if (itemsArray && itemsArray.length > 0) {
                console.log(`Itens encontrados: ${itemsArray.length}`);
                hasItems = true;
                
                itemsArray.forEach((item, index) => {
                    console.log(`Item ${index}:`, item);
                    const row = document.createElement('tr');
                    const statusClass = `status-${item.status}`;
                    
                    // Criar descri√ß√£o mais detalhada com valor extra√≠do
                    let descricaoCompleta = item.descricao || item.message || 'Descri√ß√£o n√£o dispon√≠vel';
                    if (item.valor_extraido) {
                        descricaoCompleta += `<br><strong>Valor detectado:</strong> <span class="valor-extraido">[${item.valor_extraido}]</span>`;
                    } else if (item.valor_extraido === null) {
                        descricaoCompleta += `<br><strong>Valor detectado:</strong> <span class="valor-nao-encontrado">[N√£o encontrado]</span>`;
                    }
                    
                    row.innerHTML = `
                        <td class="status-cell">
                            <span class="status-icon ${statusClass}">
                                ${getStatusIcon(item.status)}
                            </span>
                        </td>
                        <td><strong>${item.campo || item.field || 'Campo n√£o especificado'}</strong></td>
                        <td>${getTipoLabel(item.tipo || item.type)}</td>
                        <td>${descricaoCompleta}</td>
                    `;
                    
                    detailsTableBody.appendChild(row);
                });
            }
            
            // Os dados brutos agora est√£o integrados na an√°lise principal
            // atrav√©s dos campos 'valor_extraido', ent√£o n√£o precisamos de se√ß√£o separada
            
            // Se n√£o h√° itens nem dados brutos, mostrar mensagem informativa
            if (!hasItems) {
                console.log('Nenhum item ou dado encontrado no resultado:', result);
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <i class="mdi mdi-information-outline" style="font-size: 3rem; color: #9ca3af;"></i>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">An√°lise em Processamento</div>
                                <div style="font-size: 0.875rem;">
                                    ${result?.sumario?.conclusao || 'O arquivo foi processado mas os dados ainda n√£o est√£o dispon√≠veis para exibi√ß√£o.'}
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                detailsTableBody.appendChild(noDataRow);
            }
            
            detailsContainer.style.display = 'block';
            detailsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'ok':
                    return '<i class="mdi mdi-check-circle"></i>';
                case 'alerta':
                    return '<i class="mdi mdi-alert"></i>';
                case 'erro':
                    return '<i class="mdi mdi-alert-circle"></i>';
                default:
                    return '';
            }
        }

        function getTipoLabel(tipo) {
            switch (tipo) {
                case 'erro_critico':
                    return 'Erro Cr√≠tico';
                case 'observacao':
                    return 'Observa√ß√£o';
                case 'alerta':
                    return 'Alerta';
                case 'ok':
                    return 'OK';
                default:
                    return tipo;
            }
        }

        // Fechar detalhes
        detailsClose.addEventListener('click', function() {
            detailsContainer.style.display = 'none';
        });

        // Fun√ß√µes de loading
        function showLoading(message) {
            loadingMessage.textContent = message || 'Carregando...';
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Fun√ß√£o para inicializar a timeline de processamento
        function initTimeline(steps) {
            timelineSteps.innerHTML = ''; // Limpa os passos existentes
            
            steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'timeline-step';
                stepElement.classList.add(step.status); // Adiciona a classe de status
                
                stepElement.innerHTML = `
                    <div class="timeline-step-icon">
                        ${getStepIcon(step.status)}
                    </div>
                    <div class="timeline-step-title">${step.title}</div>
                `;
                
                timelineSteps.appendChild(stepElement);
                
                // Adiciona o conector entre os passos
                if (index < steps.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'timeline-connector';
                    connector.style.height = `${getConnectorHeight(step.status)}px`; // Altura din√¢mica
                    timelineSteps.appendChild(connector);
                }
            });
        }

        function getStepIcon(status) {
            switch (status) {
                case 'pending':
                    return '<i class="mdi mdi-clock-outline"></i>';
                case 'active':
                    return '<i class="mdi mdi-cog-sync-outline"></i>';
                case 'completed':
                    return '<i class="mdi mdi-check-circle"></i>';
                case 'error':
                    return '<i class="mdi mdi-alert-circle"></i>';
                default:
                    return '';
            }
        }

        function getConnectorHeight(status) {
            switch (status) {
                case 'pending':
                    return 20;
                case 'active':
                    return 40;
                case 'completed':
                    return 0;
                case 'error':
                    return 0;
                default:
                    return 0;
            }
        }

        // Exemplo de inicializa√ß√£o da timeline
        initTimeline([
            { title: 'Recep√ß√£o dos Documentos', status: 'completed' },
            { title: 'An√°lise Inicial', status: 'completed' },
            { title: 'Valida√ß√£o de Dados', status: 'active' },
            { title: 'Gera√ß√£o de Relat√≥rio', status: 'pending' },
            { title: 'Confer√™ncia Final', status: 'pending' }
        ]);

        // Atualiza a largura da barra de progresso da timeline
        function updateTimelineProgress(progress) {
            const activeStep = document.querySelector('.timeline-step.active');
            if (activeStep) {
                const progressBar = document.createElement('div');
                progressBar.className = 'timeline-progress';
                progressBar.style.width = `${progress}%`;
                activeStep.appendChild(progressBar);
            }
        }

        // Exemplo de atualiza√ß√£o da barra de progresso
        setTimeout(() => {
            updateTimelineProgress(70);
        }, 2000);

        // Fun√ß√µes da Timeline de Processamento
        function showTimeline() {
            const timeline = document.getElementById('processing-timeline');
            if (timeline) {
                timeline.style.display = 'block';
                resetTimeline();
            }
        }

        function hideTimeline() {
            const timeline = document.getElementById('processing-timeline');
            if (timeline) {
                timeline.style.display = 'none';
            }
        }

        function resetTimeline() {
            const steps = ['step-uploaded', 'step-analyzing', 'step-extracting', 'step-validating', 'step-completed'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                if (step) {
                    step.className = 'timeline-step pending';
                }
            });
            
            const progressLine = document.getElementById('timeline-progress');
            if (progressLine) {
                progressLine.style.width = '0%';
            }
        }

        function updateTimelineStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `timeline-step ${status}`;
            }
            
            // Atualizar a linha de progresso
            const steps = ['step-uploaded', 'step-analyzing', 'step-extracting', 'step-validating', 'step-completed'];
            const currentStepIndex = steps.indexOf(stepId);
            const progressLine = document.getElementById('timeline-progress');
            
            if (progressLine && currentStepIndex >= 0) {
                const progressPercent = ((currentStepIndex + 1) / steps.length) * 100;
                progressLine.style.width = `${progressPercent}%`;
            }
        }

        function simulateTimelineProgress() {
            // Simular o progresso da timeline baseado nos logs do backend
            updateTimelineStep('step-uploaded', 'completed');
            
            setTimeout(() => {
                updateTimelineStep('step-analyzing', 'active');
            }, 500);
            
            setTimeout(() => {
                updateTimelineStep('step-analyzing', 'completed');
                updateTimelineStep('step-extracting', 'active');
            }, 2500);       
            
            setTimeout(() => {
                updateTimelineStep('step-extracting', 'completed');
                updateTimelineStep('step-validating', 'active');
            }, 5000);
            
            setTimeout(() => {
                updateTimelineStep('step-validating', 'completed');
                updateTimelineStep('step-completed', 'active');
            }, 7000);
            
            setTimeout(() => {
                updateTimelineStep('step-completed', 'completed');
            }, 8000);
        }

        // Novas fun√ß√µes para timeline do popup
        function resetPopupTimeline() {
            const steps = ['popup-step-uploaded', 'popup-step-analyzing', 'popup-step-extracting', 'popup-step-validating', 'popup-step-completed'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                if (step) {
                    step.className = 'timeline-step-popup pending';
                    const statusEl = step.querySelector('.timeline-step-status-popup');
                    if (statusEl) {
                        statusEl.textContent = 'Aguardando...';
                    }
                }
            });
        }

        function updatePopupTimelineStep(stepId, status, message = '') {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `timeline-step-popup ${status}`;
                const statusEl = step.querySelector('.timeline-step-status-popup');
                if (statusEl) {
                    let statusText = '';
                    switch(status) {
                        case 'active':
                            statusText = message || 'Processando...';
                            break;
                        case 'completed':
                            statusText = message || 'Conclu√≠do';
                            break;
                        case 'error':
                            statusText = message || 'Erro';
                            break;
                        default:
                            statusText = 'Aguardando...';
                    }
                    statusText += ` (${new Date().toLocaleTimeString()})`;
                    statusEl.textContent = statusText;
                }
            }
        }

        // Sobrescrever a fun√ß√£o showTimeline para usar o popup
        function showTimeline() {
            const popupTimeline = document.getElementById('popup-timeline');
            if (popupTimeline) {
                popupTimeline.style.display = 'block';
                resetPopupTimeline();
                // Simular progresso real
                simulateRealTimelineProgress();
            }
        }

        function hideTimeline() {
            const popupTimeline = document.getElementById('popup-timeline');
            if (popupTimeline) {
                popupTimeline.style.display = 'none';
            }
        }

        // Nova fun√ß√£o para simular progresso mais realista
        function simulateRealTimelineProgress() {
            updatePopupTimelineStep('popup-step-uploaded', 'completed', 'Arquivo recebido com sucesso');
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-analyzing', 'active', 'Conectando com IA Gemini...');
            }, 800);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-analyzing', 'active', 'Analisando conte√∫do do documento...');
            }, 2000);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-analyzing', 'completed', 'An√°lise conclu√≠da');
                updatePopupTimelineStep('popup-step-extracting', 'active', 'Extraindo dados estruturados...');
            }, 4500);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-extracting', 'active', 'Processando campos obrigat√≥rios...');
            }, 6000);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-extracting', 'completed', 'Dados extra√≠dos com sucesso');
                updatePopupTimelineStep('popup-step-validating', 'active', 'Validando conformidade regulat√≥ria...');
            }, 8000);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-validating', 'active', 'Verificando inconsist√™ncias...');
            }, 10000);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-validating', 'completed', 'Valida√ß√£o conclu√≠da');
                updatePopupTimelineStep('popup-step-completed', 'active', 'Gerando relat√≥rio final...');
            }, 12000);
            
            setTimeout(() => {
                updatePopupTimelineStep('popup-step-completed', 'completed', 'Confer√™ncia finalizada');
            }, 14000);
        }

        // Iniciar simula√ß√£o de progresso da timeline (para teste)
        // simulateTimelineProgress();
    });
</script>
{% endblock %}
