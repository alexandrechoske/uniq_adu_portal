{% extends "base.html" %}
{% block title %}
    {% if user %}Editar{% else %}Novo{% endif %} Usuário - Portal UniSystem
{% endblock %}

{% block extra_css %}
<style>
    /* === DESIGN SYSTEM - VARIÁVEIS MODERNAS === */
    :root {
        /* Paleta de cores minimalista */
        --color-background: #fafbfc;
        --color-surface: #ffffff;
        --color-surface-hover: #f8fafc;
        --color-border: #e2e8f0;
        --color-border-light: #f1f5f9;
        
        /* Textos */
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --color-text-muted: #64748b;
        --color-text-light: #94a3b8;
        
        /* Cores de destaque elegantes */
        --color-primary: #3b82f6;
        --color-primary-light: #dbeafe;
        --color-success: #10b981;
        --color-success-light: #d1fae5;
        --color-warning: #f59e0b;
        --color-warning-light: #fef3c7;
        --color-danger: #ef4444;
        --color-danger-light: #fee2e2;
        --color-info: #06b6d4;
        --color-info-light: #cffafe;
        --color-purple: #8b5cf6;
        --color-purple-light: #ede9fe;
        
        /* Sombras minimalistas */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* Espacamentos consistentes */
        --spacing-xs: 0.5rem;
        --spacing-sm: 0.75rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        /* Bordas arredondadas */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* Transições suaves */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }

    /* === LAYOUT BASE === */
    .dashboard-container {
        background: var(--color-background);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        width: 100%;
        box-sizing: border-box;
        padding-top: 4rem;
    }

    .main-content {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-xl);
        box-sizing: border-box;
    }

    /* === HEADER MODERNIZADO === */
    .dashboard-header {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-lg) var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-lg);
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-title-section {
        flex: 1;
    }

    .header-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-xs) 0;
        letter-spacing: -0.02em;
    }

    .header-subtitle {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    /* === CARDS E FORMULÁRIOS === */
    .form-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-2xl);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
    }

    .form-card:hover {
        box-shadow: var(--shadow-md);
    }

    .info-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        height: fit-content;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-lg) 0;
        letter-spacing: -0.01em;
    }

    .card-subtitle {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-md) 0;
    }

    /* === FORMULÁRIOS === */
    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .form-input, .form-select {
        width: 100%;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.875rem;
        color: var(--color-text-primary);
        transition: all var(--transition-fast);
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    /* === BOTÕES === */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all var(--transition-fast);
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: var(--color-primary);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
    }

    .btn-outline:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-text-secondary);
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--color-text-muted);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        margin-bottom: var(--spacing-lg);
    }

    .back-link:hover {
        color: var(--color-text-secondary);
        transform: translateX(-2px);
    }

    /* === PERFIS DE USUÁRIO === */
    .role-card {
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        transition: all var(--transition-fast);
    }

    .role-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .role-cliente {
        background: var(--color-success-light);
        border: 1px solid #a7f3d0;
    }

    .role-interno {
        background: var(--color-primary-light);
        border: 1px solid #bfdbfe;
    }

    .role-admin {
        background: var(--color-danger-light);
        border: 1px solid #fecaca;
    }

    .role-title {
        font-weight: 600;
        margin: 0 0 var(--spacing-xs) 0;
    }

    .role-cliente .role-title {
        color: #059669;
    }

    .role-interno .role-title {
        color: #2563eb;
    }

    .role-admin .role-title {
        color: #dc2626;
    }

    .role-description {
        font-size: 0.875rem;
        margin: 0;
    }

    .role-cliente .role-description {
        color: #047857;
    }

    .role-interno .role-description {
        color: #1d4ed8;
    }

    .role-admin .role-description {
        color: #b91c1c;
    }

    /* === SEÇÃO DE EMPRESAS === */
    .companies-section {
        margin-top: var(--spacing-2xl);
    }

    .companies-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
    }

    .section-subtitle {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin: var(--spacing-xs) 0 0 0;
    }

    .section-counter {
        font-size: 0.875rem;
        color: var(--color-text-muted);
    }

    .section-counter strong {
        color: var(--color-text-primary);
        font-weight: 600;
    }

    /* === TABELAS === */
    .table-container {
        background: var(--color-surface);
        border: 1px solid var(--color-border-light);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: var(--spacing-lg);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background: var(--color-background);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-sm) var(--spacing-lg);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .table td {
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 0.875rem;
        color: var(--color-text-primary);
    }

    .table tr:hover {
        background: var(--color-surface-hover);
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    /* === SEARCH FORM === */
    .search-form {
        background: var(--color-background);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
    }

    .search-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-sm) 0;
    }

    .search-row {
        display: flex;
        gap: var(--spacing-sm);
        align-items: end;
    }

    .search-input {
        flex: 1;
    }

    .search-btn {
        background: var(--color-primary);
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .search-btn:hover {
        background: #2563eb;
    }

    /* === GRID RESPONSIVO === */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: var(--spacing-xl);
        align-items: start;
    }

    @media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    /* === HIDDEN CLASS === */
    .hidden {
        display: none;
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 1024px) {
        .header-content {
            flex-direction: column;
            align-items: stretch;
        }

        .header-controls {
            justify-content: stretch;
        }

        .main-content {
            padding: 0 var(--spacing-lg);
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 0 var(--spacing-md);
        }

        .form-card, .info-card, .companies-card {
            padding: var(--spacing-lg);
        }

        .search-row {
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
        }
    }

    /* === ESTILO PARA NOTIFICAÇÕES === */
    #notification-container {
        max-height: 100vh;
        overflow-y: auto;
        pointer-events: none;
        top: 8rem;
        right: 1.5rem;
        position: fixed;
        z-index: 50;
    }
    
    #notification-container > div {
        pointer-events: auto;
        margin-bottom: 0.5rem;
    }
    
    @media (max-width: 640px) {
        #notification-container {
            top: 6rem;
            right: 1rem;
            left: 1rem;
        }
        
        #notification-container > div {
            min-width: auto;
            max-width: none;
        }
    }
    
    @media (min-width: 641px) and (max-width: 1024px) {
        #notification-container {
            top: 7rem;
            right: 1.5rem;
        }
    }
    
    .notification-enter {
        animation: slideInRight 0.3s ease-out;
    }
    
    .notification-exit {
        animation: slideOutRight 0.3s ease-in;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sistema de Notificações -->
    <div id="notification-container">
        <!-- Notificações serão inseridas aqui via JavaScript -->
    </div>

    <!-- Verificar se há mensagens flash e exibir notificações -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    {% for category, message in messages %}
                        showNotification({{ message|tojson }}, {{ category|tojson }});
                    {% endfor %}
                });
            </script>
        {% endif %}
    {% endwith %}

    <!-- Header da Página -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title-section">
                <h1 class="header-title">{% if user %}Editar Usuário{% else %}Novo Usuário{% endif %}</h1>
                <p class="header-subtitle">
                    <i class="mdi mdi-account-{% if user %}edit{% else %}plus{% endif %}"></i>
                    {% if user %}Modifique as informações do usuário{% else %}Crie um novo usuário no sistema{% endif %}
                </p>
            </div>
            <div class="header-controls">
                <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline">
                    <i class="mdi mdi-arrow-left"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="form-grid">
            <!-- Formulário Principal -->
            <div class="form-card">
                <h2 class="card-title">
                    {% if user %}Editar Usuário{% else %}Criar Usuário{% endif %}
                </h2>
                
                <form method="POST" action="{% if user %}{{ url_for('usuarios.salvar', user_id=user.id) }}{% else %}{{ url_for('usuarios.criar') }}{% endif %}" id="userForm">
                    <!-- Campo Nome -->
                    <div class="form-group">
                        <label for="name" class="form-label">Nome Completo</label>
                        <input type="text" name="name" id="name" 
                               value="{{ user.name if user else '' }}"
                               class="form-input"
                               placeholder="Digite o nome completo"
                               required>
                    </div>

                    <!-- Campo Email -->
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" name="email" id="email" 
                               value="{{ user.email if user else '' }}"
                               class="form-input"
                               placeholder="Digite o email do usuário"
                               required>
                    </div>

                    <!-- Campo Senha (apenas para novos usuários) -->
                    {% if not user %}
                    <div class="form-group">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" name="password" id="password" 
                               class="form-input"
                               placeholder="Digite uma senha segura"
                               required>
                    </div>
                    {% endif %}

                    <!-- Campo Perfil -->
                    <div class="form-group">
                        <label for="role" class="form-label">Perfil de Acesso</label>
                        <select name="role" id="role" class="form-select" required>
                            <option value="">Selecione um perfil</option>
                            <option value="admin" {% if user and user.role == 'admin' %}selected{% endif %}>Administrador</option>
                            <option value="interno_unique" {% if user and user.role == 'interno_unique' %}selected{% endif %}>Interno Unique</option>
                            <option value="cliente_unique" {% if user and user.role == 'cliente_unique' %}selected{% endif %}>Cliente Unique</option>
                        </select>
                    </div>

                    <!-- Botões de Ação -->
                    <div style="display: flex; justify-content: flex-end; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
                        <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline">
                            Cancelar
                        </a>
                        <button type="submit" id="submitButton" class="btn btn-primary">
                            <span id="submitButtonText">{% if user %}Salvar Alterações{% else %}Criar Usuário{% endif %}</span>
                            <i id="submitLoader" class="mdi mdi-loading mdi-spin hidden" style="margin-left: var(--spacing-xs);"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Card Informativo -->
            <div class="info-card">
                <h3 class="card-subtitle">Perfis de Usuário</h3>
                
                <div class="role-card role-cliente">
                    <h4 class="role-title">
                        <i class="mdi mdi-account-group" style="margin-right: var(--spacing-xs);"></i>
                        Cliente Unique
                    </h4>
                    <p class="role-description">Acesso aos seus próprios processos e relatórios. Pode visualizar apenas empresas vinculadas.</p>
                </div>
                
                <div class="role-card role-interno">
                    <h4 class="role-title">
                        <i class="mdi mdi-account-tie" style="margin-right: var(--spacing-xs);"></i>
                        Interno Unique
                    </h4>
                    <p class="role-description">Acesso a todos os processos e relatórios. Visão completa do sistema.</p>
                </div>
                
                <div class="role-card role-admin">
                    <h4 class="role-title">
                        <i class="mdi mdi-shield-crown" style="margin-right: var(--spacing-xs);"></i>
                        Administrador
                    </h4>
                    <p class="role-description">Acesso total ao sistema, incluindo gestão de usuários e configurações.</p>
                </div>
            </div>
        </div>

        <!-- Seção de Empresas (visível apenas para Cliente Unique) -->
        <div id="empresasSection" class="companies-section {% if not user or user.role != 'cliente_unique' %}hidden{% endif %}">
            <div class="companies-card">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">
                            <i class="mdi mdi-domain" style="margin-right: var(--spacing-xs); color: var(--color-purple);"></i>
                            Empresas Vinculadas
                        </h3>
                        <p class="section-subtitle">Empresas associadas a este usuário cliente</p>
                    </div>
                    <div class="section-counter">
                        Total: <strong id="totalEmpresas">0</strong>
                    </div>
                </div>
                
                <!-- Tabela de Empresas -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>Razão Social</th>
                                <th style="text-align: right;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="empresasTableBody">
                            <!-- As empresas serão inseridas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Formulário para Adicionar Nova Empresa -->
                <div class="search-form">
                    <h4 class="search-title">
                        <i class="mdi mdi-plus-circle" style="margin-right: var(--spacing-xs);"></i>
                        Adicionar Nova Empresa
                    </h4>
                    <div class="search-row">
                        <div class="search-input">
                            <input type="text" id="cnpjSearch" 
                                   class="form-input" 
                                   placeholder="Ex: 75.339.051/0001-41"
                                   maxlength="18">
                        </div>
                        <button type="button" id="searchButton" class="search-btn">
                            <i class="mdi mdi-magnify" style="margin-right: var(--spacing-xs);"></i>
                            Pesquisar
                        </button>
                    </div>
                    
                    <!-- Resultados da Pesquisa -->
                    <div id="searchResults" style="display: none; margin-top: var(--spacing-md); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
                        <div id="searchResultsList" style="max-height: 200px; overflow-y: auto; padding: var(--spacing-sm);">
                            <!-- Resultados aqui -->
                        </div>
                    </div>

                    <!-- Lista de Empresas Selecionadas -->
                    <div style="margin-top: var(--spacing-md);">
                        <h4 class="search-title">Empresas Selecionadas</h4>
                        <div id="selectedCompanies" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                            <!-- Empresas selecionadas serão listadas aqui -->
                        </div>
                        <input type="hidden" name="selected_companies" id="selectedCompaniesInput">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('role');
    const empresasSection = document.getElementById('empresasSection');
    const userId = getUserIdFromUrl();
      // Função para obter user ID da URL
    function getUserIdFromUrl() {
        const pathParts = window.location.pathname.split('/');
        const editIndex = pathParts.indexOf('editar');
        if (editIndex !== -1) {
            return pathParts[editIndex - 1];
        }
        // Para páginas de criação, não há userId ainda
        return null;
    }
      // Mostrar/ocultar seção de empresas baseado no perfil
    function toggleEmpresasSection() {
        if (roleSelect.value === 'cliente_unique') {
            empresasSection.classList.remove('hidden');
            if (userId) {
                // Apenas carrega empresas se estivermos editando um usuário existente
                carregarEmpresasUsuario();
            } else {
                // Para novos usuários, apenas mostra a seção para seleção
                document.getElementById('empresasTableBody').innerHTML = '<tr><td colspan="3" style="padding: var(--spacing-lg); text-align: center; color: var(--color-text-muted);">Selecione as empresas abaixo para vincular ao novo usuário</td></tr>';
                document.getElementById('totalEmpresas').textContent = '0';
            }
        } else {
            empresasSection.classList.add('hidden');
        }
    }
    
    // Event listener para mudança de perfil
    if (roleSelect) {
        roleSelect.addEventListener('change', toggleEmpresasSection);
        // Verificar perfil inicial
        toggleEmpresasSection();
    }
      // Carregar empresas do usuário (apenas para edição)
    async function carregarEmpresasUsuario() {
        if (!userId) return;
        
        try {
            const response = await fetch(`/usuarios/${userId}/empresas-detalhadas`);
            if (!response.ok) throw new Error('Falha ao carregar empresas');
            
            const data = await response.json();
            if (data.empresas) {
                renderizarEmpresas(data.empresas);
            }
        } catch (error) {
            console.error('Erro ao carregar empresas:', error);
            mostrarNotificacao('Erro ao carregar empresas', 'error');
        }
    }
    
    // Renderizar empresas na tabela
    function renderizarEmpresas(empresas) {
        const tbody = document.getElementById('empresasTableBody');
        const totalElement = document.getElementById('totalEmpresas');
        
        tbody.innerHTML = '';
        
        if (empresas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" style="padding: var(--spacing-lg); text-align: center; color: var(--color-text-muted);">
                        Nenhuma empresa vinculada
                    </td>
                </tr>
            `;
        } else {
            empresas.forEach(empresa => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: var(--spacing-md) var(--spacing-lg); font-weight: 500;">
                        ${empresa.cnpj}
                    </td>
                    <td style="padding: var(--spacing-md) var(--spacing-lg); color: var(--color-text-secondary);">
                        ${empresa.razao_social}
                    </td>
                    <td style="padding: var(--spacing-md) var(--spacing-lg); text-align: right;">
                        <button type="button" onclick="removerEmpresa('${empresa.cnpj}')"
                                style="color: var(--color-danger); background: none; border: none; cursor: pointer; padding: var(--spacing-xs); border-radius: var(--radius-sm); transition: all var(--transition-fast);"
                                onmouseover="this.style.background='var(--color-danger-light)'"
                                onmouseout="this.style.background='none'">
                            <i class="mdi mdi-delete" style="font-size: 1rem;"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        totalElement.textContent = empresas.length;
    }
    
    // Validar formato CNPJ
    function validarCNPJ(cnpj) {
        const regex = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/;
        return regex.test(cnpj);
    }
    
    // Aplicar máscara CNPJ
    function aplicarMascaraCNPJ(input) {
        let valor = input.value.replace(/\D/g, '');
        
        if (valor.length <= 14) {
            valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
            valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
            valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        input.value = valor;
    }
    
    // Event listener para máscara do CNPJ
    const cnpjInput = document.getElementById('cnpjSearch');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            aplicarMascaraCNPJ(e.target);
        });
    }
    
    // Pesquisar empresas
    const searchButton = document.getElementById('searchButton');
    if (searchButton) {
        searchButton.addEventListener('click', async function() {
            const cnpj = document.getElementById('cnpjSearch').value.trim();
            
            if (!cnpj || !validarCNPJ(cnpj)) {
                alert('Digite um CNPJ válido no formato XX.XXX.XXX/XXXX-XX');
                return;
            }
            
            try {
                const response = await fetch('/usuarios/pesquisar-empresa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cnpj: cnpj })
                });
                
                const data = await response.json();
                
                const resultsList = document.getElementById('searchResultsList');
                const searchResults = document.getElementById('searchResults');
                
                resultsList.innerHTML = '';
                
                if (data.success && data.empresa) {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        padding: var(--spacing-sm);
                        background: var(--color-surface-hover);
                        border-radius: var(--radius-sm);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: var(--spacing-xs);
                        transition: all var(--transition-fast);
                    `;
                    item.innerHTML = `
                        <div>
                            <div style="font-weight: 500; color: var(--color-text-primary); font-size: 0.875rem;">${data.empresa.cnpj}</div>
                            <div style="color: var(--color-text-muted); font-size: 0.8rem;">${data.empresa.razao_social}</div>
                        </div>
                        <button type="button" onclick="adicionarEmpresa('${data.empresa.cnpj}', '${data.empresa.razao_social.replace(/'/g, "\\'")}')"
                                class="btn btn-primary" style="font-size: 0.75rem; padding: var(--spacing-xs) var(--spacing-sm);">
                            Adicionar
                        </button>
                    `;
                    resultsList.appendChild(item);
                    searchResults.style.display = 'block';
                } else {
                    resultsList.innerHTML = '<div style="padding: var(--spacing-sm); text-align: center; color: var(--color-text-muted); font-size: 0.875rem;">Empresa não encontrada</div>';
                    searchResults.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro na pesquisa:', error);
                mostrarNotificacao('Erro ao pesquisar empresa', 'error');
            }
        });
    }
      // Remover empresa
    window.removerEmpresa = async function(cnpj) {
        if (!confirm('Deseja remover esta empresa?')) return;
        
        try {
            if (userId) {
                // Modo edição: remover via API
                const response = await fetch(`/usuarios/${userId}/empresas/remover`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cnpj: cnpj })
                });
                
                if (response.ok) {
                    carregarEmpresasUsuario();
                    mostrarNotificacao('Empresa removida com sucesso', 'success');
                } else {
                    mostrarNotificacao('Erro ao remover empresa', 'error');
                }
            } else {
                // Modo criação: remover da lista local
                removeCompany(cnpj);
                mostrarNotificacao('Empresa removida da lista', 'success');
            }
        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('Erro ao remover empresa', 'error');
        }
    };
      // Adicionar empresa
    window.adicionarEmpresa = async function(cnpj, razaoSocial) {
        try {
            if (userId) {
                // Modo edição: adicionar via API
                const response = await fetch(`/usuarios/${userId}/empresas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cnpj: cnpj
                    })
                });
                
                if (response.ok) {
                    carregarEmpresasUsuario();
                    document.getElementById('cnpjSearch').value = '';
                    document.getElementById('searchResults').classList.add('hidden');
                    mostrarNotificacao('Empresa adicionada com sucesso', 'success');
                } else {
                    const errorData = await response.json();
                    mostrarNotificacao(errorData.error || 'Erro ao adicionar empresa', 'error');
                }
            } else {
                // Modo criação: adicionar à lista local
                const company = { cnpj: cnpj, razao_social: razaoSocial };
                addCompany(company);
                document.getElementById('cnpjSearch').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                mostrarNotificacao('Empresa adicionada à lista', 'success');
            }
        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('Erro ao adicionar empresa', 'error');
        }
    };
    
    // Mostrar notificação (atualizada para usar o novo sistema)
    function mostrarNotificacao(mensagem, tipo) {
        showNotification(mensagem, tipo);
    }
    
    // Função para atualizar a tabela de empresas
    function atualizarTabelaEmpresas(empresas) {
        const tbody = document.getElementById('empresasTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!empresas || empresas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                        ${userId ? 'Nenhuma empresa vinculada' : 'Selecione as empresas abaixo para vincular ao novo usuário'}
                    </td>
                </tr>
            `;
            return;
        }
        
        empresas.forEach(empresa => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${empresa.cnpj}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${empresa.razao_social}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button type="button" onclick="removerEmpresa('${empresa.cnpj}')"
                            class="text-red-600 hover:text-red-900">
                        <i class="mdi mdi-delete h-5 w-5"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Se estivermos na página de edição, carregar empresas
    if (userId) {
        carregarEmpresasUsuario();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const cnpjInput = document.getElementById('cnpjSearch');
    const searchButton = document.getElementById('searchButton');
    const searchResults = document.getElementById('searchResults');
    const searchResultsList = document.getElementById('searchResultsList');
    const selectedCompanies = document.getElementById('selectedCompanies');
    const selectedCompaniesInput = document.getElementById('selectedCompaniesInput');
    
    // Array para armazenar as empresas selecionadas
    let selectedCompaniesArray = [];

    // Aplicar máscara de CNPJ
    cnpjInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 14) {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    // Função para pesquisar empresas
    searchButton.addEventListener('click', async function() {
        const cnpjFormatado = cnpjInput.value.trim();
        
        if (!cnpjFormatado || !validarCNPJ(cnpjFormatado)) {
            alert('Digite um CNPJ válido no formato XX.XXX.XXX/XXXX-XX');
            return;
        }

        try {
            const response = await fetch('/usuarios/pesquisar-empresa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cnpj: cnpjFormatado })
            });

            if (!response.ok) {
                throw new Error('Erro ao pesquisar empresa');
            }

            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                return;
            }

            // Limpar resultados anteriores
            searchResultsList.innerHTML = '';
            
            // Criar elemento para a empresa encontrada
            if (data.empresa) {
                const company = data.empresa;
                const companyElement = document.createElement('div');
                companyElement.className = 'flex items-center justify-between p-2 hover:bg-gray-50';
                companyElement.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="company-${company.cnpj}" 
                               value="${company.cnpj}"
                               class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="company-${company.cnpj}" class="text-sm text-gray-900">
                            ${company.razao_social} (${company.cnpj})
                        </label>
                    </div>
                `;

                const checkbox = companyElement.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        addCompany(company);
                    }
                });

                searchResultsList.appendChild(companyElement);
                searchResults.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao pesquisar empresa');
        }
    });

    // Função para adicionar empresa à lista de selecionadas
    function addCompany(company) {
        if (!selectedCompaniesArray.some(c => c.cnpj === company.cnpj)) {
            selectedCompaniesArray.push(company);
            updateSelectedCompaniesList();
        }
    }

    // Função para remover empresa da lista de selecionadas
    function removeCompany(cnpj) {
        selectedCompaniesArray = selectedCompaniesArray.filter(c => c.cnpj !== cnpj);
        updateSelectedCompaniesList();
    }    // Função para atualizar a lista visual de empresas selecionadas
    function updateSelectedCompaniesList() {
        selectedCompanies.innerHTML = '';
        selectedCompaniesArray.forEach(company => {
            const element = document.createElement('div');
            element.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            element.innerHTML = `
                <span class="text-sm text-gray-900">${company.razao_social} (${company.cnpj})</span>                <button type="button" data-cnpj="${company.cnpj}" 
                        class="text-red-600 hover:text-red-900">
                    <i class="mdi mdi-delete h-5 w-5"></i>
                </button>
            `;

            element.querySelector('button').addEventListener('click', function() {
                removeCompany(this.dataset.cnpj);
            });

            selectedCompanies.appendChild(element);
        });

        // Atualizar input hidden com as empresas selecionadas
        selectedCompaniesInput.value = JSON.stringify(selectedCompaniesArray);
          // Se estivermos no modo criação, também atualizar a tabela principal
        if (!userId) {
            atualizarTabelaEmpresas(selectedCompaniesArray);
            document.getElementById('totalEmpresas').textContent = selectedCompaniesArray.length;
        }
    }
    
    // Controle de submit do formulário principal
    const userForm = document.getElementById('userForm');
    const submitButton = document.getElementById('submitButton');
    const submitButtonText = document.getElementById('submitButtonText');
    const submitLoader = document.getElementById('submitLoader');
    
    if (userForm) {
        userForm.addEventListener('submit', function(e) {
            console.log('[DEBUG] Formulário enviado');
            
            // Mostrar loading
            submitButton.disabled = true;
            submitButtonText.textContent = userId ? 'Salvando...' : 'Criando...';
            submitLoader.classList.remove('hidden');
            
            // Validar campos obrigatórios
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const role = document.getElementById('role').value;
            
            console.log('[DEBUG] Dados do formulário:', { name, email, role });
            
            if (!name || !email || !role) {
                e.preventDefault();
                showNotification('Preencha todos os campos obrigatórios', 'warning');
                resetSubmitButton();
                return false;
            }
            
            // Para novos usuários, validar senha
            if (!userId) {
                const password = document.getElementById('password').value;
                if (!password) {
                    e.preventDefault();
                    showNotification('A senha é obrigatória para novos usuários', 'warning');
                    resetSubmitButton();
                    return false;
                }
                console.log('[DEBUG] Password validado para novo usuário');
            }
            
            console.log('[DEBUG] Validação concluída, enviando formulário...');
        });
    }
    
    function resetSubmitButton() {
        submitButton.disabled = false;
        submitButtonText.textContent = userId ? 'Salvar' : 'Criar';
        submitLoader.classList.add('hidden');
    }
    
    // Tornar as funções globais para uso em outros contextos
    window.addCompany = addCompany;
    window.removeCompany = removeCompany;
});

// Sistema de Notificações
function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notification-container');
    
    // Determinar cores e ícones baseados no tipo
    let bgColor, textColor, icon;
    
    switch (type) {
        case 'success':
            bgColor = 'bg-green-500';
            textColor = 'text-white';
            icon = 'mdi-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-500';
            textColor = 'text-white';
            icon = 'mdi-alert-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-500';
            textColor = 'text-white';
            icon = 'mdi-alert';
            break;
        default:
            bgColor = 'bg-blue-500';
            textColor = 'text-white';
            icon = 'mdi-information';
    }
    
    // Criar elemento da notificação
    const notification = document.createElement('div');
    notification.className = `${bgColor} ${textColor} px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-80 max-w-md transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`;
    
    notification.innerHTML = `
        <i class="mdi ${icon} text-xl flex-shrink-0"></i>
        <div class="flex-1">
            <p class="text-sm font-medium">${message}</p>
        </div>
        <button type="button" class="flex-shrink-0 ml-4 text-white/80 hover:text-white" onclick="closeNotification(this)">
            <i class="mdi mdi-close text-lg"></i>
        </button>
    `;
    
    // Adicionar ao container
    container.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-full');
        notification.classList.add('opacity-100', 'translate-x-0');
    }, 100);
    
    // Auto-remover após duração especificada
    if (duration > 0) {
        setTimeout(() => {
            closeNotification(notification.querySelector('button'));
        }, duration);
    }
}

function closeNotification(button) {
    const notification = button.closest('div');
    
    // Animar saída
    notification.classList.remove('opacity-100', 'translate-x-0');
    notification.classList.add('opacity-0', 'translate-x-full');
    
    // Remover após animação
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 300);
}

// Interceptar envio do formulário para exibir feedback de loading
document.addEventListener('DOMContentLoaded', function() {
    const userForm = document.getElementById('userForm');
    
    if (userForm) {
        userForm.addEventListener('submit', function(e) {
            // Limpar notificações existentes
            clearAllNotifications();
            
            // Mostrar notificação de loading
            showNotification(
                userId ? 'Salvando alterações do usuário...' : 'Criando novo usuário...', 
                'info', 
                0 // Não remove automaticamente
            );
        });
    }
});

// Função para limpar todas as notificações
function clearAllNotifications() {
    const container = document.getElementById('notification-container');
    if (container) {
        container.innerHTML = '';
    }
}

// Função para mostrar notificação específica de sucesso na criação
function showSuccessMessage(isEdit = false) {
    const message = isEdit ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!';
    showNotification(message, 'success', 4000);
}

// Função para mostrar notificação específica de erro
function showErrorMessage(message = 'Ocorreu um erro ao processar a solicitação') {
    showNotification(message, 'error', 6000);
}
</script>
{% endblock %}
