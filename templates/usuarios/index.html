{% extends "base.html" %}

{% block title %}Usuários - Portal UniSystem{% endblock %}

{% block extra_css %}
<style>
    /* === DESIGN SYSTEM - VARIÁVEIS MODERNAS === */
    :root {
        /* Paleta de cores minimalista */
        --color-background: #fafbfc;
        --color-surface: #ffffff;
        --color-surface-hover: #f8fafc;
        --color-border: #e2e8f0;
        --color-border-light: #f1f5f9;
        
        /* Textos */
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --color-text-muted: #64748b;
        --color-text-light: #94a3b8;
        
        /* Cores de destaque elegantes */
        --color-primary: #3b82f6;
        --color-primary-light: #dbeafe;
        --color-success: #10b981;
        --color-success-light: #d1fae5;
        --color-warning: #f59e0b;
        --color-warning-light: #fef3c7;
        --color-danger: #ef4444;
        --color-danger-light: #fee2e2;
        --color-info: #06b6d4;
        --color-info-light: #cffafe;
        --color-purple: #8b5cf6;
        --color-purple-light: #ede9fe;
        
        /* Sombras minimalistas */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* Espacamentos consistentes */
        --spacing-xs: 0.5rem;
        --spacing-sm: 0.75rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        /* Bordas arredondadas */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* Transições suaves */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }

    /* === LAYOUT BASE === */
    .dashboard-container {
        background: var(--color-background);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        width: 100%;
        box-sizing: border-box;
        padding-top: 4rem;
    }

    .main-content {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-xl);
        box-sizing: border-box;
    }

    /* === HEADER MODERNIZADO === */
    .dashboard-header {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-lg) var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-lg);
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-title-section {
        flex: 1;
    }

    .header-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0 0 var(--spacing-xs) 0;
        letter-spacing: -0.02em;
    }

    .header-subtitle {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    /* === CARDS DE MÉTRICAS === */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-2xl);
    }

    .metric-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-lg);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        box-shadow: var(--shadow-sm);
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin: 0 0 var(--spacing-xs) 0;
        font-weight: 500;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin: 0;
        line-height: 1;
    }

    /* === FILTROS === */
    .filters-section {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-md);
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .filter-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-secondary);
    }

    .filter-input {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.875rem;
        color: var(--color-text-primary);
        transition: all var(--transition-fast);
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    /* === SEÇÕES DE USUÁRIOS === */
    .users-section {
        margin-bottom: var(--spacing-2xl);
    }

    .section-header {
        background: var(--color-surface);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        border: 1px solid var(--color-border-light);
        padding: var(--spacing-lg);
        border-bottom: none;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .section-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0;
    }

    .section-count {
        background: var(--color-background);
        color: var(--color-text-muted);
        font-size: 0.875rem;
        font-weight: 500;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-md);
    }

    .users-table-container {
        background: var(--color-surface);
        border: 1px solid var(--color-border-light);
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        background: var(--color-background);
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-md) var(--spacing-lg);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .users-table td {
        border-bottom: 1px solid var(--color-border-light);
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 0.875rem;
        color: var(--color-text-primary);
    }

    .users-table tr:hover {
        background: var(--color-surface-hover);
    }

    .users-table tr:last-child td {
        border-bottom: none;
    }

    /* === BADGES === */
    .role-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-md);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .role-admin {
        background: var(--color-danger-light);
        color: #dc2626;
    }

    .role-interno {
        background: var(--color-primary-light);
        color: #2563eb;
    }

    .role-cliente {
        background: var(--color-success-light);
        color: #059669;
    }

    /* === BOTÕES === */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all var(--transition-fast);
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: var(--color-primary);
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: var(--color-text-muted);
        color: white;
    }

    .btn-secondary:hover {
        background: var(--color-text-secondary);
        transform: translateY(-1px);
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
    }

    .btn-outline:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-text-secondary);
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            align-items: stretch;
        }

        .header-controls {
            justify-content: stretch;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .main-content {
            padding: 0 var(--spacing-md);
        }
    }

    /* === ESTILO PARA NOTIFICAÇÕES === */
    #notification-container {
        max-height: 100vh;
        overflow-y: auto;
        pointer-events: none;
        top: 8rem;
        right: 1.5rem;
        position: fixed;
        z-index: 50;
    }
    
    #notification-container > div {
        pointer-events: auto;
        margin-bottom: 0.5rem;
    }
    
    @media (max-width: 640px) {
        #notification-container {
            top: 6rem;
            right: 1rem;
            left: 1rem;
        }
        
        #notification-container > div {
            min-width: auto;
            max-width: none;
        }
    }
    
    @media (min-width: 641px) and (max-width: 1024px) {
        #notification-container {
            top: 7rem;
            right: 1.5rem;
        }
    }
    
    .notification-enter {
        animation: slideInRight 0.3s ease-out;
    }
    
    .notification-exit {
        animation: slideOutRight 0.3s ease-in;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* === EMPTY STATE === */
    .empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--color-text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sistema de Notificações -->
    <div id="notification-container">
        <!-- Notificações serão inseridas aqui via JavaScript -->
    </div>

    <!-- Verificar se há mensagens flash e exibir notificações -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    {% for category, message in messages %}
                        showNotification('{{ message|safe }}', '{{ category }}');
                    {% endfor %}
                });
            </script>
        {% endif %}
    {% endwith %}

    <!-- Header da Página -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-title-section">
                <h1 class="header-title">Gestão de Usuários</h1>
                <p class="header-subtitle">
                    <i class="mdi mdi-account-multiple"></i>
                    Administração e controle de acesso ao sistema
                </p>
            </div>
            <div class="header-controls">
                <a href="{{ url_for('usuarios.refresh') }}" class="btn btn-outline" title="Atualizar lista">
                    <i class="mdi mdi-refresh"></i>
                    Atualizar
                </a>
                <a href="{{ url_for('usuarios.novo') }}" class="btn btn-primary">
                    <i class="mdi mdi-plus"></i>
                    Novo Usuário
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Cards de Métricas -->
        <div class="metrics-grid">
            <!-- Administradores -->
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--color-danger-light); color: #dc2626;">
                    <i class="mdi mdi-shield-crown"></i>
                </div>
                <div class="metric-content">
                    <p class="metric-label">Administradores</p>
                    <h3 class="metric-value" id="admins-count">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h3>
                </div>
            </div>

            <!-- Usuários Internos -->
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--color-primary-light); color: #2563eb;">
                    <i class="mdi mdi-account-tie"></i>
                </div>
                <div class="metric-content">
                    <p class="metric-label">Usuários Internos</p>
                    <h3 class="metric-value" id="internos-count">{{ users|selectattr('role', 'equalto', 'interno_unique')|list|length }}</h3>
                </div>
            </div>

            <!-- Clientes -->
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--color-success-light); color: #059669;">
                    <i class="mdi mdi-account-group"></i>
                </div>
                <div class="metric-content">
                    <p class="metric-label">Clientes</p>
                    <h3 class="metric-value" id="clientes-count">{{ users|selectattr('role', 'equalto', 'cliente_unique')|list|length }}</h3>
                </div>
            </div>

            <!-- Total de Empresas -->
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--color-purple-light); color: #7c3aed;">
                    <i class="mdi mdi-domain"></i>
                </div>
                <div class="metric-content">
                    <p class="metric-label">Empresas Vinculadas</p>
                    <h3 class="metric-value" id="empresas-count">
                        {% set total_empresas = [] %}
                        {% for user in users %}
                            {% if user.agent_info and user.agent_info.empresas %}
                                {% for empresa in user.agent_info.empresas %}
                                    {% if total_empresas.append(empresa.cnpj) %}{% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        {{ total_empresas|unique|list|length }}
                    </h3>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Buscar Usuário</label>
                    <input type="text" id="search-input" class="filter-input" placeholder="Nome ou email...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filtrar por Perfil</label>
                    <select id="role-filter" class="filter-input">
                        <option value="">Todos os perfis</option>
                        <option value="admin">Administradores</option>
                        <option value="interno_unique">Usuários Internos</option>
                        <option value="cliente_unique">Clientes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Empresa</label>
                    <input type="text" id="empresa-filter" class="filter-input" placeholder="Nome da empresa...">
                </div>
                <div class="filter-group">
                    <button type="button" id="clear-filters" class="btn btn-outline" style="margin-top: auto;">
                        <i class="mdi mdi-filter-remove"></i>
                        Limpar
                    </button>
                </div>
            </div>
        </div>

        {% if users %}
            <!-- Seção Administradores -->
            <div class="users-section" data-role="admin">
                <div class="section-header">
                    <div class="section-icon" style="background: var(--color-danger-light); color: #dc2626;">
                        <i class="mdi mdi-shield-crown"></i>
                    </div>
                    <h2 class="section-title">Administradores</h2>
                    <span class="section-count" id="admin-section-count">
                        {{ users|selectattr('role', 'equalto', 'admin')|list|length }} usuários
                    </span>
                </div>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="admin-tbody">
                            {% for user in users %}
                                {% if user.role == 'admin' %}
                                <tr class="user-row" data-role="admin" data-name="{{ user.name|lower }}" data-email="{{ user.email|lower }}">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 32px; height: 32px; background: var(--color-danger-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #dc2626;">
                                                <i class="mdi mdi-shield-crown" style="font-size: 1rem;"></i>
                                            </div>
                                            <strong>{{ user.name }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="role-badge role-admin">Administrador</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <a href="{{ url_for('usuarios.editar', user_id=user.id) }}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-pencil"></i>
                                            </a>
                                            <button onclick="openDeleteModal('{{ user.id }}')" class="btn" style="background: var(--color-danger); color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção Usuários Internos -->
            <div class="users-section" data-role="interno_unique">
                <div class="section-header">
                    <div class="section-icon" style="background: var(--color-primary-light); color: #2563eb;">
                        <i class="mdi mdi-account-tie"></i>
                    </div>
                    <h2 class="section-title">Usuários Internos</h2>
                    <span class="section-count" id="interno-section-count">
                        {{ users|selectattr('role', 'equalto', 'interno_unique')|list|length }} usuários
                    </span>
                </div>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="interno-tbody">
                            {% for user in users %}
                                {% if user.role == 'interno_unique' %}
                                <tr class="user-row" data-role="interno_unique" data-name="{{ user.name|lower }}" data-email="{{ user.email|lower }}">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 32px; height: 32px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #2563eb;">
                                                <i class="mdi mdi-account-tie" style="font-size: 1rem;"></i>
                                            </div>
                                            <strong>{{ user.name }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="role-badge role-interno">Interno Unique</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <a href="{{ url_for('usuarios.editar', user_id=user.id) }}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-pencil"></i>
                                            </a>
                                            <button onclick="openDeleteModal('{{ user.id }}')" class="btn" style="background: var(--color-danger); color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção Clientes -->
            <div class="users-section" data-role="cliente_unique">
                <div class="section-header">
                    <div class="section-icon" style="background: var(--color-success-light); color: #059669;">
                        <i class="mdi mdi-account-group"></i>
                    </div>
                    <h2 class="section-title">Clientes</h2>
                    <span class="section-count" id="cliente-section-count">
                        {{ users|selectattr('role', 'equalto', 'cliente_unique')|list|length }} usuários
                    </span>
                </div>
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Empresas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="cliente-tbody">
                            {% for user in users %}
                                {% if user.role == 'cliente_unique' %}
                                <tr class="user-row" data-role="cliente_unique" data-name="{{ user.name|lower }}" data-email="{{ user.email|lower }}" 
                                    data-empresas="{% if user.agent_info and user.agent_info.empresas %}{% for empresa in user.agent_info.empresas %}{{ empresa.razao_social|lower }} {{ empresa.cnpj }} {% endfor %}{% endif %}">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 32px; height: 32px; background: var(--color-success-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #059669;">
                                                <i class="mdi mdi-account-group" style="font-size: 1rem;"></i>
                                            </div>
                                            <strong>{{ user.name }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        {% if user.agent_info and user.agent_info.empresas %}
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                                {% for empresa in user.agent_info.empresas %}
                                                    <span style="background: var(--color-purple-light); color: #7c3aed; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;">
                                                        {{ empresa.razao_social }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span style="color: var(--color-text-muted); font-style: italic;">Nenhuma empresa</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <a href="{{ url_for('usuarios.editar', user_id=user.id) }}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-pencil"></i>
                                            </a>
                                            <button onclick="openDeleteModal('{{ user.id }}')" class="btn" style="background: var(--color-danger); color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% else %}
            <!-- Estado Vazio -->
            <div class="users-section">
                <div class="users-table-container">
                    <div class="empty-state">
                        <i class="mdi mdi-account-multiple-outline"></i>
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--color-text-primary); margin: var(--spacing-md) 0;">
                            Nenhum usuário encontrado
                        </h3>
                        <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-lg);">
                            A lista de usuários está vazia. Isso pode ser devido a um problema de conexão com o banco de dados.
                        </p>
                        <div style="display: flex; justify-content: center; gap: var(--spacing-md);">
                            <a href="{{ url_for('usuarios.refresh') }}" class="btn btn-secondary">
                                <i class="mdi mdi-refresh"></i>
                                Tentar Novamente
                            </a>
                            <a href="{{ url_for('usuarios.novo') }}" class="btn btn-primary">
                                <i class="mdi mdi-plus"></i>
                                Adicionar Primeiro Usuário
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
<!-- Modal de Exclusão -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden" style="z-index: 1000;">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full" style="box-shadow: var(--shadow-xl);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div style="width: 48px; height: 48px; background: var(--color-danger-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #dc2626;">
                    <i class="mdi mdi-alert-circle" style="font-size: 1.5rem;"></i>
                </div>
                <div>
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--color-text-primary); margin: 0;">
                        Confirmar Exclusão
                    </h3>
                    <p style="font-size: 0.875rem; color: var(--color-text-muted); margin: 0;">
                        Esta ação não pode ser desfeita
                    </p>
                </div>
            </div>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
                Tem certeza que deseja excluir este usuário? Todos os dados associados serão removidos permanentemente.
            </p>
            <div style="display: flex; justify-content: flex-end; gap: var(--spacing-md);">
                <button onclick="closeDeleteModal()" class="btn btn-outline">
                    Cancelar
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn" style="background: var(--color-danger); color: white;" 
                            onclick="console.log('[DEBUG] Botão excluir clicado diretamente');">
                        <i class="mdi mdi-delete"></i>
                        Excluir Usuário
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// === SISTEMA DE NOTIFICAÇÕES ===
function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notification-container');
    
    let bgColor, textColor, icon;
    switch (type) {
        case 'success':
            bgColor = 'bg-green-500';
            textColor = 'text-white';
            icon = 'mdi-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-500';
            textColor = 'text-white';
            icon = 'mdi-alert-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-500';
            textColor = 'text-white';
            icon = 'mdi-alert';
            break;
        default:
            bgColor = 'bg-blue-500';
            textColor = 'text-white';
            icon = 'mdi-information';
    }
    
    const notification = document.createElement('div');
    notification.className = `${bgColor} ${textColor} px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-80 max-w-md transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`;
    
    notification.innerHTML = `
        <i class="mdi ${icon} text-xl flex-shrink-0"></i>
        <div class="flex-1">
            <p class="text-sm font-medium">${message}</p>
        </div>
        <button type="button" class="flex-shrink-0 ml-4 text-white/80 hover:text-white" onclick="closeNotification(this)">
            <i class="mdi mdi-close text-lg"></i>
        </button>
    `;
    
    container.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-full');
        notification.classList.add('opacity-100', 'translate-x-0');
    }, 100);
    
    if (duration > 0) {
        setTimeout(() => {
            closeNotification(notification.querySelector('button'));
        }, duration);
    }
}

function closeNotification(button) {
    const notification = button.closest('div');
    notification.classList.remove('opacity-100', 'translate-x-0');
    notification.classList.add('opacity-0', 'translate-x-full');
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 300);
}

// === MODAL DE EXCLUSÃO ===
function openDeleteModal(userId) {
    console.log('[DEBUG] openDeleteModal chamado com userId:', userId);
    console.log('[DEBUG] Tipo do userId:', typeof userId);
    
    try {
        const modal = document.getElementById('deleteModal');
        const form = document.getElementById('deleteForm');
        
        console.log('[DEBUG] Modal encontrado:', modal);
        console.log('[DEBUG] Form encontrado:', form);
        
        if (!modal) {
            console.error('[DEBUG] Modal deleteModal não encontrado!');
            alert('Erro: Modal de exclusão não encontrado');
            return;
        }
        
        if (!form) {
            console.error('[DEBUG] Form deleteForm não encontrado!');
            alert('Erro: Formulário de exclusão não encontrado');
            return;
        }
        
        const actionUrl = `/usuarios/${userId}/excluir`;
        console.log('[DEBUG] URL de ação configurada:', actionUrl);
        
        // Remover hidden e configurar action
        modal.classList.remove('hidden');
        form.action = actionUrl;
        document.body.style.overflow = 'hidden';
        
        console.log('[DEBUG] Modal aberto, action do form:', form.action);
        console.log('[DEBUG] Classes do modal:', modal.classList.toString());
        console.log('[DEBUG] Body overflow:', document.body.style.overflow);
        
        // Verificar se o modal realmente ficou visível
        setTimeout(() => {
            const computedStyle = window.getComputedStyle(modal);
            console.log('[DEBUG] Display do modal após timeout:', computedStyle.display);
            console.log('[DEBUG] Visibility do modal após timeout:', computedStyle.visibility);
        }, 100);
        
    } catch (error) {
        console.error('[DEBUG] Erro em openDeleteModal:', error);
        alert('Erro ao abrir modal de exclusão: ' + error.message);
    }
}

function closeDeleteModal() {
    console.log('[DEBUG] closeDeleteModal chamado');
    
    try {
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            console.log('[DEBUG] Modal fechado');
        } else {
            console.error('[DEBUG] Modal deleteModal não encontrado para fechar!');
        }
    } catch (error) {
        console.error('[DEBUG] Erro em closeDeleteModal:', error);
    }
}

// === SISTEMA DE FILTROS ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] Página de usuários carregada');
    console.log('[DEBUG] DOM Content Loaded executado');
    
    const searchInput = document.getElementById('search-input');
    const roleFilter = document.getElementById('role-filter');
    const empresaFilter = document.getElementById('empresa-filter');
    const clearButton = document.getElementById('clear-filters');
    
    console.log('[DEBUG] Elementos encontrados:', {
        searchInput,
        roleFilter,
        empresaFilter,
        clearButton
    });
    
    // Função para filtrar usuários
    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;
        const empresaTerm = empresaFilter.value.toLowerCase();
        
        // Filtrar todas as linhas de usuários
        const userRows = document.querySelectorAll('.user-row');
        const sections = document.querySelectorAll('.users-section');
        
        let visibleCounts = {
            admin: 0,
            interno_unique: 0,
            cliente_unique: 0
        };
        
        userRows.forEach(row => {
            const name = row.dataset.name || '';
            const email = row.dataset.email || '';
            const role = row.dataset.role || '';
            const empresas = row.dataset.empresas || '';
            
            const matchesSearch = !searchTerm || 
                                name.includes(searchTerm) || 
                                email.includes(searchTerm);
            const matchesRole = !selectedRole || role === selectedRole;
            const matchesEmpresa = !empresaTerm || empresas.includes(empresaTerm);
            
            const isVisible = matchesSearch && matchesRole && matchesEmpresa;
            
            row.style.display = isVisible ? '' : 'none';
            
            if (isVisible) {
                visibleCounts[role]++;
            }
        });
        
        // Atualizar contadores das seções
        document.getElementById('admin-section-count').textContent = `${visibleCounts.admin} usuários`;
        document.getElementById('interno-section-count').textContent = `${visibleCounts.interno_unique} usuários`;
        document.getElementById('cliente-section-count').textContent = `${visibleCounts.cliente_unique} usuários`;
        
        // Mostrar/ocultar seções vazias
        sections.forEach(section => {
            const role = section.dataset.role;
            if (role && visibleCounts[role] === 0) {
                section.style.display = selectedRole && selectedRole !== role ? 'none' : 'block';
                if (selectedRole === role || (!selectedRole && (searchTerm || empresaTerm))) {
                    // Mostrar mensagem de nenhum resultado encontrado
                    const tbody = section.querySelector('tbody');
                    if (tbody && !tbody.querySelector('.no-results')) {
                        const noResultsRow = document.createElement('tr');
                        noResultsRow.className = 'no-results';
                        noResultsRow.innerHTML = `
                            <td colspan="4" class="empty-state" style="padding: var(--spacing-xl);">
                                <i class="mdi mdi-filter-remove" style="font-size: 2rem; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
                                <p style="color: var(--color-text-muted);">Nenhum usuário encontrado com os filtros aplicados</p>
                            </td>
                        `;
                        tbody.appendChild(noResultsRow);
                    }
                } else {
                    section.style.display = 'block';
                }
            } else {
                section.style.display = 'block';
                // Remover mensagem de nenhum resultado
                const noResults = section.querySelector('.no-results');
                if (noResults) {
                    noResults.remove();
                }
            }
        });
    }
    
    // Event listeners para filtros
    searchInput.addEventListener('input', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
    empresaFilter.addEventListener('input', filterUsers);
    
    // Limpar filtros
    clearButton.addEventListener('click', function() {
        searchInput.value = '';
        roleFilter.value = '';
        empresaFilter.value = '';
        filterUsers();
    });
    
    // Adicionar funcionalidade ao botão de atualizar
    const refreshButton = document.querySelector('a[href*="/usuarios/refresh"]');
    if (refreshButton) {
        refreshButton.addEventListener('click', function(e) {
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Atualizando...';
            this.style.pointerEvents = 'none';
            this.style.opacity = '0.75';
        });
    }
    
    // Fechar modal ao clicar fora
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    // Debug do formulário de exclusão
    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
        console.log('[DEBUG] Formulário de exclusão encontrado');
        deleteForm.addEventListener('submit', function(e) {
            console.log('[DEBUG] Formulário de exclusão enviado');
            console.log('[DEBUG] Action do formulário:', this.action);
            console.log('[DEBUG] Method do formulário:', this.method);
            console.log('[DEBUG] Event target:', e.target);
            
            // Mostrar notificação de loading
            showNotification('Excluindo usuário...', 'info', 0);
            
            // Debug adicional
            const formData = new FormData(this);
            console.log('[DEBUG] FormData:', Array.from(formData.entries()));
        });
    } else {
        console.error('[DEBUG] Formulário de exclusão NÃO encontrado!');
    }
    
    // Debug dos botões de exclusão
    const deleteButtons = document.querySelectorAll('button[onclick*="openDeleteModal"]');
    console.log('[DEBUG] Botões de exclusão encontrados:', deleteButtons.length);
    
    deleteButtons.forEach((button, index) => {
        console.log(`[DEBUG] Botão ${index + 1}:`, button);
        console.log(`[DEBUG] Onclick do botão ${index + 1}:`, button.getAttribute('onclick'));
        
        // Adicionar listener adicional para debug
        button.addEventListener('click', function(e) {
            console.log(`[DEBUG] Botão de exclusão ${index + 1} clicado`);
            console.log('[DEBUG] Event:', e);
            console.log('[DEBUG] Target:', e.target);
            console.log('[DEBUG] CurrentTarget:', e.currentTarget);
        });
    });
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });
});
</script>

{% endblock %}